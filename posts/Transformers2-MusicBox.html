<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Scott H. Hawley">
<meta name="dcterms.date" content="2023-12-18">
<meta name="description" content="Toy Transformer Tunes">

<title>Understanding Transformers, Part 2: Wee Music Box ‚Äì Scott H. Hawley</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-1b3db88def35042d172274863c1cdcf0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8d1ea2f4f8e14d12cbb0a1c491d81284.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/quarto-contrib/fontawesome6-6.7.2/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-6.7.2/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
details > summary {
    color: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Understanding Transformers, Part 2: Wee Music Box ‚Äì Scott H. Hawley">
<meta name="twitter:description" content="Toy Transformer Tunes">
<meta name="twitter:image" content="https://drscotthawley.github.io/blog/posts/images/musicbox_prime.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Scott H. Hawley</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/drscotthawley"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/drscotthawley.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/drscotthawley"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/drscotthawley/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Understanding Transformers, Part 2: Wee Music Box</h1>
                  <div>
        <div class="description">
          Toy Transformer Tunes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">nlp</div>
                <div class="quarto-category">architectures</div>
                <div class="quarto-category">transformers</div>
                <div class="quarto-category">music</div>
                <div class="quarto-category">midi</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Scott H. Hawley </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 18, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preface" id="toc-preface" class="nav-link active" data-scroll-target="#preface"><span class="header-section-number">1</span> Preface</a>
  <ul class="collapse">
  <li><a href="#managing-expectations" id="toc-managing-expectations" class="nav-link" data-scroll-target="#managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</a></li>
  </ul></li>
  <li><a href="#intuiting-the-rest-of-the-transformer" id="toc-intuiting-the-rest-of-the-transformer" class="nav-link" data-scroll-target="#intuiting-the-rest-of-the-transformer"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</a>
  <ul class="collapse">
  <li><a href="#the-cost-of-attention" id="toc-the-cost-of-attention" class="nav-link" data-scroll-target="#the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</a></li>
  <li><a href="#positional-encoding-aka-positional-embeddings" id="toc-positional-encoding-aka-positional-embeddings" class="nav-link" data-scroll-target="#positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</a>
  <ul class="collapse">
  <li><a href="#some-options-for-pe" id="toc-some-options-for-pe" class="nav-link" data-scroll-target="#some-options-for-pe"><span class="header-section-number">2.2.1</span> Some Options for PE</a></li>
  <li><a href="#pe-to-add-or-concatenate" id="toc-pe-to-add-or-concatenate" class="nav-link" data-scroll-target="#pe-to-add-or-concatenate"><span class="header-section-number">2.2.2</span> PE: To Add or Concatenate?</a></li>
  </ul></li>
  <li><a href="#residual-connections" id="toc-residual-connections" class="nav-link" data-scroll-target="#residual-connections"><span class="header-section-number">2.3</span> Residual Connections</a></li>
  <li><a href="#multi-head-attention" id="toc-multi-head-attention" class="nav-link" data-scroll-target="#multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</a></li>
  <li><a href="#layer-normalization" id="toc-layer-normalization" class="nav-link" data-scroll-target="#layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</a></li>
  <li><a href="#stacking-blocks-embeddings-of-embeddingsof-embeddings" id="toc-stacking-blocks-embeddings-of-embeddingsof-embeddings" class="nav-link" data-scroll-target="#stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings‚Ä¶of Embeddings</a></li>
  </ul></li>
  <li><a href="#the-music-midi-dataset" id="toc-the-music-midi-dataset" class="nav-link" data-scroll-target="#the-music-midi-dataset"><span class="header-section-number">3</span> The Music (MIDI) Dataset</a>
  <ul class="collapse">
  <li><a href="#learning-about-midi-data" id="toc-learning-about-midi-data" class="nav-link" data-scroll-target="#learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</a></li>
  <li><a href="#install-and-import" id="toc-install-and-import" class="nav-link" data-scroll-target="#install-and-import"><span class="header-section-number">3.2</span> Install and Import</a></li>
  <li><a href="#download-and-inspect-the-data" id="toc-download-and-inspect-the-data" class="nav-link" data-scroll-target="#download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</a></li>
  <li><a href="#making-a-tokenizer-codebooks" id="toc-making-a-tokenizer-codebooks" class="nav-link" data-scroll-target="#making-a-tokenizer-codebooks"><span class="header-section-number">3.4</span> Making a Tokenizer: Codebooks</a>
  <ul class="collapse">
  <li><a href="#encoding-and-decoding" id="toc-encoding-and-decoding" class="nav-link" data-scroll-target="#encoding-and-decoding"><span class="header-section-number">3.4.1</span> Encoding and Decoding</a></li>
  <li><a href="#checking-encoding-decoding-playing-tensors" id="toc-checking-encoding-decoding-playing-tensors" class="nav-link" data-scroll-target="#checking-encoding-decoding-playing-tensors"><span class="header-section-number">3.4.2</span> Checking Encoding &amp; Decoding, ‚ÄòPlaying‚Äô Tensors</a></li>
  </ul></li>
  <li><a href="#making-pytorch-datasets" id="toc-making-pytorch-datasets" class="nav-link" data-scroll-target="#making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</a>
  <ul class="collapse">
  <li><a href="#data-augmentation" id="toc-data-augmentation" class="nav-link" data-scroll-target="#data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</a></li>
  <li><a href="#pytorch-dataset-object-definition" id="toc-pytorch-dataset-object-definition" class="nav-link" data-scroll-target="#pytorch-dataset-object-definition"><span class="header-section-number">3.5.2</span> PyTorch Dataset Object Definition</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#hyperparameters-model-configuration" id="toc-hyperparameters-model-configuration" class="nav-link" data-scroll-target="#hyperparameters-model-configuration"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</a></li>
  <li><a href="#transformer-model-code" id="toc-transformer-model-code" class="nav-link" data-scroll-target="#transformer-model-code"><span class="header-section-number">5</span> Transformer Model Code</a></li>
  <li><a href="#preliminaries-before-training" id="toc-preliminaries-before-training" class="nav-link" data-scroll-target="#preliminaries-before-training"><span class="header-section-number">6</span> Preliminaries Before Training</a>
  <ul class="collapse">
  <li><a href="#set-up-the-gpucpu-device" id="toc-set-up-the-gpucpu-device" class="nav-link" data-scroll-target="#set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></a></li>
  <li><a href="#prompt-for-demos" id="toc-prompt-for-demos" class="nav-link" data-scroll-target="#prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</a></li>
  <li><a href="#re-init-things" id="toc-re-init-things" class="nav-link" data-scroll-target="#re-init-things"><span class="header-section-number">6.3</span> (Re-)Init Things</a></li>
  </ul></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model"><span class="header-section-number">7</span> Train the Model</a>
  <ul class="collapse">
  <li><a href="#optional-setup-wandb-run-tracking" id="toc-optional-setup-wandb-run-tracking" class="nav-link" data-scroll-target="#optional-setup-wandb-run-tracking"><span class="header-section-number">7.1</span> Optional: Setup WandB Run Tracking</a></li>
  <li><a href="#training-loop-go" id="toc-training-loop-go" class="nav-link" data-scroll-target="#training-loop-go"><span class="header-section-number">7.2</span> Training Loop: Go!</a></li>
  </ul></li>
  <li><a href="#evaluate-the-model" id="toc-evaluate-the-model" class="nav-link" data-scroll-target="#evaluate-the-model"><span class="header-section-number">8</span> Evaluate the Model</a>
  <ul class="collapse">
  <li><a href="#sample-generations" id="toc-sample-generations" class="nav-link" data-scroll-target="#sample-generations"><span class="header-section-number">8.1</span> Sample Generations</a></li>
  <li><a href="#perplexity-score" id="toc-perplexity-score" class="nav-link" data-scroll-target="#perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</a></li>
  <li><a href="#accuracy-score" id="toc-accuracy-score" class="nav-link" data-scroll-target="#accuracy-score"><span class="header-section-number">8.3</span> Accuracy Score</a></li>
  <li><a href="#data-distributions" id="toc-data-distributions" class="nav-link" data-scroll-target="#data-distributions"><span class="header-section-number">8.4</span> Data Distributions</a></li>
  </ul></li>
  <li><a href="#summary-and-faq" id="toc-summary-and-faq" class="nav-link" data-scroll-target="#summary-and-faq"><span class="header-section-number">9</span> Summary and FAQ</a>
  <ul class="collapse">
  <li><a href="#faq" id="toc-faq" class="nav-link" data-scroll-target="#faq"><span class="header-section-number">9.1</span> FAQ</a></li>
  </ul></li>
  <li><a href="#sec-further" id="toc-sec-further" class="nav-link" data-scroll-target="#sec-further"><span class="header-section-number">10</span> Ideas for Further Exploration</a>
  <ul class="collapse">
  <li><a href="#change-hyperparamters-dataset" id="toc-change-hyperparamters-dataset" class="nav-link" data-scroll-target="#change-hyperparamters-dataset"><span class="header-section-number">10.1</span> Change Hyperparamters / Dataset</a></li>
  <li><a href="#report-individual-parts-of-the-loss" id="toc-report-individual-parts-of-the-loss" class="nav-link" data-scroll-target="#report-individual-parts-of-the-loss"><span class="header-section-number">10.2</span> Report Individual Parts of the Loss</a></li>
  <li><a href="#improving-generation-by-implementing-beam-search" id="toc-improving-generation-by-implementing-beam-search" class="nav-link" data-scroll-target="#improving-generation-by-implementing-beam-search"><span class="header-section-number">10.3</span> Improving Generation by Implementing Beam Search</a></li>
  <li><a href="#using-huggingfaces-transformers-instead" id="toc-using-huggingfaces-transformers-instead" class="nav-link" data-scroll-target="#using-huggingfaces-transformers-instead"><span class="header-section-number">10.4</span> Using Huggingface‚Äôs <code>transformers</code> instead</a></li>
  <li><a href="#pitch-only-estimation" id="toc-pitch-only-estimation" class="nav-link" data-scroll-target="#pitch-only-estimation"><span class="header-section-number">10.5</span> Pitch-Only Estimation</a></li>
  <li><a href="#raw-audio" id="toc-raw-audio" class="nav-link" data-scroll-target="#raw-audio"><span class="header-section-number">10.6</span> Raw Audio</a></li>
  <li><a href="#penalize-generation-of-end-of-song-padding" id="toc-penalize-generation-of-end-of-song-padding" class="nav-link" data-scroll-target="#penalize-generation-of-end-of-song-padding"><span class="header-section-number">10.7</span> Penalize Generation of ‚ÄúEnd of Song‚Äù Padding?</a></li>
  </ul></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements"><span class="header-section-number">11</span> Acknowledgements</a></li>
  <li><a href="#appendix-feeding-it-christmas-carols" id="toc-appendix-feeding-it-christmas-carols" class="nav-link" data-scroll-target="#appendix-feeding-it-christmas-carols"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols üéÑ</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/musicbox_prime.jpeg" class="img-fluid figure-img"></p>
<figcaption>Musicbox-Transformer image, via Stable Diffusion XL</figcaption>
</figure>
</div>
<div id="cell-2" class="cell">
<div class="cell-output cell-output-display">
<style>
details > summary {
    color: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
</div>
</div>
<section id="preface" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Preface</h1>
<p>This is a follow-up to an earlier lesson, <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">‚ÄúTo Understand Transformers, Focus on Attention‚Äù</a>. If you haven‚Äôt read that yet, <em>do</em>. IMHO, it‚Äôs really good. ;-) In this lesson, we‚Äôll fill in the ‚Äúblanks‚Äù we left in the Transformer architecture last time, and go on to build a working example.</p>
<p>For that example, let‚Äôs do something different from the many other online lessons about working with text &amp; Natural Language Processing (NLP): Let‚Äôs make a ‚ÄúGenerative Music Transformer.‚Äù To keep things ‚Äúsmall,‚Äù we‚Äôll work in terms of MIDI instead of raw audio. For ideas about trying raw audio, see ‚ÄúFurther Study‚Äù in <a href="#sec-further" class="quarto-xref">Section&nbsp;10</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The goal of this exercise is to build <em>some understanding</em>, not to build a killer MIDI-generating app. If you want the latter, check out <a href="https://magenta.tensorflow.org/music-transformer">Google Magenta‚Äôs paper</a> from 2018, or various extensions since then, such as 2023‚Äôs <a href="https://salu133445.github.io/mmt/">‚ÄúMultitrack Music Transformer‚Äù</a> from a group at UCSD. If you just want to play around with a great MIDI model, check out <a href="https://huggingface.co/spaces/skytnt/midi-composer">SkyTNT‚Äôs HuggingFace Space</a>. By ‚Äúsome‚Äù understanding, I also mean that we‚Äôre going to largely ignore the many variants and improvements on Transformers made over the past several years ‚Äì lately <a href="https://www.youtube.com/watch?v=ouF-H35atOY">‚ÄúMamba‚Äù</a> is generating considerable buzz. I find <a href="https://twitter.com/rasbt">Sebastian Raschka</a>‚Äôs posts to be informative about major updates on the Transformer ‚Äútheme‚Äù. Even as improvements are made, the Transformer architecture will continue to form an important part of the conversation about neural network design.</p>
</div>
</div>
<section id="managing-expectations" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</h2>
<p>What we‚Äôll end up with is something akin to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">producing garbled Shakespeare</a>, except it‚Äôs going to be musical. Garbled music seems much harder to tolerate than garbled Shakespeare, which is why I have delayed releasing this lesson for <em>multiple months</em> ‚Äì I‚Äôve kept <a href="https://wandb.ai/drscotthawley/musicbox-q?workspace=user-drscotthawley">trying</a> and <a href="https://wandb.ai/drscotthawley/musicbox-jsb?workspace=user-drscotthawley">trying</a> (and <a href="https://wandb.ai/drscotthawley/musicbox?workspace=user-drscotthawley">trying</a>) to get better results. At this point, I‚Äôm resigned to the fact that <em>this is a hard problem</em> (even for MIDI!), and my current outputs are about ‚Äúas good as they‚Äôre going to get‚Äù:</p>
<blockquote class="twitter-tweet tw-align-center blockquote">
<p lang="en" dir="ltr">
It's way harder to train a simple MIDI transformer to sound OK than a next-character GPT-type transformer to create text that makes at least basic sense. MIDI tokenizer choice is a big deal here also.
</p>
‚Äî Mateusz Modrzejewski (@mamodrzejewski) <a href="https://twitter.com/mamodrzejewski/status/1728858756736557451?ref_src=twsrc%5Etfw">November 26, 2023</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>‚Ä¶and we‚Äôre going to keep the tokenizer simple.</p>
<p>‚Äì <a href="https://hedges.belmont.edu">Scott H. Hawley</a>, December 2023</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In what follows, I‚Äôve often put sections and subsections in expandable ‚ÄúDetails‚Äù blocks, to enable readers to pick and choose the level of depth they want to see. Enjoy!</p>
</div>
</div>
<hr>
</section>
</section>
<section id="intuiting-the-rest-of-the-transformer" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</h1>
<p>The <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">previous lesson</a> left some things out. In this section, we‚Äôll build some intuitive understanding of these other components and a bit of code.</p>
<p>Below is a picture of the original Transformer model diagram, whose parts we will elucidate as we go on. It‚Äôs set up like the traditional <a href="https://tex.stackexchange.com/questions/374926/drawing-an-encoder-decoder-architecture-in-tikz">‚Äúencoder-decoder‚Äù architecture</a> one often sees in the form of an <a href="images/EncoderDecoder_feedback_large.png">‚Äúhourglass shape‚Äù</a>, although it may not be obvious from the Transformer diagram:</p>
<style>
.img1 {
    /*transform-origin: top left;*/
    width:450px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img1:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-trans-diag" class="img1 quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trans-diag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/TransformerSchematic_labeled.png" class="img1 img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trans-diag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;1<strong>.</strong> (Mouse-over or press to expand.) Original Transformer architecture illustration, blue and red annotations added by me. The ‚ÄúEncoder side‚Äù circled in red is often used for generating embeddings for analysis-based workflows such as classification tasks; of the most famous ‚Äòencoder-only‚Äô models was BERT (which stood Bidirectional Encoder Representations from Transformers). There‚Äôs already an <a href="https://pytorch.org/tutorials/beginner/transformer_tutorial.html">official PyTorch tutorial</a> for the Encoder side. For this lesson, we‚Äôll implement just the Decoder side circled in blue.
</figcaption>
</figure>
</div>
<p>For language translation tasks, both the Encoder (circled in red) and Decoder (circled in blue) are used. For purely ‚Äúgenerative‚Äù systems like the GPT variants and what we‚Äôll do today, we‚Äôll use the Decoder side. Note however that even the Decoder can involve some encoding, as we combine an embedding of the words / MIDI / ‚Äútokens‚Äù with Positional Encoding information. PE is discussed below.</p>
<p>We‚Äôre going to go through the various components that make up the above diagram. But first, let‚Äôs point out something about the Attention mechanism that we skipped over in the previous lesson, namely the computational ‚Äúcost‚Äù associated with making every part of a sequence interact with every other part.</p>
<section id="the-cost-of-attention" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</h2>
<p>The attention mechanism <em>per se</em> that we covered in the previous post has a serious drawback: the computational cost scales like the sequence length squared, i.e.&nbsp;for a sequence length of <span class="math inline">\(N\)</span>, the cost is <big>ùí™</big>(<span class="math inline">\(N^2)\)</span>. This is one reason that Large Language Models can be ‚ÄúLarge‚Äù ‚Äì trying to model long sequences results in big matrices!</p>
<details>
<summary>
Details
</summary>
<p>Various schemes have been proposed to reduce this cost, such as only applying attention over nearby tokens (so-called ‚Äúsliding window‚Äù attention) or other methods that fall under the general heading of ‚Äúmatrix sparsification‚Äù. Here‚Äôs a slide from a talk I gave a few years ago, illustrating a few of these schemes:</p>
<div id="fig-attn-cost" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-attn-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/attention_cost.hawley.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-attn-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;2<strong>.</strong> Various schemes for reducing the <big>ùí™</big>(<span class="math inline">\(N^2)\)</span> cost of Attention. Many such schemes involve replacing the <code>Linear</code> layers with convolution operations, such as with the local receptive fields shown in b) and c). (Source: S.H. Hawley, <a href="https://hedges.belmont.edu/AES_ML_2020/">‚ÄúLearning Tunable Audio Effects via Neural Networks with Self-Attention‚Äù</a>, AES Virtual Symposium: Applications of Machine Learning in Audio, Sep 28, 2020.)
</figcaption>
</figure>
</div>
<p>For this lesson, we‚Äôll see how far we can get with the basic <span class="math inline">\(N^2\)</span> attention. Beyond that, I encourage you to check the literature for whatever the latest/hottest cost-reducing model might be. Popular candidates include <a href="https://arxiv.org/abs/2205.14135">FlashAttention</a> and <a href="https://arxiv.org/abs/2107.14795">PercieverIO</a>. Even sliding windows are <a href="https://twitter.com/hrishioa/status/1712199009308398079">still in use in ways that some people find significant</a>.</p>
</details></section>
<section id="positional-encoding-aka-positional-embeddings" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</h2>
<p>Ordinary Feed-Foward layers (and even convolutional layers) don‚Äôt come with (much of) a sense of position, but giving them one can improve performance on tasks where ordering and position matters. There are many ways people have endowed such models with position-awareness and‚Ä¶ TBH there‚Äôs not necessarily a ‚Äúsilver bullet‚Äù solution, so a variety of approaches can end up performing about the same. In what follows we‚Äôll describe various schemes for doing PEs.</p>
<details>
<summary>
Details on PE
</summary>
<section id="some-options-for-pe" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="some-options-for-pe"><span class="header-section-number">2.2.1</span> Some Options for PE</h3>
<ol type="1">
<li><p>You could just concatenate a ‚Äúlinear ramp‚Äù of values to provide some position values, but‚Ä¶ you wouldn‚Äôt want to do that. See, you don‚Äôt just want the <em>values</em> of the PEs to contain positional information, you want the <em>gradients</em> of the PEs to convey positional info too. But a linear ramp has a constant gradient.</p></li>
<li><p>There‚Äôs the orignal positional encoding from the <a href="https://arxiv.org/abs/1706.03762">AIAYN</a> paper, which uses a set of sines &amp; cosines of expontially-increasing wavelength. They tweaked these wavelengths for their use case and ended up with the following equations: <span class="math display">\[
\begin{aligned}
PE_{(pos,2i)} = \sin(pos / 10000^{2i/d_{model}}) \\
PE_{(pos,2i+1)} = \cos(pos / 10000^{2i/d_{model}})
\end{aligned}
\]</span> But the authors of the Transformer paper said they tried a few different PE methods/equations ‚Äì including letting the model learn the PEs ‚Äì but found no significant impact on performance between them. Let‚Äôs add learned PEs to the list though:</p></li>
<li><p><strong>Let the positional embeddings be learned</strong> via some trainable mapping. <em>This</em> is the approach that Karpathy uses in his mini-GPT tutorial, and it‚Äôs the default approach we‚Äôll use in this lesson.</p></li>
<li><p><a href="https://fleuret.org/francois/">Francois Fleuret</a> in his <a href="https://twitter.com/francoisfleuret/status/1262639062785105922">‚ÄúAttentionToy1D‚Äù</a> demo, used a simplification of approach #2 by essentially turning it into a set of <a href="images/fleuret_binary.png">binary sequences</a> that correspond to the vertices of a hypercube.</p></li>
<li><p><a href="https://arxiv.org/abs/2108.12409">‚ÄúALiBi‚Äù (Attention with Linear Biases)</a> is a method whereby you don‚Äôt do positional encoding of the inputs, rather you insert the positional information into the attention calculation itself. It is <em>slightly</em> faster to execute than traditional PE and (probably?) offers less memory overhead, and yields comparable results. I tried it and the results were comparable to those obtained from Option #3 above, so <strong>I‚Äôve included ALiBi as a configuration option in the code below.</strong></p></li>
<li><p>One scheme, ‚Äú<a href="https://paperswithcode.com/method/relative-position-encodings">Relative Position Embeddings</a>,‚Äù was reported to make a big difference and it arose in the <a href="https://arxiv.org/abs/1809.04281">Music Transformer</a> paper itself. Should we do this? Yes, probably. Are going to do that in this notebook? ‚Ä¶Uh‚Ä¶.no, but that would be a great exercise for a student!</p></li>
<li><p>Rotary Encodings. If you view the PEs not as objects themselves but as a set of <em>transformations</em>, and then you require that these be <em>unitary</em> (i.e., magnitude-preserving) transformations,‚Ä¶one could imagine that might help a bit. Rotary encodings are becoming increasingly prevelent in SOTA models, but in our toy case I hypothesize that any gains from this scheme will be swamped by the error from other sources, and thus unnoticeable. Note that the sines &amp; cosines from the original AIAYN paper (Option #2 above) are reminiscent of the ‚Äúcomponents‚Äù of rotations.</p></li>
</ol>
</section>
<section id="pe-to-add-or-concatenate" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="pe-to-add-or-concatenate"><span class="header-section-number">2.2.2</span> PE: To Add or Concatenate?</h3>
<p>Here‚Äôs a design question: Should we add these PEs to our inputs or concatenate them? There are a variety of views on this, such as those <a href="https://www.youtube.com/watch?v=M2ToEXF6Olw">described in this video</a>.</p>
<p><strong>Here‚Äôs my opinion on this:</strong></p>
<p>Your token embeddings (for the words, or notes, or whatever) are already going to be very high-dimensional. Now, for low-dimensional spaces, adding things up can sort of ‚Äúdestroy‚Äù or ‚Äúobscure‚Äù information, but when you‚Äôre upwards of 128, 256, 1028 dimensions, etc., then adding ends up being <em>akin</em> to a kind of concatenation anyway (just in some wonky subspace). If you were to concatenate, then sure, your positional info always stays separate from the content. But if you‚Äôre going to allow your overall (high-dimensional) embeddings to be <em>learned</em> anyway, then you might as well let the learning dynamic find useful ways to combine the position info with the content info. Otherwise you‚Äôre kind of ‚Äúwasting space‚Äù (with concatenation) and doing more calculations than you‚Äôd need compared to the ‚Äúcompressed‚Äù representation gained by adding learned embeddings.</p>
<p>‚Ä¶But perhaps this is a matter of taste. I‚Äôm open to being convinced otherwise!</p>
<p>In the code that follows below, all our embeddigns will be learned and added together, and the position info be treated similarly. But I will add an option to use the ‚ÄúALiBi‚Äù scheme that essentially just moves the PEs to inside the Attention computation.</p>
</section></details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A great source of instruction about all things related to Positional Encodings is the YouTube channel, <a href="https://www.youtube.com/@AICoffeeBreak">‚ÄúAI Coffee Break with Letitia‚Äù</a>.</p>
</div>
</div>
</section>
</section>
<section id="residual-connections" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="residual-connections"><span class="header-section-number">2.3</span> Residual Connections</h2>
<p>In the Transformer model diagram of <a href="#fig-trans-diag" class="quarto-xref">Figure&nbsp;1</a>, wherever you see arrows going <em>around</em> something and connecting to a yellow ‚ÄúAdd &amp; Norm‚Äù block, that is indicative of a ‚Äúskip residual‚Äù or just ‚Äúresidual‚Äù connection. Readers will likely have seen residual / skip connections in other contexts, so we‚Äôll make this section ‚ÄúDetails‚Äù-expandable for those who haven‚Äôt encountered them.</p>
<details>
<summary>
Details
</summary>
<p>This is a pretty simple idea that yields payoffs in many areas of numerical modeling: You model the <em>change</em> in something instead of modeling the whole thing. The following flowchart illustrates this:</p>
<div id="fig-resid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-resid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div style="background-color:white; width: 65%; margin-left: auto; margin-right: auto;">
<p><img src="https://mermaid.ink/svg/pako:eNo1j0EKg0AMRa8yBAQFewEXBaubQruxu5JNcGIVnIyMGUqR3r3TSnf_fR4kf4PeW4YKhtk_-5GCmkuHkmVG_WLsRI9ADqXOz7JELczhcDzljXcJ2DQjyYMLlNO3N01eW5uo3gml-YU273iNsxZQguPgaLLp3oZiDIKO7BihStHyQElDQHknlaL620t6qDRELiEulpTb_aN_yXZSH677hN-SEhaSu_dJGWhe-f0B3txJZw" class="figure-img"></p>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-resid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;3<strong>.</strong> Flowchart of a residual connection
</figcaption>
</figure>
</div>
<p>With neural networks, this residual scheme has the added benefit of allowing for efficient backpropagation. There are claims that ‚Äúskip residual‚Äù connections also help smooth the loss surface, such as <a href="https://arxiv.org/abs/1712.09913">this figure in a N(eur)IPS paper from 2017</a>:</p>
<div id="fig-loss-landscape" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-loss-landscape-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://miro.medium.com/v2/resize:fit:723/1*_Qd_txKxRlsMdfuH2J-k4g.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-loss-landscape-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;4<strong>.</strong> Loss landscape picture purporting to show the ‚Äúsmoothing‚Äù effects of residual connections. (Source: <a href="https://arxiv.org/abs/1712.09913">Li et al</a>.)
</figcaption>
</figure>
</div>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modeling the <em>change</em> in something rather than the thing itself often yields significant payoffs in many areas of computational modeling. If you want another example of this, consider that diffusion models model the <em>noise added</em>, not the images or latent vectors themselves.</p>
</div>
</div>
</section>
<section id="multi-head-attention" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</h2>
<p>We already covered this in the <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">previous lesson</a> so I suggest going there. However, I‚Äôll add a recap as Details here:</p>
<details>
<summary>
Details
</summary>
<p>Multi-Head Attention simply involves allowing differently-weighted attention operators (called ‚Äúheads‚Äù) to perform attention operations, allowing them to focus on different ‚Äúsenses‚Äù of phrases, parts of speech, or in our case, musical structures. The multiple heads are usually just extra dimensions of a big(ger) matrix multiplication, however they can also be implemented in the form of a loop over the heads to save precious GPU RAM.</p>
<style>
.img-mh {
    /*transform-origin: top left;*/
    width:250px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-mh:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-mh-attn" class="img-mh quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mh-attn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://machinelearningmastery.com/wp-content/uploads/2021/09/tour_4.png" class="img-mh img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mh-attn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;5<strong>.</strong> Diagram of Multi-Head Attention. The multiple attention ‚Äúheads‚Äù are shown below as depthwise semi-transparent copies, which are then concatenated into ‚Äúone big long thing‚Äù via the Concat operation, and then mapped into the the output for the module via the last Linear layer: (Source: <a href="https://arxiv.org/abs/1706.03762">AIAYN</a>.)
</figcaption>
</figure>
</div>
</details></section>
<section id="layer-normalization" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</h2>
<p>This is an alternative to <a href="https://paperswithcode.com/method/batch-normalization">Batch Normalization</a>. With BN, we perform elementwise operations where we subtract the mean across the batch dimension and divide by the variance. With LN, instead of doing this across the batch dimension, we do it across the feature dimension(s).</p>
<style>
.img-ln {
    /*transform-origin: top left;*/
    width:350px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-ln:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-norm-types" class="img-ln quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-norm-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://production-media.paperswithcode.com/methods/Screen_Shot_2020-05-19_at_4.24.42_PM.png" class="img-ln img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-norm-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;6<strong>.</strong> (Mouse-over or press to expand.) Batch normalization vs.&nbsp;Layer normalization. (Source: <a href="https://paperswithcode.com/method/layer-normalization">PapersWithCode</a>.)
</figcaption>
</figure>
</div>
<p>One big advantage of doing our normalization across layers instead of batches is that <em>it allows for small batch sizes.</em> Language models are often <em>large</em>, so they take up a lot of memory, which means you might need very small batches. But small batches will not allow you to do very good batch normalization. So, LayerNorm helps us get good statistics for the mean and variance that we use to normalize.</p>
</section>
<section id="stacking-blocks-embeddings-of-embeddingsof-embeddings" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings‚Ä¶of Embeddings</h2>
<p>By stacking layers of our transformers, i.e.&nbsp;feeding embeddings into layers that will render them as new embeddings, we will increase the representational power of our model. In terms of code, this is easy to do by looping over a list of layers.</p>
</section>

<section id="the-music-midi-dataset" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The Music (MIDI) Dataset</h1>
<p>This section adopts a first-person perspective because I want to convey a personal tone: I confess that I‚Äôm ‚Äúnot a MIDI guy,‚Äù having always worked with raw audio exclusively. I vastly underestimated how difficult it would be to get decent results. Starting from Google‚Äôs well-known <a href="https://magenta.tensorflow.org/datasets/maestro">MAESTRO dataset</a> of solo piano performances ‚Äì NOTE: <em>virtuoso</em> piano performances! ‚ÄìI kept downgrading the ‚Äúdifficulty‚Äù of the dataset until settling on <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach chorales</a>.</p>
<section id="learning-about-midi-data" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</h2>
<details>
<summary>
Details
</summary>
<p>The MAESTRO data wasn‚Äôt overly challenging if I only focussed on modeling the pitches, but music is pitch + timing (+ more). What‚Äôs more, I‚Äôd only ever seen MIDI music ‚Äúquantized‚Äù into a grid-based ‚Äúpiano roll‚Äù format with a known time-signature, not realizing that that‚Äôs not what MIDI data really is. For our purposes, it‚Äôs worth noting that MIDI encodes several pieces of information on a <em>per-note</em> basis:</p>
<ol type="1">
<li>What instrument played the note</li>
<li>What pitch was played ‚Äì an integer between 0 and 127.</li>
<li>The start time of the note ‚Äì in units of the ‚ÄúMIDI clock‚Äù which <em>usually</em> ticks at 50,000 times a second. This is typically rendered as a floating-point number when using Python MIDI-processing packages such as Colin Raffel‚Äôs <a href="https://craffel.github.io/pretty-midi/">pretty-midi</a> (which we will use)</li>
<li>The end time of the note - another float.</li>
<li>The ‚Äúvelocity‚Äù of the note ‚Äì e.g.&nbsp;how hard a piano key was struck.</li>
</ol>
<p>So, no time signature, no quarter-note, half-note, etc. But fine, taking a lead from the <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">Google Tensorflow Demo for RNN Modeling</a>, we can reduce each note to 3 numbers: 1. pitch 2. ‚Äústep‚Äù in time since the previous note 3. duration of the note (i.e.&nbsp;end time minus start time).</p>
<p>‚Ä¶and focus on single-instrument work, and disregard the velocity.</p>
<p>EVEN THAT was too hard for the code below do with MAESTRO. I then noticed a <a href="https://arxiv.org/abs/1808.03715">paper by the Google team</a> pointed out that quantizing the time into bins of 8 milliseconds was an ok simplification to make, but even this proved too hard for my model. (I could do 16 ms, but that sounded weird.)</p>
<p>‚Ä¶so‚Ä¶. after surveying other things, I went with <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach Chorales</a>, which actually <em>are</em> presented in piano-roll format quantized to 16th note time intervals. Then I had to convert those from JSON to true MIDI, because by then the rest of my code expected MIDI.</p>
<p>I‚Äôll spare you the details of that process, but note that the data link below is not the official dataset link, it‚Äôs <a href="https://drive.google.com/file/d/1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb/view?usp=sharing">my private stash</a> where I converted the JSON to .mid.</p>
</details></section>
<section id="install-and-import" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="install-and-import"><span class="header-section-number">3.2</span> Install and Import</h2>
<div id="cell-23" class="cell">
<details class="code-fold">
<summary>Show the code for system-wide installs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Somehow you need to install fluidsynth</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> install_package(package_name):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"For installing system binaries on Linux (Ubuntu/Debia) or Mac (via Homebrew)"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">'Darwin'</span>:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        os.system(<span class="ss">f'brew install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> platform.system() <span class="op">==</span> <span class="st">'Linux'</span>:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> getpass  <span class="co"># </span><span class="al">NOTE</span><span class="co">: colab doesn't need a password for sudo</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        password <span class="op">=</span> getpass.getpass()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        command <span class="op">=</span> <span class="ss">f"sudo -S apt-get install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        os.popen(command, <span class="st">'w'</span>).write(password<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Unsupported Operating System"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># commenting out b/c I keep re-running this notebook</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">#install_package('fluidsynth')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-24" class="cell">
<details class="code-fold">
<summary>Show the code for pip installs</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq gdown pyfluidsynth pretty_midi torch numpy pandas midi<span class="op">-</span>player multiprocess</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-25" class="cell">
<details class="code-fold">
<summary>Show the code for imports</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import (most of) what we'll need for the entire lesson</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fluidsynth</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pretty_midi</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn, einsum</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> functional <span class="im">as</span> F</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocess <span class="im">as</span> mp   <span class="co"># multiprocess is a Jupyter-compatible fork of multiprocessing</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm  <span class="co"># note: Quarto blog won't print output from tqdm.notebook</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">#from tqdm.contrib.concurrent import process_map  # process_map throws errors on Mac :'-( </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, HTML</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="download-and-inspect-the-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</h2>
<div id="cell-27" class="cell">
<details class="code-fold">
<summary>Show the code for downloading the dataset</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_source <span class="op">=</span> <span class="st">'jsb_chorales_midi'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add options for MAESTRO, others</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">'midi_data'</span>) <span class="co"># generic name for whatever midi we might want</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>REST_PITCH <span class="op">=</span> <span class="dv">127</span>  <span class="co"># special code  used to denote rests</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>gdown <span class="op">-</span>O {data_source}.tgz <span class="dv">1</span><span class="er">MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tar zxf {data_source}.tgz<span class="op">;</span> rm <span class="op">-</span>rf midi_data<span class="op">;</span> ln <span class="op">-</span>s {data_source} midi_data <span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the list of MIDI filenames</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> <span class="bu">sorted</span>(glob(<span class="bu">str</span>(data_dir<span class="op">/</span><span class="st">'**/*.mid*'</span>),recursive<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Number of files:'</span>, <span class="bu">len</span>(filenames))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading...
From: https://drive.google.com/uc?id=1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb
To: /Users/shawley/github/blog/posts/jsb_chorales_midi.tgz
100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 137k/137k [00:00&lt;00:00, 7.18MB/s]
Number of files: 382</code></pre>
</div>
</div>
<p>Let‚Äôs inspect one of the files ‚Äì using the <a href="https://github.com/drscotthawley/midi-player"><code>MIDIPlayer</code></a> object created especially for this lesson!</p>
<div id="cell-fig-midi-play1" class="cell">
<details class="code-fold">
<summary>Show the code for MIDI player usage</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player <span class="im">import</span> MIDIPlayer</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player.stylers <span class="im">import</span> general, dark <span class="co"># I like dark mode</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>midi_file <span class="op">=</span> filenames[<span class="dv">0</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>MIDIPlayer(midi_file, <span class="dv">360</span>, styler<span class="op">=</span>dark, title<span class="op">=</span><span class="ss">f"midi_file = </span><span class="sc">{</span>midi_file<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-midi-play1" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-midi-play1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section984 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section984 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section984 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section984 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section984 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section984 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section984 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section984 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section984 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section984 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section984 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section984&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>midi_file = midi_data/test/jsb_chorale_test_0.mid<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A sound-font visualizer=&quot;#section984 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="360" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-midi-play1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<strong>Figure</strong>&nbsp;7<strong>.</strong> Example of the first MIDI file on our list. (Press the play button to listen.) These particular notes really <em>were</em> arranged on a ‚Äúgrid,‚Äù however I converted them to a series of MIDI ‚Äúnotes,‚Äù occurring one after the other in the file, with simultaneously-starting notes sorted in ascending order of pitch.
</figcaption>
</figure>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes the <code>MIDIPlayer</code>‚Äôs piano roll view will appear blank if the notes are below the bottom of the visible frame. Scroll downward inside the player to reveal all the notes. The piano roll also scrolls left &amp; right.</p>
</div>
</div>
<p>Let‚Äôs load a single file and convert it to a PyTorch tensor called <code>notes_tensor</code>, and we‚Äôll go ahead and convert ‚Äústart‚Äù and ‚Äúend‚Äù times ‚Äústep‚Äù and ‚Äúduration‚Äù times. So, displaying the first several notes (using a <code>pandas</code> dataframe for style) we see‚Ä¶</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code that made Table 1</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Now that the encoder uses rouding/nearest neighbors, we could save the time-quantization for later. </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#       That sets us up for vector quantization approaches</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quantize_times(times, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                   res_ms<span class="op">=</span><span class="dv">8</span>, <span class="co"># resolution in milliseconds. 8ms was deemed sufficient for MAESTRO.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                   clamp_range_s<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">4.0</span>]):</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    quant_step <span class="op">=</span> res_ms <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    q_times <span class="op">=</span> torch.<span class="bu">round</span>(times <span class="op">/</span> quant_step) <span class="op">*</span> quant_step</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> clamp_range_s <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        q_times <span class="op">=</span> torch.clamp(q_times, clamp_range_s[<span class="dv">0</span>], clamp_range_s[<span class="dv">1</span>])</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q_times</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midi_file_to_tensor(filenames, i<span class="op">=</span><span class="va">None</span>, keep_start_end<span class="op">=</span><span class="va">False</span>, rest_pitches<span class="op">=</span>[REST_PITCH]):  <span class="co"># filenames could just be a single filename</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    midi_file <span class="op">=</span> filenames <span class="cf">if</span> i <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">type</span>(filenames)<span class="op">==</span><span class="bu">str</span>  <span class="cf">else</span> filenames[i]</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"reads a single midi file and converts it to tensor with elements (pitch, step, duration)"</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI(midi_file) <span class="co"># read in the whole file. this can be very slow for long MIDI files (e.g. in MAESTRO)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort the notes first by start time (and then by pitch if two notes start at the same time)</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    sorted_notes <span class="op">=</span> <span class="bu">sorted</span>(pm.instruments[<span class="dv">0</span>].notes, key<span class="op">=</span><span class="kw">lambda</span> note: (note.start, note.pitch))</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#notes = torch.empty( (len(sorted_notes), 3 + 2*keep_start_end), dtype=torch.float32 ) # allocate storage</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> sorted_notes[<span class="dv">0</span>].start</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> []</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_notes):</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        new_note <span class="op">=</span>  torch.empty( (<span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>keep_start_end) , dtype<span class="op">=</span>torch.float32)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">int</span>(note.pitch) <span class="kw">in</span> rest_pitches: <span class="cf">continue</span>  <span class="co"># we can actually delete the rests! </span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">0</span>] <span class="op">=</span> note.pitch</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">1</span>] <span class="op">=</span> note.start <span class="op">-</span> prev_start  <span class="co"># step, i.e. time since start of previous note</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">2</span>] <span class="op">=</span> note.end <span class="op">-</span> note.start    <span class="co"># duration</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> keep_start_end:                     <span class="co"># might find it useful be able to keep these for easier analysis later</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>            new_note[<span class="dv">3</span>] <span class="op">=</span> note.start</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>            new_note[<span class="dv">4</span>] <span class="op">=</span> note.end</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> note.start</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        notes.append(new_note)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> torch.vstack(notes)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(notes[:,<span class="dv">1</span>:])</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> notes</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>notes_tensor <span class="op">=</span> midi_file_to_tensor(midi_file)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.notebook_repr_html'</span>, <span class="va">True</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>notes_df <span class="op">=</span> pd.DataFrame(notes_tensor, columns<span class="op">=</span>[<span class="st">'pitch'</span>,<span class="st">'step (s)'</span>,<span class="st">'duration (s)'</span>]) <span class="co"># actually df's look nicer</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="co"># making it look better in the blog: adjust width of pandas dataframes</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">'''</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe {</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="st">    width: 40%; /* Adjust this value as needed */</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe th, .dataframe td {</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="st">    width: auto !important;</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="st">table {</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="st">th, td {</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a><span class="st">    min-width: 100px; /* Or any other width */</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>))</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>HTML(notes_df[:<span class="dv">8</span>].to_html(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="tbl-firstnotes" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-firstnotes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1<strong>.</strong> First 8 notes of <code>notes_tensor</code>
</figcaption>
<div aria-describedby="tbl-firstnotes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">

<style>
.dataframe {
    width: 40%; /* Adjust this value as needed */
    margin-left: auto;
    margin-right: auto;
}
.dataframe th, .dataframe td {
    text-align: center;
    width: auto !important;
}

table {
    margin-left: auto;
    margin-right: auto;
}
th, td {
    text-align: center;
    min-width: 100px; /* Or any other width */
}
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pitch</th>
<th data-quarto-table-cell-role="th">step (s)</th>
<th data-quarto-table-cell-role="th">duration (s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>53.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="even">
<td>57.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>60.0</td>
<td>0.00</td>
<td>1.44</td>
</tr>
<tr class="even">
<td>65.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>52.0</td>
<td>0.48</td>
<td>0.48</td>
</tr>
<tr class="even">
<td>55.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>72.0</td>
<td>0.00</td>
<td>0.24</td>
</tr>
<tr class="even">
<td>70.0</td>
<td>0.24</td>
<td>0.24</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>We‚Äôll convert those floating point numbers to integer indices in ‚Äúcodebooks‚Äù via the ‚Äútokenizer‚Äù below.</p>
<p>Now we‚Äôll load each song into an entry in a list called <code>notes_tensor_list</code>:</p>
<div id="cell-33" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> files_to_tensor_list(filenames, keep_start_end<span class="op">=</span><span class="va">False</span>, serial<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Reads MIDI files in parallel so should be reasonably fast. JSB Chorales are no prob but for MAESTRO you want this"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tensor_list = process_map(midi_file_to_tensor, filenames, max_workers=mp.cpu_count(), chunksize=1) # Doesn't work on Mac</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    tensor_list <span class="op">=</span> []</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    max_ <span class="op">=</span> <span class="bu">len</span>(filenames)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> serial:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, filename <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(filenames)):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            tensor_list.append(midi_file_to_tensor(filename,  keep_start_end<span class="op">=</span>keep_start_end))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mp.Pool(processes<span class="op">=</span>mp.cpu_count()) <span class="im">as</span> p:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> tqdm(total<span class="op">=</span>max_) <span class="im">as</span> pbar:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> r <span class="kw">in</span> p.imap_unordered(partial(midi_file_to_tensor, filenames, keep_start_end<span class="op">=</span>keep_start_end), <span class="bu">range</span>(<span class="dv">0</span>, max_)):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                    tensor_list.append(r)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                    pbar.update()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  tensor_list</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>notes_tensor_list_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>data_source<span class="sc">}</span><span class="ss">_tensor_list.pt'</span>         <span class="co"># we'll save the result to a file for easier re-reading next time</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>read_all_midi_files <span class="op">=</span> <span class="kw">not</span> os.path.exists(notes_tensor_list_filename) <span class="co"># check to see if it already exists</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> read_all_midi_files:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> files_to_tensor_list(filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    torch.save(notes_tensor_list, notes_tensor_list_filename) <span class="co"># save for next time</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> torch.load(notes_tensor_list_filename) <span class="co"># just read from the last time we made one</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">len(notes_tensor_list) = </span><span class="sc">{</span><span class="bu">len</span>(notes_tensor_list)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 382/382 [00:02&lt;00:00, 148.46it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
len(notes_tensor_list) = 382</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>Also, let‚Äôs make a single tensor <code>all_notes</code> out of all the notes. We‚Äôre only going to use this for analysis purposes; for everything else we‚Äôll use the <code>notes_tensor_list</code>, which‚Ä¶I‚Äôm now going to abbreviate as <code>notes_tl</code></p>
<div id="cell-35" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>notes_tl <span class="op">=</span> notes_tensor_list</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>all_notes <span class="op">=</span> torch.vstack(notes_tl).<span class="bu">type</span>(torch.float32)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"all_notes.shape = "</span>,all_notes.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>all_notes.shape =  torch.Size([78349, 3])</code></pre>
</div>
</div>
</section>
<section id="making-a-tokenizer-codebooks" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="making-a-tokenizer-codebooks"><span class="header-section-number">3.4</span> Making a Tokenizer: Codebooks</h2>
Rather than try something sophisticated like calling <a href="https://github.com/Natooz/MidiTok">MidiTok</a>, we‚Äôre going to treat this like a ‚Äúchar-level RNN‚Äù and just regard each note as a ‚Äúparallel‚Äù group of 3 tokens (i.e., one token each for pitch, step, and duration). This means that we will need 3 ‚Äúcodebooks‚Äù that can encode &amp; decode between real-world values and their indices in the codebooks.
<details>
<summary>
Details
</summary>
<p>For the pitch values, it‚Äôs pretty easy since there are up to 128 MIDI pitches. Probably they won‚Äôt all be used, so we <em>could</em> limit the range of pitches, however, I‚Äôm going to want to do some pitch-bending data augmentation, so the pitch tokens will just be <code>int</code> versions of their <code>floats</code>, i.e., indices in a 128-dimensional space.</p>
<p>For the timing ‚Äì which I don‚Äôt plan to do any augmentation of ‚Äì we‚Äôll just write down what unique values are present. These will form the ‚Äúvocabularies‚Äù that we often see used in NLP settings.</p>
<p>Oh, also: The timing values end up being <em>reaaalllly</em> long in some cases. Like, notes with 15 seconds in duration? I‚Äôm going to go ahead an clamp those to a maximum value of 4 seconds.</p>
<div id="cell-37" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_codebooks(all_notes, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    codebooks <span class="op">=</span> []</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    n_codebooks <span class="op">=</span> all_notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="co"># should be 3</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_codebooks): </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:  <span class="co"># i=0 means pitch</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> torch.arange(<span class="dv">128</span>)  <span class="co"># just use all possible pitches. could limit to min/max range but...not gonna. </span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:     <span class="co"># i!=0 means timing</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> all_notes[:,i].unique().sort()[<span class="dv">0</span>] </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">---</span><span class="ch">\n</span><span class="ss">cb </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: cb_vals = </span><span class="sc">{</span>cb_vals<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        codebooks.append(cb_vals)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> codebooks</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>all_notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(all_notes[:,<span class="dv">1</span>:]) <span class="co"># we should already be time-quantized so this should be unnecessary, but...just in case</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>codebooks <span class="op">=</span> make_codebooks(all_notes, verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>vocab_sizes <span class="op">=</span> [<span class="bu">len</span>(cb) <span class="cf">for</span> cb <span class="kw">in</span> codebooks]</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="ss">f"Codebook sizes = </span><span class="sc">{</span>vocab_sizes<span class="sc">}</span><span class="ss">&lt;br&gt;&lt;br&gt;"</span>))</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">###--- From here down, it's just a nice way to display the codebooks in the blog post: </span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> pd.DataFrame(codebooks[<span class="dv">1</span>].numpy(), columns<span class="op">=</span>[<span class="st">'steps (s)'</span>])</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> pd.DataFrame(codebooks[<span class="dv">2</span>].numpy(), columns<span class="op">=</span>[<span class="st">'durations (s)'</span>])</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="ss">f"Codebooks for steps &amp; durations are </span><span class="sc">{</span><span class="st">''</span> <span class="cf">if</span> df1<span class="sc">.</span>equals(df2) <span class="cf">else</span> <span class="st">'not '</span><span class="sc">}</span><span class="ss">the same:"</span>))</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>html1, html2 <span class="op">=</span> df1.to_html(index<span class="op">=</span><span class="va">False</span>),  df2.to_html(index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine HTML strings with a space in between</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>combined_html <span class="op">=</span> <span class="ss">f'''&lt;div style="width: 100%; text-align: center;"&gt;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="ss">     &lt;table style="margin-left: auto; margin-right: auto;"&gt; &lt;tr&gt;</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="ss">     &lt;td style="vertical-align: top;"&gt;</span><span class="sc">{</span>html1<span class="sc">}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="ss">     &lt;td style="width: 50px;"&gt;&lt;/td&gt;</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="ss">     &lt;td style="vertical-align: top;"&gt;</span><span class="sc">{</span>html2<span class="sc">}</span><span class="ss">&lt;/td&gt;</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="ss">     &lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;'''</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the combined HTML</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>display(HTML(combined_html))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
Codebook sizes = [128, 15, 28]<br><br>
</div>
<div class="cell-output cell-output-display">
Codebooks for steps &amp; durations are not the same:
</div>
<div class="cell-output cell-output-display">
<div style="width: 100%; text-align: center;">
     
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<tbody>
<tr class="odd">
<td style="vertical-align: top"><table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">steps (s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.00</td>
</tr>
<tr class="even">
<td>0.12</td>
</tr>
<tr class="odd">
<td>0.24</td>
</tr>
<tr class="even">
<td>0.36</td>
</tr>
<tr class="odd">
<td>0.48</td>
</tr>
<tr class="even">
<td>0.72</td>
</tr>
<tr class="odd">
<td>0.96</td>
</tr>
<tr class="even">
<td>1.20</td>
</tr>
<tr class="odd">
<td>1.44</td>
</tr>
<tr class="even">
<td>1.68</td>
</tr>
<tr class="odd">
<td>1.92</td>
</tr>
<tr class="even">
<td>2.40</td>
</tr>
<tr class="odd">
<td>2.88</td>
</tr>
<tr class="even">
<td>3.84</td>
</tr>
<tr class="odd">
<td>4.00</td>
</tr>
</tbody>
</table></td>
<td style="width: 50px"></td>
<td style="vertical-align: top"><table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">durations (s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.12</td>
</tr>
<tr class="even">
<td>0.24</td>
</tr>
<tr class="odd">
<td>0.36</td>
</tr>
<tr class="even">
<td>0.48</td>
</tr>
<tr class="odd">
<td>0.60</td>
</tr>
<tr class="even">
<td>0.72</td>
</tr>
<tr class="odd">
<td>0.84</td>
</tr>
<tr class="even">
<td>0.96</td>
</tr>
<tr class="odd">
<td>1.08</td>
</tr>
<tr class="even">
<td>1.20</td>
</tr>
<tr class="odd">
<td>1.32</td>
</tr>
<tr class="even">
<td>1.44</td>
</tr>
<tr class="odd">
<td>1.56</td>
</tr>
<tr class="even">
<td>1.68</td>
</tr>
<tr class="odd">
<td>1.80</td>
</tr>
<tr class="even">
<td>1.92</td>
</tr>
<tr class="odd">
<td>2.04</td>
</tr>
<tr class="even">
<td>2.16</td>
</tr>
<tr class="odd">
<td>2.40</td>
</tr>
<tr class="even">
<td>2.52</td>
</tr>
<tr class="odd">
<td>2.64</td>
</tr>
<tr class="even">
<td>2.88</td>
</tr>
<tr class="odd">
<td>3.12</td>
</tr>
<tr class="even">
<td>3.24</td>
</tr>
<tr class="odd">
<td>3.36</td>
</tr>
<tr class="even">
<td>3.60</td>
</tr>
<tr class="odd">
<td>3.84</td>
</tr>
<tr class="even">
<td>4.00</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="encoding-and-decoding" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="encoding-and-decoding"><span class="header-section-number">3.4.1</span> Encoding and Decoding</h3>
<p>Now we need routines to encode and decode, i.e., to convert back and forth between real-world values and codebook indices.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since the quantities we‚Äôre tokenizing are numerical, we don‚Äôt need key-value pairs as you might see in NLP applications. (Thus we can avoid <code>KeyError</code>s. ;-) ) Rather, for encoding, we can use a simple ‚Äú<code>argmin</code>‚Äù on the ‚Äúdistances‚Äù between new values and codebook values. Then decoding will simply be a matter of inserting the index into the array of codebook values. This is like <a href="https://drscotthawley.github.io/blog/posts/2023-06-12-RVQ.html">Vector Quantization</a>, except it‚Äôs only one dimension (so ‚Äúscalar quantization‚Äù?). For codebooks in high-dimensional spaces, typically VQ methods will use (Approximate) Nearest Neighbors or Locality Sensitive Hashing, but since we‚Äôre just in 1-D, simple argmin is fine.</p>
</div>
</div>
<div id="cell-39" class="cell">
<details class="code-fold">
<summary>Show the (Token) Encoder/Decoder code (i.e., real-world values &lt;‚Äì&gt; codebook indices)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_one_cb(seq:torch.Tensor, cb:torch.Tensor) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Encodes one 'column' of note info (either pitches, steps, or durations)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">        given new value(s) and codebook, return argmin of the difference</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">        Difficulty: seq and cb may have different lengths &amp; may not broadcast, </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">        thus I wrote a loop that broadcasts each note over all cb values</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    sidx <span class="op">=</span> torch.empty( seq.shape, dtype<span class="op">=</span><span class="bu">int</span>, device<span class="op">=</span>seq.device)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(seq):                          <span class="co"># note: this is trivially parallel but jupyter mp hangs for me :'-(</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        sidx[i] <span class="op">=</span> torch.argmin( ( note <span class="op">-</span> cb )<span class="op">**</span><span class="dv">2</span>, dim<span class="op">=</span><span class="dv">0</span> )   <span class="co"># could use torch.abs() instead of ^2 since we're in 1-D, but I want this to be general</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sidx</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode_one_cb(xi, cb:torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Decodes one 'column' of note-index info (either pitch_i, step_i, or duration_i)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">    xi should be an int, a list of ints, or a tensor of ints"""</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cb[xi]</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode(seq:torch.Tensor, cbs<span class="op">=</span>codebooks) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Encodes a sequence of notes, where each note is (pitch, step, dur)"</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(seq.shape) <span class="op">==</span> <span class="dv">2</span>, <span class="st">"Not set up for batch processing yet, but could be a fun exercise for a student ;-) "</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    encoded <span class="op">=</span> torch.empty( seq.shape, dtype<span class="op">=</span><span class="bu">int</span>, device<span class="op">=</span>seq.device)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, cb <span class="kw">in</span> <span class="bu">enumerate</span>(cbs):</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        encoded[:,i] <span class="op">=</span> encode_one_cb( seq[:,i], cb)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> encoded</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode(sidx:torch.Tensor, cbs<span class="op">=</span>codebooks) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Decodes a sequence of integer indices for notes (pitch_i, step_i, dur_i)"</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(sidx.shape) <span class="op">==</span> <span class="dv">2</span>, <span class="st">"Not set up for batch processing yet, but could be a fun exercise for a student ;-)"</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    decoded <span class="op">=</span> torch.empty( sidx.shape, dtype<span class="op">=</span>torch.float32, device<span class="op">=</span>sidx.device)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, cb <span class="kw">in</span> <span class="bu">enumerate</span>(cbs):</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>        decoded[:,i] <span class="op">=</span> decode_one_cb( sidx[:,i], cb)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decoded    </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's do a little test to see if we get back what we encode</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>midi_seq <span class="op">=</span> all_notes[<span class="dv">0</span>:<span class="dv">8</span>].clone()</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before encoding, midi_seq =</span><span class="ch">\n</span><span class="st">"</span>,midi_seq)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After encoding, token_list =</span><span class="ch">\n</span><span class="st">"</span>,token_list)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>return_seq <span class="op">=</span> decode(token_list)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After decoding, return_seq =</span><span class="ch">\n</span><span class="st">"</span>,return_seq)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> torch.equal( midi_seq, return_seq), <span class="ss">f"Oops. midi_seq=</span><span class="sc">{</span>midi_seq<span class="sc">}</span><span class="ss">, but return_seq=</span><span class="sc">{</span>return_seq<span class="sc">}</span><span class="ss">. Should be the same"</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="co"># "safety" check re. values that exceed codebook range -- should get truncated to last cb entry</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>midi_seq[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">100.0</span>  <span class="co"># give the last time a huge value to check that our mapper won't crash</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq, codebooks) <span class="co"># if it doesn't crash, we're good</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> token_list[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="bu">len</span>(codebooks[<span class="op">-</span><span class="dv">1</span>])<span class="op">-</span><span class="dv">1</span>, <span class="ss">f"Big value (</span><span class="sc">{</span>midi_seq[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">) should have gotten the last spot in the last codebook (</span><span class="sc">{</span><span class="bu">len</span>(codebooks[<span class="op">-</span><span class="dv">1</span>])<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">) but came back as </span><span class="sc">{</span>token_list[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Preliminary Encoding/Decoding checks pass! :-)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Before encoding, midi_seq =
 tensor([[53.0000,  0.0000,  0.4800],
        [57.0000,  0.0000,  0.4800],
        [60.0000,  0.0000,  1.4400],
        [65.0000,  0.0000,  0.4800],
        [52.0000,  0.4800,  0.4800],
        [55.0000,  0.0000,  0.4800],
        [72.0000,  0.0000,  0.2400],
        [70.0000,  0.2400,  0.2400]])
After encoding, token_list =
 tensor([[53,  0,  3],
        [57,  0,  3],
        [60,  0, 11],
        [65,  0,  3],
        [52,  4,  3],
        [55,  0,  3],
        [72,  0,  1],
        [70,  2,  1]])
After decoding, return_seq =
 tensor([[53.0000,  0.0000,  0.4800],
        [57.0000,  0.0000,  0.4800],
        [60.0000,  0.0000,  1.4400],
        [65.0000,  0.0000,  0.4800],
        [52.0000,  0.4800,  0.4800],
        [55.0000,  0.0000,  0.4800],
        [72.0000,  0.0000,  0.2400],
        [70.0000,  0.2400,  0.2400]])
Preliminary Encoding/Decoding checks pass! :-)</code></pre>
</div>
</div>
</section>
<section id="checking-encoding-decoding-playing-tensors" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="checking-encoding-decoding-playing-tensors"><span class="header-section-number">3.4.2</span> Checking Encoding &amp; Decoding, ‚ÄòPlaying‚Äô Tensors</h3>
<p>Before moving on, it‚Äôs a good idea to double check: Can we really encode and decode an entire midi sequence? Let‚Äôs write some more utility files. Notably the <code>midiplayer()</code> routine which will allow us to play our PyTorch tensors directly in this notebook.</p>
<div id="cell-41" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_start_end(notes:torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"integrates (step,duration) timing pairs to recover (start,end) info. concats them as new columns"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    newnotes <span class="op">=</span> torch.empty((<span class="bu">len</span>(notes), <span class="dv">5</span>), dtype<span class="op">=</span>notes.dtype, device<span class="op">=</span>notes.device)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    newnotes[:,:<span class="dv">3</span>] <span class="op">=</span> notes[:,:<span class="dv">3</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(notes): </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        step, dur <span class="op">=</span> note[<span class="dv">1</span>], note[<span class="dv">2</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> step  <span class="op">+</span> prev_start </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        end   <span class="op">=</span> start <span class="op">+</span> dur</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        newnotes[i,<span class="dv">3</span>], newnotes[i,<span class="dv">4</span>] <span class="op">=</span> start, end</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> start   </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newnotes</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> notes_to_midi(notes:torch.Tensor, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                  time_rescale<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                  out_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">''</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                  instrument_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">'Acoustic Grand Piano'</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                  velocity: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>,  <span class="co"># default loudness for all notes</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                 ) <span class="op">-&gt;</span> pretty_midi.PrettyMIDI:</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.clone()       <span class="co"># just to avoid weird overwrites of memory addresses</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="fl">0.0</span>:</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">"WARNING: You have negative pitches, steps or durations. Setting them to zero"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>      notes <span class="op">=</span> notes <span class="op">*</span> (notes <span class="op">&gt;=</span> <span class="dv">0</span>)  <span class="co"># ReLU on all quantities</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> time_rescale <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:    <span class="co"># added because sometimes I want to slow/speed up</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        notes[:,<span class="dv">1</span>:] <span class="op">=</span> notes[:,<span class="dv">1</span>:] <span class="op">*</span>time_rescale</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    instrument <span class="op">=</span> pretty_midi.Instrument( program<span class="op">=</span>pretty_midi.instrument_name_to_program(instrument_name) )</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">5</span>: notes <span class="op">=</span> get_start_end(notes)  <span class="co"># figure out start,end times from step,dur, concat as new columns</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.cpu().numpy()</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> note <span class="kw">in</span> notes: </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        midi_note <span class="op">=</span> pretty_midi.Note( velocity<span class="op">=</span>velocity, pitch<span class="op">=</span><span class="bu">int</span>(note[<span class="dv">0</span>]), start<span class="op">=</span>note[<span class="dv">3</span>], end<span class="op">=</span>note[<span class="dv">4</span>], )</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        instrument.notes.append(midi_note)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    pm.instruments.append(instrument)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_file: pm.write(out_file)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pm</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midiplayer(notes_tensor, height<span class="op">=</span><span class="dv">400</span>, time_rescale<span class="op">=</span><span class="va">None</span>, midi_file<span class="op">=</span><span class="st">"/tmp/tmp.mid"</span>, title<span class="op">=</span><span class="st">''</span>, styler<span class="op">=</span>dark):</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"MIDIplayer that writes input tensor to temporary file"</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> notes_to_midi(notes_tensor, time_rescale<span class="op">=</span>time_rescale, out_file<span class="op">=</span>midi_file)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MIDIPlayer(midi_file, height, styler<span class="op">=</span>dark, dl<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span>title)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We‚Äôre going to encode &amp; decode, and write to a MIDI file, and play that midi file. Using the same file as above:</p>
<div id="cell-43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>midiplayer(decode(encode(midi_file_to_tensor(filenames[<span class="dv">0</span>]))), title<span class="op">=</span><span class="st">'Encode-Decode Test'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section113 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section113 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section113 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section113 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section113 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section113 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section113 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section113 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section113 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section113 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section113 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section113&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Encode-Decode Test<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== sound-font visualizer=&quot;#section113 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>Yay! Moving on‚Ä¶</p>
</section>
</details></section>
<section id="making-pytorch-datasets" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</h2>
<p>Our particular dataset already comes with a test/train/valid split in its subdirectories, so let‚Äôs use that split. We‚Äôll go ahead and re-load the files:</p>
<div id="cell-47" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor lists</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>train_filenames <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/train'</span> <span class="kw">in</span> x]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>val_filenames   <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/val'</span>   <span class="kw">in</span> x]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test_filenames  <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/test'</span>  <span class="kw">in</span> x]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>train_notes_tl <span class="op">=</span> files_to_tensor_list(train_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>val_notes_tl   <span class="op">=</span> files_to_tensor_list(val_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_notes_tl  <span class="op">=</span> files_to_tensor_list(test_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, tl <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">'train'</span>,<span class="st">'val'</span>,<span class="st">'test'</span>],[train_notes_tl, val_notes_tl, test_notes_tl]):</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> torch.vstack(tl)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(tl)<span class="sc">}</span><span class="ss"> songs in </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>stack<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> notes"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:01&lt;00:00, 145.31it/s]
100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 76/76 [00:00&lt;00:00, 152.73it/s]
100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 77/77 [00:00&lt;00:00, 142.14it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>229 songs in train, 46660 notes
76 songs in val, 15052 notes
77 songs in test, 16637 notes</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>‚Ä¶that‚Äôs not a ton of data. We should include some data augmentation.</p>
<section id="data-augmentation" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</h3>
<p>We‚Äôll augment the pitch values by raising &amp; lowering them within an octave, except we‚Äôll leave the rest pitch (=127 for the JSB chorales) alone since that sometimes gets used as a rest. And we‚Äôll leave the timing values alone.</p>
<div id="cell-49" class="cell">
<details class="code-fold">
<summary>Show the Data Augmentation code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_data(data, pitch_shift<span class="op">=</span><span class="dv">12</span>, debug<span class="op">=</span><span class="va">True</span>, extra_augs<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    datanew <span class="op">=</span> data.clone()                                     <span class="co"># avoid overwriting memory of data</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pitch</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    change <span class="op">=</span> torch.randint(<span class="op">-</span>pitch_shift, pitch_shift, (<span class="dv">1</span>,))    <span class="co"># how many semitones to change all the pitches</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((change, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># change the pitches</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> extra_augs: </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>:                         <span class="co"># sometimes invert pitches? Probably not useful but anyway</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">*=</span> torch.tensor((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((<span class="dv">127</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># time - if we sometimes increase each non-zero time-token by one, that should be ok, right? </span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do step</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            datanew[ datanew[:,<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do duration</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>            datanew[ datanew[:,<span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extra 'safety' constraint: clamp to range of valid values (of tokens)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, cb <span class="kw">in</span> <span class="bu">enumerate</span>(codebooks):</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        datanew[:,i] <span class="op">=</span> torch.clamp(datanew[:,i], <span class="dv">0</span>, <span class="bu">len</span>(cb)<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datanew</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># A couple quick tests: </span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">3</span>) <span class="co"># setting this just  to make sure something happens ;-) </span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> torch.tensor([[<span class="dv">54</span>,<span class="dv">12</span>,<span class="dv">6</span>],[<span class="dv">61</span>,<span class="dv">0</span>,<span class="dv">40</span>],[REST_PITCH,<span class="dv">14</span>,<span class="dv">4</span>],[<span class="dv">86</span>,<span class="dv">0</span>,<span class="dv">12</span>],[<span class="dv">126</span>,<span class="dv">7</span>,<span class="dv">12</span>]])</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"data.shape = "</span>,data.shape)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"original data = </span><span class="ch">\n</span><span class="st">"</span>,data)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> augment_data(data)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"augmented data = </span><span class="ch">\n</span><span class="st">"</span>,aug) <span class="co"># </span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> torch.equal(aug[:,<span class="dv">0</span>], data[:,<span class="dv">0</span>]), <span class="st">"Oops, nothing changed"</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> aug[<span class="dv">2</span>,<span class="dv">0</span>]<span class="op">==</span>data[<span class="dv">2</span>,<span class="dv">0</span>], <span class="st">"Oops,  The REST_PITCH got changed"</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checks passed! :-) "</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data.shape =  torch.Size([5, 3])
original data = 
 tensor([[ 54,  12,   6],
        [ 61,   0,  40],
        [127,  14,   4],
        [ 86,   0,  12],
        [126,   7,  12]])
augmented data = 
 tensor([[ 52,  12,   6],
        [ 59,   0,  27],
        [127,  14,   4],
        [ 84,   0,  12],
        [124,   7,  12]])
Checks passed! :-) </code></pre>
</div>
</div>
</section>
<section id="pytorch-dataset-object-definition" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="pytorch-dataset-object-definition"><span class="header-section-number">3.5.2</span> PyTorch Dataset Object Definition</h3>
<p>Now we‚Äôre ready to define our <code>Dataset</code> class/object. We‚Äôre going to yield <code>input, target</code> pairs of token sequences in which the targets have been shifted by one token so the model learns to predict what comes next. This method is called <a href="https://en.wikipedia.org/wiki/Teacher_forcing">‚ÄúTeacher Forcing‚Äù</a> by the way. (I didn‚Äôt know it needed a name; seems like regular Supervised Learning to me!)</p>
<div id="cell-51" class="cell">
<details class="code-fold">
<summary>Show the Pytorch Dataset code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesDataset(Dataset):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"simple custom dataset of sliding windows"</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                 tensor_list, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                 seq_length:<span class="bu">int</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                 tokenizer<span class="op">=</span>encode,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                 codebooks<span class="op">=</span>codebooks, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                 aug_callback<span class="op">=</span>augment_data,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                 len_mult<span class="op">=</span><span class="dv">100</span>,  <span class="co"># factor to 'fudge' the dataset length when it's inspected by DataLoaders</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>                 pad<span class="op">=</span><span class="va">True</span>, <span class="co"># pad end with rests</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sl <span class="op">=</span> seq_length</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.len_mult <span class="op">=</span> len_mult</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_list <span class="op">=</span> [tokenizer(t) <span class="cf">for</span> t <span class="kw">in</span> tensor_list] <span class="co"># Encode everything at the start; encoded tokens are all we'll use</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pad:</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            rests <span class="op">=</span> torch.tensor([REST_PITCH,<span class="dv">1</span>,<span class="dv">1</span>]).unsqueeze(<span class="dv">0</span>).tile((seq_length,<span class="dv">1</span>))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.data_list <span class="op">=</span> [torch.cat((toks,rests), dim<span class="op">=</span><span class="dv">0</span>) <span class="cf">for</span> toks <span class="kw">in</span> <span class="va">self</span>.data_list]</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.aug_callback <span class="op">=</span> aug_callback</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""we're going to be grabbing random windows from the data, so just the len of the tensor </span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co">        list will be too small for large batch sizes, hence we multiply by len_mult"""</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.data_list)<span class="op">*</span><span class="va">self</span>.len_mult  <span class="co"># this will keep the DataLoader going longer</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx, shift<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> (torch.Tensor, torch.Tensor):</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">"grabs a random 'window' from a random song, with an offset of `shift` tokens between inputs and targets"</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        i_song <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list), (<span class="dv">1</span>,)) <span class="co"># pick a song</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span>  torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list[i_song]) <span class="op">-</span> <span class="va">self</span>.sl <span class="op">-</span> <span class="dv">1</span>, (<span class="dv">1</span>,))  <span class="co"># start of window within song</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        data_block <span class="op">=</span> <span class="va">self</span>.data_list[i_song][ix:ix<span class="op">+</span><span class="va">self</span>.sl<span class="op">+</span><span class="dv">1</span>]  <span class="co"># grab window plus an extra character</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.aug_callback <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            data_block <span class="op">=</span> <span class="va">self</span>.aug_callback(data_block)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        inputs, targets <span class="op">=</span> data_block[:<span class="va">self</span>.sl], data_block[shift:<span class="va">self</span>.sl<span class="op">+</span>shift]</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inputs, targets</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>seq_length <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset(train_notes_tl, seq_length)</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># save test_ds for Evaluation section, later</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset lengths:  Train: </span><span class="sc">{</span><span class="bu">len</span>(train_ds)<span class="sc">}</span><span class="ss"> notes, Validation: </span><span class="sc">{</span><span class="bu">len</span>(val_ds)<span class="sc">}</span><span class="ss"> notes."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset lengths:  Train: 22900 notes, Validation: 76000000 notes.</code></pre>
</div>
</div>
<p>Now we can use the <code>Dataset</code> instances to create <code>DataLoader</code> objects. Since the latter may involve random shuffling, let‚Äôs seed all the Random Number Generators for the sake of reproducibility.</p>
<div id="cell-53" class="cell">
<details class="code-fold">
<summary>Show the RNG-setting &amp; DataLoader code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  set RNG seeds for reproducibility.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seeds(seed):</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed(seed)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed_all(seed) </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span> <span class="co"># We may change this further down, for now it's just a test</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>batch_x, batch_y <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dl))</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checking batch shapes:  batch_x.shape, batch_y.shape = "</span>,batch_x.shape, batch_y.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Checking batch shapes:  batch_x.shape, batch_y.shape =  torch.Size([128, 64, 3]) torch.Size([128, 64, 3])</code></pre>
</div>
</div>
<p>Ok. Now that we have a feel for how to handle our data, let‚Äôs get set up for the Transformer!</p>
</section>
</section>
</section>
<section id="hyperparameters-model-configuration" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</h1>
<p>Here‚Äôs where we‚Äôll put all of our architecture design variables, storing them in a dict-like ‚Äú<code>dataclass</code>‚Äù object for easy passing around.</p>
<div id="cell-56" class="cell">
<details class="code-fold">
<summary>Show the config-creation code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicBoxConfig:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model architecture details</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    seq_length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    n_embd:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span>     <span class="co"># embedding dimension to use for tokens &amp; positions</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    n_heads:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>       <span class="co"># number of attention heads</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    n_blocks:   <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>       <span class="co"># number of attention blocks</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    dropout:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span>     <span class="co"># dropout value applied everywhere. since JSB is a small dataset, let's use more than usual</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    bias:      <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>   <span class="co"># True: bias in Linears and LayerNorms, like GPT-2. False: a bit better and faster</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    use_alibi: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>   <span class="co"># use ALiBi PE scheme</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training details</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    weight_decay:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>   <span class="co"># 0.01 is pytorch default</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    epochs:          <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other handy bookkeeping</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    vocab_sizes: <span class="bu">tuple</span> <span class="op">=</span> <span class="bu">tuple</span>(vocab_sizes)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> MusicBoxConfig()</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>pp <span class="op">=</span> pprint.PrettyPrinter(indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>pp.pprint(config)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MusicBoxConfig(seq_length=64,
               batch_size=128,
               n_embd=128,
               n_heads=8,
               n_blocks=4,
               dropout=0.2,
               bias=False,
               use_alibi=False,
               learning_rate=0.001,
               weight_decay=0.01,
               epochs=20,
               vocab_sizes=(128, 15, 28))</code></pre>
</div>
</div>
</section>
<section id="transformer-model-code" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Transformer Model Code</h1>
<p>I did write my own Transformer code(s) ‚Äì <a href="https://github.com/drscotthawley/TTTT/tree/main/notebooks">honest!</a> ‚Äì but in the <a href="https://wandb.ai/drscotthawley/projects">quest</a> to get better results, I increasingly borrowed from Andrej Karpathy‚Äôs lesson code (feeling like the ‚ÄúSalieri‚Äù to his ‚ÄúMozart‚Äù), to the point where the following is really a set of minor modifications, such as my added support for multiple codebooks, and passing around the config.</p>
<details>
<summary>
Details
</summary>
<div id="cell-58" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from my mod of Karpathy's code.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Unless otherwise noted, anything good in what follows was pasted </span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://github.com/karpathy/minGPT and adapted by Scott H. Hawley (SHH)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_alibi_mask(n):</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"SHH: added this after the fact to demo ALiBi support"</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    mat <span class="op">=</span> torch.zeros((n, n))</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate over the lower triangular indices (excluding the diagonal)</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i):</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>            mat[i, j] <span class="op">=</span> <span class="op">-</span>(i <span class="op">-</span> j)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a mask for the upper triangular part, excluding the diagonal</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> torch.triu(torch.ones_like(mat), diagonal<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    mat[mask.<span class="bu">bool</span>()] <span class="op">=</span> <span class="bu">float</span>(<span class="st">'-inf'</span>) <span class="co"># Apply mask, set upper triangular -inf</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mat</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Head(nn.Module):</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" one head of self-attention </span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co">        SHH: Note: Often Multi-head Attention is done all at once via one big matrix multiply, </span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="co">                   but Karpathy (perhaps for reasons of clarity or to keep VRAM usage low)</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co">                   implemented each Head separately and then looped over them.</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, head_size, config):</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        n_embd, block_size <span class="op">=</span> config.n_embd, config.seq_length</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.query <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_alibi <span class="op">=</span> config.use_alibi</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_alibi:</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.register_buffer(<span class="st">'alibi'</span>, create_alibi_mask(block_size))</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.register_buffer(<span class="st">'tril'</span>, torch.tril(torch.ones(block_size, block_size)))</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        B,T,C <span class="op">=</span> x.shape</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="va">self</span>.key(x)   <span class="co"># (B,T,C)</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> <span class="va">self</span>.query(x) <span class="co"># (B,T,C)</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># compute attention scores ("affinities")</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> q <span class="op">@</span> k.transpose(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> C<span class="op">**-</span><span class="fl">0.5</span> <span class="co"># (B, T, C) @ (B, C, T) -&gt; (B, T, T)</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_alibi:</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>            wei <span class="op">=</span> wei <span class="op">+</span> <span class="va">self</span>.alibi[:T,:T]</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>            wei <span class="op">=</span> wei.masked_fill(<span class="va">self</span>.tril[:T, :T] <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">'-inf'</span>)) <span class="co"># (B, T, T)</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> F.softmax(wei, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, T, T)</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> <span class="va">self</span>.dropout(wei)</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># perform the weighted aggregation of the values</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="va">self</span>.value(x) <span class="co"># (B,T,C)</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> wei <span class="op">@</span> v <span class="co"># (B, T, T) @ (B, T, C) -&gt; (B, T, C)</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiHeadAttention(nn.Module):</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" multiple heads of self-attention in parallel </span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="co">        SHH: As noted above, typically MHA is one big matmul (as in my original code), </span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a><span class="co">             but Karpathy looped over heads so we'll do that.</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_heads, head_size, config):</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>        n_embd <span class="op">=</span> config.n_embd</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.heads <span class="op">=</span> nn.ModuleList([Head(head_size, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_heads)])</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proj <span class="op">=</span> nn.Linear(n_embd, n_embd)</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> torch.cat([h(x) <span class="cf">for</span> h <span class="kw">in</span> <span class="va">self</span>.heads], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> <span class="va">self</span>.dropout(<span class="va">self</span>.proj(out))</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeedFoward(nn.Module):</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" a simple linear layer followed by a non-linearity """</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, config):</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.net <span class="op">=</span> nn.Sequential(</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>            nn.Linear(n_embd, <span class="dv">4</span> <span class="op">*</span> n_embd),</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">4</span> <span class="op">*</span> n_embd, n_embd),</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(config.dropout),</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.net(x)</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Block(nn.Module):</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Transformer block: communication followed by computation </span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="co">        SHH: Note: The ordering of the LayerNorm ops has differed in different Transformer implementations</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a><span class="co">                   Some have pointed out that the original Transformer architecture diagram didn't match the code</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, n_head, config):</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># n_embd: embedding dimension, n_head: the number of heads we'd like</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>        head_size <span class="op">=</span> n_embd <span class="op">//</span> n_head</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sa <span class="op">=</span> MultiHeadAttention(n_head, head_size, config)</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffwd <span class="op">=</span> FeedFoward(n_embd, config)</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln1 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln2 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.sa(<span class="va">self</span>.ln1(x))</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.ffwd(<span class="va">self</span>.ln2(x))</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Transformer(nn.Module):</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""  Main Transformer class, from Karpathy's "BigramLanguageModel" class. </span></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a><span class="co">         SHH added the looping over multiple codebooks / vocabs</span></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, config, debug<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>        n_cb <span class="op">=</span> <span class="bu">len</span>(config.vocab_sizes)</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block_size, n_embd, n_head, n_layer, <span class="va">self</span>.use_alibi <span class="op">=</span> config.seq_length, config.n_embd, config.n_heads, config.n_blocks, config.use_alibi</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># seperate embeddings for pitch, step &amp; dur part of notes</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_embedding_tables <span class="op">=</span> nn.ModuleList([nn.Embedding(vocab_sizes[cbi], n_embd) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)])</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> config.use_alibi: <span class="va">self</span>.position_embedding_table <span class="op">=</span> nn.Embedding(<span class="va">self</span>.block_size, n_embd)</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.blocks <span class="op">=</span> nn.Sequential(<span class="op">*</span>[Block(n_embd, n_head, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layer)])</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln_f <span class="op">=</span> nn.LayerNorm(n_embd) <span class="co"># final layer norm</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lm_heads <span class="op">=</span> nn.ModuleList([nn.Linear(n_embd, vocab_sizes[cbi]) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)]) <span class="co"># output token predictors</span></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.debug<span class="op">=</span><span class="va">False</span></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, idx, targets<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is array of input token indices in the current context</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>        B, T, CBS <span class="op">=</span> idx.shape</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>        tok_emb <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS): <span class="co"># just sum codebook reps</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>            tok_emb <span class="op">=</span> tok_emb <span class="op">+</span> <span class="va">self</span>.token_embedding_tables[cb](idx[:,:,cb])</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tok_emb</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.use_alibi:</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>            pos_emb <span class="op">=</span> <span class="va">self</span>.position_embedding_table(torch.arange(T, device<span class="op">=</span>idx.device)) <span class="co"># (T,E)</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> x <span class="op">+</span> pos_emb    <span class="co">#  sum token embeddings &amp; positional embeddings</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.blocks(x) <span class="co"># Main computation loop! </span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.ln_f(x)   <span class="co"># final layernorm</span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>        logits_list <span class="op">=</span> [head(x) <span class="cf">for</span> head <span class="kw">in</span> <span class="va">self</span>.lm_heads]  <span class="co"># list of output projections over all codebook values</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> targets <span class="kw">is</span> <span class="va">None</span>:  <span class="co"># need targets to compute loss</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>            lambdas <span class="op">=</span> [<span class="fl">0.5</span>]<span class="op">*</span>CBS   <span class="co"># relative "weights" to pitch, step, dur parts of loss. </span><span class="al">TODO</span><span class="co">: Should be in config as hyperparams</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS):        <span class="co"># loop over codebooks  (for pitch, step &amp; dur), summing loss</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  </span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>                B, T, V <span class="op">=</span> logits.shape   <span class="co"># V = vocab size, i.e. codebook length</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targets[:,:,cb]   <span class="co"># B, T </span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits.view(B<span class="op">*</span>T, V)</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targ.reshape(B<span class="op">*</span>T)    <span class="co"># needs reshape &amp; not view b/c of contiguous memory issues.</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss <span class="op">+</span>  lambdas[cb] <span class="op">*</span> F.cross_entropy(logits, targ)</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logits_list, loss</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">@torch.no_grad</span>()</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, idx, max_new_tokens, temperature<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is (B, T, CBS) array of token indices in the current context</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_new_tokens):</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>            idx_cond <span class="op">=</span> idx[:, <span class="op">-</span><span class="va">self</span>.block_size:]      <span class="co"># crop idx to the last block_size tokens</span></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>            logits_list, loss <span class="op">=</span> <span class="va">self</span>(idx_cond)   <span class="co"># get the predictions</span></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>            idx_next_list <span class="op">=</span> []</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(idx_cond.shape[<span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>                <span class="co"># focus only on the last time step</span></span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  <span class="co"># B, T, V  where V = vocab/embedding size </span></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits[:, <span class="op">-</span><span class="dv">1</span>, :] <span class="co"># get last time.  becomes (B, V)</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>                <span class="co"># apply softmax to get probabilities</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> F.softmax(logits<span class="op">/</span>temperature, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, V)</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>                <span class="co"># sample from the distribution</span></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>                idx_next_list.append(torch.multinomial(probs, num_samples<span class="op">=</span><span class="dv">1</span>)) <span class="co"># (B, 1)</span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>            idx_next <span class="op">=</span> torch.tensor(idx_next_list).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>).to(idx.device)</span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>            <span class="co"># append sampled index to the running sequence</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> torch.cat((idx, idx_next), dim<span class="op">=</span><span class="dv">1</span>) <span class="co"># (B, T+1)</span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="co"># test that, make sure we don't get any errors: </span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="op">/</span><span class="fl">1e6</span>, <span class="st">'M parameters in the model'</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.843947 M parameters in the model</code></pre>
</div>
</div>
</details></section>
<section id="preliminaries-before-training" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Preliminaries Before Training</h1>
GPU device, Demo prompts, Clean re-init
<details>
<summary>
Details
</summary>
<section id="set-up-the-gpucpu-device" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></h2>
<div id="cell-61" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"mps"</span> <span class="cf">if</span> torch.backends.mps.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"device is"</span>,device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>device is mps</code></pre>
</div>
</div>
</section>
<section id="prompt-for-demos" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</h2>
<p>Let‚Äôs create a ‚Äúprompt‚Äù from the validation dataset so we can monitor the models capabilities in producing ‚Äúdemos‚Äù of the music</p>
<div id="cell-63" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>demo_prompt_idx <span class="op">=</span> <span class="dv">0</span>    <span class="co"># file index from which to pull the demo prompt</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>demo_target <span class="op">=</span> val_notes_tl[demo_prompt_idx]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>display(midiplayer(demo_target, title<span class="op">=</span><span class="ss">f"Full demo 'target', </span><span class="sc">{</span><span class="bu">len</span>(demo_target)<span class="sc">}</span><span class="ss"> notes in length"</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>demo_prompt_length <span class="op">=</span> <span class="dv">16</span>  <span class="co"># number of notes in demo prompt context</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>demo_max_new_tokens <span class="op">=</span> <span class="bu">min</span>(<span class="dv">150</span>, <span class="bu">len</span>(demo_target))  <span class="co"># try to make the whole song, but don't go on too long</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> demo_target[:demo_prompt_length]</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>demo_prompt_length<span class="sc">}</span><span class="ss">-note 'prompt' for demos"</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full demo 'target', 149 notes in length<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>16-note 'prompt' for demos<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="re-init-things" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="re-init-things"><span class="header-section-number">6.3</span> (Re-)Init Things</h2>
<p>Just to keep things ‚Äòclean‚Äô, re-setup the datasets &amp; loaders for good measure, instantiate a model and optimizer.</p>
<div id="cell-65" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset(train_notes_tl, config.seq_length, len_mult<span class="op">=</span>config.batch_size)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>total_params_str <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="op">/</span><span class="fl">1e6</span><span class="sc">}</span><span class="ss"> M'</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(total_params_str,<span class="st">'parameters in the model'</span>)  </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op">=</span>config.learning_rate, weight_decay<span class="op">=</span>config.weight_decay)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.843947 M parameters in the model</code></pre>
</div>
</div>
</section>
</details></section>
<section id="train-the-model" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Train the Model</h1>
<section id="optional-setup-wandb-run-tracking" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="optional-setup-wandb-run-tracking"><span class="header-section-number">7.1</span> Optional: Setup WandB Run Tracking</h2>
<div id="cell-68" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>use_wandb <span class="op">=</span> <span class="va">True</span>  <span class="co"># Tip: leave this off at first, until you're sure everything's working!</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> use_wandb:</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> wandb </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    wandb.login()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    wandb.init(project<span class="op">=</span><span class="st">"musicbox-jsb-tutorial"</span>, config<span class="op">=</span>config)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-blue-fg ansi-bold">wandb</span>: Currently logged in as: <span class="ansi-yellow-fg">drscotthawley</span>. Use <span class="ansi-bold">`wandb login --relogin`</span> to force relogin
</pre>
</div>
</div>
<div class="cell-output cell-output-display">
Tracking run with wandb version 0.16.1
</div>
<div class="cell-output cell-output-display">
Run data is saved locally in <code>/Users/shawley/github/blog/posts/wandb/run-20231218_102422-xo3mc3qf</code>
</div>
<div class="cell-output cell-output-display">
Syncing run <strong><a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/xo3mc3qf" target="_blank">light-dew-42</a></strong> to <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">Weights &amp; Biases</a> (<a href="https://wandb.me/run" target="_blank">docs</a>)<br>
</div>
<div class="cell-output cell-output-display">
 View project at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial</a>
</div>
<div class="cell-output cell-output-display">
 View run at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/xo3mc3qf" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/xo3mc3qf</a>
</div>
</div>
</section>
<section id="training-loop-go" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="training-loop-go"><span class="header-section-number">7.2</span> Training Loop: Go!</h2>
<div id="cell-70" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>val_every  <span class="op">=</span> <span class="dv">1</span> <span class="co"># in steps, evaluate loss on val dataset</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cp_every   <span class="op">=</span> <span class="dv">60</span> <span class="co"># in epochs, checkpoint every</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>demo_every <span class="op">=</span> <span class="dv">4</span> <span class="co"># in epochs, make a midi player demo</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>best_loss <span class="op">=</span> <span class="dv">999</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>ema_weight, loss_ema, val_loss_ema <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">None</span> , <span class="va">None</span> <span class="co"># exponential moving averages for loss reporting</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>step <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> {}</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> config.epochs</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>model.train()</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,epochs<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    pbar <span class="op">=</span> tqdm(total<span class="op">=</span><span class="bu">len</span>(train_dl), desc<span class="op">=</span><span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>config<span class="sc">.</span>epochs<span class="sc">}</span><span class="ss">"</span>, dynamic_ncols<span class="op">=</span><span class="va">False</span>, ncols<span class="op">=</span><span class="dv">100</span>) <span class="co"># progress bar, per epoch</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bi, batch <span class="kw">in</span> <span class="bu">enumerate</span>(train_dl):</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> batch[<span class="dv">0</span>].to(device), batch[<span class="dv">1</span>].to(device)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        logits, loss <span class="op">=</span> model(xb, yb) <span class="co"># evaluate the loss</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        loss_ema <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>loss_ema <span class="cf">if</span> loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> loss.item()</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        losses[<span class="st">'train'</span>], losses[<span class="st">'train_ema'</span>] <span class="op">=</span> loss.item(), loss_ema</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad(set_to_none<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># status / diagnostics:</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (step <span class="op">%</span> val_every <span class="op">==</span> <span class="dv">0</span>):   <span class="co"># note: computing val loss after backprop step will yield "artificially" low values vs train set...at first. I'm ok with that</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>                model.<span class="bu">eval</span>()</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>                xvb, yvb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(val_dl))</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>                val_logits, val_loss <span class="op">=</span> model( xvb.to(device), yvb.to(device) ) </span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>                val_loss_ema <span class="op">=</span>  (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>val_loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>val_loss_ema <span class="cf">if</span> val_loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> val_loss.item() </span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>                losses[<span class="st">'val'</span>], losses[<span class="st">'val_ema'</span>] <span class="op">=</span> val_loss.item(), val_loss_ema</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>            model.train()</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>        wbl_dict <span class="op">=</span> {<span class="st">'step'</span>:step, <span class="st">'epoch'</span>:epoch} <span class="op">|</span> losses   <span class="co"># dict for logging losses, midi examples, etc to wandb</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix( <span class="bu">dict</span>((k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>,<span class="st">'val_ema'</span>])) <span class="co"># loss info for progress bar</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>        pbar.update(<span class="dv">1</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_wandb <span class="kw">and</span> wbl_dict <span class="op">!=</span> {}: wandb.log(wbl_dict)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--- end of epoch ---</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> losses[<span class="st">'val_ema'</span>] <span class="op">&lt;</span> best_loss: <span class="co"># Tracking best val_loss_ema for checkpointing purposes</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>        best_loss <span class="op">=</span> losses[<span class="st">'val_ema'</span>]</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix(<span class="bu">dict</span>( (k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]) <span class="op">|</span> {<span class="st">'BEST val_ema'</span>:best_loss})</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">%</span> cp_every<span class="op">==</span><span class="dv">0</span>) <span class="kw">or</span> (epoch<span class="op">==</span>epochs):   <span class="co"># occasionally save a checkpoint of best model/optimizer states</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>            cp_file <span class="op">=</span> <span class="ss">f"musicbox-jsb"</span> <span class="co">#    -{step}" # let's leave out step to avoid filling disk</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saving a checkpoint to </span><span class="sc">{</span>cp_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>            torch.save({ <span class="st">'step'</span>: step, <span class="st">'model_state_dict'</span>: model.state_dict(), <span class="st">'loss'</span>: loss,</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'optimizer_state_dict'</span>: optimizer.state_dict(),}, cp_file)</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    pbar.refresh()</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>    pbar.close()</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (epoch <span class="op">%</span> demo_every <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> (epoch<span class="op">==</span>epochs):  <span class="co"># demo of midi generation</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>            new_notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>demo_max_new_tokens, temperature<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].cpu() )</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>            p2 <span class="op">=</span> midiplayer(new_notes,title<span class="op">=</span><span class="ss">f"Demo on val dataset, Epoch=</span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>            display(p2)</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_wandb: wandb.log( {<span class="st">'step'</span>:step, <span class="st">'player'</span>:wandb.Html(p2.html)} )              </span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>        model.train()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 1/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:48&lt;00:00,  4.73it/s, train=2.05, val=1.99, BEST val_ema=2.05]
Epoch 2/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.85it/s, train=1.81, val=1.76, BEST val_ema=1.76]
Epoch 3/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.90it/s, train=1.53, val=1.58, BEST val_ema=1.54]
Epoch 4/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.92it/s, train=1.57, val=1.49, BEST val_ema=1.44]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=4<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAABBQGktQABBAABDQABFAGotAAAyAAA0QAA8QABDAIFTQ0BqPABpNAAARkBqMEAAPAAAQEAAQUAAQUAARUAARgBpQQAAQwAARUBqLkAAMAAAMkAAQAAAQQAAQ0AARQAARQCBUy1AAC4AADBAADIAAEBAAEMAai0AADAAADJAAD5AAEVAaStAADIAADdAADtAAEFAAEUAaj4AAEAAaihAACsAADRAADcAADxAAEEAgVMoAAA0AAA7AAA8AABAQABDQIFTLkAAMEAANUAAPEAAPkAAQAAAQwBqKUAALgAAOUAAQUBpNQAAN0AAPAAAPgAAQEAAQQBqJEAAKQAAMAAAOQAAPEAAQAAAQUBpJAAAKUAANwAAOUAAPAAAPEAAQQBqOQAAOkAAPAAAPkAAQEBqKQAAK0AAOkAAPgAAQAAAQEBpOgAAQAAAQUBqKUAAKwAAM0AANUAAOUAAOgAAQQBpNQAAOQAAPEBqK0AAMkBqMgAAO0BpJEAAKQAAKwAAMwBqJAAAMEBpKUAALUAANUA1OUA1KkAAMkAANQAANUAAOwA1OQA1KgAAOkBpKEAANQAAOgAAO0AAPABqKAAAKEAAKQAALQBpKAAAMgAAN0AAOwBqJkAALUAANUAANwAAOUCBUyYAADAAADBAgVMfQAAuQAAwAAA5AIFUHwAAK0AALQAALgAANQAAO0BpKUAAKwBqKQAALUAAOwBpLQAANkAAOUCBVDJAADYAADZAADkAADxAgVMpQAAyAAAyQAA1QAA2AAA6QAA8AGk0QAA1AAA5QAA6AGomQAAyAAA0AAA1QAA3QAA5AAA6QGomAAApQAA5QAA6AGkpAAA1AAA5AAA8QGopAAArQAAvQAA6QAA8AGkkQAArAAAvAAAwQAA0QAA3QAA6AGokAAAmQAA3AGokQAAmAGkfQAAkAAArQGorAAAvQAAwAAA0AAA3AGkvAAA4QGomQAAyQAA4AGofAAAmAAAyAAA2QGkiQAApQGoeQAAiAAApAAAyQGkeAAAyAAA+QGorQAAuQAA2AAA3QGopQAArAAAtQAAuAAA1QAA5QAA+AGknQAA3AGotAGknAAAuQGopAAA1AAA5AGouAAAuQAAzQAA6QAA8QIFTLgAAMwAANUAAOEAAOgBpK0AALkAANQAAN0AAOAAAOkBqKwAALgAAM0AAOgAAPEBqMwAAPACBUzcAaTwAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAABBQGktQABBAABDQABFAGotAAAyAAA0QAA8QABDAIFTQ0BqPABpNAAARkBqMEAAPAAAQEAAQUAAQUAARUAARgBpQQAAQwAARUBqLkAAMAAAMkAAQAAAQQAAQ0AARQAARQCBUy1AAC4AADBAADIAAEBAAEMAai0AADAAADJAAD5AAEVAaStAADIAADdAADtAAEFAAEUAaj4AAEAAaihAACsAADRAADcAADxAAEEAgVMoAAA0AAA7AAA8AABAQABDQIFTLkAAMEAANUAAPEAAPkAAQAAAQwBqKUAALgAAOUAAQUBpNQAAN0AAPAAAPgAAQEAAQQBqJEAAKQAAMAAAOQAAPEAAQAAAQUBpJAAAKUAANwAAOUAAPAAAPEAAQQBqOQAAOkAAPAAAPkAAQEBqKQAAK0AAOkAAPgAAQAAAQEBpOgAAQAAAQUBqKUAAKwAAM0AANUAAOUAAOgAAQQBpNQAAOQAAPEBqK0AAMkBqMgAAO0BpJEAAKQAAKwAAMwBqJAAAMEBpKUAALUAANUA1OUA1KkAAMkAANQAANUAAOwA1OQA1KgAAOkBpKEAANQAAOgAAO0AAPABqKAAAKEAAKQAALQBpKAAAMgAAN0AAOwBqJkAALUAANUAANwAAOUCBUyYAADAAADBAgVMfQAAuQAAwAAA5AIFUHwAAK0AALQAALgAANQAAO0BpKUAAKwBqKQAALUAAOwBpLQAANkAAOUCBVDJAADYAADZAADkAADxAgVMpQAAyAAAyQAA1QAA2AAA6QAA8AGk0QAA1AAA5QAA6AGomQAAyAAA0AAA1QAA3QAA5AAA6QGomAAApQAA5QAA6AGkpAAA1AAA5AAA8QGopAAArQAAvQAA6QAA8AGkkQAArAAAvAAAwQAA0QAA3QAA6AGokAAAmQAA3AGokQAAmAGkfQAAkAAArQGorAAAvQAAwAAA0AAA3AGkvAAA4QGomQAAyQAA4AGofAAAmAAAyAAA2QGkiQAApQGoeQAAiAAApAAAyQGkeAAAyAAA+QGorQAAuQAA2AAA3QGopQAArAAAtQAAuAAA1QAA5QAA+AGknQAA3AGotAGknAAAuQGopAAA1AAA5AGouAAAuQAAzQAA6QAA8QIFTLgAAMwAANUAAOEAAOgBpK0AALkAANQAAN0AAOAAAOkBqKwAALgAAM0AAOgAAPEBqMwAAPACBUzcAaTwAAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAABBQGktQABBAABDQABFAGotAAAyAAA0QAA8QABDAIFTQ0BqPABpNAAARkBqMEAAPAAAQEAAQUAAQUAARUAARgBpQQAAQwAARUBqLkAAMAAAMkAAQAAAQQAAQ0AARQAARQCBUy1AAC4AADBAADIAAEBAAEMAai0AADAAADJAAD5AAEVAaStAADIAADdAADtAAEFAAEUAaj4AAEAAaihAACsAADRAADcAADxAAEEAgVMoAAA0AAA7AAA8AABAQABDQIFTLkAAMEAANUAAPEAAPkAAQAAAQwBqKUAALgAAOUAAQUBpNQAAN0AAPAAAPgAAQEAAQQBqJEAAKQAAMAAAOQAAPEAAQAAAQUBpJAAAKUAANwAAOUAAPAAAPEAAQQBqOQAAOkAAPAAAPkAAQEBqKQAAK0AAOkAAPgAAQAAAQEBpOgAAQAAAQUBqKUAAKwAAM0AANUAAOUAAOgAAQQBpNQAAOQAAPEBqK0AAMkBqMgAAO0BpJEAAKQAAKwAAMwBqJAAAMEBpKUAALUAANUA1OUA1KkAAMkAANQAANUAAOwA1OQA1KgAAOkBpKEAANQAAOgAAO0AAPABqKAAAKEAAKQAALQBpKAAAMgAAN0AAOwBqJkAALUAANUAANwAAOUCBUyYAADAAADBAgVMfQAAuQAAwAAA5AIFUHwAAK0AALQAALgAANQAAO0BpKUAAKwBqKQAALUAAOwBpLQAANkAAOUCBVDJAADYAADZAADkAADxAgVMpQAAyAAAyQAA1QAA2AAA6QAA8AGk0QAA1AAA5QAA6AGomQAAyAAA0AAA1QAA3QAA5AAA6QGomAAApQAA5QAA6AGkpAAA1AAA5AAA8QGopAAArQAAvQAA6QAA8AGkkQAArAAAvAAAwQAA0QAA3QAA6AGokAAAmQAA3AGokQAAmAGkfQAAkAAArQGorAAAvQAAwAAA0AAA3AGkvAAA4QGomQAAyQAA4AGofAAAmAAAyAAA2QGkiQAApQGoeQAAiAAApAAAyQGkeAAAyAAA+QGorQAAuQAA2AAA3QGopQAArAAAtQAAuAAA1QAA5QAA+AGknQAA3AGotAGknAAAuQGopAAA1AAA5AGouAAAuQAAzQAA6QAA8QIFTLgAAMwAANUAAOEAAOgBpK0AALkAANQAAN0AAOAAAOkBqKwAALgAAM0AAOgAAPEBqMwAAPACBUzcAaTwAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 5/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.88it/s, train=1.48, val=1.37, BEST val_ema=1.38]
Epoch 6/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.87it/s, train=1.42, val=1.26, BEST val_ema=1.34]
Epoch 7/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.90it/s, train=1.38, val=1.28, BEST val_ema=1.31]
Epoch 8/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:45&lt;00:00,  5.03it/s, train=1.35, val=1.18, BEST val_ema=1.27]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=8<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD9ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAaSlAACsAAEUAgVM5QABAQIFUKQAAPAAAPkBpK0AAMEAAO0AAPgAAQEAAQUBqKEAAOQAAOwAAQAAAQQBpKAAAKwAAL0AAMAAAMEAAMkBqJEAALwAAMAAAMgAANEAAQEBqQAAAQAAAQUBpJAAAKEAAL0AANAAAO0AAQQAAQ0CBUygAADRAADsAAEMAAERAgVQtQAA0AAA1QAA8QABEAABFQIFTK0AALQAANQAAN0AAO0AAPAAAPkAARQCBUysAAC9AADJAADcAADsAADtAAD4AAENAgVMkQAAvAAAyAAA0QAA7AGovAGkkAAApQAA0AAA1QAA5QAA8QABDAGo+QGopAAArQAA1AAA3QAA5AAA7QAA8AIFTKUAAKwAALUAANwAAOUAAOwBpKQAAOQAAQEBqKEAAN0AAPEAAQABqJkAAKAAANUAAPAAAPgAAPkBpJgAAKEAALQAANEAANQAANwAAPEAAPgBqO0AAPABpKAAANAAAOwAAPkBqLUAANEAAN0AAPgAAQEBqQAAAR0BpK0AALQAAMkAANAAANkAANwAARUAARwBqMgAAPkBpKwAAMUAANgAAPgAARQBqMQAANEAAOUAAPEAAQ0BqLUAANABpLQAAMkAAPAAAPkBqPgAAQUBpK0AAMgAAO0AAQQAAQwBqKwAAMEAAOQAAOwAAQEBqMAAAPEBpL0AAMkAAN0AAPABqNwAAQAAAQUBpLwAAMEAAMgAAOUBqLUAAMAAANEAAOQAAPEAAQQCBUzQAADwAgj0tAII9OUAAQECBUytAADJAADkAADpAAEAAAEdANToANTdAAD5ANDcAADhAADtAAD4ANSsAADIAADgAADxAAEcANTBAADRAajAAADJAaTIAADRAAERAai1AADQAaS0AAC9AADQAADsAADwAAEJAAEQAajxAai1AAC8AADFAADlAAEIAaTEAADwAAEVANTVAAD5AAENANS0AADkAAEUAgR4tQAA0QAA1AAA8QAA+AGotAAAvQAAwQAAyQAA0AGktQAAvAAAwAAAyAAA0QAA3QAA8AAA9QABDAGo3AAA5QGomQAAtAAAyQAA0AAA2QAA5AAA9AAA+QDR/QDV/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDUmAAAyAAA2AAA+AAB/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/ADV/AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD9ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAaSlAACsAAEUAgVM5QABAQIFUKQAAPAAAPkBpK0AAMEAAO0AAPgAAQEAAQUBqKEAAOQAAOwAAQAAAQQBpKAAAKwAAL0AAMAAAMEAAMkBqJEAALwAAMAAAMgAANEAAQEBqQAAAQAAAQUBpJAAAKEAAL0AANAAAO0AAQQAAQ0CBUygAADRAADsAAEMAAERAgVQtQAA0AAA1QAA8QABEAABFQIFTK0AALQAANQAAN0AAO0AAPAAAPkAARQCBUysAAC9AADJAADcAADsAADtAAD4AAENAgVMkQAAvAAAyAAA0QAA7AGovAGkkAAApQAA0AAA1QAA5QAA8QABDAGo+QGopAAArQAA1AAA3QAA5AAA7QAA8AIFTKUAAKwAALUAANwAAOUAAOwBpKQAAOQAAQEBqKEAAN0AAPEAAQABqJkAAKAAANUAAPAAAPgAAPkBpJgAAKEAALQAANEAANQAANwAAPEAAPgBqO0AAPABpKAAANAAAOwAAPkBqLUAANEAAN0AAPgAAQEBqQAAAR0BpK0AALQAAMkAANAAANkAANwAARUAARwBqMgAAPkBpKwAAMUAANgAAPgAARQBqMQAANEAAOUAAPEAAQ0BqLUAANABpLQAAMkAAPAAAPkBqPgAAQUBpK0AAMgAAO0AAQQAAQwBqKwAAMEAAOQAAOwAAQEBqMAAAPEBpL0AAMkAAN0AAPABqNwAAQAAAQUBpLwAAMEAAMgAAOUBqLUAAMAAANEAAOQAAPEAAQQCBUzQAADwAgj0tAII9OUAAQECBUytAADJAADkAADpAAEAAAEdANToANTdAAD5ANDcAADhAADtAAD4ANSsAADIAADgAADxAAEcANTBAADRAajAAADJAaTIAADRAAERAai1AADQAaS0AAC9AADQAADsAADwAAEJAAEQAajxAai1AAC8AADFAADlAAEIAaTEAADwAAEVANTVAAD5AAENANS0AADkAAEUAgR4tQAA0QAA1AAA8QAA+AGotAAAvQAAwQAAyQAA0AGktQAAvAAAwAAAyAAA0QAA3QAA8AAA9QABDAGo3AAA5QGomQAAtAAAyQAA0AAA2QAA5AAA9AAA+QDR/QDV/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDUmAAAyAAA2AAA+AAB/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/ADV/AAH/LwA= sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD9ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAaSlAACsAAEUAgVM5QABAQIFUKQAAPAAAPkBpK0AAMEAAO0AAPgAAQEAAQUBqKEAAOQAAOwAAQAAAQQBpKAAAKwAAL0AAMAAAMEAAMkBqJEAALwAAMAAAMgAANEAAQEBqQAAAQAAAQUBpJAAAKEAAL0AANAAAO0AAQQAAQ0CBUygAADRAADsAAEMAAERAgVQtQAA0AAA1QAA8QABEAABFQIFTK0AALQAANQAAN0AAO0AAPAAAPkAARQCBUysAAC9AADJAADcAADsAADtAAD4AAENAgVMkQAAvAAAyAAA0QAA7AGovAGkkAAApQAA0AAA1QAA5QAA8QABDAGo+QGopAAArQAA1AAA3QAA5AAA7QAA8AIFTKUAAKwAALUAANwAAOUAAOwBpKQAAOQAAQEBqKEAAN0AAPEAAQABqJkAAKAAANUAAPAAAPgAAPkBpJgAAKEAALQAANEAANQAANwAAPEAAPgBqO0AAPABpKAAANAAAOwAAPkBqLUAANEAAN0AAPgAAQEBqQAAAR0BpK0AALQAAMkAANAAANkAANwAARUAARwBqMgAAPkBpKwAAMUAANgAAPgAARQBqMQAANEAAOUAAPEAAQ0BqLUAANABpLQAAMkAAPAAAPkBqPgAAQUBpK0AAMgAAO0AAQQAAQwBqKwAAMEAAOQAAOwAAQEBqMAAAPEBpL0AAMkAAN0AAPABqNwAAQAAAQUBpLwAAMEAAMgAAOUBqLUAAMAAANEAAOQAAPEAAQQCBUzQAADwAgj0tAII9OUAAQECBUytAADJAADkAADpAAEAAAEdANToANTdAAD5ANDcAADhAADtAAD4ANSsAADIAADgAADxAAEcANTBAADRAajAAADJAaTIAADRAAERAai1AADQAaS0AAC9AADQAADsAADwAAEJAAEQAajxAai1AAC8AADFAADlAAEIAaTEAADwAAEVANTVAAD5AAENANS0AADkAAEUAgR4tQAA0QAA1AAA8QAA+AGotAAAvQAAwQAAyQAA0AGktQAAvAAAwAAAyAAA0QAA3QAA8AAA9QABDAGo3AAA5QGomQAAtAAAyQAA0AAA2QAA5AAA9AAA+QDR/QDV/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDUmAAAyAAA2AAA+AAB/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/ADV/AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 9/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.86it/s, train=1.28, val=1.28, BEST val_ema=1.26]
Epoch 10/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.96it/s, train=1.35, val=1.23, BEST val_ema=1.24]
Epoch 11/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.92it/s, train=1.22, val=1.27, BEST val_ema=1.23]
Epoch 12/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.97it/s, train=1.26, val=1.18, BEST val_ema=1.21]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section776 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section776 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section776 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section776 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section776 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section776 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section776 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section776 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section776 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section776 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section776 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section776&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=12<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD5wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1AaitAAC0AaisAAEAAAEZAaTVAAEUAAEVAAEYAajRAADUAAENAaTQAADVAAD5AAEFAAEMAAEUAAEVAajUAADdAAEEAAEUAAEZAajcAADlAADwAAEBAAEVAAEYAaTxAAD4AajkAAEUAaSZAAD5AAEZAaiYAADBAai5AADAAADwAAENAAEYAaTxAAD4AajlAADwAAEJAAEMANX9ANEAAAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANS4AADkAAEIAAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8ANX8AAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD5wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1AaitAAC0AaisAAEAAAEZAaTVAAEUAAEVAAEYAajRAADUAAENAaTQAADVAAD5AAEFAAEMAAEUAAEVAajUAADdAAEEAAEUAAEZAajcAADlAADwAAEBAAEVAAEYAaTxAAD4AajkAAEUAaSZAAD5AAEZAaiYAADBAai5AADAAADwAAENAAEYAaTxAAD4AajlAADwAAEJAAEMANX9ANEAAAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANS4AADkAAEIAAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8ANX8AAf8vAA== sound-font visualizer=&quot;#section776 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD5wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1AaitAAC0AaisAAEAAAEZAaTVAAEUAAEVAAEYAajRAADUAAENAaTQAADVAAD5AAEFAAEMAAEUAAEVAajUAADdAAEEAAEUAAEZAajcAADlAADwAAEBAAEVAAEYAaTxAAD4AajkAAEUAaSZAAD5AAEZAaiYAADBAai5AADAAADwAAENAAEYAaTxAAD4AajlAADwAAEJAAEMANX9ANEAAAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANS4AADkAAEIAAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8ANX8AAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 13/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:46&lt;00:00,  4.91it/s, train=1.22, val=1.22, BEST val_ema=1.21]
Epoch 14/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.87it/s, train=1.27, val=1.2, BEST val_ema=1.2]
Epoch 15/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:48&lt;00:00,  4.74it/s, train=1.17, val=1.24, BEST val_ema=1.18]
Epoch 16/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.84it/s, train=1.14, val=1.22, val_ema=1.19]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section911 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section911 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section911 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section911 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section911 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section911 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section911 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section911 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section911 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section911 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section911 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section911&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=16<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1Aai0AADJAajIAAEAAAEFAaTVAADdAAEEAAEFAAENAAEUAajUAADVAADcAAEEAAEMAAEVAaTRAADUAADxAAENAAEUAajtAADwAajwAAD5AAEMAaTRAADsAADxANTtAADwANTBAADQAADQAADsAADxAAEBAgVMwAAA1QAA+AABAAABFQGo0QAA1AAA3QGkyQAA0AAA8AAA+QABFAABGQIFTMgAANEAANwAAPgAAQEAAQ0AARgBqMkAANAAAPkAAQABqMUAAMgAAMkAAPgAAQEAAQUAAQwAARUBpMgAANEAAOkAAPEBqMQAAN0AAOgAAPAAAPkAAQAAAQQAARQBpNUAANwAAOUAAPEAAPgBqN0AAOQAAO0AAPAAAPkBqNAAANQBpKEAANwAAPgAAQEBqQAAAQ0BpKAAAMkAANUAAQUBqOwAAPEAAQwBqLUAAMgAANEAANQAAN0AAPAAAPEAAQQBpKkAALQAANAAAPkA1PgAAQEA1KgAAK0AAL0AANwAAPAAAPkAAQAAAR0CEeTRAADtAAD4AAENAajJAaisAAC8AADBAADIAADQAADZAADlAAEMAAEVAAEcAaTkAADsAADtAai9AADAAADFAADRAADYAADlAADsAAD5AAEBAAEUAgVMsQAAvAAAxAAA0AAA3QAA5AAA8QAA+AABAAABAQGosAAAuQAA7QAA8AGkuAAAyQAA2QAA3AAA5QAA7AAA+QABAAGotQAAyAGktAAAvQAA+AABAQGovAAAxQAA4QAA5AGoxAAAxQAA4AAA5QGkvQAAxAAA2AAA5AGovAAA3QAA7QGk3AAA5QAA7AAA9QGovQAA5AAA7QAA9AAA+QGo+AABCQGkuQAAvAAA7AAA9QABAAABAQABCAABDQGorQAAuAAA7QABDAGktQAA9AGomQAArAAAtAAAvQAA2QAA7AAA+QGpAAGkmAAAoQAAvAAA0QAA2AAA4QGoyQAA0AGkoAAAtQAAxQAAyAAA0QAA4AAA5QAA+AIMnLQAAMQAANAAAN0AAOQAAPkAAf0AAf0BpK0AANEAANwAAOkAAPUAAPgAAfwAAfwBqKwAALEAAL0AANAAAOgAAPQAAPkBqLAAAPgAAQ0A0LwAAMUAAOUAAPUA1LUAAOQAAQwA1LQAAMQAANkAAOkBqMkAAPQCBUzRAgyYmQAAsQAAyAAA2AAA6AAA9QGomAAA9AGk0AIFULAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1Aai0AADJAajIAAEAAAEFAaTVAADdAAEEAAEFAAENAAEUAajUAADVAADcAAEEAAEMAAEVAaTRAADUAADxAAENAAEUAajtAADwAajwAAD5AAEMAaTRAADsAADxANTtAADwANTBAADQAADQAADsAADxAAEBAgVMwAAA1QAA+AABAAABFQGo0QAA1AAA3QGkyQAA0AAA8AAA+QABFAABGQIFTMgAANEAANwAAPgAAQEAAQ0AARgBqMkAANAAAPkAAQABqMUAAMgAAMkAAPgAAQEAAQUAAQwAARUBpMgAANEAAOkAAPEBqMQAAN0AAOgAAPAAAPkAAQAAAQQAARQBpNUAANwAAOUAAPEAAPgBqN0AAOQAAO0AAPAAAPkBqNAAANQBpKEAANwAAPgAAQEBqQAAAQ0BpKAAAMkAANUAAQUBqOwAAPEAAQwBqLUAAMgAANEAANQAAN0AAPAAAPEAAQQBpKkAALQAANAAAPkA1PgAAQEA1KgAAK0AAL0AANwAAPAAAPkAAQAAAR0CEeTRAADtAAD4AAENAajJAaisAAC8AADBAADIAADQAADZAADlAAEMAAEVAAEcAaTkAADsAADtAai9AADAAADFAADRAADYAADlAADsAAD5AAEBAAEUAgVMsQAAvAAAxAAA0AAA3QAA5AAA8QAA+AABAAABAQGosAAAuQAA7QAA8AGkuAAAyQAA2QAA3AAA5QAA7AAA+QABAAGotQAAyAGktAAAvQAA+AABAQGovAAAxQAA4QAA5AGoxAAAxQAA4AAA5QGkvQAAxAAA2AAA5AGovAAA3QAA7QGk3AAA5QAA7AAA9QGovQAA5AAA7QAA9AAA+QGo+AABCQGkuQAAvAAA7AAA9QABAAABAQABCAABDQGorQAAuAAA7QABDAGktQAA9AGomQAArAAAtAAAvQAA2QAA7AAA+QGpAAGkmAAAoQAAvAAA0QAA2AAA4QGoyQAA0AGkoAAAtQAAxQAAyAAA0QAA4AAA5QAA+AIMnLQAAMQAANAAAN0AAOQAAPkAAf0AAf0BpK0AANEAANwAAOkAAPUAAPgAAfwAAfwBqKwAALEAAL0AANAAAOgAAPQAAPkBqLAAAPgAAQ0A0LwAAMUAAOUAAPUA1LUAAOQAAQwA1LQAAMQAANkAAOkBqMkAAPQCBUzRAgyYmQAAsQAAyAAA2AAA6AAA9QGomAAA9AGk0AIFULAAB/y8A sound-font visualizer=&quot;#section911 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC1Aai0AADJAajIAAEAAAEFAaTVAADdAAEEAAEFAAENAAEUAajUAADVAADcAAEEAAEMAAEVAaTRAADUAADxAAENAAEUAajtAADwAajwAAD5AAEMAaTRAADsAADxANTtAADwANTBAADQAADQAADsAADxAAEBAgVMwAAA1QAA+AABAAABFQGo0QAA1AAA3QGkyQAA0AAA8AAA+QABFAABGQIFTMgAANEAANwAAPgAAQEAAQ0AARgBqMkAANAAAPkAAQABqMUAAMgAAMkAAPgAAQEAAQUAAQwAARUBpMgAANEAAOkAAPEBqMQAAN0AAOgAAPAAAPkAAQAAAQQAARQBpNUAANwAAOUAAPEAAPgBqN0AAOQAAO0AAPAAAPkBqNAAANQBpKEAANwAAPgAAQEBqQAAAQ0BpKAAAMkAANUAAQUBqOwAAPEAAQwBqLUAAMgAANEAANQAAN0AAPAAAPEAAQQBpKkAALQAANAAAPkA1PgAAQEA1KgAAK0AAL0AANwAAPAAAPkAAQAAAR0CEeTRAADtAAD4AAENAajJAaisAAC8AADBAADIAADQAADZAADlAAEMAAEVAAEcAaTkAADsAADtAai9AADAAADFAADRAADYAADlAADsAAD5AAEBAAEUAgVMsQAAvAAAxAAA0AAA3QAA5AAA8QAA+AABAAABAQGosAAAuQAA7QAA8AGkuAAAyQAA2QAA3AAA5QAA7AAA+QABAAGotQAAyAGktAAAvQAA+AABAQGovAAAxQAA4QAA5AGoxAAAxQAA4AAA5QGkvQAAxAAA2AAA5AGovAAA3QAA7QGk3AAA5QAA7AAA9QGovQAA5AAA7QAA9AAA+QGo+AABCQGkuQAAvAAA7AAA9QABAAABAQABCAABDQGorQAAuAAA7QABDAGktQAA9AGomQAArAAAtAAAvQAA2QAA7AAA+QGpAAGkmAAAoQAAvAAA0QAA2AAA4QGoyQAA0AGkoAAAtQAAxQAAyAAA0QAA4AAA5QAA+AIMnLQAAMQAANAAAN0AAOQAAPkAAf0AAf0BpK0AANEAANwAAOkAAPUAAPgAAfwAAfwBqKwAALEAAL0AANAAAOgAAPQAAPkBqLAAAPgAAQ0A0LwAAMUAAOUAAPUA1LUAAOQAAQwA1LQAAMQAANkAAOkBqMkAAPQCBUzRAgyYmQAAsQAAyAAA2AAA6AAA9QGomAAA9AGk0AIFULAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 17/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:48&lt;00:00,  4.68it/s, train=1.15, val=1.22, BEST val_ema=1.18]
Epoch 18/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.85it/s, train=1.14, val=1.2, val_ema=1.19]
Epoch 19/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:47&lt;00:00,  4.79it/s, train=1.16, val=1.19, val_ema=1.18]
Epoch 20/20: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:48&lt;00:00,  4.76it/s, train=1.13, val=1.15, val_ema=1.19]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section430 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section430 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section430 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section430 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section430 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section430 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section430 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section430 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section430 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section430 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section430 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section430&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=20<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAAEZAaUUAAEVAAEYAakNAAEUAaUBAaisAADJAAD5AAEAAAEFAAEFAAEMAajwAADxAAD4AAEEAAEVAaS9AADIAADwAAD5AAENAAEUAai8AADBAaTAAADJAAEEAAEJAAEMAaj4AAEVAajBAADIAADpAAEIAAENAAEUAaToAAEMAAEpAajAAADlAADxAaTNAADkAADpAADwAAENAAEoAajJAADMAADlAADoAAD5AAEFAAEMAgVMwQAAyAAA5AAA8QAA+AAA/QABBAABDQIFTMAAAMkAAPkAAPwAAQUAAQwBqOUAAPAAAPgAAP0BqMEAAMgAAN0AAOQAAOkAAPkAAPwAAQQBpNUAANwBqMAAAOgAAPEAAPgA1RUCBHjwANS5AADNAADpAAENAAEUANTUAgR4uAAAyQAAzAABBQABDAIFTMgAANEAAQQAAQ0AARUCBUzJAAD5AAEMAAEUAAEdAajQAADhAADoAai1AADIAADgAAD4AAEBAAEVAAEcAAEhAaUgAAE1Aai0AAC9AAD5AAEAAAEJAAEUAAEtAAE0AaUFAAEIAai8AADBAAD4AAD9AAENAAEsAakEAAEhAaSxAADAAAEMAAERAakdAAEgAaSwAAC1AAD8AAEJAAEQAAEVAAEcAajxAai0AADFAAEIANCtAADEAAD5AAEBAgR9FADUrAAArQAA7QAA+AABAAABDQIFTNEAAOwCBUylAACsAADQAADxAAEFAAEMAgVM5QABBAABBQGopAAArQGkrAAA5AAA6QAA+QABBAGo6AABDQGo3QAA+AABDAABDQGk3AABLQDU8ADUyQAA8AAA+QABBQABDAABLAABNQGlBAABGQGoyAAAzQAA+AAA/QABDQABGAABNAABPQGpIQABPAGkzAAA1QAA+QAA/AABBQABDAABRQGo1AAA3QAA+AABRAABSQGk3AAA5QAA6QABBAGo5AAA5QAA6AGo5AAA8QABAQGk6QAA8AAA+QABAAGo5QAA6AAA8QAA+ADU8AAA+QDQ1QAA5AAA8QAA+AAA/QABBQABSAGpBAABFQGoyQAA1AAA6QAA8AAA/AABFAABGQGkyAAAzQAA1QAA/QABIAGoyQAAzAAA1AAA3QAA6AAA/AABBQGkwQAAyAAA/QABBAABGAGowAAAyQAA+QAA/AIFTNwAAPgAARkBqMgBpM0AARgCBVDMAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAAEZAaUUAAEVAAEYAakNAAEUAaUBAaisAADJAAD5AAEAAAEFAAEFAAEMAajwAADxAAD4AAEEAAEVAaS9AADIAADwAAD5AAENAAEUAai8AADBAaTAAADJAAEEAAEJAAEMAaj4AAEVAajBAADIAADpAAEIAAENAAEUAaToAAEMAAEpAajAAADlAADxAaTNAADkAADpAADwAAENAAEoAajJAADMAADlAADoAAD5AAEFAAEMAgVMwQAAyAAA5AAA8QAA+AAA/QABBAABDQIFTMAAAMkAAPkAAPwAAQUAAQwBqOUAAPAAAPgAAP0BqMEAAMgAAN0AAOQAAOkAAPkAAPwAAQQBpNUAANwBqMAAAOgAAPEAAPgA1RUCBHjwANS5AADNAADpAAENAAEUANTUAgR4uAAAyQAAzAABBQABDAIFTMgAANEAAQQAAQ0AARUCBUzJAAD5AAEMAAEUAAEdAajQAADhAADoAai1AADIAADgAAD4AAEBAAEVAAEcAAEhAaUgAAE1Aai0AAC9AAD5AAEAAAEJAAEUAAEtAAE0AaUFAAEIAai8AADBAAD4AAD9AAENAAEsAakEAAEhAaSxAADAAAEMAAERAakdAAEgAaSwAAC1AAD8AAEJAAEQAAEVAAEcAajxAai0AADFAAEIANCtAADEAAD5AAEBAgR9FADUrAAArQAA7QAA+AABAAABDQIFTNEAAOwCBUylAACsAADQAADxAAEFAAEMAgVM5QABBAABBQGopAAArQGkrAAA5AAA6QAA+QABBAGo6AABDQGo3QAA+AABDAABDQGk3AABLQDU8ADUyQAA8AAA+QABBQABDAABLAABNQGlBAABGQGoyAAAzQAA+AAA/QABDQABGAABNAABPQGpIQABPAGkzAAA1QAA+QAA/AABBQABDAABRQGo1AAA3QAA+AABRAABSQGk3AAA5QAA6QABBAGo5AAA5QAA6AGo5AAA8QABAQGk6QAA8AAA+QABAAGo5QAA6AAA8QAA+ADU8AAA+QDQ1QAA5AAA8QAA+AAA/QABBQABSAGpBAABFQGoyQAA1AAA6QAA8AAA/AABFAABGQGkyAAAzQAA1QAA/QABIAGoyQAAzAAA1AAA3QAA6AAA/AABBQGkwQAAyAAA/QABBAABGAGowAAAyQAA+QAA/AIFTNwAAPgAARkBqMgBpM0AARgCBVDMAAf8vAA== sound-font visualizer=&quot;#section430 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD8wDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAACtAAEAAAEZAaUUAAEVAAEYAakNAAEUAaUBAaisAADJAAD5AAEAAAEFAAEFAAEMAajwAADxAAD4AAEEAAEVAaS9AADIAADwAAD5AAENAAEUAai8AADBAaTAAADJAAEEAAEJAAEMAaj4AAEVAajBAADIAADpAAEIAAENAAEUAaToAAEMAAEpAajAAADlAADxAaTNAADkAADpAADwAAENAAEoAajJAADMAADlAADoAAD5AAEFAAEMAgVMwQAAyAAA5AAA8QAA+AAA/QABBAABDQIFTMAAAMkAAPkAAPwAAQUAAQwBqOUAAPAAAPgAAP0BqMEAAMgAAN0AAOQAAOkAAPkAAPwAAQQBpNUAANwBqMAAAOgAAPEAAPgA1RUCBHjwANS5AADNAADpAAENAAEUANTUAgR4uAAAyQAAzAABBQABDAIFTMgAANEAAQQAAQ0AARUCBUzJAAD5AAEMAAEUAAEdAajQAADhAADoAai1AADIAADgAAD4AAEBAAEVAAEcAAEhAaUgAAE1Aai0AAC9AAD5AAEAAAEJAAEUAAEtAAE0AaUFAAEIAai8AADBAAD4AAD9AAENAAEsAakEAAEhAaSxAADAAAEMAAERAakdAAEgAaSwAAC1AAD8AAEJAAEQAAEVAAEcAajxAai0AADFAAEIANCtAADEAAD5AAEBAgR9FADUrAAArQAA7QAA+AABAAABDQIFTNEAAOwCBUylAACsAADQAADxAAEFAAEMAgVM5QABBAABBQGopAAArQGkrAAA5AAA6QAA+QABBAGo6AABDQGo3QAA+AABDAABDQGk3AABLQDU8ADUyQAA8AAA+QABBQABDAABLAABNQGlBAABGQGoyAAAzQAA+AAA/QABDQABGAABNAABPQGpIQABPAGkzAAA1QAA+QAA/AABBQABDAABRQGo1AAA3QAA+AABRAABSQGk3AAA5QAA6QABBAGo5AAA5QAA6AGo5AAA8QABAQGk6QAA8AAA+QABAAGo5QAA6AAA8QAA+ADU8AAA+QDQ1QAA5AAA8QAA+AAA/QABBQABSAGpBAABFQGoyQAA1AAA6QAA8AAA/AABFAABGQGkyAAAzQAA1QAA/QABIAGoyQAAzAAA1AAA3QAA6AAA/AABBQGkwQAAyAAA/QABBAABGAGowAAAyQAA+QAA/AIFTNwAAPgAARkBqMgBpM0AARgCBVDMAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p><br> <br> ‚Ä¶and that‚Äôs about as good as it‚Äôs going to get for now. üòï Moving on‚Ä¶</p>
</section>
</section>
<section id="evaluate-the-model" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Evaluate the Model</h1>
<p>Now we‚Äôll grab some data from the hitherto-unseen <code>test</code> dataset, and use it to prompt the model. We‚Äôll see how it ‚Äúscores‚Äù ‚Äì in more ways than one!</p>
<section id="sample-generations" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sample-generations"><span class="header-section-number">8.1</span> Sample Generations</h2>
<p>First we‚Äôll set a ‚Äúprompt‚Äù from the <code>test</code> set to see how the model continues it.</p>
<div id="cell-75" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>file_ind <span class="op">=</span> <span class="dv">1</span>  </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>original <span class="op">=</span> test_notes_tl[file_ind]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>num_tokens <span class="op">=</span> <span class="bu">len</span>(original)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>display(midiplayer(original, title<span class="op">=</span><span class="ss">f"Full Evaluation Target, </span><span class="sc">{</span>num_tokens<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>prompt_len <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> original[:prompt_len] </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"Evaluation Prompt, </span><span class="sc">{</span>prompt_len<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section41 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section41 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section41 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section41 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section41 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section41 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section41 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section41 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section41 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section41 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section41 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section41&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full Evaluation Target, 210 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A sound-font visualizer=&quot;#section41 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section265 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section265 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section265 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section265 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section265 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section265 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section265 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section265 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section265 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section265 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section265 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section265&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Evaluation Prompt, 21 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA== sound-font visualizer=&quot;#section265 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>In what follows, we‚Äôll vary the ‚Äútemperature‚Äù (aka ‚Äúwackiness‚Äù) parameter of the model (see the <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html#sec-softmax-fun">bottom of the previous lesson</a>), to see its effect on the variety of notes produced.</p>
<div id="cell-77" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>new_tokens <span class="op">=</span> num_tokens <span class="op">-</span> prompt_len</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> temperature <span class="kw">in</span> [ <span class="fl">0.7</span>, <span class="fl">0.85</span>, <span class="fl">0.92</span>, <span class="fl">1.0</span>, <span class="fl">1.2</span>, <span class="fl">1.5</span>]:</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    set_seeds(<span class="dv">0</span>) </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>new_tokens, temperature<span class="op">=</span>temperature)[<span class="dv">0</span>].cpu() )</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    display(midiplayer(notes, title<span class="op">=</span><span class="ss">f"Temperature = </span><span class="sc">{</span>temperature<span class="sc">}</span><span class="ss">"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.7<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajhAADkAADtAaTgAADlAADsAAD1AAEBAgVMyQAA5AAA9AABAAABCQABFQABJQABKAGpJAABOQGoyAAA0QABAQABCAABEQABFAABHQABOAGlCQABEAGotQAA0AAA9QABAAABCAABMQGk9AAA/QGotAAA0QAA7QAA/AABDQABEQABGQABHAABMAIFTMUAANAAAOwAAPUAAQwBqPQAATEBpMQAAM0AAP0AARgAATAAATkCBVDMAADhAAEQAAERAAEdAAE4AaT1AAD8AajgAADlAAEJAAEQAAEcAAElAaT0AAD9AajhAADkAAD1AAD8AAExAajxAAD0AaStAADgAADtAADwAAEIAAEkAAEpAAEwAajlAADsAAD1AAEBAaSsAADdAAEoAajJAADcAADkAAD5AAEAAAEJAgVMyAAA7QAA9AAA+AAA+QABCAABDQABHQGo+AABAQABCQABDAGk2QAA7AAA9QABAAABCAABCQABFQABHAIFUNgAAN0AAPQAAPkAAQgAARQAAR0BpNEAANkAANwAAPgAAQEAARkAARkAARwBqL0AANAAANgAAQAAAQkAARgAARgAAR0AASkCBUy8AADZAAEZAAEcAakBAAEYAaTNAADYAAEAAAEJAAEZAakRAAEYAaS9AADMAAD9AAEIAAEJAAEQAAEoAgVQvAAA7QAA+QAA/AABCAABCAABDQGlHQGoxQAA7AAA+AABAQABDAABGQABJQGlHAABHQABJAGoxAAAyQABAAABCQABFQABGAABHAGpFAABKQGkxQAAyAABAQABCAABDQABKAABMQGo+QABAAABCQABDAGkxAAA3QAA5QAA9QAA+AABAQABCAABJQABMAGo3QAA5AAA9AAA+QABAAGo2QAA3AAA3AAA5QAA+AAA+QABJAABKQGk0QAA2AAA+AABDQGoyQAA0AAA5AAA+QABCQABDAGlCAABFQGorQAAyAABDQABFAABHQABKAIFTKwAAMEAAPgAAQEAAQwAAQ0AARwAASEBqQwAARUBpMAAAMkAAPkAAQAAAQkAARQCBVDIAADdAAD4AAEIAAENAAEZAAEgAgVMwQAA3AABAQABBQABDAGk8QABAAGowAAA1QAA8AAA+QABBAABFQABGAIFTNEAANQAAPEAAPgAAQ0AARQAAT0CBUzJAADQAADwAAD5AAEJAAEMAAE8AAFFAgVQyAAA3QAA+AABCAABDQABRAABSQGlBQABDAGo3AAA5QAA/QABBAABFQABSAABUQIFTLkAAOQAAPwAAQUAARQAASkAAUkAAVABqLgAAOUAAQQAAQ0AASEAASgBpN0AAOQAAPkAAQwAASAAASkAAUgAAU0CBUzcAAD4AAENAAEZAAEhAAEoAAExAAFFAAFMAakZAAEgAAFEAAFJAaj5AAEMAAEVAAEYAAEYAAEpAAEwAAE1AAFIAaUUAAEZAajlAADxAAD4AAEYAAEhAAEoAAEtAAE0AgVM5AAA6QAA8AABIAABLAGo6AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajhAADkAADtAaTgAADlAADsAAD1AAEBAgVMyQAA5AAA9AABAAABCQABFQABJQABKAGpJAABOQGoyAAA0QABAQABCAABEQABFAABHQABOAGlCQABEAGotQAA0AAA9QABAAABCAABMQGk9AAA/QGotAAA0QAA7QAA/AABDQABEQABGQABHAABMAIFTMUAANAAAOwAAPUAAQwBqPQAATEBpMQAAM0AAP0AARgAATAAATkCBVDMAADhAAEQAAERAAEdAAE4AaT1AAD8AajgAADlAAEJAAEQAAEcAAElAaT0AAD9AajhAADkAAD1AAD8AAExAajxAAD0AaStAADgAADtAADwAAEIAAEkAAEpAAEwAajlAADsAAD1AAEBAaSsAADdAAEoAajJAADcAADkAAD5AAEAAAEJAgVMyAAA7QAA9AAA+AAA+QABCAABDQABHQGo+AABAQABCQABDAGk2QAA7AAA9QABAAABCAABCQABFQABHAIFUNgAAN0AAPQAAPkAAQgAARQAAR0BpNEAANkAANwAAPgAAQEAARkAARkAARwBqL0AANAAANgAAQAAAQkAARgAARgAAR0AASkCBUy8AADZAAEZAAEcAakBAAEYAaTNAADYAAEAAAEJAAEZAakRAAEYAaS9AADMAAD9AAEIAAEJAAEQAAEoAgVQvAAA7QAA+QAA/AABCAABCAABDQGlHQGoxQAA7AAA+AABAQABDAABGQABJQGlHAABHQABJAGoxAAAyQABAAABCQABFQABGAABHAGpFAABKQGkxQAAyAABAQABCAABDQABKAABMQGo+QABAAABCQABDAGkxAAA3QAA5QAA9QAA+AABAQABCAABJQABMAGo3QAA5AAA9AAA+QABAAGo2QAA3AAA3AAA5QAA+AAA+QABJAABKQGk0QAA2AAA+AABDQGoyQAA0AAA5AAA+QABCQABDAGlCAABFQGorQAAyAABDQABFAABHQABKAIFTKwAAMEAAPgAAQEAAQwAAQ0AARwAASEBqQwAARUBpMAAAMkAAPkAAQAAAQkAARQCBVDIAADdAAD4AAEIAAENAAEZAAEgAgVMwQAA3AABAQABBQABDAGk8QABAAGowAAA1QAA8AAA+QABBAABFQABGAIFTNEAANQAAPEAAPgAAQ0AARQAAT0CBUzJAADQAADwAAD5AAEJAAEMAAE8AAFFAgVQyAAA3QAA+AABCAABDQABRAABSQGlBQABDAGo3AAA5QAA/QABBAABFQABSAABUQIFTLkAAOQAAPwAAQUAARQAASkAAUkAAVABqLgAAOUAAQQAAQ0AASEAASgBpN0AAOQAAPkAAQwAASAAASkAAUgAAU0CBUzcAAD4AAENAAEZAAEhAAEoAAExAAFFAAFMAakZAAEgAAFEAAFJAaj5AAEMAAEVAAEYAAEYAAEpAAEwAAE1AAFIAaUUAAEZAajlAADxAAD4AAEYAAEhAAEoAAEtAAE0AgVM5AAA6QAA8AABIAABLAGo6AAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajhAADkAADtAaTgAADlAADsAAD1AAEBAgVMyQAA5AAA9AABAAABCQABFQABJQABKAGpJAABOQGoyAAA0QABAQABCAABEQABFAABHQABOAGlCQABEAGotQAA0AAA9QABAAABCAABMQGk9AAA/QGotAAA0QAA7QAA/AABDQABEQABGQABHAABMAIFTMUAANAAAOwAAPUAAQwBqPQAATEBpMQAAM0AAP0AARgAATAAATkCBVDMAADhAAEQAAERAAEdAAE4AaT1AAD8AajgAADlAAEJAAEQAAEcAAElAaT0AAD9AajhAADkAAD1AAD8AAExAajxAAD0AaStAADgAADtAADwAAEIAAEkAAEpAAEwAajlAADsAAD1AAEBAaSsAADdAAEoAajJAADcAADkAAD5AAEAAAEJAgVMyAAA7QAA9AAA+AAA+QABCAABDQABHQGo+AABAQABCQABDAGk2QAA7AAA9QABAAABCAABCQABFQABHAIFUNgAAN0AAPQAAPkAAQgAARQAAR0BpNEAANkAANwAAPgAAQEAARkAARkAARwBqL0AANAAANgAAQAAAQkAARgAARgAAR0AASkCBUy8AADZAAEZAAEcAakBAAEYAaTNAADYAAEAAAEJAAEZAakRAAEYAaS9AADMAAD9AAEIAAEJAAEQAAEoAgVQvAAA7QAA+QAA/AABCAABCAABDQGlHQGoxQAA7AAA+AABAQABDAABGQABJQGlHAABHQABJAGoxAAAyQABAAABCQABFQABGAABHAGpFAABKQGkxQAAyAABAQABCAABDQABKAABMQGo+QABAAABCQABDAGkxAAA3QAA5QAA9QAA+AABAQABCAABJQABMAGo3QAA5AAA9AAA+QABAAGo2QAA3AAA3AAA5QAA+AAA+QABJAABKQGk0QAA2AAA+AABDQGoyQAA0AAA5AAA+QABCQABDAGlCAABFQGorQAAyAABDQABFAABHQABKAIFTKwAAMEAAPgAAQEAAQwAAQ0AARwAASEBqQwAARUBpMAAAMkAAPkAAQAAAQkAARQCBVDIAADdAAD4AAEIAAENAAEZAAEgAgVMwQAA3AABAQABBQABDAGk8QABAAGowAAA1QAA8AAA+QABBAABFQABGAIFTNEAANQAAPEAAPgAAQ0AARQAAT0CBUzJAADQAADwAAD5AAEJAAEMAAE8AAFFAgVQyAAA3QAA+AABCAABDQABRAABSQGlBQABDAGo3AAA5QAA/QABBAABFQABSAABUQIFTLkAAOQAAPwAAQUAARQAASkAAUkAAVABqLgAAOUAAQQAAQ0AASEAASgBpN0AAOQAAPkAAQwAASAAASkAAUgAAU0CBUzcAAD4AAENAAEZAAEhAAEoAAExAAFFAAFMAakZAAEgAAFEAAFJAaj5AAEMAAEVAAEYAAEYAAEpAAEwAAE1AAFIAaUUAAEZAajlAADxAAD4AAEYAAEhAAEoAAEtAAE0AgVM5AAA6QAA8AABIAABLAGo6AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.85<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajdAADkAAEBAaTZAADcAADlAAEAAgVM2AAA4QAA5AABHQABJQABKAABMQGo4AAA+QABCQABFQABHAABJAGo+AABAQABCAABFAABHQABMAGk5QABFQABHAABJQIFTPkAAQkAASQCBVDkAAD4AAEIAAEUAAEdAAEpAaUAAAENAaj1AAEFAAEcAAEoAAExAaUMAAEVAaj0AAD5AAEEAAEwAAE5AajxAAExAAE4AaTdAADtAADwAAD4AAENAAEUAAEpAAEwAajsAAD1AAEoAAExAaTJAADcAADlAAEJAAEMAajkAAD0AAD5AAEwANUJAAEpANUIANEVANT4ANStAAEIAAEUAAEdANTIANSsAADtAAENAAEcAaTsAAElAAEoAai9AAEJAAEMAAEZAaUBAAEIAai8AADJAAEAAAEJAAEVAAEYAakkAhBAyAAA+QABFAABKQIFTOUAAQgAAQkAASUAASgBpN0AAOQAAPgAAQEAAQgBqNkAANwAAQAAARUAAR0AASQBqNEAANgAAQ0AARQAAT0BpMUAAMkAANAAASkAATEAATwBqMQAAMgAANkAAPkAARwAASgAASkAATAA1RUBpRQAATEA1PgA1RkA1QwAARgAAR0A0RUAARwBqTACCcjYAAEoAgR4yQABCQABFQGoyAABOQGk3QGo3AAA7QAA+QABHQABOAGlCAABFAABFAABMQGo5QAA7AAA9QAA+AABGQABHAABKQGpGAABHQABJQABKAABMAGk5AAA7QAA9AABDQABHAABHQABJAGo2QABCQABDAABFQABHAABKQGk0QAA2AAA7AABCAABDQABFAABJQABKAGpDAABFQABJAABJQGo0AAA2QAA3QABCQABDQABFAABHQABJAGlAQABCAGo2AAA2QAA3AAA+QABDAABGQABHAGlAAABDQGo9QAA+AABGAGovQAA7QAA9AAA/QABCQABDAGk2AGo7QGk7AAA9QGovAAAzQAA7AAA7QAA9AAA/AGpHQGkxQAAzAAA7AAA9QABGQABHAIFTPQAAQkAARgAAR0BqL0AAMQAAPkAAQgAAQ0BqQEAAQgAARwBpLkAALwAAPUAAPgAAQkAAQwBqLgAANEAAO0AAQAAAQ0BpMUAAMkAANAAAPQAAQgAATEBqMUAAMgAAOkAAOwAAQwBqMQAAMQAAMkAAQkAATABpMgAANEAAOgBqNAAANEAAO0AAPkAAQEAAQgAAREBpLUAANAAAPUAAPgBqLQAAL0AAOwAAO0AAPQAAQAAAQkAARABqOwAAPUAAPkAAQEAAQgBpL0AAPQAAPgAAPkAAQAAAQkAASkBqLwAANEAAO0AAPgAAQ0BpLwAANAAAOUAAOwAAPUAAQEAAQgAAQwAASUAASgBqMkAAPQAAQAAAQkAASQAASkBqMUAAMgAAQEAAQgAASgAATEBpMQAAMkBqMgAANEAAN0AAOQAAO0AAQAAAQkAATACBUzQAADcAADsAAEIAAEpAakoAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajdAADkAAEBAaTZAADcAADlAAEAAgVM2AAA4QAA5AABHQABJQABKAABMQGo4AAA+QABCQABFQABHAABJAGo+AABAQABCAABFAABHQABMAGk5QABFQABHAABJQIFTPkAAQkAASQCBVDkAAD4AAEIAAEUAAEdAAEpAaUAAAENAaj1AAEFAAEcAAEoAAExAaUMAAEVAaj0AAD5AAEEAAEwAAE5AajxAAExAAE4AaTdAADtAADwAAD4AAENAAEUAAEpAAEwAajsAAD1AAEoAAExAaTJAADcAADlAAEJAAEMAajkAAD0AAD5AAEwANUJAAEpANUIANEVANT4ANStAAEIAAEUAAEdANTIANSsAADtAAENAAEcAaTsAAElAAEoAai9AAEJAAEMAAEZAaUBAAEIAai8AADJAAEAAAEJAAEVAAEYAakkAhBAyAAA+QABFAABKQIFTOUAAQgAAQkAASUAASgBpN0AAOQAAPgAAQEAAQgBqNkAANwAAQAAARUAAR0AASQBqNEAANgAAQ0AARQAAT0BpMUAAMkAANAAASkAATEAATwBqMQAAMgAANkAAPkAARwAASgAASkAATAA1RUBpRQAATEA1PgA1RkA1QwAARgAAR0A0RUAARwBqTACCcjYAAEoAgR4yQABCQABFQGoyAABOQGk3QGo3AAA7QAA+QABHQABOAGlCAABFAABFAABMQGo5QAA7AAA9QAA+AABGQABHAABKQGpGAABHQABJQABKAABMAGk5AAA7QAA9AABDQABHAABHQABJAGo2QABCQABDAABFQABHAABKQGk0QAA2AAA7AABCAABDQABFAABJQABKAGpDAABFQABJAABJQGo0AAA2QAA3QABCQABDQABFAABHQABJAGlAQABCAGo2AAA2QAA3AAA+QABDAABGQABHAGlAAABDQGo9QAA+AABGAGovQAA7QAA9AAA/QABCQABDAGk2AGo7QGk7AAA9QGovAAAzQAA7AAA7QAA9AAA/AGpHQGkxQAAzAAA7AAA9QABGQABHAIFTPQAAQkAARgAAR0BqL0AAMQAAPkAAQgAAQ0BqQEAAQgAARwBpLkAALwAAPUAAPgAAQkAAQwBqLgAANEAAO0AAQAAAQ0BpMUAAMkAANAAAPQAAQgAATEBqMUAAMgAAOkAAOwAAQwBqMQAAMQAAMkAAQkAATABpMgAANEAAOgBqNAAANEAAO0AAPkAAQEAAQgAAREBpLUAANAAAPUAAPgBqLQAAL0AAOwAAO0AAPQAAQAAAQkAARABqOwAAPUAAPkAAQEAAQgBpL0AAPQAAPgAAPkAAQAAAQkAASkBqLwAANEAAO0AAPgAAQ0BpLwAANAAAOUAAOwAAPUAAQEAAQgAAQwAASUAASgBqMkAAPQAAQAAAQkAASQAASkBqMUAAMgAAQEAAQgAASgAATEBpMQAAMkBqMgAANEAAN0AAOQAAO0AAQAAAQkAATACBUzQAADcAADsAAEIAAEpAakoAAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaT5AAEJAAElAAEoAaj4AAEAAAEIAAEkAAEpAajdAADkAAEBAaTZAADcAADlAAEAAgVM2AAA4QAA5AABHQABJQABKAABMQGo4AAA+QABCQABFQABHAABJAGo+AABAQABCAABFAABHQABMAGk5QABFQABHAABJQIFTPkAAQkAASQCBVDkAAD4AAEIAAEUAAEdAAEpAaUAAAENAaj1AAEFAAEcAAEoAAExAaUMAAEVAaj0AAD5AAEEAAEwAAE5AajxAAExAAE4AaTdAADtAADwAAD4AAENAAEUAAEpAAEwAajsAAD1AAEoAAExAaTJAADcAADlAAEJAAEMAajkAAD0AAD5AAEwANUJAAEpANUIANEVANT4ANStAAEIAAEUAAEdANTIANSsAADtAAENAAEcAaTsAAElAAEoAai9AAEJAAEMAAEZAaUBAAEIAai8AADJAAEAAAEJAAEVAAEYAakkAhBAyAAA+QABFAABKQIFTOUAAQgAAQkAASUAASgBpN0AAOQAAPgAAQEAAQgBqNkAANwAAQAAARUAAR0AASQBqNEAANgAAQ0AARQAAT0BpMUAAMkAANAAASkAATEAATwBqMQAAMgAANkAAPkAARwAASgAASkAATAA1RUBpRQAATEA1PgA1RkA1QwAARgAAR0A0RUAARwBqTACCcjYAAEoAgR4yQABCQABFQGoyAABOQGk3QGo3AAA7QAA+QABHQABOAGlCAABFAABFAABMQGo5QAA7AAA9QAA+AABGQABHAABKQGpGAABHQABJQABKAABMAGk5AAA7QAA9AABDQABHAABHQABJAGo2QABCQABDAABFQABHAABKQGk0QAA2AAA7AABCAABDQABFAABJQABKAGpDAABFQABJAABJQGo0AAA2QAA3QABCQABDQABFAABHQABJAGlAQABCAGo2AAA2QAA3AAA+QABDAABGQABHAGlAAABDQGo9QAA+AABGAGovQAA7QAA9AAA/QABCQABDAGk2AGo7QGk7AAA9QGovAAAzQAA7AAA7QAA9AAA/AGpHQGkxQAAzAAA7AAA9QABGQABHAIFTPQAAQkAARgAAR0BqL0AAMQAAPkAAQgAAQ0BqQEAAQgAARwBpLkAALwAAPUAAPgAAQkAAQwBqLgAANEAAO0AAQAAAQ0BpMUAAMkAANAAAPQAAQgAATEBqMUAAMgAAOkAAOwAAQwBqMQAAMQAAMkAAQkAATABpMgAANEAAOgBqNAAANEAAO0AAPkAAQEAAQgAAREBpLUAANAAAPUAAPgBqLQAAL0AAOwAAO0AAPQAAQAAAQkAARABqOwAAPUAAPkAAQEAAQgBpL0AAPQAAPgAAPkAAQAAAQkAASkBqLwAANEAAO0AAPgAAQ0BpLwAANAAAOUAAOwAAPUAAQEAAQgAAQwAASUAASgBqMkAAPQAAQAAAQkAASQAASkBqMUAAMgAAQEAAQgAASgAATEBpMQAAMkBqMgAANEAAN0AAOQAAO0AAQAAAQkAATACBUzQAADcAADsAAEIAAEpAakoAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.92<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAAEpAajhAADkAADtAAD4AAEIAAEdAAEkAaTgAADlAADsAAEBAAEVAAEcAAElAaj5AAEkAaTkAAD4AAEAAAEJAAEoAakIAAElAajtAAEJAAEUAAEpAaUkAajsAAD1AAEVAAEoAgVNFAABMQIFTPQAAQgAATAAAUUBqUUBpO0AAR0AASkAAUEAAUQAAUQCBVDsAAD1AAEVAAEoAAExAAFAAAFFAaUcAAElAaj0AAD5AAEUAAEkAAEpAAEwAAE5AAFEAaVFAajtAAD4AAENAAE4AAE9AAFEAaj1AAEJAAEMAAEVAAEdAAEoAaTZAADsAAD0AAEcAAE8ANUNANUIANUMAAExANDYANTFAAEVANUUANTEAADJAAD5AAEUAAEdAaTIAADRAAD4AAENAajJAADQAAEJAAEMAAEVAAEcAAElAAEwAajFAADIAAEkAAEpAaTEAADJAAEIAAEdAAEoAajIAADtAAERAaTZAADsAAEUAajYAADlAAEBAAElAakcAaUAAAEJAAEQAakVAAEkAAEpAaThAADkAAEBAAEIAAEUAAEdAAEoAAExAakpAAEwAajgAADlAAEAAAEJAAEVAAEcAAElAAEoAgVM4QAA5AABFAABHQABJAABKQGlFQABHAGo2QAA4AABFAABGQGpEQABGAGk2AAA9QABAQABEAABFQGo0QAA7QAA9AAA+QABAAABKAABMQGk7AAA7QABCAABFAGo0AAA5QAA7AAA+AABJQABMAGoyQAA5AABHQABJAGkyAAA0QABAQABDQABHAABIQGo0AAA2QABAAABCQABDAABFQABIAABKQGk0QAA2AABAQABCAABDQABDQABFAABHQABKAGo3QAA8QABAAABAQABDAABDAABHAABIQGo0AAA8AABGQGkyQAA3AAA+QABAAABCQABGAABIAABKQGo9QAA+AGkyAAA2QAA7QAA9AABHQABKAGpFQABHAGo0QAA2AABCAABDQABFAABPQGk0AAA2QAA8QABKQABPAGo0QAA3QAA7AABDAABFQABKAGk0AAA2AAA8AABDQABFAGo3AAA7QAA+QGo3QAA8QABDAABMQGk2QAA7AAA+AGo2AAA3AABKQABMAGk5QGo3QAA5AAA7QAA8AABDQABKAABMQIFTNkAANwAAOwAAPkAAQwAARUAASkAATACBUzRAADYAAD4AAEBAAENAAEUAAEhAAEoAgVQyQAA0AAA5QAA+QABAAABDAABHQABIAGkyAAA0QAA3QAA+AGo0AAA3AAA5AAA8QABAQABDQABHAGkyQAA8AAA+QABAAABCQABDAABFQGoyAAA0QAA0QAA2QAA7QAA+AABAQABCAABDQGoyQAA0AAA0AAA5QAA7AABAAABCQABDAABFAGk2AABCAABFQGouQAA+QABDQABFAIFTMgCBUy4AADdAADlAAD1AAD4AAEBAAEMAajRAADcAADkAADlAaS1AADQAADdAADkAAD0AAD1AajkAAD0Aai0AADcAAEAAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAAEpAajhAADkAADtAAD4AAEIAAEdAAEkAaTgAADlAADsAAEBAAEVAAEcAAElAaj5AAEkAaTkAAD4AAEAAAEJAAEoAakIAAElAajtAAEJAAEUAAEpAaUkAajsAAD1AAEVAAEoAgVNFAABMQIFTPQAAQgAATAAAUUBqUUBpO0AAR0AASkAAUEAAUQAAUQCBVDsAAD1AAEVAAEoAAExAAFAAAFFAaUcAAElAaj0AAD5AAEUAAEkAAEpAAEwAAE5AAFEAaVFAajtAAD4AAENAAE4AAE9AAFEAaj1AAEJAAEMAAEVAAEdAAEoAaTZAADsAAD0AAEcAAE8ANUNANUIANUMAAExANDYANTFAAEVANUUANTEAADJAAD5AAEUAAEdAaTIAADRAAD4AAENAajJAADQAAEJAAEMAAEVAAEcAAElAAEwAajFAADIAAEkAAEpAaTEAADJAAEIAAEdAAEoAajIAADtAAERAaTZAADsAAEUAajYAADlAAEBAAElAakcAaUAAAEJAAEQAakVAAEkAAEpAaThAADkAAEBAAEIAAEUAAEdAAEoAAExAakpAAEwAajgAADlAAEAAAEJAAEVAAEcAAElAAEoAgVM4QAA5AABFAABHQABJAABKQGlFQABHAGo2QAA4AABFAABGQGpEQABGAGk2AAA9QABAQABEAABFQGo0QAA7QAA9AAA+QABAAABKAABMQGk7AAA7QABCAABFAGo0AAA5QAA7AAA+AABJQABMAGoyQAA5AABHQABJAGkyAAA0QABAQABDQABHAABIQGo0AAA2QABAAABCQABDAABFQABIAABKQGk0QAA2AABAQABCAABDQABDQABFAABHQABKAGo3QAA8QABAAABAQABDAABDAABHAABIQGo0AAA8AABGQGkyQAA3AAA+QABAAABCQABGAABIAABKQGo9QAA+AGkyAAA2QAA7QAA9AABHQABKAGpFQABHAGo0QAA2AABCAABDQABFAABPQGk0AAA2QAA8QABKQABPAGo0QAA3QAA7AABDAABFQABKAGk0AAA2AAA8AABDQABFAGo3AAA7QAA+QGo3QAA8QABDAABMQGk2QAA7AAA+AGo2AAA3AABKQABMAGk5QGo3QAA5AAA7QAA8AABDQABKAABMQIFTNkAANwAAOwAAPkAAQwAARUAASkAATACBUzRAADYAAD4AAEBAAENAAEUAAEhAAEoAgVQyQAA0AAA5QAA+QABAAABDAABHQABIAGkyAAA0QAA3QAA+AGo0AAA3AAA5AAA8QABAQABDQABHAGkyQAA8AAA+QABAAABCQABDAABFQGoyAAA0QAA0QAA2QAA7QAA+AABAQABCAABDQGoyQAA0AAA0AAA5QAA7AABAAABCQABDAABFAGk2AABCAABFQGouQAA+QABDQABFAIFTMgCBUy4AADdAADlAAD1AAD4AAEBAAEMAajRAADcAADkAADlAaS1AADQAADdAADkAAD0AAD1AajkAAD0Aai0AADcAAEAAAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAAEpAajhAADkAADtAAD4AAEIAAEdAAEkAaTgAADlAADsAAEBAAEVAAEcAAElAaj5AAEkAaTkAAD4AAEAAAEJAAEoAakIAAElAajtAAEJAAEUAAEpAaUkAajsAAD1AAEVAAEoAgVNFAABMQIFTPQAAQgAATAAAUUBqUUBpO0AAR0AASkAAUEAAUQAAUQCBVDsAAD1AAEVAAEoAAExAAFAAAFFAaUcAAElAaj0AAD5AAEUAAEkAAEpAAEwAAE5AAFEAaVFAajtAAD4AAENAAE4AAE9AAFEAaj1AAEJAAEMAAEVAAEdAAEoAaTZAADsAAD0AAEcAAE8ANUNANUIANUMAAExANDYANTFAAEVANUUANTEAADJAAD5AAEUAAEdAaTIAADRAAD4AAENAajJAADQAAEJAAEMAAEVAAEcAAElAAEwAajFAADIAAEkAAEpAaTEAADJAAEIAAEdAAEoAajIAADtAAERAaTZAADsAAEUAajYAADlAAEBAAElAakcAaUAAAEJAAEQAakVAAEkAAEpAaThAADkAAEBAAEIAAEUAAEdAAEoAAExAakpAAEwAajgAADlAAEAAAEJAAEVAAEcAAElAAEoAgVM4QAA5AABFAABHQABJAABKQGlFQABHAGo2QAA4AABFAABGQGpEQABGAGk2AAA9QABAQABEAABFQGo0QAA7QAA9AAA+QABAAABKAABMQGk7AAA7QABCAABFAGo0AAA5QAA7AAA+AABJQABMAGoyQAA5AABHQABJAGkyAAA0QABAQABDQABHAABIQGo0AAA2QABAAABCQABDAABFQABIAABKQGk0QAA2AABAQABCAABDQABDQABFAABHQABKAGo3QAA8QABAAABAQABDAABDAABHAABIQGo0AAA8AABGQGkyQAA3AAA+QABAAABCQABGAABIAABKQGo9QAA+AGkyAAA2QAA7QAA9AABHQABKAGpFQABHAGo0QAA2AABCAABDQABFAABPQGk0AAA2QAA8QABKQABPAGo0QAA3QAA7AABDAABFQABKAGk0AAA2AAA8AABDQABFAGo3AAA7QAA+QGo3QAA8QABDAABMQGk2QAA7AAA+AGo2AAA3AABKQABMAGk5QGo3QAA5AAA7QAA8AABDQABKAABMQIFTNkAANwAAOwAAPkAAQwAARUAASkAATACBUzRAADYAAD4AAEBAAENAAEUAAEhAAEoAgVQyQAA0AAA5QAA+QABAAABDAABHQABIAGkyAAA0QAA3QAA+AGo0AAA3AAA5AAA8QABAQABDQABHAGkyQAA8AAA+QABAAABCQABDAABFQGoyAAA0QAA0QAA2QAA7QAA+AABAQABCAABDQGoyQAA0AAA0AAA5QAA7AABAAABCQABDAABFAGk2AABCAABFQGouQAA+QABDQABFAIFTMgCBUy4AADdAADlAAD1AAD4AAEBAAEMAajRAADcAADkAADlAaS1AADQAADdAADkAAD0AAD1AajkAAD0Aai0AADcAAEAAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.0<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFAQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AAA+QGk2QAA9QAA+AABAQABGQABHAABJAABMAIFTNgAAO0AAPQAAQkAARgAASkCBVEVAAElAAEoAaUdAAEkAajRAADsAADtAAEAAAEIAAENAAERAAEUAAEZAAEcAgVM0AAA2QAA7AAA9QABCQABDAABEAABGAABGQIFTO0AAPQAARgAASkBqNgBpOEAAO0AASgAATEBqNEAAOAAAOwAASkAATABqNAAANkAAOwAAPUAAQgAARUAASgAASkBpMUAANgAAPQAAQEAARQBqL0AAMQAAPkAAQAAAR0AASgBpLwAAPgAARwAASkBqOUAAPUAAQEAARUBqJ0AAQkAAREAARQAASgBpOQAAQAAAQEAAQgAARAAARUBqJwAAOEAAO0AAP0AAQAAAQkAARQBpNkAAOAAAOUAAOwAAPwA1OQAAOUA1NEAANgAAOQAAO0AAPQAAREBqOwAAPUAAQUBpPQAAP0AAP0AAQQAAQgBqL0AAMUAANAAAPwAAPwAAQEAAQkBpLwAAMQAAMUAAPUAAQAAAQgAARAAARkBqMQAANkAAO0AAPQA1OwA1M0AANgAANkAAPUAARgAAR0BpMwAANEAAPQAAP0BqNAAAN0AAPUAAPwAARkAARwCBUzRAADcAADtAAD0AAERAAEYAai5AADhAAEFAaTQAADgAADsAAD1AAENAAEQAaixAAC4AADxAAD0AaSwAAC5AADpAADwAAD5AAEFAAEMAajYAAEEAgj0nQAAuAAA+AAA/QABBAABCQGk5QAA6AABBQABCAGonAAAuQAAzQAA9QAA/AABBAABCQGouAAAwQGkwAAAxQAAzAAAzQAA9AAA/QABCAABmQGowQAAxAAA/AGkuQAAwAAAzAAA6QIFULgAAL0AAOgAAO0AAP0AAZgBpOUAAOwBqKEAALwAAOQAAOQAAO0AAPwAAQUAARECBUygAACpAADFAADpAADsAAEEAAEJAAEQAaioAACxAAC9AADEAADoAADtAaSwAAC5AAC8AADFAADsAAD1AAEBAAEIAakAAAEFAaSpAAC4AADEAADpAAD0AAEEAAEJAgVQqAAAsQAA6AAA7QAA/QABCAABEQIFTLAAALkAAOkAAOwAAPkAAPwAAQkAARACBUzhAADoAADtAAD4AAEFAAEIAaj9AAEEAaTZAADgAADpAADsAAD1AAD8AAEJAajFAADYAaS9AADEAADNAADoAAEIAai8AADFAADMAAD1AAEFAai4AAC9AADEAADtAAD0AAD0AaS5AAC8AADpAADsAAD1AAD9AAEEAaj0AAEJAaSlAACxAAC4AADoAADxAAD8AAEFAAEIAajwAAD1AaidAACkAACwAADZAADtAAD0AAD9AAEEAaScAAClAADhAADsAaikAADFAADgAADpAAD1AAD8AaTRAADYAaiNAADEAADQAADoAAD0AaiMAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFAQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AAA+QGk2QAA9QAA+AABAQABGQABHAABJAABMAIFTNgAAO0AAPQAAQkAARgAASkCBVEVAAElAAEoAaUdAAEkAajRAADsAADtAAEAAAEIAAENAAERAAEUAAEZAAEcAgVM0AAA2QAA7AAA9QABCQABDAABEAABGAABGQIFTO0AAPQAARgAASkBqNgBpOEAAO0AASgAATEBqNEAAOAAAOwAASkAATABqNAAANkAAOwAAPUAAQgAARUAASgAASkBpMUAANgAAPQAAQEAARQBqL0AAMQAAPkAAQAAAR0AASgBpLwAAPgAARwAASkBqOUAAPUAAQEAARUBqJ0AAQkAAREAARQAASgBpOQAAQAAAQEAAQgAARAAARUBqJwAAOEAAO0AAP0AAQAAAQkAARQBpNkAAOAAAOUAAOwAAPwA1OQAAOUA1NEAANgAAOQAAO0AAPQAAREBqOwAAPUAAQUBpPQAAP0AAP0AAQQAAQgBqL0AAMUAANAAAPwAAPwAAQEAAQkBpLwAAMQAAMUAAPUAAQAAAQgAARAAARkBqMQAANkAAO0AAPQA1OwA1M0AANgAANkAAPUAARgAAR0BpMwAANEAAPQAAP0BqNAAAN0AAPUAAPwAARkAARwCBUzRAADcAADtAAD0AAERAAEYAai5AADhAAEFAaTQAADgAADsAAD1AAENAAEQAaixAAC4AADxAAD0AaSwAAC5AADpAADwAAD5AAEFAAEMAajYAAEEAgj0nQAAuAAA+AAA/QABBAABCQGk5QAA6AABBQABCAGonAAAuQAAzQAA9QAA/AABBAABCQGouAAAwQGkwAAAxQAAzAAAzQAA9AAA/QABCAABmQGowQAAxAAA/AGkuQAAwAAAzAAA6QIFULgAAL0AAOgAAO0AAP0AAZgBpOUAAOwBqKEAALwAAOQAAOQAAO0AAPwAAQUAARECBUygAACpAADFAADpAADsAAEEAAEJAAEQAaioAACxAAC9AADEAADoAADtAaSwAAC5AAC8AADFAADsAAD1AAEBAAEIAakAAAEFAaSpAAC4AADEAADpAAD0AAEEAAEJAgVQqAAAsQAA6AAA7QAA/QABCAABEQIFTLAAALkAAOkAAOwAAPkAAPwAAQkAARACBUzhAADoAADtAAD4AAEFAAEIAaj9AAEEAaTZAADgAADpAADsAAD1AAD8AAEJAajFAADYAaS9AADEAADNAADoAAEIAai8AADFAADMAAD1AAEFAai4AAC9AADEAADtAAD0AAD0AaS5AAC8AADpAADsAAD1AAD9AAEEAaj0AAEJAaSlAACxAAC4AADoAADxAAD8AAEFAAEIAajwAAD1AaidAACkAACwAADZAADtAAD0AAD9AAEEAaScAAClAADhAADsAaikAADFAADgAADpAAD1AAD8AaTRAADYAaiNAADEAADQAADoAAD0AaiMAAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFAQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AAA+QGk2QAA9QAA+AABAQABGQABHAABJAABMAIFTNgAAO0AAPQAAQkAARgAASkCBVEVAAElAAEoAaUdAAEkAajRAADsAADtAAEAAAEIAAENAAERAAEUAAEZAAEcAgVM0AAA2QAA7AAA9QABCQABDAABEAABGAABGQIFTO0AAPQAARgAASkBqNgBpOEAAO0AASgAATEBqNEAAOAAAOwAASkAATABqNAAANkAAOwAAPUAAQgAARUAASgAASkBpMUAANgAAPQAAQEAARQBqL0AAMQAAPkAAQAAAR0AASgBpLwAAPgAARwAASkBqOUAAPUAAQEAARUBqJ0AAQkAAREAARQAASgBpOQAAQAAAQEAAQgAARAAARUBqJwAAOEAAO0AAP0AAQAAAQkAARQBpNkAAOAAAOUAAOwAAPwA1OQAAOUA1NEAANgAAOQAAO0AAPQAAREBqOwAAPUAAQUBpPQAAP0AAP0AAQQAAQgBqL0AAMUAANAAAPwAAPwAAQEAAQkBpLwAAMQAAMUAAPUAAQAAAQgAARAAARkBqMQAANkAAO0AAPQA1OwA1M0AANgAANkAAPUAARgAAR0BpMwAANEAAPQAAP0BqNAAAN0AAPUAAPwAARkAARwCBUzRAADcAADtAAD0AAERAAEYAai5AADhAAEFAaTQAADgAADsAAD1AAENAAEQAaixAAC4AADxAAD0AaSwAAC5AADpAADwAAD5AAEFAAEMAajYAAEEAgj0nQAAuAAA+AAA/QABBAABCQGk5QAA6AABBQABCAGonAAAuQAAzQAA9QAA/AABBAABCQGouAAAwQGkwAAAxQAAzAAAzQAA9AAA/QABCAABmQGowQAAxAAA/AGkuQAAwAAAzAAA6QIFULgAAL0AAOgAAO0AAP0AAZgBpOUAAOwBqKEAALwAAOQAAOQAAO0AAPwAAQUAARECBUygAACpAADFAADpAADsAAEEAAEJAAEQAaioAACxAAC9AADEAADoAADtAaSwAAC5AAC8AADFAADsAAD1AAEBAAEIAakAAAEFAaSpAAC4AADEAADpAAD0AAEEAAEJAgVQqAAAsQAA6AAA7QAA/QABCAABEQIFTLAAALkAAOkAAOwAAPkAAPwAAQkAARACBUzhAADoAADtAAD4AAEFAAEIAaj9AAEEAaTZAADgAADpAADsAAD1AAD8AAEJAajFAADYAaS9AADEAADNAADoAAEIAai8AADFAADMAAD1AAEFAai4AAC9AADEAADtAAD0AAD0AaS5AAC8AADpAADsAAD1AAD9AAEEAaj0AAEJAaSlAACxAAC4AADoAADxAAD8AAEFAAEIAajwAAD1AaidAACkAACwAADZAADtAAD0AAD9AAEEAaScAAClAADhAADsAaikAADFAADgAADpAAD1AAD8AaTRAADYAaiNAADEAADQAADoAAD0AaiMAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.2<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AABCQABHAABJQGk1QAA9QABCAABGQABJAABJAABMAIFTNQAARgAATUAAUECBVDZAAFAAAFFAgVM2AAA4QAA9AABHQABNAIFTNEAAOAAAQ0AARkAARwAAUQAAUkCBUzQAADRAAEYAAEhAAFFAAFIAgVMwQAA0AAA8QABMQABRAGowAAA1QABDAABEQABIAGo1AAA6QAA8AABDQABEAABGQABJQABMAGlCQABDAGowQAA6AABBQABCAABDQABFQABGAABIQABJAIMmMAAAPEAAQwAASACBUzwAAEEAAEUAAExAAE9AakpAAE8AAFZAakFAAEhAAEoAAEwAAFFAaVEAAFJAAFYAaidAAEgAAElAAFIAAFJAaU5AAFIAaicAADhAAE4AAFBAakEAaTVAADgAAERAAEhAAEtAAFAANUsAAE1ANTUAADpAAElAAE0AaUFAAEgAAEkAAEkAAFJAakEAAENAAEtAAFIAajoAAD9AAEQAaTJAADxAAD8AAEZAAEsAajwAAEYAAE1AaTIAAD5AAH9AakMAAH8AAH9ANX9ANT4AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANU0AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AABCQABHAABJQGk1QAA9QABCAABGQABJAABJAABMAIFTNQAARgAATUAAUECBVDZAAFAAAFFAgVM2AAA4QAA9AABHQABNAIFTNEAAOAAAQ0AARkAARwAAUQAAUkCBUzQAADRAAEYAAEhAAFFAAFIAgVMwQAA0AAA8QABMQABRAGowAAA1QABDAABEQABIAGo1AAA6QAA8AABDQABEAABGQABJQABMAGlCQABDAGowQAA6AABBQABCAABDQABFQABGAABIQABJAIMmMAAAPEAAQwAASACBUzwAAEEAAEUAAExAAE9AakpAAE8AAFZAakFAAEhAAEoAAEwAAFFAaVEAAFJAAFYAaidAAEgAAElAAFIAAFJAaU5AAFIAaicAADhAAE4AAFBAakEAaTVAADgAAERAAEhAAEtAAFAANUsAAE1ANTUAADpAAElAAE0AaUFAAEgAAEkAAEkAAFJAakEAAENAAEtAAFIAajoAAD9AAEQAaTJAADxAAD8AAEZAAEsAajwAAEYAAE1AaTIAAD5AAH9AakMAAH8AAH9ANX9ANT4AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANU0AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/gDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAEkAAEpAaTdAAEBAajZAADcAADlAAEAAgVM2AAA3QAA5AABHQABJQABKAABMQGo3AABCQABHAABJQGk1QAA9QABCAABGQABJAABJAABMAIFTNQAARgAATUAAUECBVDZAAFAAAFFAgVM2AAA4QAA9AABHQABNAIFTNEAAOAAAQ0AARkAARwAAUQAAUkCBUzQAADRAAEYAAEhAAFFAAFIAgVMwQAA0AAA8QABMQABRAGowAAA1QABDAABEQABIAGo1AAA6QAA8AABDQABEAABGQABJQABMAGlCQABDAGowQAA6AABBQABCAABDQABFQABGAABIQABJAIMmMAAAPEAAQwAASACBUzwAAEEAAEUAAExAAE9AakpAAE8AAFZAakFAAEhAAEoAAEwAAFFAaVEAAFJAAFYAaidAAEgAAElAAFIAAFJAaU5AAFIAaicAADhAAE4AAFBAakEAaTVAADgAAERAAEhAAEtAAFAANUsAAE1ANTUAADpAAElAAE0AaUFAAEgAAEkAAEkAAFJAakEAAENAAEtAAFIAajoAAD9AAEQAaTJAADxAAD8AAEZAAEsAajwAAEYAAE1AaTIAAD5AAH9AakMAAH8AAH9ANX9ANT4AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANU0AAH8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.5<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAENAAEZAaTlAAEBAAEVAAEYAAEkAgVNAAABAQABBQABFAABFQGo5AAA6QABDAABFAGo6AAA8QABAAGk8AABJQGo1QABAQABGQDVBADQ1AAA5QABFQABJAGpFAABGAABIQIFTQ0AASAAATEBqOQAAQwAAR0AASEAATABpQAAAQ0BqN0AAO0AARwBqSAAATEBpMkAANwAAOwAAQUAASkBqPEAASgAATAAATEBpN0AAO0AAPAAAQQAAQwAAQ0BqMgAANwAAOUAAOwAAPEAAQwAARUBqN0AAOQAASkAATABpNwAAN0AAOkAAPAAAQ0AARQBqNkAANwAAOgAAQwAARUBpRQA1MkAAPkAASkA1SgA1MgAAOUAAPEAAPgAAQ0A1NgA0QEAASgBqN0AAOQAAQAAAQUAAQwAARUBqQEAARQAARUBpJ0AANwAAO0AAQAAAQQAAQkAAQkAARQBqJwAAKEAAPAAAQgAAQ0A1OUAAQwA0KAAAL0AAOQAAPkBqPgAAPkBqOwAAPUAAPgAAQgAAQ0AARkBpLwAAPQAAP0AAQEBqPwAAQAAARkBpMkAAQkAARgBqMgAANEAAO0AARgBqQwBpNAAANkAATEBqT0BpM0AANgAAN0BqMwAATAAAf0A1f0A1fwAAf0A0fwAAf0A1QgAAfwAAf0A1fwAAf0A1OwAATwAAfwAAf0A1fwAAf0A0NwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1ZkAAfwA1fwAAf0A1ZgAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwA1fwAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAENAAEZAaTlAAEBAAEVAAEYAAEkAgVNAAABAQABBQABFAABFQGo5AAA6QABDAABFAGo6AAA8QABAAGk8AABJQGo1QABAQABGQDVBADQ1AAA5QABFQABJAGpFAABGAABIQIFTQ0AASAAATEBqOQAAQwAAR0AASEAATABpQAAAQ0BqN0AAO0AARwBqSAAATEBpMkAANwAAOwAAQUAASkBqPEAASgAATAAATEBpN0AAO0AAPAAAQQAAQwAAQ0BqMgAANwAAOUAAOwAAPEAAQwAARUBqN0AAOQAASkAATABpNwAAN0AAOkAAPAAAQ0AARQBqNkAANwAAOgAAQwAARUBpRQA1MkAAPkAASkA1SgA1MgAAOUAAPEAAPgAAQ0A1NgA0QEAASgBqN0AAOQAAQAAAQUAAQwAARUBqQEAARQAARUBpJ0AANwAAO0AAQAAAQQAAQkAAQkAARQBqJwAAKEAAPAAAQgAAQ0A1OUAAQwA0KAAAL0AAOQAAPkBqPgAAPkBqOwAAPUAAPgAAQgAAQ0AARkBpLwAAPQAAP0AAQEBqPwAAQAAARkBpMkAAQkAARgBqMgAANEAAO0AARgBqQwBpNAAANkAATEBqT0BpM0AANgAAN0BqMwAATAAAf0A1f0A1fwAAf0A0fwAAf0A1QgAAfwAAf0A1fwAAf0A1OwAATwAAfwAAf0A1fwAAf0A0NwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1ZkAAfwA1fwAAf0A1ZgAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwA1fwAB/y8A sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAaj5AAEAAAEJAAElAajkAAD4AAEIAAENAAEZAaTlAAEBAAEVAAEYAAEkAgVNAAABAQABBQABFAABFQGo5AAA6QABDAABFAGo6AAA8QABAAGk8AABJQGo1QABAQABGQDVBADQ1AAA5QABFQABJAGpFAABGAABIQIFTQ0AASAAATEBqOQAAQwAAR0AASEAATABpQAAAQ0BqN0AAO0AARwBqSAAATEBpMkAANwAAOwAAQUAASkBqPEAASgAATAAATEBpN0AAO0AAPAAAQQAAQwAAQ0BqMgAANwAAOUAAOwAAPEAAQwAARUBqN0AAOQAASkAATABpNwAAN0AAOkAAPAAAQ0AARQBqNkAANwAAOgAAQwAARUBpRQA1MkAAPkAASkA1SgA1MgAAOUAAPEAAPgAAQ0A1NgA0QEAASgBqN0AAOQAAQAAAQUAAQwAARUBqQEAARQAARUBpJ0AANwAAO0AAQAAAQQAAQkAAQkAARQBqJwAAKEAAPAAAQgAAQ0A1OUAAQwA0KAAAL0AAOQAAPkBqPgAAPkBqOwAAPUAAPgAAQgAAQ0AARkBpLwAAPQAAP0AAQEBqPwAAQAAARkBpMkAAQkAARgBqMgAANEAAO0AARgBqQwBpNAAANkAATEBqT0BpM0AANgAAN0BqMwAATAAAf0A1f0A1fwAAf0A0fwAAf0A1QgAAfwAAf0A1fwAAf0A1OwAATwAAfwAAf0A1fwAAf0A0NwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1ZkAAfwA1fwAAf0A1ZgAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwA1fwAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="perplexity-score" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</h2>
<p>‚Äú<a href="https://blog.echen.me/2021/12/23/a-laymans-introduction-to-perplexity-in-nlp/">Perplexity</a>‚Äù is a common metric for language models; it comes from the field of information theory. Perplexity is often described as a measure of how ‚Äúsurprised‚Äù your model is by novel data.<br>
Operationally, it‚Äôs just the exponential of the value of the (cross-entropy) loss function ‚Äì like, ‚Ä¶yea, that‚Äôs it.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do people report perplexity scores instead of just cross-entropy loss values (since the exponential function is monotonic)? Well‚Ä¶because of custom, and because perplexity has some natural relation to entropy (but so does cross-entropy, so‚Ä¶?), and because it relates to something called the ‚Äúbranching factor‚Äù of a language‚Ä¶ But ‚Äúbecause custom‚Äù is enough.</p>
</div>
</div>
<p>So, all we‚Äôre going to do is feed the test set into our model, measure the loss, and take the exponential of that and that‚Äôs our perplexity! Lower scores are better.</p>
<div id="cell-79" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> NotesDataset(test_notes_tl, config.seq_length, len_mult<span class="op">=</span>config.batch_size, pad<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>test_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>total, batches <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, batch <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(test_dl, ncols<span class="op">=</span><span class="dv">100</span>)): </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        batches <span class="op">+=</span><span class="dv">1</span> </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> [q.to(device) <span class="cf">for</span> q <span class="kw">in</span> batch]</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        logits, loss <span class="op">=</span> model(xb, yb)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> total <span class="op">+</span> loss.cpu().item()</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>perplexity <span class="op">=</span> np.exp(total<span class="op">/</span>batches) </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"(Average) Perplexity = </span><span class="sc">{</span>perplexity<span class="sc">:5.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 229/229 [00:08&lt;00:00, 26.95it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(Average) Perplexity = 2.622</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>Interesting. That seems really low to me. Perhaps all it means is that once you‚Äôve seen a couple hundred Bach chorales, new ones aren‚Äôt very surprising! ;-)</p>
</section>
<section id="accuracy-score" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="accuracy-score"><span class="header-section-number">8.3</span> Accuracy Score</h2>
<p>How often did the model guess the ‚Äúcorrect‚Äù next note?</p>
<p><em>‚Ä¶Uh‚Ä¶ sorry folks, I ran out of time on this one. Left as an exercise. ;-)</em></p>
</section>
<section id="data-distributions" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="data-distributions"><span class="header-section-number">8.4</span> Data Distributions</h2>
<p>Let‚Äôs compare statistics of true notes from the test set vs.&nbsp;our generated notes. We‚Äôll generate a lot of data, and then compare histograms of the codebook indices:</p>
<div id="cell-83" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>redo_datadist_calc <span class="op">=</span> <span class="va">True</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> redo_datadist_calc:</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    all_test_notes <span class="op">=</span> torch.vstack([encode(t) <span class="cf">for</span> t <span class="kw">in</span> test_notes_tl]).<span class="bu">type</span>(torch.float32)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    all_test_notes <span class="op">=</span> all_test_notes[:<span class="bu">len</span>(all_test_notes)<span class="op">//</span><span class="dv">4</span>]  <span class="co"># to save time, let's not do stats on ALL-all of them, just a quarter</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generate a big batch of fake data. </span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">WARNING</span><span class="co">: this is super slow because our generator only works for batches of one, oops</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    prompt_len, max_new_tokens <span class="op">=</span> <span class="dv">12</span>, <span class="dv">54</span>          <span class="co"># I just made these numbers up. not great science yet, sorry.</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    new_notes_list <span class="op">=</span> []</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    set_seeds(<span class="dv">0</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Generating new notes..."</span>) </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, notes <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(test_notes_tl, ncols<span class="op">=</span><span class="dv">100</span>)): </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        ptoks <span class="op">=</span> encode(notes[:prompt_len]).unsqueeze(<span class="dv">0</span>).to(device)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># generate more notes, chop off prompt before adding to list of all generated notes</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>        new_notes_list.append( model.generate(ptoks, max_new_tokens<span class="op">=</span>max_new_tokens)[<span class="dv">0</span>].cpu()[prompt_len:]  )</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    all_new_notes <span class="op">=</span> torch.vstack(new_notes_list).<span class="bu">type</span>(torch.float32)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"# of test notes = </span><span class="sc">{</span><span class="bu">len</span>(all_test_notes)<span class="sc">}</span><span class="ss">,  # of generated notes = </span><span class="sc">{</span><span class="bu">len</span>(all_new_notes)<span class="sc">}</span><span class="ss"> --- Close enough!"</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [<span class="st">'pitch'</span>, <span class="st">'step'</span>, <span class="st">'duration'</span>]</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> <span class="dv">32</span> <span class="cf">if</span> i <span class="op">!=</span><span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>np.arange(<span class="dv">128</span><span class="op">//</span><span class="dv">2</span>) </span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    ax[i].hist(all_test_notes[:,i].numpy(), bins<span class="op">=</span>bins, label<span class="op">=</span><span class="st">'test indices'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    ax[i].hist(all_new_notes[:,i].numpy(),  bins<span class="op">=</span>bins, label<span class="op">=</span><span class="st">'generated indices'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(names[i])</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i<span class="op">==</span><span class="dv">2</span>: ax[i].legend()</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlabel(<span class="st">'Value'</span>)</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>: ax[i].set_ylabel(<span class="st">'Count'</span>)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generating new notes...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 77/77 [02:05&lt;00:00,  1.63s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># of test notes = 4159,  # of generated notes = 4158 --- Close enough!</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Transformers2-MusicBox_files/figure-html/cell-30-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Hey! The generated and test data distributions look pretty similar. The generated pitches have a slightly larger spread, which is consistent with what we observe in the generated examples, and may be due to the pitch-shifting in our data augmentation.</p>
</section>
</section>
<section id="summary-and-faq" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Summary and FAQ</h1>
<p>We have delved into all the parts of the ‚Äúclassic‚Äù Transformer model architecture beyond just the Attention mechanism covered in the <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">‚ÄúPart 1‚Äù</a> lesson. Transformers and the Attention mechanism itself have both received a number of significant ‚Äúupdates‚Äù over the years, and we‚Äôve seen ‚Äúchallenger‚Äù architectures appear. It may be that some new method will utterly unseat Transformers as the ‚ÄúSOTA‚Äù scheme, however Transformers will likely continue to be an important part of the ‚Äúvocabulary‚Äù of model architectures, and thus studying them as an educational exercise is rewarding.</p>
<p>Avoiding the typical example of text generation, we chose to do MIDI generation, taking our cues from the many successes of the Google Magenta team. MIDI data has some particularities that make it different from many other common data types, notably the ‚Äúfree floating‚Äù nature of the <em>timing</em> information. This proved to be a major (and unforeseen) challenge in developing the code for this lesson. In the end, we chose the relatively ‚Äúeasy‚Äù task of continuing Bach chorales ‚Äì btw, a tradition in AI-music that goes back to at least the 1970s, if not the 1950s ‚Äì and found that the results were tolerable.</p>
<p>In the section that follows below, we provide some suggestions for further study. In particular, the fact that this project involved making predictions using multiple codebooks helps it generalize to complex datatypes such as video and audio. Overall, the development of this lesson was a great opportunity for self-education by the author! Thanks for joining me.</p>
<p>Finally, an <strong>Invitation:</strong> If you have suggestions for improvements or critiques of this lesson, <em>please write to me!</em> I‚Äôm not an NLP or MIDI specialist and I want to learn more. Find me on social media as @drscotthawley and/or you can get contact info from my university page: https://hawley.belmont.edu</p>
<section id="faq" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="faq"><span class="header-section-number">9.1</span> FAQ</h2>
<p><strong>Q: Can we have a Colab with just the code from this lesson?</strong><br> A: Sure! <a href="https://colab.research.google.com/github/drscotthawley/TTTT/blob/main/notebooks/Transformers2-MusicBox-Colab.ipynb">Here it is</a>. &nbsp; <a href="https://colab.research.google.com/github/drscotthawley/TTTT/blob/main/notebooks/Transformers2-MusicBox-Colab.ipynb"> <img src="https://colab.research.google.com/assets/colab-badge.svg" alt="open with Colab" width="130px"></a><br> <br> <strong>Q: If the Transformer is predicting ‚Äúchunks‚Äù of tokens at a time, couldn‚Äôt we do faster autoregressive generation by predicting multiple tokens ahead (instead of just one at a time)?</strong> <br> A: Well, for starters, recall that our target data for ‚Äúteacher forcing‚Äù is only shifted one token ahead, so you‚Äôd need to change that first. After that,‚Ä¶you‚Äôre welcome to try it, but‚Ä¶ I don‚Äôt see people doing this much. There are probably ‚Äúgood reasons‚Äù of stability or ‚Äúthe curse of dimensionality‚Äù (so speculates Jeremy Jordan) for why this isn‚Äôt common practice.<br> <br> <strong>Q: What about the ethics of sourcing your dataset?</strong><br> A: Bach‚Äôs works are in the public domain, and these MIDI files don‚Äôt seem to taken from recorded performances, rather they seem to be taken from digitized versions of the sheet music. Tracing back through the history of papers using this dataset, even before the oft-cited 2012 work by <a href="https://arxiv.org/pdf/1206.6392.pdf">Boulanger-Lewandowski, Bengio, and Vincent</a>, I find earliest mention from Allan &amp; Williams, who don‚Äôt give us more than a mention of a URL, and there the trail ends:</p>
<blockquote cite="https://papers.nips.cc/paper_files/paper/2004/file/b628386c9b92481fab68fbf284bd6a64-Paper.pdf" class="blockquote">
<p>
We used a computer-readable edition of Bach‚Äôs chorales downloaded from <a href="ftp://i11ftp.ira.uka.de/pub/neuro/dominik/midifiles/bach.zip">ftp://i11ftp.ira.uka.de/pub/neuro/dominik/midifiles/bach.zip</a>
</p>
<footer>
‚ÄîAllan &amp; Williams, <cite><a href="https://papers.nips.cc/paper_files/paper/2004/file/b628386c9b92481fab68fbf284bd6a64-Paper.pdf">‚ÄúHarmonising chorales by probabilistic inference,‚Äù</a> NIPS 2004</cite>
</footer>
</blockquote>
</section>
</section>
<section id="sec-further" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Ideas for Further Exploration</h1>
The following are some ideas for taking this lesson further.
<details>
<summary>
Details
</summary>
<section id="change-hyperparamters-dataset" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="change-hyperparamters-dataset"><span class="header-section-number">10.1</span> Change Hyperparamters / Dataset</h2>
<p>I tried a <em>lot</em> of hyperparameter tuning already. Now it‚Äôs your turn. Maybe even trying WandB‚Äôs <a href="https://docs.wandb.ai/guides/sweeps">‚ÄúSweeps‚Äù</a>feature. Here‚Äôs a <code>config</code> suggestion <a href="https://wandb.ai/drscotthawley/musicbox-maestro-tutorial?workspace=user-drscotthawley">that I used for the MAESTRO dataset</a>:</p>
<div id="cell-88" class="cell">
<details class="code-fold">
<summary>Watch out, there‚Äôs a Monster in this code!</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LargeConfig:  <span class="co"># "Monster" size model ;-) </span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model architecture details</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    seq_length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    n_embd:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span>     </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    n_heads:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span>      </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    n_blocks:   <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>       </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    dropout:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>    </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    bias:      <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    use_alibi: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training details</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    weight_decay:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.04</span>   <span class="co"># 0.01 is pytorch default</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    epochs:          <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other handy bookkeeping</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    vocab_sizes: <span class="bu">tuple</span> <span class="op">=</span> <span class="bu">tuple</span>(vocab_sizes)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="report-individual-parts-of-the-loss" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="report-individual-parts-of-the-loss"><span class="header-section-number">10.2</span> Report Individual Parts of the Loss</h2>
<p>Currently we‚Äôre not reporting the contributions of pitch, step, and durations to the loss, separately. Doing so should be instructive! (My older codes had this, I just didn‚Äôt get around to putting it back in after a major rewrite.)</p>
</section>
<section id="improving-generation-by-implementing-beam-search" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="improving-generation-by-implementing-beam-search"><span class="header-section-number">10.3</span> Improving Generation by Implementing Beam Search</h2>
<p>Right now we‚Äôre just sampling a single token from the predicted probability distribution. If we instead predicted the most likely estimates by looking two or three steps into the future, that could greatly improve our results. Check out ‚Äú<a href="https://towardsdatascience.com/foundations-of-nlp-explained-visually-beam-search-how-it-works-1586b9849a24">beam search</a>‚Äù algorithms.</p>
</section>
<section id="using-huggingfaces-transformers-instead" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="using-huggingfaces-transformers-instead"><span class="header-section-number">10.4</span> Using Huggingface‚Äôs <code>transformers</code> instead</h2>
<p><a href="https://github.com/huggingface/transformers"><code>transformers</code></a> is a package that is optimized for general applications and would likely outperform the above code in numerous ways: parallelism, mixed-precision training, &amp; more.</p>
</section>
<section id="pitch-only-estimation" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="pitch-only-estimation"><span class="header-section-number">10.5</span> Pitch-Only Estimation</h2>
<p>The timing can be the most challenging part. If you take that out and do only pitches (i.e.&nbsp;assume all notes have the same spacing and duration), you may like what you hear.</p>
</section>
<section id="raw-audio" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="raw-audio"><span class="header-section-number">10.6</span> Raw Audio</h2>
<p>If you were to instead use raw audio, I‚Äôd recommend converting it to spectrograms, treating each column of the spectrogram as a ‚Äúword vector.‚Äù However, there‚Äôd likely be a lot of ‚Äúwasted space‚Äù so you‚Äôd probably want to (invertibly) compress the dimensionality of your ‚Äúaudio-word vectors‚Äù via something like <a href="https://drscotthawley.github.io/blog/posts/2023-06-12-RVQ.html">(Residual) Vector Quantization</a>, an <a href="https://drscotthawley.github.io/audio-algebra/given-models.html">autoencoder</a>, or <a href="https://umap-learn.readthedocs.io/en/latest/">UMAP</a>. ‚Ä¶And then you‚Äôd need to expand/decode it on the output side to be able to listen. Relatedly, a pretrained system like Meta‚Äôs <a href="https://github.com/facebookresearch/encodec">EnCodec</a> would likely provide such functions nicely.</p>
</section>
<section id="penalize-generation-of-end-of-song-padding" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="penalize-generation-of-end-of-song-padding"><span class="header-section-number">10.7</span> Penalize Generation of ‚ÄúEnd of Song‚Äù Padding?</h2>
<p>You‚Äôll notice that in some of the examples, the generated song will reach its end really quickly and then just print out repeated <code>REST_NOTE</code>s, which is my current way of denoting the end of a song. Perhaps we could penalize the model for doing that (while it‚Äôs training), so it‚Äôs less likely to quit on us too early. Either that, or we just manually lower the probability of such notes in the generator code itself.</p>
</section>
</details></section>
<section id="acknowledgements" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Acknowledgements</h1>
<ul>
<li><p>Super huge thanks to <a href="https://twitter.com/jeremyjordan">Jeremy Jordan</a> for many fruitful discussions as I developed this! Check out <a href="https://www.jeremyjordan.me/">his blog</a> for many helpful posts, esp.&nbsp;on Transformers, Attention, and many other Machine Learning topics.</p></li>
<li><p>I referred to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">Andrej Karpathy‚Äôs lesson and codes</a> frequently when my own code wasn‚Äôt working to my satisfaction (i.e.&nbsp;all the time).</p></li>
<li><p>Various papers by the Google Magenta team ‚Äì the undisputed ML-MIDI experts in my book ‚Äì were helpful in figuring out what to do. This lesson was influenced by their tutorial <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">‚ÄúGenerate Music with an RNN‚Äù</a>, which I converted PyTorch. In this lesson, code that wasn‚Äôt lifted from Karpathy was heavily influenced by the Magenta code.</p></li>
<li><p>I‚Äôm thankful to <a href="https://github.com/cifkao">Ond≈ôej C√≠fka</a> for the exchanges that led to my development of Jupyter support for the MIDI player object(s) that he built off Magenta‚Äôs work.</p></li>
<li><p>As I included in the Preface, thanks to <a href="https://twitter.com/mamodrzejewski">Mateusz Modrzejewski</a> for what I took to be a word of encouragement.</p></li>
<li><p>ChatGPT was used extensively for helping with what I‚Äôll unapologetically term ‚Äúannoying formatting bullshit‚Äù (with pandas, tqdm, CSS,‚Ä¶), but not for anything more significant.</p></li>
</ul>
</section>
<section id="appendix-feeding-it-christmas-carols" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols üéÑ</h1>
<p>This is probably a bad idea for so many reasons ‚Äì it will be <em>wayyy</em> outside the distribution of training data ‚Äì but given the time of year, I‚Äôma try it anyway.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Attribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>We‚Äôre downloading the prompt MIDI files on the fly from <a href="https://www.mfiles.co.uk/christmas-music-and-carols.htm">MFiles</a>.</p>
</div>
</div>
<!--- comment 
---
# Afterward: Stuff I Probably Should Have Looked at First


BTW, that code is a PyTorch implementation of the 2018 [Music Transformer](https://arxiv.org/abs/1809.04281) paper by Google Brain, the abstract of which includes:

> "Existing approaches for representing relative positional information
in the Transformer modulate attention based on pairwise distance (Shaw et al.,
2018). This is impractical for long sequences such as musical compositions since
their memory complexity for intermediate relative information is quadratic in the
sequence length. We propose an algorithm that reduces their intermediate memory
requirement to linear in the sequence length.
This enables us to demonstrate that a
Transformer with our modified relative attention mechanism can generate minutelong compositions (thousands of steps, four times the length modeled in Oore et al.
(2018)) with compelling structure, generate continuations that coherently elaborate
on a given motif, and in a seq2seq setup generate accompaniments conditioned on
melodies"

....but this notebook is a tutorial, so forgive me if it's 5 years behind SOTA. ;-)

[Here's a nother code for a Pytorch MIDI transformer from 2 years ago](https://github.com/spectraldoy/music-transformer)

https://medium.com/data-science-in-your-pocket/music-generation-using-musictransformer-with-codes-c7be89ba85b1

--->
<div id="cell-93" class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>xmas_css <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="st">/* Custom player style */</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="st">p { </span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 0; </span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player {</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="st">  display: block;</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="st">  width: inherit;</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 4px;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="st">  margin-bottom: 0;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #d4d4d4; /* Lighter text color for better readability */</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(control-panel) {</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="st">  background: #004400; /* green background */</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid #888; /* Lightened border color for contrast */</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 10px 10px 0 0;</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(play-button) {</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #ffffff; /* White text for visibility */</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid currentColor;</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="st">  background-color: #ff00000; </span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 20px;</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="st">  transition: all 0.2s;</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="st">  content: 'hello';</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(play-button):hover {</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #a00; </span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="st">  background-color: #9fafc9; </span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 10px;</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(time) {</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a><span class="st">  font-family: monospace; /* Monospace font for time */</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="st">/* Custom visualizer style */</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer .piano-roll-visualizer {</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a><span class="st">  background: #900; /* red background for visualizer */</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid #505050; /* Dark border for subtle appearance */</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a><span class="st">  border-top: none;</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 0 0 10px 10px;</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 4px;</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a><span class="st">  width: inherit;</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="st">  margin-top: 0;</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a><span class="st">  overflow: auto;</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note {</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="st">  opacity: 0.9; </span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke-width: 1; /* Stroke width for note clarity */</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a><span class="st">/* Different instrument colors */</span></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-instrument="0"]{</span></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #00f000; /* Green for Instrument 0 */</span></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #444; </span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-instrument="2"]{</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #008000; /* Green for Instrument 2 */</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #444;</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-is-drum="true"]{</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #008000; /* Green for drum notes */</span></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #bbb;</span></span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note.active {</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a><span class="st">  opacity: 0.9; /* Highlight active notes */</span></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #ffffff; /* White stroke for maximum contrast */</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke-width: 2; /* Thicker stroke for active notes */</span></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xmasplayer(notes_tensor, height<span class="op">=</span><span class="dv">400</span>, time_rescale<span class="op">=</span><span class="va">None</span>, midi_file<span class="op">=</span><span class="st">"/tmp/tmp.mid"</span>, title<span class="op">=</span><span class="st">''</span>, styler<span class="op">=</span>general, css<span class="op">=</span>xmas_css):</span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">"MIDIplayer that writes input tensor to temporary file"</span></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> notes_to_midi(notes_tensor, time_rescale<span class="op">=</span>time_rescale, out_file<span class="op">=</span>midi_file)</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MIDIPlayer(midi_file, height, styler<span class="op">=</span>partial(styler, css<span class="op">=</span>css), dl<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span>title)</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> christmas_ohno(filename, title<span class="op">=</span><span class="st">""</span>, time_rescale<span class="op">=</span><span class="fl">0.242</span><span class="op">/</span><span class="fl">0.2880</span>, debug<span class="op">=</span><span class="va">False</span>, seed<span class="op">=</span><span class="dv">0</span>, temperature<span class="op">=</span><span class="fl">0.9</span>):</span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://www.mfiles.co.uk/downloads/"</span><span class="op">+</span>filename</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>wget <span class="op">-</span>qq <span class="op">-</span>N {url}</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> midi_file_to_tensor(filename)</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> debug: <span class="bu">print</span>(<span class="st">"notes = "</span>,notes)</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>    notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(notes[:,<span class="dv">1</span>:]<span class="op">*</span>time_rescale, res_ms<span class="op">=</span><span class="dv">10</span>) <span class="co"># time rescale is mainly to get codebooks to agree</span></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> notes[:<span class="dv">30</span>]</span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>    prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>    set_seeds(seed)</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>new_tokens, temperature<span class="op">=</span>temperature)[<span class="dv">0</span>].cpu() )</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xmasplayer(notes,title<span class="op">=</span>title)</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>c1 <span class="op">=</span> christmas_ohno(<span class="st">"jingle-bells-keyboard.mid"</span>, title<span class="op">=</span><span class="st">"Janky Bells"</span>, seed<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>display(c1)</span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>c2 <span class="op">=</span> christmas_ohno(<span class="st">"away-in-a-manger.mid"</span>, title<span class="op">=</span><span class="st">"Away in a Mangled"</span>, time_rescale<span class="op">=</span><span class="fl">.48</span><span class="op">/</span><span class="fl">.68</span>, seed<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>display(c2)</span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>c3 <span class="op">=</span> christmas_ohno(<span class="st">"hark-the-herald-angels-sing.mid"</span>, title<span class="op">=</span><span class="st">"Arg the Herald Angels Cringe"</span>,time_rescale<span class="op">=</span><span class="fl">.48</span><span class="op">/</span><span class="fl">.616</span>, seed<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>display(c3)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Janky Bells<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFNQDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpLUAANABqLQAARUBqPAAAQABpNkAAPkCBUzYAAEUAAEpAAE9Aaj1AAD4AajhAADtAAD0AAEdAAEoAAExAAE8AgVMzQAA4AABCQABHAABMAABOQGkzAAA0QABCAABDQGoyQAA0AAA7AABIQABMQABOAIMmMgAAO0AASAAASkAATACBVDZAADsAAEoAAExAaTRAADYAajJAADQAAEhAaTBAADIAADtAAEwAajAAADsAAEMAAEgAAEpAajlAADxAAEoAAExAaTdAADkAADtAADwAajZAADcAADlAADsAAEpAAEwAaUhAAEoAajRAADYAAEdAAEgAAE9AakcAAEhAAE8AAFFAaTJAADQAADkAAD5AAEdAAEgAAE9AAFEAajIAADRAaTJAADQAADxAAD4AAEVAAEcAAE5AAE8AgycyAAA8AAA+QABFAABKQABOAABOQIFTN0AAPgAAQ0AAR0AATgBqQwAAT0BpNwAAOUAARwAASEAATEAATwBqN0AAOQBpNwAAO0AAQkAASgAASkAATABqOUAAOwAAQgAAQ0BqOQAAO0AAQkAAQwAAR0AASAAASgAASkCBU0IAAEoAAE5AaUBAAENAAEcAAEhAajsAAD5AAEAAAEMAAEVAAE4AAE5AakgAAEpAaTxAAD4AAENAAEUAAEoAAExAAE4Agj1DAGo+QABKQABMAABOQGk8AAA9QAA+AABKAABMQGo7QAA9AABKQABMAABOAABPQGkwQAA3QAA7AABHQABMQGowAAA0QAA3AABAQABHAABIQABKAABMADVIAABKQDU0AAA2QAA5QABAAABFQABIQABKAGk2AAA3QAA5AAA+QABFAABHQABPAGo3AAA5QAA+AABAQABIAABIQGk5AAA7QAA+QABAAABHAABIAABKQGo7AAA+AABOQGo3QABDQABOAABTQGk3AAA5QABIQABTAABUQGo5AAA7QABDAABDQABIAABKAABTQABUAGk7AAA8QABTAABUQGo8AAA8QAA+QABCQGo3QAA8AAA+AABCAABDAABDQABKQDQ3AAA5QABKADU5AAA7QABBQABKQABWQGpDAABHQABKAABUAGk7AAA8QAA/QABBAABHAABIQABPQABWAIR6PAAAQ0BqO0AAPwBpOwAAPEAAPkAAQkAAQwAASABqO0AAPgBpOkAAPAAAPkAAP0AAQgBqOgAAOwAAPEAAPwAARUBqN0AAPAAAPgAAPkAAQ0AARQBpQwAAR0AATwBqRUAARwBpNkAANwBqNgAAN0AAQ0AARQAAR0CBUzcAADxAAD4AAEBAAEMAAEcAAEhAaj5AAEAAAEFAaTlAADwAAEBAAEEAajVAADkAADlAADpAAD4AAD5AAEAAajkAADoAAEVAAEgAaTUAADdAADpAAD4AAENAAEUAAEZAajoAADxAAEBAAEMAAEYAAEhAaTwAAD5AAEAAAEFAAEZAAEgAajcAAEVAAEYAajpAAEEAAENAAEUAaT4AAENAajJAADxAAEBAaTIAADoAAEAAAEMAajwAgVNDAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFNQDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpLUAANABqLQAARUBqPAAAQABpNkAAPkCBUzYAAEUAAEpAAE9Aaj1AAD4AajhAADtAAD0AAEdAAEoAAExAAE8AgVMzQAA4AABCQABHAABMAABOQGkzAAA0QABCAABDQGoyQAA0AAA7AABIQABMQABOAIMmMgAAO0AASAAASkAATACBVDZAADsAAEoAAExAaTRAADYAajJAADQAAEhAaTBAADIAADtAAEwAajAAADsAAEMAAEgAAEpAajlAADxAAEoAAExAaTdAADkAADtAADwAajZAADcAADlAADsAAEpAAEwAaUhAAEoAajRAADYAAEdAAEgAAE9AakcAAEhAAE8AAFFAaTJAADQAADkAAD5AAEdAAEgAAE9AAFEAajIAADRAaTJAADQAADxAAD4AAEVAAEcAAE5AAE8AgycyAAA8AAA+QABFAABKQABOAABOQIFTN0AAPgAAQ0AAR0AATgBqQwAAT0BpNwAAOUAARwAASEAATEAATwBqN0AAOQBpNwAAO0AAQkAASgAASkAATABqOUAAOwAAQgAAQ0BqOQAAO0AAQkAAQwAAR0AASAAASgAASkCBU0IAAEoAAE5AaUBAAENAAEcAAEhAajsAAD5AAEAAAEMAAEVAAE4AAE5AakgAAEpAaTxAAD4AAENAAEUAAEoAAExAAE4Agj1DAGo+QABKQABMAABOQGk8AAA9QAA+AABKAABMQGo7QAA9AABKQABMAABOAABPQGkwQAA3QAA7AABHQABMQGowAAA0QAA3AABAQABHAABIQABKAABMADVIAABKQDU0AAA2QAA5QABAAABFQABIQABKAGk2AAA3QAA5AAA+QABFAABHQABPAGo3AAA5QAA+AABAQABIAABIQGk5AAA7QAA+QABAAABHAABIAABKQGo7AAA+AABOQGo3QABDQABOAABTQGk3AAA5QABIQABTAABUQGo5AAA7QABDAABDQABIAABKAABTQABUAGk7AAA8QABTAABUQGo8AAA8QAA+QABCQGo3QAA8AAA+AABCAABDAABDQABKQDQ3AAA5QABKADU5AAA7QABBQABKQABWQGpDAABHQABKAABUAGk7AAA8QAA/QABBAABHAABIQABPQABWAIR6PAAAQ0BqO0AAPwBpOwAAPEAAPkAAQkAAQwAASABqO0AAPgBpOkAAPAAAPkAAP0AAQgBqOgAAOwAAPEAAPwAARUBqN0AAPAAAPgAAPkAAQ0AARQBpQwAAR0AATwBqRUAARwBpNkAANwBqNgAAN0AAQ0AARQAAR0CBUzcAADxAAD4AAEBAAEMAAEcAAEhAaj5AAEAAAEFAaTlAADwAAEBAAEEAajVAADkAADlAADpAAD4AAD5AAEAAajkAADoAAEVAAEgAaTUAADdAADpAAD4AAENAAEUAAEZAajoAADxAAEBAAEMAAEYAAEhAaTwAAD5AAEAAAEFAAEZAAEgAajcAAEVAAEYAajpAAEEAAENAAEUAaT4AAENAajJAADxAAEBAaTIAADoAAEAAAEMAajwAgVNDAAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFNQDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpLUAANABqLQAARUBqPAAAQABpNkAAPkCBUzYAAEUAAEpAAE9Aaj1AAD4AajhAADtAAD0AAEdAAEoAAExAAE8AgVMzQAA4AABCQABHAABMAABOQGkzAAA0QABCAABDQGoyQAA0AAA7AABIQABMQABOAIMmMgAAO0AASAAASkAATACBVDZAADsAAEoAAExAaTRAADYAajJAADQAAEhAaTBAADIAADtAAEwAajAAADsAAEMAAEgAAEpAajlAADxAAEoAAExAaTdAADkAADtAADwAajZAADcAADlAADsAAEpAAEwAaUhAAEoAajRAADYAAEdAAEgAAE9AakcAAEhAAE8AAFFAaTJAADQAADkAAD5AAEdAAEgAAE9AAFEAajIAADRAaTJAADQAADxAAD4AAEVAAEcAAE5AAE8AgycyAAA8AAA+QABFAABKQABOAABOQIFTN0AAPgAAQ0AAR0AATgBqQwAAT0BpNwAAOUAARwAASEAATEAATwBqN0AAOQBpNwAAO0AAQkAASgAASkAATABqOUAAOwAAQgAAQ0BqOQAAO0AAQkAAQwAAR0AASAAASgAASkCBU0IAAEoAAE5AaUBAAENAAEcAAEhAajsAAD5AAEAAAEMAAEVAAE4AAE5AakgAAEpAaTxAAD4AAENAAEUAAEoAAExAAE4Agj1DAGo+QABKQABMAABOQGk8AAA9QAA+AABKAABMQGo7QAA9AABKQABMAABOAABPQGkwQAA3QAA7AABHQABMQGowAAA0QAA3AABAQABHAABIQABKAABMADVIAABKQDU0AAA2QAA5QABAAABFQABIQABKAGk2AAA3QAA5AAA+QABFAABHQABPAGo3AAA5QAA+AABAQABIAABIQGk5AAA7QAA+QABAAABHAABIAABKQGo7AAA+AABOQGo3QABDQABOAABTQGk3AAA5QABIQABTAABUQGo5AAA7QABDAABDQABIAABKAABTQABUAGk7AAA8QABTAABUQGo8AAA8QAA+QABCQGo3QAA8AAA+AABCAABDAABDQABKQDQ3AAA5QABKADU5AAA7QABBQABKQABWQGpDAABHQABKAABUAGk7AAA8QAA/QABBAABHAABIQABPQABWAIR6PAAAQ0BqO0AAPwBpOwAAPEAAPkAAQkAAQwAASABqO0AAPgBpOkAAPAAAPkAAP0AAQgBqOgAAOwAAPEAAPwAARUBqN0AAPAAAPgAAPkAAQ0AARQBpQwAAR0AATwBqRUAARwBpNkAANwBqNgAAN0AAQ0AARQAAR0CBUzcAADxAAD4AAEBAAEMAAEcAAEhAaj5AAEAAAEFAaTlAADwAAEBAAEEAajVAADkAADlAADpAAD4AAD5AAEAAajkAADoAAEVAAEgAaTUAADdAADpAAD4AAENAAEUAAEZAajoAADxAAEBAAEMAAEYAAEhAaTwAAD5AAEAAAEFAAEZAAEgAajcAAEVAAEYAajpAAEEAAENAAEUAaT4AAENAajJAADxAAEBAaTIAADoAAEAAAEMAajwAgVNDAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Away in a Mangled<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRADAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANQAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QAA1AABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpAgVMtAAAwQAAyAAA3QABAQABCAABIQABKAIFTMAAAMkAANwAAOUAAQAAAQUAASAAASkBqP0AAQQBpMgAANEAAOQAAO0AAPwAAQEAASEAASgBqP0AAQABqMkAANAAAOUAAOwAAPkAAPwAASAAASkBpSEAASgBqMUAAMgAAPgAAQEAASAAASUBpSQAATEBqMQAAMkAAQAAAQUAASkAATACBUyxAADIAAEBAAEEAAElAAEoAgVMsAAAtQAAyQAA7QAA+QABAAABBQABJAGotAAAuQAA0QABDQGoyAAA3QAA7AAA+AABBAGk0AAA5AAA+QABDAGo3AAA7QGkuAAAyQAA3QAA7AGoyAAA3AAA5QABAQGopQAA4QAA5AAA+AAA+QABAAABBQIFTKQAAK0AAN0AAOAAAPEAAPgAAQEAAQQCBUysAADBAAEAAAEBAgVMtQAAwAAA3AAA5QAA8AAA8QABAAABCQGo8AAA+QGktAAAuQAA5AAA6QAA9QAA+AABCAABDQGorQAAuAGorAAA8QAA9AAA+QGkyQAA8AAA+AAA+QGoyAAA1QAA5QAA6AAA8QAA+AABDAABFQIFTOQAAOkAAPAAARQAARkBqSUBpNQAAN0AAOgAAPkAARUAARgBqNkAASQBpNEAANwAAPEAAPgAAQ0AARQBqNgAARUBqMEAANABpMAAAQEAAQwAARQBqQAAAQ0BpL0AAPAAAPkAAQUBqPgAAPkAAQwAAR0BqLwAAMEAAPEAAPgAAQEAAQQAARUAARwBpQAAAQkBqMAAAMEAAN0AAPAAAQEAAQgAARQAARkBpMAAAMkAAQAAAQUBqMgAANEAAPEAAQQAAQ0AARgBqMkAANAAANUAANwAAPAAARUBpMEAAMgAANEAANQAAPEAAQwAAQ0AARQBqMAAAMkAANAAAPAAARkBpMEAAMgAANEAARUAARgBqNAAAN0BqMAAAMkAANUAANwAAPkAAQwBpNQAAN0BqLUAAMgAANwAAOUAAPUAAPgAAQEAARQCEeTkAADlAAD0AAD1AgVQtAABAAIFTPQAAQEAASECBUzkAAEAAAEgAAFFAalEAAFFAaTdAAD5AAEZAAE9AajcAADlAAD1AAD4AAFEAaTkAADtAAD0AAD5AAEJAAEYAAEpAAE8AgVQ3QAA7AABCAABDQIFTNwAAOkAAPEAAPgAAPkAAQEAAQwAARUAASgCBUzZAADoAADwAAD4AAD5AAEAAAEpAgVM2AAA3QAA+AABDQABFAABGQABJQABKAIFTNwAAOUAAQEAARUAARgAASEAASQCBVDkAADtAAD5AAEAAAEMAAENAAEUAAEgAAEpAaTsAAD1AAD4AAEBAaj0AAD5AAEAAAEFAAEVAAEoAaTxAAD4AAEUAAEdAajpAADwAAD5AAEEAAEFAAEMAAEcAAEhAajlAADoAADxAAEEAaTdAADkAADwAAENAajZAADcAAD4AAD5AAEMAAEVAaTdAAEgAajcAADpAAD4AAEpAajYAgjw6AABDQABKAABMQGoyQABKQABMAGpDAABFAGkyAABKAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRADAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANQAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QAA1AABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpAgVMtAAAwQAAyAAA3QABAQABCAABIQABKAIFTMAAAMkAANwAAOUAAQAAAQUAASAAASkBqP0AAQQBpMgAANEAAOQAAO0AAPwAAQEAASEAASgBqP0AAQABqMkAANAAAOUAAOwAAPkAAPwAASAAASkBpSEAASgBqMUAAMgAAPgAAQEAASAAASUBpSQAATEBqMQAAMkAAQAAAQUAASkAATACBUyxAADIAAEBAAEEAAElAAEoAgVMsAAAtQAAyQAA7QAA+QABAAABBQABJAGotAAAuQAA0QABDQGoyAAA3QAA7AAA+AABBAGk0AAA5AAA+QABDAGo3AAA7QGkuAAAyQAA3QAA7AGoyAAA3AAA5QABAQGopQAA4QAA5AAA+AAA+QABAAABBQIFTKQAAK0AAN0AAOAAAPEAAPgAAQEAAQQCBUysAADBAAEAAAEBAgVMtQAAwAAA3AAA5QAA8AAA8QABAAABCQGo8AAA+QGktAAAuQAA5AAA6QAA9QAA+AABCAABDQGorQAAuAGorAAA8QAA9AAA+QGkyQAA8AAA+AAA+QGoyAAA1QAA5QAA6AAA8QAA+AABDAABFQIFTOQAAOkAAPAAARQAARkBqSUBpNQAAN0AAOgAAPkAARUAARgBqNkAASQBpNEAANwAAPEAAPgAAQ0AARQBqNgAARUBqMEAANABpMAAAQEAAQwAARQBqQAAAQ0BpL0AAPAAAPkAAQUBqPgAAPkAAQwAAR0BqLwAAMEAAPEAAPgAAQEAAQQAARUAARwBpQAAAQkBqMAAAMEAAN0AAPAAAQEAAQgAARQAARkBpMAAAMkAAQAAAQUBqMgAANEAAPEAAQQAAQ0AARgBqMkAANAAANUAANwAAPAAARUBpMEAAMgAANEAANQAAPEAAQwAAQ0AARQBqMAAAMkAANAAAPAAARkBpMEAAMgAANEAARUAARgBqNAAAN0BqMAAAMkAANUAANwAAPkAAQwBpNQAAN0BqLUAAMgAANwAAOUAAPUAAPgAAQEAARQCEeTkAADlAAD0AAD1AgVQtAABAAIFTPQAAQEAASECBUzkAAEAAAEgAAFFAalEAAFFAaTdAAD5AAEZAAE9AajcAADlAAD1AAD4AAFEAaTkAADtAAD0AAD5AAEJAAEYAAEpAAE8AgVQ3QAA7AABCAABDQIFTNwAAOkAAPEAAPgAAPkAAQEAAQwAARUAASgCBUzZAADoAADwAAD4AAD5AAEAAAEpAgVM2AAA3QAA+AABDQABFAABGQABJQABKAIFTNwAAOUAAQEAARUAARgAASEAASQCBVDkAADtAAD5AAEAAAEMAAENAAEUAAEgAAEpAaTsAAD1AAD4AAEBAaj0AAD5AAEAAAEFAAEVAAEoAaTxAAD4AAEUAAEdAajpAADwAAD5AAEEAAEFAAEMAAEcAAEhAajlAADoAADxAAEEAaTdAADkAADwAAENAajZAADcAAD4AAD5AAEMAAEVAaTdAAEgAajcAADpAAD4AAEpAajYAgjw6AABDQABKAABMQGoyQABKQABMAGpDAABFAGkyAABKAAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRADAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANQAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QAA1AABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpAgVMtAAAwQAAyAAA3QABAQABCAABIQABKAIFTMAAAMkAANwAAOUAAQAAAQUAASAAASkBqP0AAQQBpMgAANEAAOQAAO0AAPwAAQEAASEAASgBqP0AAQABqMkAANAAAOUAAOwAAPkAAPwAASAAASkBpSEAASgBqMUAAMgAAPgAAQEAASAAASUBpSQAATEBqMQAAMkAAQAAAQUAASkAATACBUyxAADIAAEBAAEEAAElAAEoAgVMsAAAtQAAyQAA7QAA+QABAAABBQABJAGotAAAuQAA0QABDQGoyAAA3QAA7AAA+AABBAGk0AAA5AAA+QABDAGo3AAA7QGkuAAAyQAA3QAA7AGoyAAA3AAA5QABAQGopQAA4QAA5AAA+AAA+QABAAABBQIFTKQAAK0AAN0AAOAAAPEAAPgAAQEAAQQCBUysAADBAAEAAAEBAgVMtQAAwAAA3AAA5QAA8AAA8QABAAABCQGo8AAA+QGktAAAuQAA5AAA6QAA9QAA+AABCAABDQGorQAAuAGorAAA8QAA9AAA+QGkyQAA8AAA+AAA+QGoyAAA1QAA5QAA6AAA8QAA+AABDAABFQIFTOQAAOkAAPAAARQAARkBqSUBpNQAAN0AAOgAAPkAARUAARgBqNkAASQBpNEAANwAAPEAAPgAAQ0AARQBqNgAARUBqMEAANABpMAAAQEAAQwAARQBqQAAAQ0BpL0AAPAAAPkAAQUBqPgAAPkAAQwAAR0BqLwAAMEAAPEAAPgAAQEAAQQAARUAARwBpQAAAQkBqMAAAMEAAN0AAPAAAQEAAQgAARQAARkBpMAAAMkAAQAAAQUBqMgAANEAAPEAAQQAAQ0AARgBqMkAANAAANUAANwAAPAAARUBpMEAAMgAANEAANQAAPEAAQwAAQ0AARQBqMAAAMkAANAAAPAAARkBpMEAAMgAANEAARUAARgBqNAAAN0BqMAAAMkAANUAANwAAPkAAQwBpNQAAN0BqLUAAMgAANwAAOUAAPUAAPgAAQEAARQCEeTkAADlAAD0AAD1AgVQtAABAAIFTPQAAQEAASECBUzkAAEAAAEgAAFFAalEAAFFAaTdAAD5AAEZAAE9AajcAADlAAD1AAD4AAFEAaTkAADtAAD0AAD5AAEJAAEYAAEpAAE8AgVQ3QAA7AABCAABDQIFTNwAAOkAAPEAAPgAAPkAAQEAAQwAARUAASgCBUzZAADoAADwAAD4AAD5AAEAAAEpAgVM2AAA3QAA+AABDQABFAABGQABJQABKAIFTNwAAOUAAQEAARUAARgAASEAASQCBVDkAADtAAD5AAEAAAEMAAENAAEUAAEgAAEpAaTsAAD1AAD4AAEBAaj0AAD5AAEAAAEFAAEVAAEoAaTxAAD4AAEUAAEdAajpAADwAAD5AAEEAAEFAAEMAAEcAAEhAajlAADoAADxAAEEAaTdAADkAADwAAENAajZAADcAAD4AAD5AAEMAAEVAaTdAAEgAajcAADpAAD4AAEpAajYAgjw6AABDQABKAABMQGoyQABKQABMAGpDAABFAGkyAABKAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section137 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section137 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section137 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section137 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section137 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section137 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section137 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section137 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section137 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section137 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section137 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section137&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Arg the Herald Angels Cringe<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AADAAADVAADwAAD9AAEAAAEFAAEMAgVMtAAAuQAA1AAA6QAA+QAA/AGkuAAAwQGowAAAyQIFTMgAAM0AAOkAAPEAAPgCBUy1AADMAADVAADoAADoAgVQtAAAuQAAwQAA1AAA6QAA+QAA/QIFTLUAALgAAMAAANUAAOgAAPAAAPEAAPgAAPwAAQQAAQUCBUy0AAC5AADpAADwAAD5AAEEAajUAADdAADoAADxAaS4AADBAADNAADVAADcAADlAAD4AajUAADdAADwAaS5AADAAADJAADMAADkAADpAajcAajVAADoAAEFAaS4AADBAADIAADNAajAAADJAADMAADUAADpAaTlAADoAajBAADIAADdAADkAAEBAai5AADAAaS1AAC4AAC5AADVAADcAADxAAD5AAEAAaitAAC0AADxAAD4AaSlAACsAAC4AADBAADlAADwAADwAgVQmQAApAAAwAAAyQAA1AABBAABBQGkwQAAyAGomAAArQAAuQAAwAAA3QAA5AABBAABDQGkuAAAwQDUwAAAzQDUrAAAsQAAwQAAzAAA3AAA8QAA/QABDAGowAAAyQGksAAAwQAAyAAAzQAA/AABEQGo6QAA8AGkrQAAwAABDQABEAIFUOgCBUylAACsAADMAADlAADxAAEFAAEMAaShAACkAaiZAACgAADwAAD5AAEEAAENAaiYAAChAaSgAAClAADkAADpAAEFAAEMAaihAACkAaSZAACgAADoAAEEAAEFAAENAaj9AAEEAAEFAAEMAaiYAACxAADtAAD4AAD5AAD8AAEEAAENAaTdAADsAaiZAACwAADZAADcAAEMAAEVAaTxAAD4AaiYAACtAADYAADdAADtAAD5AAEUAajVAADcAADwAaTUAADxAAD4AakBAaSsAADdAAD5AAEAAgVQ0QAA1QAA3AAA5QAA7AAA8AAA8QAA+AIFTNAAANQAAN0BpOQAAOkBqNwAAPAAAPkBqMUAANUAAOgAAPEAAPgAAREBpO0AAPABqMQAAMkAANQAAOUAAOwAAP0AAQkAARABpN0AAOQAAPkAAPwAAQgAAQ0BqMEAAMgAANwAAOUAAPEAAPgAAQwAARUBqN0AAOQAAPAAAQEAARQBpNwAAOkAAQAAAQUAASkBqOUAAOgAAOkAASEAASgBpMAAAN0AAOQAAOgBqNwAAPEBqPAAAP0AAQQAASABpPwAAQ0BqOkAAPkAAQUBpQwAARkBqNEAAOgAAPEAAPgAAQQAAQ0BqRgAASEBpNAAANUAAQUAAQwAARUAASABqO0AAPAAAPEAAPkAARQBpNQAAOUAAOwAAPAAAPEAAPgBqN0AAOQAAOkAAPAAAQ0BqMkAAM0AANwAAOgAAPEAAPkAAQQBpMgAAMkAAMwAANkAAPAAAQwAARUBqMEAAMgAANgAAN0AAPgAAP0BpMAAAMkAANkAAPkAAPwBqMEAAMgAANgAAPgAAQEAARQBqMAAAMkAAPkAAQAAAQUBpOEBqMEAAMgAANwAAPgAAQEAAQQBpN0AAOABqMAAANwAAQAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AADAAADVAADwAAD9AAEAAAEFAAEMAgVMtAAAuQAA1AAA6QAA+QAA/AGkuAAAwQGowAAAyQIFTMgAAM0AAOkAAPEAAPgCBUy1AADMAADVAADoAADoAgVQtAAAuQAAwQAA1AAA6QAA+QAA/QIFTLUAALgAAMAAANUAAOgAAPAAAPEAAPgAAPwAAQQAAQUCBUy0AAC5AADpAADwAAD5AAEEAajUAADdAADoAADxAaS4AADBAADNAADVAADcAADlAAD4AajUAADdAADwAaS5AADAAADJAADMAADkAADpAajcAajVAADoAAEFAaS4AADBAADIAADNAajAAADJAADMAADUAADpAaTlAADoAajBAADIAADdAADkAAEBAai5AADAAaS1AAC4AAC5AADVAADcAADxAAD5AAEAAaitAAC0AADxAAD4AaSlAACsAAC4AADBAADlAADwAADwAgVQmQAApAAAwAAAyQAA1AABBAABBQGkwQAAyAGomAAArQAAuQAAwAAA3QAA5AABBAABDQGkuAAAwQDUwAAAzQDUrAAAsQAAwQAAzAAA3AAA8QAA/QABDAGowAAAyQGksAAAwQAAyAAAzQAA/AABEQGo6QAA8AGkrQAAwAABDQABEAIFUOgCBUylAACsAADMAADlAADxAAEFAAEMAaShAACkAaiZAACgAADwAAD5AAEEAAENAaiYAAChAaSgAAClAADkAADpAAEFAAEMAaihAACkAaSZAACgAADoAAEEAAEFAAENAaj9AAEEAAEFAAEMAaiYAACxAADtAAD4AAD5AAD8AAEEAAENAaTdAADsAaiZAACwAADZAADcAAEMAAEVAaTxAAD4AaiYAACtAADYAADdAADtAAD5AAEUAajVAADcAADwAaTUAADxAAD4AakBAaSsAADdAAD5AAEAAgVQ0QAA1QAA3AAA5QAA7AAA8AAA8QAA+AIFTNAAANQAAN0BpOQAAOkBqNwAAPAAAPkBqMUAANUAAOgAAPEAAPgAAREBpO0AAPABqMQAAMkAANQAAOUAAOwAAP0AAQkAARABpN0AAOQAAPkAAPwAAQgAAQ0BqMEAAMgAANwAAOUAAPEAAPgAAQwAARUBqN0AAOQAAPAAAQEAARQBpNwAAOkAAQAAAQUAASkBqOUAAOgAAOkAASEAASgBpMAAAN0AAOQAAOgBqNwAAPEBqPAAAP0AAQQAASABpPwAAQ0BqOkAAPkAAQUBpQwAARkBqNEAAOgAAPEAAPgAAQQAAQ0BqRgAASEBpNAAANUAAQUAAQwAARUAASABqO0AAPAAAPEAAPkAARQBpNQAAOUAAOwAAPAAAPEAAPgBqN0AAOQAAOkAAPAAAQ0BqMkAAM0AANwAAOgAAPEAAPkAAQQBpMgAAMkAAMwAANkAAPAAAQwAARUBqMEAAMgAANgAAN0AAPgAAP0BpMAAAMkAANkAAPkAAPwBqMEAAMgAANgAAPgAAQEAARQBqMAAAMkAAPkAAQAAAQUBpOEBqMEAAMgAANwAAPgAAQEAAQQBpN0AAOABqMAAANwAAQAAB/y8A sound-font visualizer=&quot;#section137 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AADAAADVAADwAAD9AAEAAAEFAAEMAgVMtAAAuQAA1AAA6QAA+QAA/AGkuAAAwQGowAAAyQIFTMgAAM0AAOkAAPEAAPgCBUy1AADMAADVAADoAADoAgVQtAAAuQAAwQAA1AAA6QAA+QAA/QIFTLUAALgAAMAAANUAAOgAAPAAAPEAAPgAAPwAAQQAAQUCBUy0AAC5AADpAADwAAD5AAEEAajUAADdAADoAADxAaS4AADBAADNAADVAADcAADlAAD4AajUAADdAADwAaS5AADAAADJAADMAADkAADpAajcAajVAADoAAEFAaS4AADBAADIAADNAajAAADJAADMAADUAADpAaTlAADoAajBAADIAADdAADkAAEBAai5AADAAaS1AAC4AAC5AADVAADcAADxAAD5AAEAAaitAAC0AADxAAD4AaSlAACsAAC4AADBAADlAADwAADwAgVQmQAApAAAwAAAyQAA1AABBAABBQGkwQAAyAGomAAArQAAuQAAwAAA3QAA5AABBAABDQGkuAAAwQDUwAAAzQDUrAAAsQAAwQAAzAAA3AAA8QAA/QABDAGowAAAyQGksAAAwQAAyAAAzQAA/AABEQGo6QAA8AGkrQAAwAABDQABEAIFUOgCBUylAACsAADMAADlAADxAAEFAAEMAaShAACkAaiZAACgAADwAAD5AAEEAAENAaiYAAChAaSgAAClAADkAADpAAEFAAEMAaihAACkAaSZAACgAADoAAEEAAEFAAENAaj9AAEEAAEFAAEMAaiYAACxAADtAAD4AAD5AAD8AAEEAAENAaTdAADsAaiZAACwAADZAADcAAEMAAEVAaTxAAD4AaiYAACtAADYAADdAADtAAD5AAEUAajVAADcAADwAaTUAADxAAD4AakBAaSsAADdAAD5AAEAAgVQ0QAA1QAA3AAA5QAA7AAA8AAA8QAA+AIFTNAAANQAAN0BpOQAAOkBqNwAAPAAAPkBqMUAANUAAOgAAPEAAPgAAREBpO0AAPABqMQAAMkAANQAAOUAAOwAAP0AAQkAARABpN0AAOQAAPkAAPwAAQgAAQ0BqMEAAMgAANwAAOUAAPEAAPgAAQwAARUBqN0AAOQAAPAAAQEAARQBpNwAAOkAAQAAAQUAASkBqOUAAOgAAOkAASEAASgBpMAAAN0AAOQAAOgBqNwAAPEBqPAAAP0AAQQAASABpPwAAQ0BqOkAAPkAAQUBpQwAARkBqNEAAOgAAPEAAPgAAQQAAQ0BqRgAASEBpNAAANUAAQUAAQwAARUAASABqO0AAPAAAPEAAPkAARQBpNQAAOUAAOwAAPAAAPEAAPgBqN0AAOQAAOkAAPAAAQ0BqMkAAM0AANwAAOgAAPEAAPkAAQQBpMgAAMkAAMwAANkAAPAAAQwAARUBqMEAAMgAANgAAN0AAPgAAP0BpMAAAMkAANkAAPkAAPwBqMEAAMgAANgAAPgAAQEAARQBqMAAAMkAAPkAAQAAAQUBpOEBqMEAAMgAANwAAPgAAQEAAQQBpN0AAOABqMAAANwAAQAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>‚Ä¶yea, not sure what that accomplished, but it was fun to try!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more holiday-themed Machine Learning instruction, check out <a href="https://hedges.belmont.edu/~shawley/naughty/">‚ÄúüéÖ Naughty by Numbers: Classifications at Christmas‚Äù</a>!</p>
</div>
</div>
<center>
My official December faculty photo:<br> <strong>‚ÄúHappy Holidays from Dr.&nbsp;Hawley and Wedge the Destroyer‚Äù</strong><br> <img src="images/hawley_wedge.jpeg" width="300px">
</center>
<hr>
<p>Copyright (c) 2023, Scott H. Hawley. Code is MIT-licensed, text is licensed CC-BY-NC 4.0.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/drscotthawley\.github\.io\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>