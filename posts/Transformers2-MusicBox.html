<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Scott H. Hawley">
<meta name="dcterms.date" content="2023-12-14">
<meta name="description" content="Toy Transformer Tunes">

<title>blog - Understanding Transformers, Part 2: Wee Music Box</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
details > summary {
    color: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="blog - Understanding Transformers, Part 2: Wee Music Box">
<meta name="twitter:description" content="Toy Transformer Tunes">
<meta name="twitter:image" content="https://drscotthawley.github.io/blog/posts/images/musicbox_prime.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/drscotthawley" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/drscotthawley" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Understanding Transformers, Part 2: Wee Music Box</h1>
                  <div>
        <div class="description">
          Toy Transformer Tunes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">nlp</div>
                <div class="quarto-category">architectures</div>
                <div class="quarto-category">transformers</div>
                <div class="quarto-category">music</div>
                <div class="quarto-category">midi</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Scott H. Hawley </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 14, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preface" id="toc-preface" class="nav-link active" data-scroll-target="#preface"><span class="header-section-number">1</span> Preface</a>
  <ul class="collapse">
  <li><a href="#managing-expectations" id="toc-managing-expectations" class="nav-link" data-scroll-target="#managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</a></li>
  </ul></li>
  <li><a href="#intuiting-the-rest-of-the-transformer" id="toc-intuiting-the-rest-of-the-transformer" class="nav-link" data-scroll-target="#intuiting-the-rest-of-the-transformer"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</a>
  <ul class="collapse">
  <li><a href="#the-cost-of-attention" id="toc-the-cost-of-attention" class="nav-link" data-scroll-target="#the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</a></li>
  <li><a href="#positional-encoding-aka-positional-embeddings" id="toc-positional-encoding-aka-positional-embeddings" class="nav-link" data-scroll-target="#positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</a>
  <ul class="collapse">
  <li><a href="#some-options-for-pes" id="toc-some-options-for-pes" class="nav-link" data-scroll-target="#some-options-for-pes"><span class="header-section-number">2.2.1</span> Some Options for PEs</a></li>
  <li><a href="#pes-to-add-or-concatenate" id="toc-pes-to-add-or-concatenate" class="nav-link" data-scroll-target="#pes-to-add-or-concatenate"><span class="header-section-number">2.2.2</span> PEs: To Add or Concatenate?</a></li>
  </ul></li>
  <li><a href="#residual-connections" id="toc-residual-connections" class="nav-link" data-scroll-target="#residual-connections"><span class="header-section-number">2.3</span> Residual Connections</a></li>
  <li><a href="#multi-head-attention" id="toc-multi-head-attention" class="nav-link" data-scroll-target="#multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</a></li>
  <li><a href="#layer-normalization" id="toc-layer-normalization" class="nav-link" data-scroll-target="#layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</a></li>
  <li><a href="#stacking-blocks-embeddings-of-embeddingsof-embeddings" id="toc-stacking-blocks-embeddings-of-embeddingsof-embeddings" class="nav-link" data-scroll-target="#stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings…of Embeddings</a></li>
  </ul></li>
  <li><a href="#the-music-midi-dataset" id="toc-the-music-midi-dataset" class="nav-link" data-scroll-target="#the-music-midi-dataset"><span class="header-section-number">3</span> The Music (MIDI) Dataset</a>
  <ul class="collapse">
  <li><a href="#learning-about-midi-data" id="toc-learning-about-midi-data" class="nav-link" data-scroll-target="#learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</a></li>
  <li><a href="#install-and-import" id="toc-install-and-import" class="nav-link" data-scroll-target="#install-and-import"><span class="header-section-number">3.2</span> Install and Import</a></li>
  <li><a href="#download-and-inspect-the-data" id="toc-download-and-inspect-the-data" class="nav-link" data-scroll-target="#download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</a></li>
  <li><a href="#making-a-tokenizer" id="toc-making-a-tokenizer" class="nav-link" data-scroll-target="#making-a-tokenizer"><span class="header-section-number">3.4</span> Making a Tokenizer</a>
  <ul class="collapse">
  <li><a href="#more-checks" id="toc-more-checks" class="nav-link" data-scroll-target="#more-checks"><span class="header-section-number">3.4.1</span> More Checks:</a></li>
  </ul></li>
  <li><a href="#making-pytorch-datasets" id="toc-making-pytorch-datasets" class="nav-link" data-scroll-target="#making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</a>
  <ul class="collapse">
  <li><a href="#data-augmentation" id="toc-data-augmentation" class="nav-link" data-scroll-target="#data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</a></li>
  <li><a href="#dataset-object-definition" id="toc-dataset-object-definition" class="nav-link" data-scroll-target="#dataset-object-definition"><span class="header-section-number">3.5.2</span> Dataset Object Definition</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#hyperparameters-model-configuration" id="toc-hyperparameters-model-configuration" class="nav-link" data-scroll-target="#hyperparameters-model-configuration"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</a></li>
  <li><a href="#transformer-model-code" id="toc-transformer-model-code" class="nav-link" data-scroll-target="#transformer-model-code"><span class="header-section-number">5</span> Transformer Model Code</a></li>
  <li><a href="#preliminaries-before-training" id="toc-preliminaries-before-training" class="nav-link" data-scroll-target="#preliminaries-before-training"><span class="header-section-number">6</span> Preliminaries before Training</a>
  <ul class="collapse">
  <li><a href="#set-up-the-gpucpu-device" id="toc-set-up-the-gpucpu-device" class="nav-link" data-scroll-target="#set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></a></li>
  <li><a href="#prompt-for-demos" id="toc-prompt-for-demos" class="nav-link" data-scroll-target="#prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</a></li>
  <li><a href="#re-init-things" id="toc-re-init-things" class="nav-link" data-scroll-target="#re-init-things"><span class="header-section-number">6.3</span> (Re-)Init Things</a></li>
  </ul></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model"><span class="header-section-number">7</span> Train the Model</a>
  <ul class="collapse">
  <li><a href="#optional-setup-wandb-run-tracking" id="toc-optional-setup-wandb-run-tracking" class="nav-link" data-scroll-target="#optional-setup-wandb-run-tracking"><span class="header-section-number">7.1</span> Optional: Setup WandB Run Tracking</a></li>
  <li><a href="#training-loop-go" id="toc-training-loop-go" class="nav-link" data-scroll-target="#training-loop-go"><span class="header-section-number">7.2</span> Training Loop: Go!</a></li>
  </ul></li>
  <li><a href="#evaluate-the-model" id="toc-evaluate-the-model" class="nav-link" data-scroll-target="#evaluate-the-model"><span class="header-section-number">8</span> Evaluate the Model</a>
  <ul class="collapse">
  <li><a href="#sample-generations" id="toc-sample-generations" class="nav-link" data-scroll-target="#sample-generations"><span class="header-section-number">8.1</span> Sample Generations</a></li>
  <li><a href="#perplexity-score" id="toc-perplexity-score" class="nav-link" data-scroll-target="#perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</a></li>
  <li><a href="#accuracy-score" id="toc-accuracy-score" class="nav-link" data-scroll-target="#accuracy-score"><span class="header-section-number">8.3</span> Accuracy Score</a></li>
  <li><a href="#data-distributions" id="toc-data-distributions" class="nav-link" data-scroll-target="#data-distributions"><span class="header-section-number">8.4</span> Data Distributions</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9</span> Summary</a></li>
  <li><a href="#sec-further" id="toc-sec-further" class="nav-link" data-scroll-target="#sec-further"><span class="header-section-number">10</span> Ideas for Further Exploration</a>
  <ul class="collapse">
  <li><a href="#change-hyperparamters-dataset" id="toc-change-hyperparamters-dataset" class="nav-link" data-scroll-target="#change-hyperparamters-dataset"><span class="header-section-number">10.1</span> Change Hyperparamters / Dataset</a></li>
  <li><a href="#report-individual-parts-of-the-loss" id="toc-report-individual-parts-of-the-loss" class="nav-link" data-scroll-target="#report-individual-parts-of-the-loss"><span class="header-section-number">10.2</span> Report Individual Parts of the Loss</a></li>
  <li><a href="#improving-generation-by-implementing-beam-search" id="toc-improving-generation-by-implementing-beam-search" class="nav-link" data-scroll-target="#improving-generation-by-implementing-beam-search"><span class="header-section-number">10.3</span> Improving Generation by Implementing Beam Search</a></li>
  <li><a href="#using-huggingfaces-transformers-instead" id="toc-using-huggingfaces-transformers-instead" class="nav-link" data-scroll-target="#using-huggingfaces-transformers-instead"><span class="header-section-number">10.4</span> Using Huggingface’s <code>transformers</code> instead</a></li>
  <li><a href="#pitch-only-estimation" id="toc-pitch-only-estimation" class="nav-link" data-scroll-target="#pitch-only-estimation"><span class="header-section-number">10.5</span> Pitch-Only Estimation</a></li>
  <li><a href="#raw-audio" id="toc-raw-audio" class="nav-link" data-scroll-target="#raw-audio"><span class="header-section-number">10.6</span> Raw Audio</a></li>
  </ul></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements"><span class="header-section-number">11</span> Acknowledgements</a></li>
  <li><a href="#appendix-feeding-it-christmas-carols" id="toc-appendix-feeding-it-christmas-carols" class="nav-link" data-scroll-target="#appendix-feeding-it-christmas-carols"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols 🎄</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/musicbox_prime.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Musicbox-Transformer image, via Stable Diffusion XL</figcaption>
</figure>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<style>
details > summary {
    color: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
</div>
</div>
<section id="preface" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Preface</h1>
<p>This is a follow-up to an earlier lesson, <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">“To Understand Transformers, Focus on Attention”</a>. In this lesson, we’ll fill the “blanks” we left in the Transformer architecture last time, and go on to build a working example.</p>
<p>For that example, let’s do something different from the many other online lessons about working with text &amp; Natural Language Processing (NLP): Let’s make a “Generative Music Transformer.” To keep things “small,” we’ll work in terms of MIDI instead of raw audio. For ideas about trying raw audio, see “Further Study” in <a href="#sec-further">Section&nbsp;10</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The goal of this exercise is building <em>some understanding</em>, not building a killer MIDI-generating app. If you want the latter, check out <a href="https://magenta.tensorflow.org/music-transformer">Google Magenta’s paper</a> from 2018, or various extensions since then. If you just want to play around with a great MIDI model, check out <a href="https://huggingface.co/spaces/skytnt/midi-composer">SkyTNT’s HuggingFace Space</a>. By “some” understanding, I also mean that we’re going to largely ignore the many, many variants and improvements on Transformers made over the past several years – lately <a href="https://arxiv.org/abs/2312.00752">“Mamba”</a> is generating consierable buzz. I find that <a href="https://twitter.com/rasbt">Sebastian Raschka</a>’s posts to be helpful for considering major updates on the Transformer “theme”.</p>
</div>
</div>
<section id="managing-expectations" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</h2>
<p>What we’ll end up with is something akin to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">producing garbled Shakespeare</a>, except it’s going to be musical. Garbled music seems much harder to tolerate than garbled Shakespeare, which is why I have delayed releasing this lesson for <em>multiple months</em> – I’ve kept trying to get better results. At this point, I’m resigned to the fact that <em>this is a hard problem</em> (even for MIDI!), and my current outputs are about “as good as they’re going to get”:</p>
<blockquote class="twitter-tweet tw-align-center blockquote">
<p lang="en" dir="ltr">
It's way harder to train a simple MIDI transformer to sound OK than a next-character GPT-type transformer to create text that makes at least basic sense. MIDI tokenizer choice is a big deal here also.
</p>
— Mateusz Modrzejewski (@mamodrzejewski) <a href="https://twitter.com/mamodrzejewski/status/1728858756736557451?ref_src=twsrc%5Etfw">November 26, 2023</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>…and we’re going to keep the tokenizer simple.</p>
<p>– <a href="https://hedges.belmont.edu">Scott H. Hawley</a>, December 2023</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In what follows, I’ve often put sections and subsections in expandable “Details” blocks, to enable readers to pick and choose the level of depth they want to see. Enjoy!</p>
</div>
</div>
<hr>
</section>
</section>
<section id="intuiting-the-rest-of-the-transformer" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</h1>
<p>The <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">previous lesson</a> left some things out. In this section, we’ll build some intuitive understanding of these other components, and a bit of code.</p>
<p>Below is a picture of the original Transformer model diagram, whose parts we will elucide as we go on. It’s set up like the traditional <a href="https://tex.stackexchange.com/questions/374926/drawing-an-encoder-decoder-architecture-in-tikz">“encoder-decoder” architecture</a> one often sees in the form of an <a href="images/EncoderDecoder_feedback_large.png">“hourglass shape”</a>, although it may not be obvious from the Transformer diagram:</p>
<style>
.img1 {
    /*transform-origin: top left;*/
    width:450px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img1:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-trans-diag" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/TransformerSchematic_labeled.png" class="img1 img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;1<strong>.</strong> (Mouse-over or press to expand.) Original Transformer architecture illustration, blue and red annotations added by me. The “Encoder side” in red is often used for generating embeddings for analysis-based workflows such as classification tasks; one of which of the most famous ‘encoder-only’ models was BERT (which stood Bidirectional Encoder Representations from Transformers).</figcaption>
</figure>
</div>
<p>For langauge translation tasks, both the Encoder and Decoder (circled in blue) are used. For purely “generative” systems like the GPT variants and what we’ll do today, we’ll use the Decoder side. Note however that even the Decoder can involve some encoding, as we combine an embedding of the words / MIDI / “tokens” with Positional Encoding information. PE is discussed below.</p>
<p>We’re going to go through the various components that make up the above diagram. But first, let’s point out something about the Attention mechanism that we skipped over in the previous less, namely the computational “cost” associated with making every part of a sequence with every other part.</p>
<section id="the-cost-of-attention" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</h2>
<p>The attention mechanism <em>per se</em> that we covered in the previous post has a serious drawback: the computational cost scales like the sequence length squared, i.e.&nbsp;for a sequence length of <span class="math inline">\(N\)</span>, the cost is <big>𝒪</big>(<span class="math inline">\(N^2)\)</span>. This is one reason that Large Language Models can be “Large” – trying to model long sequences results in big matrices!</p>
<details>
<summary>
Details
</summary>
<p>Various schemes have been proposed to reduce this cost, such as only applying attention over nearby tokens (so-called “sliding window” attention) or other methods that fall under the general heading of “matrix sparsification”. Here’s a slide from a talk I gave a few years ago, illustrating a few of these schemes:</p>
<div id="fig-attn-cost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/attention_cost.hawley.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;2<strong>.</strong> Various schemes for reducing the <big>𝒪</big>(<span class="math inline">\(N^2)\)</span> cost of Attention. Many such schemes involve replacing the <code>Linear</code> layers with convolution operations, such as with the local receptive fields shown in b) and c). (Source: S.H. Hawley, <a href="https://hedges.belmont.edu/AES_ML_2020/">“Learning Tunable Audio Effects via Neural Networks with Self-Attention”</a>, AES Virtual Symposium: Applications of Machine Learning in Audio, Sep 28, 2020.)</figcaption>
</figure>
</div>
<p>For this lesson, we’ll see how far we can get with the basic <span class="math inline">\(N^2\)</span> attention. Beyond that, I encourage you to check the literature for whatever the latest/hottest cost-reducing model might be. Popular candidates include <a href="https://arxiv.org/abs/2205.14135">FlashAttention</a> and <a href="https://arxiv.org/abs/2107.14795">PercieverIO</a>. Even sliding windows are <a href="https://twitter.com/hrishioa/status/1712199009308398079">still in use in ways that some people find significant</a>.</p>
</details></section>
<section id="positional-encoding-aka-positional-embeddings" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</h2>
<p>MLPs and/or ConvNets don’t come with (much of) a sense of position, but giving them one can improve performance on tasks where ordering and position matters. There many ways people have have endowed such models with position-awareness and… TBH there’s not necessarily a “silver bullet” solution, so a variety of approaches can end up performing about the same. In what follows we’ll describe various schemes for doing PEs.</p>
<details>
<summary>
Details on PEs
</summary>
<section id="some-options-for-pes" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="some-options-for-pes"><span class="header-section-number">2.2.1</span> Some Options for PEs</h3>
<ol type="1">
<li><p>You could just concatenate a “linear ramp” of values to provide some position values, but… you wouldn’t want to do that. You won’t get very good gradients, especially for long sequences.</p></li>
<li><p>There’s the orignal positional encoding from the <a href="https://arxiv.org/abs/1706.03762">AIAYN</a> paper, which uses a set of sines &amp; cosines of expontially-increasing wavelength. They tweaked these wavelengths for their use case and ended up with the following equations: <span class="math display">\[
\begin{aligned}
PE_{(pos,2i)} = \sin(pos / 10000^{2i/d_{model}}) \\
PE_{(pos,2i+1)} = \cos(pos / 10000^{2i/d_{model}})
\end{aligned}
\]</span> But the authors of the Transformer paper said they tried a few different PE methods/equations – including letting the model learn the PEs – but found no significant impact on performance between them. So let’s add that to list, btw:</p></li>
<li><p>You could <strong>let the positional embeddings be learned</strong> via some trainable mapping. <em>This</em> is the approach that Karpathy uses in his mini-GPT tutorial, and it’s the approach we’ll use in this lesson as well.</p></li>
<li><p><a href="https://fleuret.org/francois/">Francois Fleuret</a> in his <a href="https://twitter.com/francoisfleuret/status/1262639062785105922">“AttentionToy1D”</a> demo, used a simplification of approach #2 by essentially turning it into a set of <a href="images/fleuret_binary.png">binary sequences</a> that correspond to the vertices of a hypercube.</p></li>
<li><p><a href="https://arxiv.org/abs/2108.12409">“ALiBi” (Attention with Linear Biases)</a> is a method whereby you don’t do positional encoding of the inputs, rather you insert the positional information into the attention calculation itself. It is <em>slightly</em> faster to execute than traditional PE and (probably?) offers less memory overhead, and yields comparable results. (I tried it, it didn’t make any difference so I left it out of htis lesson.)</p></li>
<li><p>One scheme, “<a href="https://paperswithcode.com/method/relative-position-encodings">Relative Position Embeddings</a>,” was reported to make a big difference and it arose in the <a href="https://arxiv.org/abs/1809.04281">Music Transformer</a> paper itself. Are we going to do that? …Uh….no, but that would be a great exercise for a student.</p></li>
</ol>
</section>
<section id="pes-to-add-or-concatenate" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="pes-to-add-or-concatenate"><span class="header-section-number">2.2.2</span> PEs: To Add or Concatenate?</h3>
<p>Here’s a design question: Should we add these PEs to our inputs or concatenate them?</p>
<p>TODO: revise this.</p>
<p>That’s debateable, and it depends. <a href="https://www.youtube.com/watch?v=M2ToEXF6Olw">Here’s a great video discussing this topic</a>. If the number of PE channels is less than the number of input channels (or input embedding dimensions), then we’ll definitely need to concatenate the PEs as additional channels for the inputs. That’s what Fleuret did when he was working with only one channel of floating point inputs, BTW. Here’s some code we’ll use later to concatenate the PEs to our data sequences.</p>
</section></details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A great source of instruction about all things related to Positional Encodings is the YouTube channel, <a href="https://www.youtube.com/@AICoffeeBreak">“AI Coffee Break with Letitia”</a>.</p>
</div>
</div>
</section>
</section>
<section id="residual-connections" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="residual-connections"><span class="header-section-number">2.3</span> Residual Connections</h2>
<p>In the Transfomer model diagram of <a href="#fig-trans-diag">Figure&nbsp;1</a>, wherever you see arrows going <em>around</em> something and connecting to a yellow “Add &amp; Norm” block, that is indicative of a “skip residual” or just “residual” connection. Readers will likely have seen residual / skip connections in other contexts, so we’ll make this section “Details”-expandable for those who haven’t encountered them.</p>
<details>
<summary>
Details
</summary>
<p>This is a pretty simple idea that yields payoffs in many areas of numerical modeling: You model the <em>change</em> in something instead of modeling the whole thing. The following flowchart illustrates this:</p>
<div id="fig-resid" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div style="background-color:white; width: 65%; margin-left: auto; margin-right: auto;">
<p><img src="https://mermaid.ink/svg/pako:eNo1j0EKg0AMRa8yBAQFewEXBaubQruxu5JNcGIVnIyMGUqR3r3TSnf_fR4kf4PeW4YKhtk_-5GCmkuHkmVG_WLsRI9ADqXOz7JELczhcDzljXcJ2DQjyYMLlNO3N01eW5uo3gml-YU273iNsxZQguPgaLLp3oZiDIKO7BihStHyQElDQHknlaL620t6qDRELiEulpTb_aN_yXZSH677hN-SEhaSu_dJGWhe-f0B3txJZw" class="figure-img"></p>
</div>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;3<strong>.</strong> Flowchart of a residual connection</figcaption>
</figure>
</div>
<p>With neural networks, this residual scheme has the added benefit of allowing for efficient backpropagation. There are claims that “skip residual” connections also help smooth the loss surface, such as <a href="https://arxiv.org/abs/1712.09913">this figure in a N(eur)IPS paper from 2017</a>:</p>
<div id="fig-loss-landscape" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://miro.medium.com/v2/resize:fit:723/1*_Qd_txKxRlsMdfuH2J-k4g.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;4<strong>.</strong> Loss landscape picture purporting to show the “smoothing” effects of residual connections. (Source: <a href="https://arxiv.org/abs/1712.09913">Li et al</a>.)</figcaption>
</figure>
</div>
</details></section>
<section id="multi-head-attention" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</h2>
<p>As described in the previous lesson, Multi-Head Attention simply involves allowing differently-weighted attention operators (called “heads”) to perform attention operations, allowing them to focus on different “senses” of phrases, parts of speech, or in our case, musical structures.</p>
<style>
.img-mh {
    /*transform-origin: top left;*/
    width:250px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-mh:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-mh-attn" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://machinelearningmastery.com/wp-content/uploads/2021/09/tour_4.png" class="img-mh img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;5<strong>.</strong> Diagram of Multi-Head Attention. The multiple attention “heads” are shown below as depthwise semi-transparent copies, which are then concatenated into “one big long thing” via the Concat operation, and then mapped into the the output for the module via the last Linear layer: (Source: <a href="https://arxiv.org/abs/1706.03762">AIAYN</a>.)</figcaption>
</figure>
</div>
</section>
<section id="layer-normalization" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</h2>
<p>This alternative to <a href="https://paperswithcode.com/method/batch-normalization">Batch Normalization</a> (in which we perform elementwise operations where we subtract the mean across the batch dimension and divide by the variance). Instead of doing this across the batch dimension, we do it across the feature dimension(s).</p>
<style>
.img-ln {
    /*transform-origin: top left;*/
    width:350px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-ln:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-norm-types" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://production-media.paperswithcode.com/methods/Screen_Shot_2020-05-19_at_4.24.42_PM.png" class="img-ln img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;6<strong>.</strong> (Mouse-over or press to expand.) Batch normalization vs.&nbsp;Layer normalization. (Source: <a href="https://paperswithcode.com/method/layer-normalization">PapersWithCode</a>.)</figcaption>
</figure>
</div>
<p>One big advantage of doing our normalization across layers instead of batches is that <em>it allows for small batch sizes.</em> Language models are often <em>large</em>, so they take up a lot of memory, which means you might need very small batches. But small batches will not allow you to do very good batch normalization. So, LayerNorm helps us get good statistics for the mean and variance that we use to normalize.</p>
</section>
<section id="stacking-blocks-embeddings-of-embeddingsof-embeddings" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings…of Embeddings</h2>
<p>By stacking layers of our transformers, i.e.&nbsp;feeding embeddings into layers that will render them as new embeddings, we wil increase the representational power of our model. In terms of code, this is easy to do by looping over a list of layers.</p>
</section>

<section id="the-music-midi-dataset" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The Music (MIDI) Dataset</h1>
<p>This section adopts a first-person perspective because I want to convey a personal tone: I confess that I’m “not a MIDI guy,” having always worked with raw audio exclusively. I vastly underestimated how difficult it would be to get decent results. Starting from Google’s well-known <a href="https://magenta.tensorflow.org/datasets/maestro">MAESTRO dataset</a> of solo piano performances – NOTE: <em>virtuoso</em> piano performances! –I kept downgrading the “difficulty” of the dataset until settling on <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach chorales</a>.</p>
<section id="learning-about-midi-data" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</h2>
<details>
<summary>
Details
</summary>
<p>The MAESTRO data wasn’t overly challenging if I only focussed on modeling the pitches, but music is pitch + timing (+ more). What’s more, I’d only ever seen MIDI music “quantized” into a grid-based “piano roll” format with a known time-signature, not realizing that that’s not what MIDI data really is. For our purposes, it’s worth noting that MIDI encodes several pieces of information on a <em>per-note</em> basis:</p>
<ol type="1">
<li>What instrument played the note</li>
<li>What pitch was played – an integer between 0 and 127.</li>
<li>The start time of the note – in units of the “MIDI clock” which <em>usually</em> ticks at 50,000 times a second. This is typically rendered as a floating-point number when using Python MIDI-processing packages such as Colin Raffel’s <a href="https://craffel.github.io/pretty-midi/">pretty-midi</a> (which we will use)</li>
<li>The end time of the note - another float.</li>
<li>The “velocity” of the note – e.g.&nbsp;how hard a piano key was struck.</li>
</ol>
<p>So, no time signature, no quarter-note, half-note, etc. But fine, taking a lead from the <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">Google Tensorflow Demo for RNN Modeling</a>, we can reduce each note to 3 numbers: 1. pitch 2. “step” in time since the previous note 3. duration of the note (i.e.&nbsp;end time minus start time).</p>
<p>…and focus on single-instrument work, and disregard the velocity.</p>
<p>EVEN THAT was too hard for the code below do with MAESTRO. I then noticed a <a href="https://arxiv.org/abs/1808.03715">paper by the Google team</a> pointed out that quantizing the time into bins of 8 milliseconds was an ok simplification to make, but even this proved too hard for my model. (I could do 16 ms, but that sounded weird.)</p>
<p>…so…. after surveying other things, I went with <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach Chorales</a>, which actually <em>are</em> presented in piano-roll format quantized to 16th note time intervals. Then I had to convert those from JSON to true MIDI, because by then the rest of my code expected MIDI.</p>
<p>I’ll spare you the details of that process, but note that the data link below is not the official dataset link, it’s <a href="https://drive.google.com/file/d/1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb/view?usp=sharing">my private stash</a> where I converted the JSON to .mid.</p>
</details></section>
<section id="install-and-import" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="install-and-import"><span class="header-section-number">3.2</span> Install and Import</h2>
<div class="cell">
<details>
<summary>Show the code for system-wide installs</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> install_package(package_name):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"For installing system binaries on Linux (Ubuntu/Debia) or Mac (via Homebrew)"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">'Darwin'</span>:</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        os.system(<span class="ss">f'brew install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> platform.system() <span class="op">==</span> <span class="st">'Linux'</span>:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> getpass  <span class="co"># </span><span class="al">TODO</span><span class="co">: colab doesn't need a password for sudo</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        password <span class="op">=</span> getpass.getpass()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        command <span class="op">=</span> <span class="ss">f"sudo -S apt-get install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        os.popen(command, <span class="st">'w'</span>).write(password<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Unsupported Operating System"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># skip it for now</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#install_package('fluidsynth')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code for pip installs</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq gdown pyfluidsynth pretty_midi torch numpy pandas midi<span class="op">-</span>player multiprocess</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code for imports</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import (most of) what we'll need for the entire lesson</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fluidsynth</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pretty_midi</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn, einsum</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> functional <span class="im">as</span> F</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocess <span class="im">as</span> mp   <span class="co"># multiprocess is a Jupyter-compatible fork of multiprocessing</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm  <span class="co"># note: Quarto blog won't print output from tqdm.notebook</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">#from tqdm.contrib.concurrent import process_map  # process_map throws errors on Mac :'-( </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-and-inspect-the-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</h2>
<div class="cell">
<details>
<summary>Show the code for downloading the dataset</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_source <span class="op">=</span> <span class="st">'jsb_chorales_midi'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add options for MAESTRO, others</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">'midi_data'</span>) <span class="co"># generic name for whatever midi we might want</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>REST_PITCH <span class="op">=</span> <span class="dv">127</span>  <span class="co"># special code  used to denote rests</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>gdown <span class="op">-</span>O {data_source}.tgz <span class="dv">1</span><span class="er">MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tar zxf {data_source}.tgz<span class="op">;</span> rm <span class="op">-</span>rf midi_data<span class="op">;</span> ln <span class="op">-</span>s {data_source} midi_data <span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the list of MIDI filenames</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> <span class="bu">sorted</span>(glob(<span class="bu">str</span>(data_dir<span class="op">/</span><span class="st">'**/*.mid*'</span>),recursive<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Number of files:'</span>, <span class="bu">len</span>(filenames))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading...
From: https://drive.google.com/uc?id=1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb
To: /Users/shawley/github/blog/posts/jsb_chorales_midi.tgz
100%|█████████████████████████████████████████| 137k/137k [00:00&lt;00:00, 113MB/s]
Number of files: 382</code></pre>
</div>
</div>
<p>Let’s inspect one of the files – using the <a href="https://github.com/drscotthawley/midi-player"><code>MIDIPlayer</code></a> object created especially for this lesson!</p>
<div class="cell">
<details>
<summary>Show the code for MIDI player usage</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player <span class="im">import</span> MIDIPlayer</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player.stylers <span class="im">import</span> general, dark <span class="co"># I like dark mode</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>midi_file <span class="op">=</span> filenames[<span class="dv">0</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>MIDIPlayer(midi_file, <span class="dv">360</span>, styler<span class="op">=</span>dark, title<span class="op">=</span><span class="ss">f"midi_file = </span><span class="sc">{</span>midi_file<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-midi-play1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section782 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section782 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section782 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section782 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section782 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section782 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section782 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section782 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section782 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section782 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section782 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section782&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>midi_file = midi_data/test/jsb_chorale_test_0.mid<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A sound-font visualizer=&quot;#section782 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="360" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;7<strong>.</strong> Example of the first MIDI file on our list. (Press the play button to listen.) These particular notes really <em>were</em> arranged on a “grid,” however I converted them to a series of MIDI “notes,” occurring one after the other in the file, with simultaneously-starting notes sorted in ascending order of pitch.</figcaption>
</figure>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes the <code>MIDIPlayer</code>’s piano roll view will appear blank if the notes are below the bottom of the visible frame. Scroll downward inside the player to reveal all the notes. The piano roll also scrolls left &amp; right.</p>
</div>
</div>
<p>Let’s load a single file and convert it to a PyTorch tensor called <code>notes_tensor</code>, and we’ll go ahead and convert “start” and “end” times “step” and “duration” times. So, displaying the first several notes (using a <code>pandas</code> dataframe for style) we see…</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quantize_times(times, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                   res_ms<span class="op">=</span><span class="dv">8</span>, <span class="co"># resolution in milliseconds. 8ms was deemed sufficient for MAESTRO.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                   clamp_range_s<span class="op">=</span>[<span class="fl">0.0</span>,<span class="fl">4.0</span>]):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    quant_step <span class="op">=</span> res_ms <span class="op">/</span> <span class="fl">1000.0</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    q_times <span class="op">=</span> torch.<span class="bu">round</span>(times <span class="op">/</span> quant_step) <span class="op">*</span> quant_step</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> clamp_range_s <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        q_times <span class="op">=</span> torch.clamp(q_times, clamp_range_s[<span class="dv">0</span>], clamp_range_s[<span class="dv">1</span>])</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q_times</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midi_file_to_tensor(filenames, i<span class="op">=</span><span class="va">None</span>, keep_start_end<span class="op">=</span><span class="va">False</span>, rest_pitches<span class="op">=</span>[REST_PITCH]):  <span class="co"># filenames could just be a single filename</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    midi_file <span class="op">=</span> filenames <span class="cf">if</span> i <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">type</span>(filenames)<span class="op">==</span><span class="bu">str</span>  <span class="cf">else</span> filenames[i]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"reads a single midi file and converts it to tensor with elements (pitch, step, duration)"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI(midi_file) <span class="co"># read in the whole file. this can be very slow for long MIDI files (e.g. in MAESTRO)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort the notes first by start time (and then by pitch if two notes start at the same time)</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    sorted_notes <span class="op">=</span> <span class="bu">sorted</span>(pm.instruments[<span class="dv">0</span>].notes, key<span class="op">=</span><span class="kw">lambda</span> note: (note.start, note.pitch))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#notes = torch.empty( (len(sorted_notes), 3 + 2*keep_start_end), dtype=torch.float32 ) # allocate storage</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> sorted_notes[<span class="dv">0</span>].start</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> []</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_notes):</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        new_note <span class="op">=</span>  torch.empty( (<span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>keep_start_end) , dtype<span class="op">=</span>torch.float32)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">int</span>(note.pitch) <span class="kw">in</span> rest_pitches: <span class="cf">continue</span>  <span class="co"># we can actually delete the rests! </span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">0</span>] <span class="op">=</span> note.pitch</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">1</span>] <span class="op">=</span> note.start <span class="op">-</span> prev_start  <span class="co"># step, i.e. time since start of previous note</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        new_note[<span class="dv">2</span>] <span class="op">=</span> note.end <span class="op">-</span> note.start    <span class="co"># duration</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> keep_start_end:                     <span class="co"># might find it useful be able to keep these for easier analysis later</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            new_note[<span class="dv">3</span>] <span class="op">=</span> note.start</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            new_note[<span class="dv">4</span>] <span class="op">=</span> note.end</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> note.start</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        notes.append(new_note)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> torch.vstack(notes)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(notes[:,<span class="dv">1</span>:])</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> notes</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>notes_tensor <span class="op">=</span> midi_file_to_tensor(midi_file)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.notebook_repr_html'</span>, <span class="va">True</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>notes_df <span class="op">=</span> pd.DataFrame(notes_tensor, columns<span class="op">=</span>[<span class="st">'pitch'</span>,<span class="st">'step'</span>,<span class="st">'duration'</span>]) <span class="co"># actually df's look nicer</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="co"># making it look better in the blog: adjust width of pandas dataframes</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">'''</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe {</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="st">    width: 40%; /* Adjust this value as needed */</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe th, .dataframe td {</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="st">    width: auto !important;</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="st">table {</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="st">th, td {</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="st">    min-width: 100px; /* Or any other width */</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>))</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>HTML(notes_df[:<span class="dv">8</span>].to_html(index<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">


<style>
.dataframe {
    width: 40%; /* Adjust this value as needed */
    margin-left: auto;
    margin-right: auto;
}
.dataframe th, .dataframe td {
    text-align: center;
    width: auto !important;
}

table {
    margin-left: auto;
    margin-right: auto;
}
th, td {
    text-align: center;
    min-width: 100px; /* Or any other width */
}
</style>
</div>
<div class="cell-output cell-output-display">
<div id="tbl-firstnotes" class="anchored">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<caption>Table&nbsp;1<strong>.</strong> First 8 notes of <code>notes_tensor</code></caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pitch</th>
<th data-quarto-table-cell-role="th">step</th>
<th data-quarto-table-cell-role="th">duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>53.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="even">
<td>57.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>60.0</td>
<td>0.00</td>
<td>1.44</td>
</tr>
<tr class="even">
<td>65.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>52.0</td>
<td>0.48</td>
<td>0.48</td>
</tr>
<tr class="even">
<td>55.0</td>
<td>0.00</td>
<td>0.48</td>
</tr>
<tr class="odd">
<td>72.0</td>
<td>0.00</td>
<td>0.24</td>
</tr>
<tr class="even">
<td>70.0</td>
<td>0.24</td>
<td>0.24</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We’ll convert those floating point numbers to integers via the “tokenizer” below.</p>
<p>Now we’ll load each song into an entry in a list called <code>notes_tensor_list</code>:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> files_to_tensor_list(filenames, keep_start_end<span class="op">=</span><span class="va">False</span>, serial<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Reads MIDI files in parallel so should be reasonably fast. JSB Chorales are no prob but for MAESTRO you want this"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tensor_list = process_map(midi_file_to_tensor, filenames, max_workers=mp.cpu_count(), chunksize=1) # Doesn't work on Mac</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    tensor_list <span class="op">=</span> []</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    max_ <span class="op">=</span> <span class="bu">len</span>(filenames)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> serial:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, filename <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(filenames)):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            tensor_list.append(midi_file_to_tensor(filename,  keep_start_end<span class="op">=</span>keep_start_end))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mp.Pool(processes<span class="op">=</span>mp.cpu_count()) <span class="im">as</span> p:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> tqdm(total<span class="op">=</span>max_) <span class="im">as</span> pbar:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> r <span class="kw">in</span> p.imap_unordered(partial(midi_file_to_tensor, filenames, keep_start_end<span class="op">=</span>keep_start_end), <span class="bu">range</span>(<span class="dv">0</span>, max_)):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                    tensor_list.append(r)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                    pbar.update()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  tensor_list</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>notes_tensor_list_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>data_source<span class="sc">}</span><span class="ss">_tensor_list.pt'</span>         <span class="co"># we'll save the result to a file for easier re-reading next time</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>read_all_midi_files <span class="op">=</span> <span class="va">True</span> <span class="co"># not os.path.exists(notes_tensor_list_filename) # check to see if it already exists</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> read_all_midi_files:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> files_to_tensor_list(filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    torch.save(notes_tensor_list, notes_tensor_list_filename) <span class="co"># save for next time</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> torch.load(notes_tensor_list_filename) <span class="co"># just read from the last time we made one</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">len(notes_tensor_list) = </span><span class="sc">{</span><span class="bu">len</span>(notes_tensor_list)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████| 382/382 [00:02&lt;00:00, 155.96it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
len(notes_tensor_list) = 382</code></pre>
</div>
</div>
<p>Also, let’s make a single tensor <code>all_notes</code> out of all the notes. We’re only going to use this for analysis purposes; for everything else we’ll use the <code>notes_tensor_list</code>, which…I’m now going to abbreviate as <code>notes_tl</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>notes_tl <span class="op">=</span> notes_tensor_list</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>all_notes <span class="op">=</span> torch.vstack(notes_tl).<span class="bu">type</span>(torch.float32)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"all_notes.shape = "</span>,all_notes.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>all_notes.shape =  torch.Size([78349, 3])</code></pre>
</div>
</div>
</section>
<section id="making-a-tokenizer" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="making-a-tokenizer"><span class="header-section-number">3.4</span> Making a Tokenizer</h2>
Rather than try something sophisticated like calling <a href="https://github.com/Natooz/MidiTok">MidiTok</a>, we’re going to treat this like a “char-level RNN” and just regard each note as a “parallel” group of 3 tokens (one token for pitch, step, and duration). This means that we will need 3 “codebooks” that can encode &amp; decode between true values and their tokens.
<details>
<summary>
Details
</summary>
<p>For the pitch values, it’s pretty easy since there are up to 128 pitches. Probably they won’t all be used, so we <em>could</em> limit the range of pitches, however, I’m going to want to do some pitch-bending data augmentation, so the pitch tokens will just be <code>int</code> versions of their <code>floats</code>, indices in a 128-dimensional space.</p>
<p>For the timing – which I don’t plan to do any augmentation of – we’ll just write down what unique values are present. These will form the “vocabularies” that we often see used in NLP settings.</p>
<p>Oh, also: The timing values end up being <em>reaaalllly</em> long in some cases. Like, notes with 15 seconds in duration? I’m going to go ahead an clamp those to a maximum value of 4 seconds.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_codebooks(all_notes, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    codebooks <span class="op">=</span> []</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    n_codebooks <span class="op">=</span> all_notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="co"># should be 3</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_codebooks): </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:  <span class="co"># i=0 means pitch</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> torch.arange(<span class="dv">128</span>)  <span class="co"># just use all possible pitches </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:     <span class="co"># i!=0 means timing</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> all_notes[:,i].unique().sort()[<span class="dv">0</span>] </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">---</span><span class="ch">\n</span><span class="ss">cb </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: cb_vals = </span><span class="sc">{</span>cb_vals<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        codebooks.append({<span class="st">'encode'</span>:{np.<span class="bu">round</span>(k.item(),<span class="dv">3</span>): <span class="bu">int</span>(v) <span class="cf">for</span> v, k <span class="kw">in</span> <span class="bu">enumerate</span>(cb_vals)}, <span class="co"># codebooks go both ways</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'decode'</span>:{<span class="bu">int</span>(v): k <span class="cf">for</span> v, k <span class="kw">in</span> <span class="bu">enumerate</span>(cb_vals)}})</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f" cb </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: cb keys = </span><span class="sc">{</span>codebooks[<span class="op">-</span><span class="dv">1</span>][<span class="st">'encode'</span>]<span class="sc">.</span>keys()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> codebooks</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>all_notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(all_notes[:,<span class="dv">1</span>:])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#all_notes[:,1:] = torch.clamp(all_notes[:,1:], 0, 4.0) # clamp max value of step &amp; dur</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>codebooks <span class="op">=</span> make_codebooks(all_notes)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>vocab_sizes <span class="op">=</span> [<span class="bu">len</span>(cb[<span class="st">'encode'</span>]) <span class="cf">for</span> cb <span class="kw">in</span> codebooks]</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"vocab_sizes = "</span>,vocab_sizes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
---
cb 0: cb_vals = tensor([  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,
         14,  15,  16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,  27,
         28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,  41,
         42,  43,  44,  45,  46,  47,  48,  49,  50,  51,  52,  53,  54,  55,
         56,  57,  58,  59,  60,  61,  62,  63,  64,  65,  66,  67,  68,  69,
         70,  71,  72,  73,  74,  75,  76,  77,  78,  79,  80,  81,  82,  83,
         84,  85,  86,  87,  88,  89,  90,  91,  92,  93,  94,  95,  96,  97,
         98,  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
        112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125,
        126, 127])
 cb 0: cb keys = dict_keys([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127])

---
cb 1: cb_vals = tensor([0.0000, 0.1200, 0.2400, 0.3600, 0.4800, 0.7200, 0.9600, 1.2000, 1.4400,
        1.6800, 1.9200, 2.4000, 2.8800, 3.8400, 4.0000])
 cb 1: cb keys = dict_keys([0.0, 0.12, 0.24, 0.36, 0.48, 0.72, 0.96, 1.2, 1.44, 1.68, 1.92, 2.4, 2.88, 3.84, 4.0])

---
cb 2: cb_vals = tensor([0.1200, 0.2400, 0.3600, 0.4800, 0.6000, 0.7200, 0.8400, 0.9600, 1.0800,
        1.2000, 1.3200, 1.4400, 1.5600, 1.6800, 1.8000, 1.9200, 2.0400, 2.1600,
        2.4000, 2.5200, 2.6400, 2.8800, 3.1200, 3.2400, 3.3600, 3.6000, 3.8400,
        4.0000])
 cb 2: cb keys = dict_keys([0.12, 0.24, 0.36, 0.48, 0.6, 0.72, 0.84, 0.96, 1.08, 1.2, 1.32, 1.44, 1.56, 1.68, 1.8, 1.92, 2.04, 2.16, 2.4, 2.52, 2.64, 2.88, 3.12, 3.24, 3.36, 3.6, 3.84, 4.0])
vocab_sizes =  [128, 15, 28]</code></pre>
</div>
</div>
<p>Now we need routines to convert back and forth between values and codebook indices. We’ll make a single function <code>remap_vals()</code> that can either go “forward” for encoding, or “backward” for decoding:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remap_vals(seq, encdec_str, dtype<span class="op">=</span>torch.<span class="bu">long</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> torch.zeros_like(seq, dtype<span class="op">=</span>dtype)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(seq.shape[<span class="op">-</span><span class="dv">1</span>]): </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        dict_map <span class="op">=</span> codebooks[cb][encdec_str]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        default_map <span class="op">=</span> <span class="bu">max</span>(codebooks[cb][encdec_str].values())</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        out[:,cb] <span class="op">=</span> torch.tensor([dict_map.get(np.<span class="bu">round</span>(x.item(),<span class="dv">3</span>),default_map) <span class="cf">for</span> x <span class="kw">in</span> seq[:,cb]], dtype<span class="op">=</span>dtype) <span class="co"># that np.round(,3) is good for avoiding KeyErrors</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">#out[:,cb] = torch.tensor([dict_map[np.round(x.item(),3)] for x in seq[:,cb]], dtype=dtype)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll be calling these 'encode' and 'decode functions', which really just pull up the applicable part of the codebooks</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>encode <span class="op">=</span> <span class="kw">lambda</span> s: remap_vals(s, <span class="st">'encode'</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>decode <span class="op">=</span> <span class="kw">lambda</span> s: remap_vals(s, <span class="st">'decode'</span>, dtype<span class="op">=</span>all_notes.dtype)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># And let's do a little test</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>midi_seq <span class="op">=</span> all_notes[<span class="dv">0</span>:<span class="dv">6</span>].clone()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before encoding, midi_seq =</span><span class="ch">\n</span><span class="st">"</span>,midi_seq)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After encoding, token_list =</span><span class="ch">\n</span><span class="st">"</span>,token_list)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>return_seq <span class="op">=</span> decode(token_list)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After decoding, return_seq =</span><span class="ch">\n</span><span class="st">"</span>,return_seq)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> torch.equal(midi_seq, return_seq), <span class="ss">f"Oops. midi_seq=</span><span class="sc">{</span>midi_seq<span class="sc">}</span><span class="ss">, but return_seq=</span><span class="sc">{</span>return_seq<span class="sc">}</span><span class="ss">. Should be the same"</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>midi_seq[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">100.0</span>  <span class="co"># give the last time a huge value to check that our mapper won't crash</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq) <span class="co"># if it doesn't crash, we're good</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> token_list[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="bu">list</span>(codebooks[<span class="op">-</span><span class="dv">1</span>][<span class="st">'encode'</span>].values())[<span class="op">-</span><span class="dv">1</span>], <span class="st">"Big value should have gotten the last spot in the last codebook"</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checks pass! :-)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Before encoding, midi_seq =
 tensor([[53.0000,  0.0000,  0.4800],
        [57.0000,  0.0000,  0.4800],
        [60.0000,  0.0000,  1.4400],
        [65.0000,  0.0000,  0.4800],
        [52.0000,  0.4800,  0.4800],
        [55.0000,  0.0000,  0.4800]])
After encoding, token_list =
 tensor([[53,  0,  3],
        [57,  0,  3],
        [60,  0, 11],
        [65,  0,  3],
        [52,  4,  3],
        [55,  0,  3]])
After decoding, return_seq =
 tensor([[53.0000,  0.0000,  0.4800],
        [57.0000,  0.0000,  0.4800],
        [60.0000,  0.0000,  1.4400],
        [65.0000,  0.0000,  0.4800],
        [52.0000,  0.4800,  0.4800],
        [55.0000,  0.0000,  0.4800]])
Checks pass! :-)</code></pre>
</div>
</div>
<section id="more-checks" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="more-checks"><span class="header-section-number">3.4.1</span> More Checks:</h3>
<p>Before moving on, it’s a good idea to double check: Can we really encode and decode an entire midi sequence? Let’s write some more utility files. Notably the <code>midiplayer()</code> routine which will allow us to play our PyTorch tensors directly in this notebook.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_startend(notes:torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"integrates (step,duration) timing pairs to recover (start,end) info. concats them as new columns"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    newnotes <span class="op">=</span> torch.zeros((<span class="bu">len</span>(notes), <span class="dv">5</span>), dtype<span class="op">=</span>notes.dtype, device<span class="op">=</span>notes.device)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    newnotes[:,:<span class="dv">3</span>] <span class="op">=</span> notes[:,:<span class="dv">3</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(notes): </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        step, dur <span class="op">=</span> note[<span class="dv">1</span>], note[<span class="dv">2</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> step  <span class="op">+</span> prev_start </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        end   <span class="op">=</span> start <span class="op">+</span> dur</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        newnotes[i,<span class="dv">3</span>], newnotes[i,<span class="dv">4</span>] <span class="op">=</span> start, end</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> start   </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newnotes</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> notes_to_midi(notes:torch.Tensor, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                  time_rescale<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                  out_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">''</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                  instrument_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">'Acoustic Grand Piano'</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                  velocity: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>,  <span class="co"># default loudness for all notes</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                 ) <span class="op">-&gt;</span> pretty_midi.PrettyMIDI:</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.clone() <span class="co"># just to avoid weird overwrites of memory addresses</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="fl">0.0</span>:</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">"WARNING: You have negative pitches, steps or durations. Setting them to zero"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>      notes <span class="op">=</span> notes <span class="op">*</span> (notes <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> time_rescale <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: <span class="co"># just added this because sometime I want to slow/speed up</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        notes[:,<span class="dv">1</span>:] <span class="op">=</span> notes[:,<span class="dv">1</span>:] <span class="op">*</span>time_rescale</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    instrument <span class="op">=</span> pretty_midi.Instrument(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        program<span class="op">=</span>pretty_midi.instrument_name_to_program(</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            instrument_name))</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">5</span>: notes <span class="op">=</span> get_startend(notes)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.cpu().numpy()</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> note <span class="kw">in</span> notes: </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        pitch, start, end <span class="op">=</span> <span class="bu">int</span>(note[<span class="dv">0</span>]), note[<span class="dv">3</span>], note[<span class="dv">4</span>] </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        midi_note <span class="op">=</span> pretty_midi.Note( velocity<span class="op">=</span>velocity, pitch<span class="op">=</span>pitch, start<span class="op">=</span>start, end<span class="op">=</span>end, )</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        instrument.notes.append(midi_note)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> start   </span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    pm.instruments.append(instrument)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_file: pm.write(out_file)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pm</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midiplayer(notes_tensor, height<span class="op">=</span><span class="dv">400</span>, time_rescale<span class="op">=</span><span class="va">None</span>, midi_file<span class="op">=</span><span class="st">"/tmp/tmp.mid"</span>, title<span class="op">=</span><span class="st">''</span>, styler<span class="op">=</span>dark):</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"MIDIplayer that writes input tensor to temporary file"</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> notes_to_midi(notes_tensor, time_rescale<span class="op">=</span>time_rescale, out_file<span class="op">=</span>midi_file)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MIDIPlayer(midi_file, height, styler<span class="op">=</span>dark, dl<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span>title)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’re going to encode &amp; decode, and write to a MIDI file, and play that midi file. Using the same file as above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>midiplayer(decode(encode(midi_file_to_tensor(filenames[<span class="dv">0</span>]))), title<span class="op">=</span><span class="st">'Encode-Decode Test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section64 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section64 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section64 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section64 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section64 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section64 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section64 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section64 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section64 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section64 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section64 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section64&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Encode-Decode Test<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== sound-font visualizer=&quot;#section64 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>Yay! Moving on…</p>
</section>
</details></section>
<section id="making-pytorch-datasets" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</h2>
<p>Our particular dataset already comes with a test/train/valid split in its subdirectores, so let’s use that split. We’ll go ahead and re-load the files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor lists</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>train_filenames <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/train'</span> <span class="kw">in</span> x]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>val_filenames   <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/val'</span>   <span class="kw">in</span> x]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test_filenames  <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/test'</span>  <span class="kw">in</span> x]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>train_notes_tl <span class="op">=</span> files_to_tensor_list(train_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>val_notes_tl   <span class="op">=</span> files_to_tensor_list(val_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_notes_tl  <span class="op">=</span> files_to_tensor_list(test_filenames, serial<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, tl <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">'train'</span>,<span class="st">'val'</span>,<span class="st">'test'</span>],[train_notes_tl, val_notes_tl, test_notes_tl]):</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> torch.vstack(tl)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(tl)<span class="sc">}</span><span class="ss"> songs in </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>stack<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> notes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████| 229/229 [00:01&lt;00:00, 148.46it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 76/76 [00:00&lt;00:00, 154.68it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 77/77 [00:00&lt;00:00, 142.49it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>229 songs in train, 46660 notes
76 songs in val, 15052 notes
77 songs in test, 16637 notes</code></pre>
</div>
</div>
<p>…that’s not a ton of data. We should incude some data augmentation.</p>
<section id="data-augmentation" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</h3>
<p>We’ll augment the pitch values by raising &amp; lowering them within an octave, except we’ll leave the rest pitch (=127 for the JSB chorales) alone since that sometimes gets used as a rest. And we’ll leave the timing values alone.</p>
<div class="cell">
<details>
<summary>Show the Data Augmentation code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_data(data, pitch_shift<span class="op">=</span><span class="dv">12</span>, debug<span class="op">=</span><span class="va">True</span>, extra_augs<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    datanew <span class="op">=</span> data.clone()                                     <span class="co"># avoid overwriting memory of data</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pitch</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    change <span class="op">=</span> torch.randint(<span class="op">-</span>pitch_shift, pitch_shift, (<span class="dv">1</span>,))    <span class="co"># how many semitones to change all the pitches</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((change, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># change the pitches</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> extra_augs: <span class="cf">return</span> datanew   <span class="co">#only do pitches</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>:                         <span class="co"># sometimes invert pitches? Probably not useful but anyway</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">*=</span> torch.tensor((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((<span class="dv">127</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time - if we sometimes increase each non-zero time-token by one, that should be ok, right? </span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do step</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do duration</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extra 'safety' constraint: clamp to range of valid values (of tokens)</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, cb <span class="kw">in</span> <span class="bu">enumerate</span>(codebooks):</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        datanew[:,i] <span class="op">=</span> torch.clamp(datanew[:,i], <span class="dv">0</span>, <span class="bu">len</span>(cb[<span class="st">'encode'</span>])<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datanew</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co"># testing code: </span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">3</span>) <span class="co"># setting this just  to make sure something happens ;-) </span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> torch.tensor([[<span class="dv">54</span>,<span class="dv">12</span>,<span class="dv">6</span>],[<span class="dv">61</span>,<span class="dv">0</span>,<span class="dv">40</span>],[<span class="dv">127</span>,<span class="dv">14</span>,<span class="dv">4</span>],[<span class="dv">86</span>,<span class="dv">0</span>,<span class="dv">12</span>],[<span class="dv">126</span>,<span class="dv">7</span>,<span class="dv">12</span>]])</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"data.shape = "</span>,data.shape)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"original data = </span><span class="ch">\n</span><span class="st">"</span>,data)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> augment_data(data)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"augmented data = </span><span class="ch">\n</span><span class="st">"</span>,aug) <span class="co"># </span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> torch.equal(aug[:,<span class="dv">0</span>], data[:,<span class="dv">0</span>]), <span class="st">"Oops, nothing changed"</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> aug[<span class="dv">2</span>,<span class="dv">0</span>]<span class="op">==</span>data[<span class="dv">2</span>,<span class="dv">0</span>], <span class="st">"Oops,  The 127 got changed"</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checks passed! :-) "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data.shape =  torch.Size([5, 3])
original data = 
 tensor([[ 54,  12,   6],
        [ 61,   0,  40],
        [127,  14,   4],
        [ 86,   0,  12],
        [126,   7,  12]])
augmented data = 
 tensor([[ 52,  12,   6],
        [ 59,   0,  40],
        [127,  14,   4],
        [ 84,   0,  12],
        [124,   7,  12]])
Checks passed! :-) </code></pre>
</div>
</div>
</section>
<section id="dataset-object-definition" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="dataset-object-definition"><span class="header-section-number">3.5.2</span> Dataset Object Definition</h3>
<p>Here we go with the dataset:</p>
<div class="cell">
<details>
<summary>Show the Pytorch Dataset code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesDataset(Dataset):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"simple custom dataset of sliding windows"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                 tensor_list, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                 seq_length:<span class="bu">int</span>, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                 tokenizer<span class="op">=</span>encode,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                 codebooks<span class="op">=</span>codebooks, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                 aug_callback<span class="op">=</span>augment_data,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                 len_mult<span class="op">=</span><span class="dv">100</span>,  <span class="co"># factor to 'fudge' the dataset length when it's inspected by DataLoaders</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                 pad<span class="op">=</span><span class="va">True</span>, <span class="co"># pad end with rests</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sl <span class="op">=</span> seq_length</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.len_mult <span class="op">=</span> len_mult</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_list <span class="op">=</span> [tokenizer(t) <span class="cf">for</span> t <span class="kw">in</span> tensor_list] <span class="co"># encoded tokens are all we'll use</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pad:</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            rests <span class="op">=</span> torch.tensor([REST_PITCH,<span class="dv">1</span>,<span class="dv">1</span>]).unsqueeze(<span class="dv">0</span>).tile((seq_length,<span class="dv">1</span>))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.data_list <span class="op">=</span> [torch.cat((toks,rests), dim<span class="op">=</span><span class="dv">0</span>) <span class="cf">for</span> toks <span class="kw">in</span> <span class="va">self</span>.data_list]</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.aug_callback <span class="op">=</span> aug_callback</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""we're going to be grabbing random windows from the data, so just the len of the tensor </span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">        list will be too small for large batch sizes, hence we multiply by len_mult"""</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.data_list)<span class="op">*</span><span class="va">self</span>.len_mult  <span class="co"># this will keep the DataLoader going longer</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx, shift<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> (torch.Tensor, torch.Tensor):</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">"grabs a random 'window' from a random song, with an offset of `shift` tokens between inputs and targets"</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        i_song <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list), (<span class="dv">1</span>,)) <span class="co"># pick a song</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span>  torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list[i_song]) <span class="op">-</span> <span class="va">self</span>.sl <span class="op">-</span> <span class="dv">1</span>, (<span class="dv">1</span>,))  <span class="co"># start of window within song</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        data_block <span class="op">=</span> <span class="va">self</span>.data_list[i_song][ix:ix<span class="op">+</span><span class="va">self</span>.sl<span class="op">+</span><span class="dv">1</span>]  <span class="co"># grab window plus an extra character</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.aug_callback <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            data_block <span class="op">=</span> <span class="va">self</span>.aug_callback(data_block)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        inputs, targets <span class="op">=</span> data_block[:<span class="va">self</span>.sl], data_block[shift:<span class="va">self</span>.sl<span class="op">+</span>shift]</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inputs, targets</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>seq_length <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset(train_notes_tl, seq_length)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co"># save test_ds for Evaluation section, later</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_ds), <span class="bu">len</span>(val_ds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>(22900, 76000000)</code></pre>
</div>
</div>
<p>And before we use it, let’s seed all the Random Number Generators for the sake of reproducibility</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  set RNG seeds for reproducibility.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seeds(seed):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed(seed)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed_all(seed) </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span> <span class="co"># We may change this further down, for now it's just a test</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, )</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>batch_x, batch_y <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dl))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"batch_x.shape, batch_y.shape = "</span>,batch_x.shape, batch_y.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>batch_x.shape, batch_y.shape =  torch.Size([128, 64, 3]) torch.Size([128, 64, 3])</code></pre>
</div>
</div>
<p>Ok. Now that we have a feel for how to handle our data, let’s get setup for the Transformer!</p>
</section>
</section>
</section>
<section id="hyperparameters-model-configuration" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</h1>
<p>Here’s where we’ll put all of our architecture design variables, storing it in a dict-like “<code>dataclass</code>” object for easy passing around.</p>
<div class="cell">
<details>
<summary>Show the config-creation code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicBoxConfig:</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model architecture details</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    seq_length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    n_embd:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span>     <span class="co"># embedding dimension to use for tokens &amp; positions</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    n_heads:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>       <span class="co"># number of attention heads</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    n_blocks:   <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>       <span class="co"># number of attention blocks</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    dropout:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>     <span class="co"># dropout value applied everywhere</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    bias:      <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>   <span class="co"># True: bias in Linears and LayerNorms, like GPT-2. False: a bit better and faster</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training details</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    weight_decay:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>   <span class="co"># 0.01 is pytorch default</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    epochs:          <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other handy bookkeeping</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    vocab_sizes: <span class="bu">tuple</span> <span class="op">=</span> <span class="bu">tuple</span>(vocab_sizes)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> MusicBoxConfig()</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>pp <span class="op">=</span> pprint.PrettyPrinter(indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>pp.pprint(config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MusicBoxConfig(seq_length=64,
               batch_size=128,
               n_embd=128,
               n_heads=8,
               n_blocks=4,
               dropout=0.1,
               bias=False,
               learning_rate=0.001,
               weight_decay=0.01,
               epochs=20,
               vocab_sizes=(128, 15, 28))</code></pre>
</div>
</div>
</section>
<section id="transformer-model-code" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Transformer Model Code</h1>
<p>I did write my own Transformer code completely from scratch – honest! – but it in the quest to get better results, I increasingly borrowed from Karpathy’s lesson code (feeling like the “Salieri” to his “Mozart”), to the point where the following is really a set of minor modifications, such as my added support for multiple codebooks, and passing around the config.</p>
<details>
<summary>
Details
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from my mod of K's code</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add more commentary! </span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Head(nn.Module):</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" one head of self-attention """</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, head_size, config):</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        n_embd, block_size <span class="op">=</span> config.n_embd, config.seq_length</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.query <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register_buffer(<span class="st">'tril'</span>, torch.tril(torch.ones(block_size, block_size)))</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        B,T,C <span class="op">=</span> x.shape</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="va">self</span>.key(x)   <span class="co"># (B,T,C)</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> <span class="va">self</span>.query(x) <span class="co"># (B,T,C)</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># compute attention scores ("affinities")</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> q <span class="op">@</span> k.transpose(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> C<span class="op">**-</span><span class="fl">0.5</span> <span class="co"># (B, T, C) @ (B, C, T) -&gt; (B, T, T)</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> wei.masked_fill(<span class="va">self</span>.tril[:T, :T] <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">'-inf'</span>)) <span class="co"># (B, T, T)</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> F.softmax(wei, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, T, T)</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> <span class="va">self</span>.dropout(wei)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># perform the weighted aggregation of the values</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="va">self</span>.value(x) <span class="co"># (B,T,C)</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> wei <span class="op">@</span> v <span class="co"># (B, T, T) @ (B, T, C) -&gt; (B, T, C)</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiHeadAttention(nn.Module):</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" multiple heads of self-attention in parallel """</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_heads, head_size, config):</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        n_embd <span class="op">=</span> config.n_embd</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.heads <span class="op">=</span> nn.ModuleList([Head(head_size, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_heads)])</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proj <span class="op">=</span> nn.Linear(n_embd, n_embd)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> torch.cat([h(x) <span class="cf">for</span> h <span class="kw">in</span> <span class="va">self</span>.heads], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> <span class="va">self</span>.dropout(<span class="va">self</span>.proj(out))</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeedFoward(nn.Module):</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" a simple linear layer followed by a non-linearity """</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, config):</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.net <span class="op">=</span> nn.Sequential(</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>            nn.Linear(n_embd, <span class="dv">4</span> <span class="op">*</span> n_embd),</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">4</span> <span class="op">*</span> n_embd, n_embd),</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(config.dropout),</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.net(x)</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Block(nn.Module):</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Transformer block: communication followed by computation """</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, n_head, config):</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># n_embd: embedding dimension, n_head: the number of heads we'd like</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>        head_size <span class="op">=</span> n_embd <span class="op">//</span> n_head</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sa <span class="op">=</span> MultiHeadAttention(n_head, head_size, config)</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffwd <span class="op">=</span> FeedFoward(n_embd, config)</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln1 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln2 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.sa(<span class="va">self</span>.ln1(x))</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.ffwd(<span class="va">self</span>.ln2(x))</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Transformer(nn.Module):</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, config, debug<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>        n_cb <span class="op">=</span> <span class="bu">len</span>(config.vocab_sizes)</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block_size, n_embd, n_head, n_layer <span class="op">=</span> config.seq_length, config.n_embd, config.n_heads, config.n_blocks </span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># seperate embeddings for pitch, step &amp; dur part of notes</span></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_embedding_tables <span class="op">=</span> nn.ModuleList([nn.Embedding(vocab_sizes[cbi], n_embd) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)])</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.position_embedding_table <span class="op">=</span> nn.Embedding(<span class="va">self</span>.block_size, n_embd)</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.blocks <span class="op">=</span> nn.Sequential(<span class="op">*</span>[Block(n_embd, n_head, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layer)])</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln_f <span class="op">=</span> nn.LayerNorm(n_embd) <span class="co"># final layer norm</span></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lm_heads <span class="op">=</span> nn.ModuleList([nn.Linear(n_embd, vocab_sizes[cbi]) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)]) <span class="co"># output token predictors</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.debug<span class="op">=</span><span class="va">False</span></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, idx, targets<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is array of input token indices in the current context</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>        B, T, CBS <span class="op">=</span> idx.shape</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>        tok_emb <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS): <span class="co"># just sum codebook reps</span></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>            tok_emb <span class="op">=</span> tok_emb <span class="op">+</span> <span class="va">self</span>.token_embedding_tables[cb](idx[:,:,cb])</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>        pos_emb <span class="op">=</span> <span class="va">self</span>.position_embedding_table(torch.arange(T, device<span class="op">=</span>idx.device)) <span class="co"># (T,E)</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tok_emb <span class="op">+</span> pos_emb <span class="co"># sum token embeddings &amp; positional embeddings</span></span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.blocks(x) <span class="co"># Main computation loop! </span></span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.ln_f(x)   <span class="co"># final layernorm</span></span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>        logits_list <span class="op">=</span> [head(x) <span class="cf">for</span> head <span class="kw">in</span> <span class="va">self</span>.lm_heads]  <span class="co"># list of output projections over all codebook values</span></span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> targets <span class="kw">is</span> <span class="va">None</span>:  <span class="co"># need targets to compute loss</span></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="va">None</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>            lambdas <span class="op">=</span> [<span class="fl">0.5</span>]<span class="op">*</span>CBS   <span class="co"># relative "weights" to pitch, step, dur parts of loss</span></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS):        <span class="co"># loop over codebooks  (for pitch, step &amp; dur), summing loss</span></span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  </span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>                B, T, V <span class="op">=</span> logits.shape   <span class="co"># V = vocab size, i.e. codebook length</span></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targets[:,:,cb]   <span class="co"># B, T </span></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits.view(B<span class="op">*</span>T, V)</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targ.reshape(B<span class="op">*</span>T)    <span class="co"># needs reshape &amp; not view b/c of contiguous memory issues.</span></span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss <span class="op">+</span>  lambdas[cb] <span class="op">*</span> F.cross_entropy(logits, targ)</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logits_list, loss</span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">@torch.no_grad</span>()</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, idx, max_new_tokens, temperature<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is (B, T, CBS) array of token indices in the current context</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_new_tokens):</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>            idx_cond <span class="op">=</span> idx[:, <span class="op">-</span><span class="va">self</span>.block_size:]      <span class="co"># crop idx to the last block_size tokens</span></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>            logits_list, loss <span class="op">=</span> <span class="va">self</span>(idx_cond)   <span class="co"># get the predictions</span></span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>            idx_next_list <span class="op">=</span> []</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(idx_cond.shape[<span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>                <span class="co"># focus only on the last time step</span></span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  <span class="co"># B, T, V  where V = vocab/embedding size </span></span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits[:, <span class="op">-</span><span class="dv">1</span>, :] <span class="co"># get last time.  becomes (B, V)</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>                <span class="co"># apply softmax to get probabilities</span></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> F.softmax(logits<span class="op">/</span>temperature, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, V)</span></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>                <span class="co"># sample from the distribution</span></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>                idx_next_list.append(torch.multinomial(probs, num_samples<span class="op">=</span><span class="dv">1</span>)) <span class="co"># (B, 1)</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>            idx_next <span class="op">=</span> torch.tensor(idx_next_list).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>).to(idx.device)</span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>            <span class="co"># append sampled index to the running sequence</span></span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> torch.cat((idx, idx_next), dim<span class="op">=</span><span class="dv">1</span>) <span class="co"># (B, T+1)</span></span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a><span class="co"># test that, make sure we don't get any errors: </span></span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="op">/</span><span class="fl">1e6</span>, <span class="st">'M parameters in the model'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.843947 M parameters in the model</code></pre>
</div>
</div>
</details></section>
<section id="preliminaries-before-training" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Preliminaries before Training</h1>
GPU device, Demo prompts, WandB logging, Re-Init
<details>
<summary>
Details
</summary>
<section id="set-up-the-gpucpu-device" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"mps"</span> <span class="cf">if</span> torch.backends.mps.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"device is"</span>,device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>device is mps</code></pre>
</div>
</div>
</section>
<section id="prompt-for-demos" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</h2>
<p>Let’s create a “prompt” from the validation dataset so we can monitor the models capabilities in producing “demos” of the music</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>demo_prompt_idx <span class="op">=</span> <span class="dv">0</span>    <span class="co"># file index from which to pull the demo prompt</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>demo_target <span class="op">=</span> val_notes_tl[demo_prompt_idx]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>display(midiplayer(demo_target, title<span class="op">=</span><span class="ss">f"Full demo 'target', </span><span class="sc">{</span><span class="bu">len</span>(demo_target)<span class="sc">}</span><span class="ss"> notes in length"</span>))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>demo_prompt_length <span class="op">=</span> <span class="dv">16</span>  <span class="co"># number of notes in demo prompt context</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>demo_max_new_tokens <span class="op">=</span> <span class="bu">min</span>(<span class="dv">150</span>, <span class="bu">len</span>(demo_target))  <span class="co"># try to make the whole song, but don't go on too long</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> demo_target[:demo_prompt_length]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>demo_prompt_length<span class="sc">}</span><span class="ss">-note 'prompt' for demos"</span>))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full demo 'target', 149 notes in length<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADlwDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAADJAAEAAAEFAaTIAADRAAEEAAENAAEUAgVM0AAA5QABAQABDAABIQIFUNEAAN0AAOQAAPAAAQACBUzQAAENAAEdAAEgAAEpAgVMwQAA3AABAQABHAABKAABMQIMmPEAAQACCPTAAADJAajIAADRAaTQAADVAajUAADdAADtAADwAajcAADlAADsAaThAADkAADtAAEFAAEMAAEpAAEwAajZAADgAaTYAADhAAEBAAEEAajRAADgAajQAADlAADsAADxAAEhAAEoAaTdAADkAajVAADcAAEAAAEVAAEgAAE1AgVM0QAA1AABDQABFAGoyQAA0AAA7QAA8AABBQABDAGkwQAAyAAA7AABBAABDQABIQABMQABNAIFTMAAAN0AAR0AASAAASkAATACDJzcAADlAADxAAEBAAEMAAEcAAEhAAEoAaUAAAEJAajdAADkAADtAADwAAEIAAENAAEgAAEpAajVAADcAaTRAADUAajJAADQAaTBAADIAADsAADxAAEoAAExAajAAADJAajIAADRAADtAADwAAEMAAERAAEpAAEwAaTJAADQAajBAADIAaS9AADAAai1AAC8AADsAADxAAEQAAEVAAEhAAEoAgVMtAAA1QABIAIFTMkAANQAAO0AAPAAAQ0AARQAAR0BqOwAAPEAAQUAAQwBqMgAAN0AAPAAAPkAAQQAAQ0CBUzBAADcAAD4AAEBAAEcAAEhAgyYvQAAwAAA+QABAAABIAABPQIFTLwAAMEAAPEAAPgAATEAATwBqL0AAMABqLwAAMEAAN0AAPABpMAAAMkAAQUAAQwAASkAATABqMgAANEAANwAAPEAAQQAAQ0AASEAASgBpMEAANABqMAAANUAAQwAARUAASAAASkBqNEAANQBpNAAANUAAO0AAPAAAQ0AARQBqNQAAN0AASgAATEBpNwAAOUAAOwAAQwAASEAATAAATUBqO0BqN0AAOQAAOwAAPEAATEAATQCBUzVAADcAADwAAENAAEdAAEgAAEpAAEwAaUVAAEcAakUAakFAaTBAADUAAEBAAEEAAEhAAEoAhHowAABAAABDAABIAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>16-note 'prompt' for demos<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AgVRAAGlFAIMnPAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="re-init-things" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="re-init-things"><span class="header-section-number">6.3</span> (Re-)Init Things</h2>
<p>Just to keep things ‘clean’, re-setup the datasets &amp; loaders for good measure, instantiate a model and optimizer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset(train_notes_tl, config.seq_length, len_mult<span class="op">=</span>config.batch_size)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">#model = BigramLanguageModel()</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>total_params_str <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())<span class="op">/</span><span class="fl">1e6</span><span class="sc">}</span><span class="ss"> M'</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(total_params_str,<span class="st">'parameters in the model'</span>)  </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op">=</span>config.learning_rate, weight_decay<span class="op">=</span>config.weight_decay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.843947 M parameters in the model</code></pre>
</div>
</div>
</section>
</details></section>
<section id="train-the-model" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Train the Model</h1>
<section id="optional-setup-wandb-run-tracking" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="optional-setup-wandb-run-tracking"><span class="header-section-number">7.1</span> Optional: Setup WandB Run Tracking</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>use_wandb <span class="op">=</span> <span class="va">True</span>  <span class="co"># Tip: leave this off at first, until you're sure everything's working!</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> use_wandb:</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> wandb </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    wandb.login()</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    wandb.init(project<span class="op">=</span><span class="st">"musicbox-jsb-tutorial"</span>, config<span class="op">=</span>config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>wandb: Currently logged in as: drscotthawley. Use `wandb login --relogin` to force relogin</code></pre>
</div>
<div class="cell-output cell-output-display">
wandb version 0.16.1 is available!  To upgrade, please run:
 $ pip install wandb --upgrade
</div>
<div class="cell-output cell-output-display">
Tracking run with wandb version 0.15.4
</div>
<div class="cell-output cell-output-display">
Run data is saved locally in <code>/Users/shawley/github/blog/posts/wandb/run-20231213_201630-okamoljp</code>
</div>
<div class="cell-output cell-output-display">
Syncing run <strong><a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/okamoljp" target="_blank">winter-rain-29</a></strong> to <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">Weights &amp; Biases</a> (<a href="https://wandb.me/run" target="_blank">docs</a>)<br>
</div>
<div class="cell-output cell-output-display">
 View project at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial</a>
</div>
<div class="cell-output cell-output-display">
 View run at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/okamoljp" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/okamoljp</a>
</div>
</div>
</section>
<section id="training-loop-go" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="training-loop-go"><span class="header-section-number">7.2</span> Training Loop: Go!</h2>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>val_every  <span class="op">=</span> <span class="dv">1</span> <span class="co"># in steps, evaluate loss on val dataset</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cp_every   <span class="op">=</span> <span class="dv">60</span> <span class="co"># in epochs, checkpoint every</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>demo_every <span class="op">=</span> <span class="dv">4</span> <span class="co"># in epochs, make a midi player demo</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>best_loss <span class="op">=</span> <span class="dv">999</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>ema_weight, loss_ema, val_loss_ema <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">None</span> , <span class="va">None</span> <span class="co"># exponential moving averages for loss reporting</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>step <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> {}</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> config.epochs</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,epochs<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    pbar <span class="op">=</span> tqdm(total<span class="op">=</span><span class="bu">len</span>(train_dl), desc<span class="op">=</span><span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>config<span class="sc">.</span>epochs<span class="sc">}</span><span class="ss">"</span>, dynamic_ncols<span class="op">=</span><span class="va">False</span>, ncols<span class="op">=</span><span class="dv">100</span>) <span class="co"># progress bar, per epoch</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bi, batch <span class="kw">in</span> <span class="bu">enumerate</span>(train_dl):</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> batch[<span class="dv">0</span>].to(device), batch[<span class="dv">1</span>].to(device)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        logits, loss <span class="op">=</span> model(xb, yb) <span class="co"># evaluate the loss</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        loss_ema <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>loss_ema <span class="cf">if</span> loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> loss.item()</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        losses[<span class="st">'train'</span>], losses[<span class="st">'train_ema'</span>] <span class="op">=</span> loss.item(), loss_ema</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad(set_to_none<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># status / diagnostics:</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (step <span class="op">%</span> val_every <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>                model.<span class="bu">eval</span>()</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>                xvb, yvb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(val_dl))</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>                val_logits, val_loss <span class="op">=</span> model( xvb.to(device), yvb.to(device) ) </span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>                val_loss_ema <span class="op">=</span>  (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>val_loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>val_loss_ema <span class="cf">if</span> val_loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> val_loss.item() </span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>                losses[<span class="st">'val'</span>], losses[<span class="st">'val_ema'</span>] <span class="op">=</span> val_loss.item(), val_loss_ema</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>            model.train()</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>        wbl_dict <span class="op">=</span> {<span class="st">'step'</span>:step, <span class="st">'epoch'</span>:epoch} <span class="op">|</span> losses   <span class="co"># dict for logging losses, midi examples, etc to wandb</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix( <span class="bu">dict</span>((k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>,<span class="st">'val_ema'</span>])) <span class="co"># loss info for progress bar</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        pbar.update(<span class="dv">1</span>)</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_wandb <span class="kw">and</span> wbl_dict <span class="op">!=</span> {}: wandb.log(wbl_dict)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--- end of epoch ---</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> losses[<span class="st">'val_ema'</span>] <span class="op">&lt;</span> best_loss: <span class="co"># Tracking best val_loss_ema for checkpointing purposes</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>        best_loss <span class="op">=</span> losses[<span class="st">'val_ema'</span>]</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix(<span class="bu">dict</span>( (k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]) <span class="op">|</span> {<span class="st">'BEST val_ema'</span>:best_loss})</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch) <span class="op">%</span> cp_every<span class="op">==</span><span class="dv">0</span>:   <span class="co"># occasionally save a checkpoint of best model/optimizer states</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>            cp_file <span class="op">=</span> <span class="ss">f"musicbox-jsb"</span> <span class="co">#    -{step}" # let's leave out step to avoid filling disk</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saving a checkpoint to </span><span class="sc">{</span>cp_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>            torch.save({ <span class="st">'step'</span>: step, <span class="st">'model_state_dict'</span>: model.state_dict(), <span class="st">'loss'</span>: loss,</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'optimizer_state_dict'</span>: optimizer.state_dict(),}, cp_file)</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>    pbar.refresh()</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    pbar.close()</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (epoch <span class="op">%</span> demo_every <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> (epoch<span class="op">==</span>epochs):  <span class="co"># demo of midi generation</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>            new_notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>demo_max_new_tokens, temperature<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].cpu() )</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>            p2 <span class="op">=</span> midiplayer(new_notes,title<span class="op">=</span><span class="ss">f"Demo on val dataset, Epoch=</span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>            display(p2)</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_wandb: wandb.log( {<span class="st">'step'</span>:step, <span class="st">'player'</span>:wandb.Html(p2.html)} )              </span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>        model.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 1/20: 100%|████████| 229/229 [00:47&lt;00:00,  4.81it/s, train=2.03, val=1.97, BEST val_ema=2.04]
Epoch 2/20: 100%|████████| 229/229 [00:46&lt;00:00,  4.89it/s, train=1.74, val=1.71, BEST val_ema=1.72]
Epoch 3/20: 100%|█████████| 229/229 [00:47&lt;00:00,  4.82it/s, train=1.44, val=1.54, BEST val_ema=1.5]
Epoch 4/20: 100%|█████████| 229/229 [00:47&lt;00:00,  4.84it/s, train=1.48, val=1.44, BEST val_ema=1.4]
Epoch 5/20: 100%|████████| 229/229 [00:49&lt;00:00,  4.67it/s, train=1.37, val=1.33, BEST val_ema=1.34]
Epoch 6/20: 100%|█████████| 229/229 [00:48&lt;00:00,  4.73it/s, train=1.31, val=1.22, BEST val_ema=1.3]
Epoch 7/20: 100%|████████| 229/229 [00:48&lt;00:00,  4.69it/s, train=1.28, val=1.24, BEST val_ema=1.27]
Epoch 8/20: 100%|████████| 229/229 [00:46&lt;00:00,  4.88it/s, train=1.25, val=1.14, BEST val_ema=1.24]
Epoch 9/20: 100%|████████| 229/229 [00:47&lt;00:00,  4.80it/s, train=1.18, val=1.25, BEST val_ema=1.23]
Epoch 10/20: 100%|████████| 229/229 [00:48&lt;00:00,  4.72it/s, train=1.24, val=1.2, BEST val_ema=1.21]
Epoch 11/20: 100%|████████| 229/229 [00:47&lt;00:00,  4.81it/s, train=1.12, val=1.24, BEST val_ema=1.2]
Epoch 12/20: 100%|███████| 229/229 [00:50&lt;00:00,  4.55it/s, train=1.15, val=1.15, BEST val_ema=1.19]
Epoch 13/20: 100%|████████| 229/229 [00:48&lt;00:00,  4.75it/s, train=1.12, val=1.2, BEST val_ema=1.19]
Epoch 14/20: 100%|███████| 229/229 [00:48&lt;00:00,  4.71it/s, train=1.15, val=1.19, BEST val_ema=1.18]
Epoch 15/20: 100%|███████| 229/229 [00:48&lt;00:00,  4.72it/s, train=1.06, val=1.24, BEST val_ema=1.18]
Epoch 16/20: 100%|████████████| 229/229 [00:46&lt;00:00,  4.96it/s, train=1.02, val=1.22, val_ema=1.18]
Epoch 17/20: 100%|████████████| 229/229 [00:48&lt;00:00,  4.70it/s, train=1.05, val=1.22, val_ema=1.18]
Epoch 18/20: 100%|█████████████| 229/229 [00:47&lt;00:00,  4.82it/s, train=1.02, val=1.2, val_ema=1.19]
Epoch 19/20: 100%|████████████| 229/229 [00:47&lt;00:00,  4.79it/s, train=1.04, val=1.21, val_ema=1.19]
Epoch 20/20: 100%|████████████████| 229/229 [00:47&lt;00:00,  4.82it/s, train=1, val=1.15, val_ema=1.2]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=4<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7QDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAGlBQABFAGotQAAyAABAQABBAGk0QIFUPAAAPEBpLQAAQABqNAAAQ0AARkBpQUAAQUAAQwAARUAARgAAR0BqQQAARUBqN0AAPAAAPkAAQQAAQ0AAQ0AARQAARQAARwAAR0BpRwAASEBqMEAAPgAAQEAAQwAAQwAASAAASEBpPkAAQABqK0AAMAAAN0AAO0AAPgAASAAASkCBUyhAACsAADcAADxAAEoAAExAgVMoAAAwQAA5QAA7AAA8AABFQABIQABMAIFUMAAAMkAANwAAOQAAPkAARQAASAAATUCBUzIAADdAAENAAEdAAE0AaTxAAD4AajcAAEMAAEcAAExAaiRAADwAAD5AAEdAaSQAADJAADlAADtAAD4AAEBAAEJAAEVAAEcAAEwAajdAADkAAEIAaS1AADIAADsAADxAAEAAAEFAAEUAajcAADwAAD5Aai0AAC5AADNAADlAAD4AAD5AAEEANH9ANX9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANDMAADkAAD4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANC4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7QDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAGlBQABFAGotQAAyAABAQABBAGk0QIFUPAAAPEBpLQAAQABqNAAAQ0AARkBpQUAAQUAAQwAARUAARgAAR0BqQQAARUBqN0AAPAAAPkAAQQAAQ0AAQ0AARQAARQAARwAAR0BpRwAASEBqMEAAPgAAQEAAQwAAQwAASAAASEBpPkAAQABqK0AAMAAAN0AAO0AAPgAASAAASkCBUyhAACsAADcAADxAAEoAAExAgVMoAAAwQAA5QAA7AAA8AABFQABIQABMAIFUMAAAMkAANwAAOQAAPkAARQAASAAATUCBUzIAADdAAENAAEdAAE0AaTxAAD4AajcAAEMAAEcAAExAaiRAADwAAD5AAEdAaSQAADJAADlAADtAAD4AAEBAAEJAAEVAAEcAAEwAajdAADkAAEIAaS1AADIAADsAADxAAEAAAEFAAEUAajcAADwAAD5Aai0AAC5AADNAADlAAD4AAD5AAEEANH9ANX9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANDMAADkAAD4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANC4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7QDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AgVQrAAAyQABAAGlBQABFAGotQAAyAABAQABBAGk0QIFUPAAAPEBpLQAAQABqNAAAQ0AARkBpQUAAQUAAQwAARUAARgAAR0BqQQAARUBqN0AAPAAAPkAAQQAAQ0AAQ0AARQAARQAARwAAR0BpRwAASEBqMEAAPgAAQEAAQwAAQwAASAAASEBpPkAAQABqK0AAMAAAN0AAO0AAPgAASAAASkCBUyhAACsAADcAADxAAEoAAExAgVMoAAAwQAA5QAA7AAA8AABFQABIQABMAIFUMAAAMkAANwAAOQAAPkAARQAASAAATUCBUzIAADdAAENAAEdAAE0AaTxAAD4AajcAAEMAAEcAAExAaiRAADwAAD5AAEdAaSQAADJAADlAADtAAD4AAEBAAEJAAEVAAEcAAEwAajdAADkAAEIAaS1AADIAADsAADxAAEAAAEFAAEUAajcAADwAAD5Aai0AAC5AADNAADlAAD4AAD5AAEEANH9ANX9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANDMAADkAAD4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANC4AAH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8ANX8AAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=8<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AaisAAC1Aai0AADVAAEAAAEVAaTRAADUAAEUAajJAADQAAD5AaTIAADRAADVAADxAAD4AajUAADdAADwAAENAAEUAajcAADwAAEMAAEdAaT5AajBAADQAADxAAD4AaTAAADwAAEVAajJAADVAAEFAAEcAajBAADUAADtAADxAAEBAAEUAaTIAADRAADsAAEEAajQAADVAADwAAEAAAENAaTUAADdAAEFAajcAADlAAEBAAEMAajdAAEEAaSlAADkAAD5AAEAAajcAaSkAAC9AADJAADdAADxAAD4AaiRAAC8AADIAADRAADcAaiQAADQAADZAADlAaTAAADYAAD5AaitAADwAAD4AaSsAADVAajUAADtAajkAAD5AaTJAADVAADsAAD5AajRAADUAAD4AAEBAaS1AADIAADQAADVAADxAAD4AAEAAAEFAai0AAC9Aai1AAC8AADBAADUAaStAAC0AaisAAC9AAEEAaS8AADAAADdAADwAAEBAai1AADcAADlAADxAAD5AAEAAailAAC0AAD4AAEBAaShAACkAADJAADVAAEAAaigAAD5AaStAADUAADkAADwAaisAACtAAC1AAC9AAD4Aai0AAENAaS1AAC8AADIAADxAgVMmQAAtAAA7QAA8AGokQAAmAAAmQAArAAA0QAA1QAA7AAA8QABDAGokAAAmAAAmQAAtQAA0AAA1AAA1QGk0QAA1AAA3QGolQAAmAAAtAAAtQAA0AAA5QAA8AIMmJQAANUAANwBqLQAANQAAOUBpNEAAPEBqMkAAOQAAQUA1QQAAR0A1MgAAMkAANAAAOQAAPAAAPkAAQUAARwBpLkBqLgAAMEAAMgAANEAAPEAAPgAAQEAAQQBpNAAANEBqQAAAQ0BqLUAANAAAPAAAPkBpLQAAMAAANUAAPEAAPgAAQUAAQwBqMkAANQAAN0BpMEAAMgAAPAAAQEAAQQBqLkAAMAAANUAANwAAPkBqOUAAPEAAPgAAQABpK0AALgAAOQAAOkAAPAAAPkCBUysAAC1AADRAADdAADoAajUAai0AADBAADQAAD4AAEBAaS9AADAAai8AADJAADVAAD5AAEAAaTBAADIAaitAADAAADUAADdAADtAAD4AAD5AgVM3AII9LUBqKwAANwAAOwBpK0AALQAAMkAAO0AAPgBqKUAAKwBpJEAAKQAAOwBqJAAAMgAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AaisAAC1Aai0AADVAAEAAAEVAaTRAADUAAEUAajJAADQAAD5AaTIAADRAADVAADxAAD4AajUAADdAADwAAENAAEUAajcAADwAAEMAAEdAaT5AajBAADQAADxAAD4AaTAAADwAAEVAajJAADVAAEFAAEcAajBAADUAADtAADxAAEBAAEUAaTIAADRAADsAAEEAajQAADVAADwAAEAAAENAaTUAADdAAEFAajcAADlAAEBAAEMAajdAAEEAaSlAADkAAD5AAEAAajcAaSkAAC9AADJAADdAADxAAD4AaiRAAC8AADIAADRAADcAaiQAADQAADZAADlAaTAAADYAAD5AaitAADwAAD4AaSsAADVAajUAADtAajkAAD5AaTJAADVAADsAAD5AajRAADUAAD4AAEBAaS1AADIAADQAADVAADxAAD4AAEAAAEFAai0AAC9Aai1AAC8AADBAADUAaStAAC0AaisAAC9AAEEAaS8AADAAADdAADwAAEBAai1AADcAADlAADxAAD5AAEAAailAAC0AAD4AAEBAaShAACkAADJAADVAAEAAaigAAD5AaStAADUAADkAADwAaisAACtAAC1AAC9AAD4Aai0AAENAaS1AAC8AADIAADxAgVMmQAAtAAA7QAA8AGokQAAmAAAmQAArAAA0QAA1QAA7AAA8QABDAGokAAAmAAAmQAAtQAA0AAA1AAA1QGk0QAA1AAA3QGolQAAmAAAtAAAtQAA0AAA5QAA8AIMmJQAANUAANwBqLQAANQAAOUBpNEAAPEBqMkAAOQAAQUA1QQAAR0A1MgAAMkAANAAAOQAAPAAAPkAAQUAARwBpLkBqLgAAMEAAMgAANEAAPEAAPgAAQEAAQQBpNAAANEBqQAAAQ0BqLUAANAAAPAAAPkBpLQAAMAAANUAAPEAAPgAAQUAAQwBqMkAANQAAN0BpMEAAMgAAPAAAQEAAQQBqLkAAMAAANUAANwAAPkBqOUAAPEAAPgAAQABpK0AALgAAOQAAOkAAPAAAPkCBUysAAC1AADRAADdAADoAajUAai0AADBAADQAAD4AAEBAaS9AADAAai8AADJAADVAAD5AAEAAaTBAADIAaitAADAAADUAADdAADtAAD4AAD5AgVM3AII9LUBqKwAANwAAOwBpK0AALQAAMkAAO0AAPgBqKUAAKwBpJEAAKQAAOwBqJAAAMgAB/y8A sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AaisAAC1Aai0AADVAAEAAAEVAaTRAADUAAEUAajJAADQAAD5AaTIAADRAADVAADxAAD4AajUAADdAADwAAENAAEUAajcAADwAAEMAAEdAaT5AajBAADQAADxAAD4AaTAAADwAAEVAajJAADVAAEFAAEcAajBAADUAADtAADxAAEBAAEUAaTIAADRAADsAAEEAajQAADVAADwAAEAAAENAaTUAADdAAEFAajcAADlAAEBAAEMAajdAAEEAaSlAADkAAD5AAEAAajcAaSkAAC9AADJAADdAADxAAD4AaiRAAC8AADIAADRAADcAaiQAADQAADZAADlAaTAAADYAAD5AaitAADwAAD4AaSsAADVAajUAADtAajkAAD5AaTJAADVAADsAAD5AajRAADUAAD4AAEBAaS1AADIAADQAADVAADxAAD4AAEAAAEFAai0AAC9Aai1AAC8AADBAADUAaStAAC0AaisAAC9AAEEAaS8AADAAADdAADwAAEBAai1AADcAADlAADxAAD5AAEAAailAAC0AAD4AAEBAaShAACkAADJAADVAAEAAaigAAD5AaStAADUAADkAADwAaisAACtAAC1AAC9AAD4Aai0AAENAaS1AAC8AADIAADxAgVMmQAAtAAA7QAA8AGokQAAmAAAmQAArAAA0QAA1QAA7AAA8QABDAGokAAAmAAAmQAAtQAA0AAA1AAA1QGk0QAA1AAA3QGolQAAmAAAtAAAtQAA0AAA5QAA8AIMmJQAANUAANwBqLQAANQAAOUBpNEAAPEBqMkAAOQAAQUA1QQAAR0A1MgAAMkAANAAAOQAAPAAAPkAAQUAARwBpLkBqLgAAMEAAMgAANEAAPEAAPgAAQEAAQQBpNAAANEBqQAAAQ0BqLUAANAAAPAAAPkBpLQAAMAAANUAAPEAAPgAAQUAAQwBqMkAANQAAN0BpMEAAMgAAPAAAQEAAQQBqLkAAMAAANUAANwAAPkBqOUAAPEAAPgAAQABpK0AALgAAOQAAOkAAPAAAPkCBUysAAC1AADRAADdAADoAajUAai0AADBAADQAAD4AAEBAaS9AADAAai8AADJAADVAAD5AAEAAaTBAADIAaitAADAAADUAADdAADtAAD4AAD5AgVM3AII9LUBqKwAANwAAOwBpK0AALQAAMkAAO0AAPgBqKUAAKwBpJEAAKQAAOwBqJAAAMgAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section776 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section776 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section776 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section776 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section776 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section776 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section776 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section776 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section776 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section776 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section776 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section776&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=12<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD6ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAAEAAAEFAAEdAaUBAAEEAAEUAajVAAEAAAENAAEcAAEhAaUgAAEpAajRAAEoAAEpAajJAADQAADdAADwAaTIAADUAADtAAEMAajsAADxAAExAaTcAADtAAEoAajlAADsAAEFAajdAADkAaTVAADcAAEVAAEwANUNAAEUANTlAAEEAAEFAAEMAgVMyQABBAABFQGo1AAA5AAA8AAA+QGkyAAA0QAA9QAA+AABAQABDQABFAABFQGpAAGk0AAA9AAA+QABBQABDAABFAABFQGo7QAA8QAA+AAA+QABAQABBAGo3QAA4QAA8AABAAABAQABFAGk3AAA5QAA7AAA8QAA+AGo4AAA4QAA5AAA5QAA8AABBQGk5AAA+QGotQAA4AAA+AABAAABAQABBAABIQDV/QDV/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAABAAABIAAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/ADV/AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD6ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAAEAAAEFAAEdAaUBAAEEAAEUAajVAAEAAAENAAEcAAEhAaUgAAEpAajRAAEoAAEpAajJAADQAADdAADwAaTIAADUAADtAAEMAajsAADxAAExAaTcAADtAAEoAajlAADsAAEFAajdAADkAaTVAADcAAEVAAEwANUNAAEUANTlAAEEAAEFAAEMAgVMyQABBAABFQGo1AAA5AAA8AAA+QGkyAAA0QAA9QAA+AABAQABDQABFAABFQGpAAGk0AAA9AAA+QABBQABDAABFAABFQGo7QAA8QAA+AAA+QABAQABBAGo3QAA4QAA8AABAAABAQABFAGk3AAA5QAA7AAA8QAA+AGo4AAA4QAA5AAA5QAA8AABBQGk5AAA+QGotQAA4AAA+AABAAABAQABBAABIQDV/QDV/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAABAAABIAAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/ADV/AAH/LwA= sound-font visualizer=&quot;#section776 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD6ADAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaS0AAC9Aai8AADBAajAAAEAAAEFAAEdAaUBAAEEAAEUAajVAAEAAAENAAEcAAEhAaUgAAEpAajRAAEoAAEpAajJAADQAADdAADwAaTIAADUAADtAAEMAajsAADxAAExAaTcAADtAAEoAajlAADsAAEFAajdAADkAaTVAADcAAEVAAEwANUNAAEUANTlAAEEAAEFAAEMAgVMyQABBAABFQGo1AAA5AAA8AAA+QGkyAAA0QAA9QAA+AABAQABDQABFAABFQGpAAGk0AAA9AAA+QABBQABDAABFAABFQGo7QAA8QAA+AAA+QABAQABBAGo3QAA4QAA8AABAAABAQABFAGk3AAA5QAA7AAA8QAA+AGo4AAA4QAA5AAA5QAA8AABBQGk5AAA+QGotQAA4AAA+AABAAABAQABBAABIQDV/QDV/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAABAAABIAAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/ADV/AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section911 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section911 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section911 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section911 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section911 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section911 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section911 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section911 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section911 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section911 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section911 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section911&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=16<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAAEAAAEFAaUUAakNAaUBAakAAAEEAajJAADwAAEFAAEVAaUEAAEMAajIAAEUAAEpAAE1AaUpAaj1AAEBAAEZAAEoAAEoAAExAAE0AgVM8QAA9AABAAABMAGpDQABMQGk1QABGAGo0QAA1AABDQABIQABMAGo8AABBQABDAABDAGk0AAA3QAA+QABBAABHQABIAGowQABAQABIQGk+AABDQABHAABIAGo3AABDAABEQGo+QGktQAAwAAA8QAA+AABAAABAQABEAABFQIFTLQAAL0AAPAAAPkAAQAAAQ0AARQAASkBqPgAAQEAASEAASgBqLwAANEAAPkAAQAAAR0AASABpPEAAPgAARUAARwBqNAAAOUAAQwBpMkAAOQAAPAAAPkAAQUBqOUBqN0AAQQAAQ0BpRQBqLUAAMgAANwAAO0AAPUAAPgBpLQAAL0AAOQAAPQAAPkBqLwAAMUAANEAAOwAAPgAAQEAAQwAARUBqL0AAMQBpLwAAOEAARQAAR0BqNAAANkAAO0AAQAAAQ0BpOAAAOUAAP0AAQwAARwBqMUAANEAANgAAOQAAPwAAQEBqMQAANAAAOwAARUBpKkAAOUAAQABqKEAAKgAAN0AAOQAAO0BpNwAAOUBqKAAANEAAN0AAOQAAOwAAPEAAQ0AARQCBUzQAADZAADcAADtAADwAAD5AgVM2AAA3QAA7AABDAABHQABKQGo5QAA+AGo0QAA3AAA5AABAQABIQABKAGkwQAAyQAA0AABFQABHAABHQABIAGowQAAyAABFAABFQABHAGkwAAA0QABDQABFAGoyQAA0AABHQGovQAAwAAAyAABDAGktQAAvAAAvQAA0QABFQIFTLQAAQAAAQ0AARQAARwCBVC8AAC9AADQAADZAAD5AAEBAAEMAaT1AAD4Aai5AAC8AADYAADdAAD0AAD5AAEAAAEJAgVMtQAAuAABAQABCAGorQAAtAAA7QABAAGkoQAAqQAArAAA5QAA7AAA+AAA+QABAQGooAAAqAAArQAA3AAA3QAA9QAA+AABAAGkrAAAtQAA0QAA3AAA5QAA9AAA+QDV/QDV/QDV/AAB/QDU5AAB/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAAA0AAA5AAA+AAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/ADR/AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAAEAAAEFAaUUAakNAaUBAakAAAEEAajJAADwAAEFAAEVAaUEAAEMAajIAAEUAAEpAAE1AaUpAaj1AAEBAAEZAAEoAAEoAAExAAE0AgVM8QAA9AABAAABMAGpDQABMQGk1QABGAGo0QAA1AABDQABIQABMAGo8AABBQABDAABDAGk0AAA3QAA+QABBAABHQABIAGowQABAQABIQGk+AABDQABHAABIAGo3AABDAABEQGo+QGktQAAwAAA8QAA+AABAAABAQABEAABFQIFTLQAAL0AAPAAAPkAAQAAAQ0AARQAASkBqPgAAQEAASEAASgBqLwAANEAAPkAAQAAAR0AASABpPEAAPgAARUAARwBqNAAAOUAAQwBpMkAAOQAAPAAAPkAAQUBqOUBqN0AAQQAAQ0BpRQBqLUAAMgAANwAAO0AAPUAAPgBpLQAAL0AAOQAAPQAAPkBqLwAAMUAANEAAOwAAPgAAQEAAQwAARUBqL0AAMQBpLwAAOEAARQAAR0BqNAAANkAAO0AAQAAAQ0BpOAAAOUAAP0AAQwAARwBqMUAANEAANgAAOQAAPwAAQEBqMQAANAAAOwAARUBpKkAAOUAAQABqKEAAKgAAN0AAOQAAO0BpNwAAOUBqKAAANEAAN0AAOQAAOwAAPEAAQ0AARQCBUzQAADZAADcAADtAADwAAD5AgVM2AAA3QAA7AABDAABHQABKQGo5QAA+AGo0QAA3AAA5AABAQABIQABKAGkwQAAyQAA0AABFQABHAABHQABIAGowQAAyAABFAABFQABHAGkwAAA0QABDQABFAGoyQAA0AABHQGovQAAwAAAyAABDAGktQAAvAAAvQAA0QABFQIFTLQAAQAAAQ0AARQAARwCBVC8AAC9AADQAADZAAD5AAEBAAEMAaT1AAD4Aai5AAC8AADYAADdAAD0AAD5AAEAAAEJAgVMtQAAuAABAQABCAGorQAAtAAA7QABAAGkoQAAqQAArAAA5QAA7AAA+AAA+QABAQGooAAAqAAArQAA3AAA3QAA9QAA+AABAAGkrAAAtQAA0QAA3AAA5QAA9AAA+QDV/QDV/QDV/AAB/QDU5AAB/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAAA0AAA5AAA+AAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/ADR/AAH/LwA= sound-font visualizer=&quot;#section911 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AailAACsAaikAAEAAAEFAaUUAakNAaUBAakAAAEEAajJAADwAAEFAAEVAaUEAAEMAajIAAEUAAEpAAE1AaUpAaj1AAEBAAEZAAEoAAEoAAExAAE0AgVM8QAA9AABAAABMAGpDQABMQGk1QABGAGo0QAA1AABDQABIQABMAGo8AABBQABDAABDAGk0AAA3QAA+QABBAABHQABIAGowQABAQABIQGk+AABDQABHAABIAGo3AABDAABEQGo+QGktQAAwAAA8QAA+AABAAABAQABEAABFQIFTLQAAL0AAPAAAPkAAQAAAQ0AARQAASkBqPgAAQEAASEAASgBqLwAANEAAPkAAQAAAR0AASABpPEAAPgAARUAARwBqNAAAOUAAQwBpMkAAOQAAPAAAPkAAQUBqOUBqN0AAQQAAQ0BpRQBqLUAAMgAANwAAO0AAPUAAPgBpLQAAL0AAOQAAPQAAPkBqLwAAMUAANEAAOwAAPgAAQEAAQwAARUBqL0AAMQBpLwAAOEAARQAAR0BqNAAANkAAO0AAQAAAQ0BpOAAAOUAAP0AAQwAARwBqMUAANEAANgAAOQAAPwAAQEBqMQAANAAAOwAARUBpKkAAOUAAQABqKEAAKgAAN0AAOQAAO0BpNwAAOUBqKAAANEAAN0AAOQAAOwAAPEAAQ0AARQCBUzQAADZAADcAADtAADwAAD5AgVM2AAA3QAA7AABDAABHQABKQGo5QAA+AGo0QAA3AAA5AABAQABIQABKAGkwQAAyQAA0AABFQABHAABHQABIAGowQAAyAABFAABFQABHAGkwAAA0QABDQABFAGoyQAA0AABHQGovQAAwAAAyAABDAGktQAAvAAAvQAA0QABFQIFTLQAAQAAAQ0AARQAARwCBVC8AAC9AADQAADZAAD5AAEBAAEMAaT1AAD4Aai5AAC8AADYAADdAAD0AAD5AAEAAAEJAgVMtQAAuAABAQABCAGorQAAtAAA7QABAAGkoQAAqQAArAAA5QAA7AAA+AAA+QABAQGooAAAqAAArQAA3AAA3QAA9QAA+AABAAGkrAAAtQAA0QAA3AAA5QAA9AAA+QDV/QDV/QDV/AAB/QDU5AAB/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDUtAAA0AAA5AAA+AAB/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/ADR/AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section430 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section430 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section430 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section430 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section430 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section430 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section430 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section430 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section430 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section430 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section430 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section430&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=20<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AAEFAaisAAC1AAEEAAEFAai0AADBAAEAAAEBAAEEAAENAaTAAADpAAD5AAEAAAEUAajVAADoAAD4AAEFAAEMAAEVAgVM5QABFAGovQAA8AGkvAAA1AAA3QAA5AAA+QABBAABDQGooQABAQGkoAAAyQAA3AAA5QABAAABBQABBQABDAGowQAAyAAA+AABAQABBAABBAGowAABAAABIQGk5AAA7QAA+QABIAABKQGo3QAA7AAA8QAA+AABAQABIQABKAGk1QAA3AAA5QAA8AAA8QABAAABDQABIAIFUNQAAN0AAPAAAPkAAQwAAR0BpOEAAOQAAPgAAQEBqNwAAOAAAOUAAPEAAQAAAQUAARwBpOQAAPAAARUBqNUAAO0AARQAASkBqQQCCPDNAADUAADVAADdAADlAADsAADxAAEoAgVQyQAAzAAA1AAA3AAA5AABFQIFTMgAANEAAQ0AARQBpMkBqMEAAMgBqMAAAMkAANAAAOkAAPABpLUAAMgAANkAAOgAAPEAAPkCBUytAAC0AADYAADdAADpAADwAAD4AAEBAAEMAajVAADcAaisAAC1AADRAADUAADlAADoAAD1AAEAAgVMmQAAtAAA0AAA9AAA+QABBQGk8QAA+AGomAAArQAAyQAA3QAA5AAA7QAA8AABBAABDQDV/QDV/QDR/QDV/AAB/QDV/AAB/AAB/QDV/AAB/QDV/AAB/QDQrAAAyAAA3AAA7AABDAAB/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/ADV/AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AAEFAaisAAC1AAEEAAEFAai0AADBAAEAAAEBAAEEAAENAaTAAADpAAD5AAEAAAEUAajVAADoAAD4AAEFAAEMAAEVAgVM5QABFAGovQAA8AGkvAAA1AAA3QAA5AAA+QABBAABDQGooQABAQGkoAAAyQAA3AAA5QABAAABBQABBQABDAGowQAAyAAA+AABAQABBAABBAGowAABAAABIQGk5AAA7QAA+QABIAABKQGo3QAA7AAA8QAA+AABAQABIQABKAGk1QAA3AAA5QAA8AAA8QABAAABDQABIAIFUNQAAN0AAPAAAPkAAQwAAR0BpOEAAOQAAPgAAQEBqNwAAOAAAOUAAPEAAQAAAQUAARwBpOQAAPAAARUBqNUAAO0AARQAASkBqQQCCPDNAADUAADVAADdAADlAADsAADxAAEoAgVQyQAAzAAA1AAA3AAA5AABFQIFTMgAANEAAQ0AARQBpMkBqMEAAMgBqMAAAMkAANAAAOkAAPABpLUAAMgAANkAAOgAAPEAAPkCBUytAAC0AADYAADdAADpAADwAAD4AAEBAAEMAajVAADcAaisAAC1AADRAADUAADlAADoAAD1AAEAAgVMmQAAtAAA0AAA9AAA+QABBQGk8QAA+AGomAAArQAAyQAA3QAA5AAA7QAA8AABBAABDQDV/QDV/QDR/QDV/AAB/QDV/AAB/AAB/QDV/AAB/QDV/AAB/QDQrAAAyAAA3AAA7AABDAAB/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/ADV/AAH/LwA= sound-font visualizer=&quot;#section430 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAD7gDAAACQMEAAPEAAQ0AASECBUzwAAEBAajAAADJAaTIAADRAajQAADVAajUAADdAAD5AAEAAAEdAAEgAaUFAAEMAai1AADcAADxAAD4AAEBAAEEAAEVAAEcAaStAAC0AAEFAaisAAC1AAEEAAEFAai0AADBAAEAAAEBAAEEAAENAaTAAADpAAD5AAEAAAEUAajVAADoAAD4AAEFAAEMAAEVAgVM5QABFAGovQAA8AGkvAAA1AAA3QAA5AAA+QABBAABDQGooQABAQGkoAAAyQAA3AAA5QABAAABBQABBQABDAGowQAAyAAA+AABAQABBAABBAGowAABAAABIQGk5AAA7QAA+QABIAABKQGo3QAA7AAA8QAA+AABAQABIQABKAGk1QAA3AAA5QAA8AAA8QABAAABDQABIAIFUNQAAN0AAPAAAPkAAQwAAR0BpOEAAOQAAPgAAQEBqNwAAOAAAOUAAPEAAQAAAQUAARwBpOQAAPAAARUBqNUAAO0AARQAASkBqQQCCPDNAADUAADVAADdAADlAADsAADxAAEoAgVQyQAAzAAA1AAA3AAA5AABFQIFTMgAANEAAQ0AARQBpMkBqMEAAMgBqMAAAMkAANAAAOkAAPABpLUAAMgAANkAAOgAAPEAAPkCBUytAAC0AADYAADdAADpAADwAAD4AAEBAAEMAajVAADcAaisAAC1AADRAADUAADlAADoAAD1AAEAAgVMmQAAtAAA0AAA9AAA+QABBQGk8QAA+AGomAAArQAAyQAA3QAA5AAA7QAA8AABBAABDQDV/QDV/QDR/QDV/AAB/QDV/AAB/AAB/QDV/AAB/QDV/AAB/QDQrAAAyAAA3AAA7AABDAAB/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDV/AAB/QDR/AAB/QDV/AAB/QDV/AAB/QDV/ADV/AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p><br> <br> …and that’s about as good as it’s going to get for now. 😕 Moving on…</p>
</section>
</section>
<section id="evaluate-the-model" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Evaluate the Model</h1>
<p>Now we’ll grab some data from the hitherto-unseen <code>test</code> dataset, and use it to prompt the model. We’ll see how it “scores” – in more ways than one!</p>
<section id="sample-generations" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sample-generations"><span class="header-section-number">8.1</span> Sample Generations</h2>
<p>First we’ll set a “prompt” from the <code>test</code> set to see how the model continues it.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>file_ind <span class="op">=</span> <span class="dv">1</span>  </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>original <span class="op">=</span> test_notes_tl[file_ind]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>num_tokens <span class="op">=</span> <span class="bu">len</span>(original)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>display(midiplayer(original, title<span class="op">=</span><span class="ss">f"Full Evaluation Target, </span><span class="sc">{</span>num_tokens<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>prompt_len <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> original[:prompt_len] </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"Evaluation Prompt, </span><span class="sc">{</span>prompt_len<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section66 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section66 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section66 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section66 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section66 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section66 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section66 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section66 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section66 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section66 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section66 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section66&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full Evaluation Target, 210 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A sound-font visualizer=&quot;#section66 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAajtAAD9AAEAAAEdAAEkAajdAADkAaTZAADcAADlAADsAAD8AAEBAAEcAAElAajRAADYAADdAADkAaTQAADZAADcAADlAAD5AAEAAAEkAAEpAajJAADYAAD4AAEVAAElAAEoAajIAADRAADkAAEBAAERAAEUAAEdAAEkAaT5AAEAAai1AADQAAD1AAD4AAEBAAEQAAEVAAEcAhHktAAAyQAA5QAA9AABAAABCQIFUMgAAM0AARQAAR0BpMwAANEBqOEAAOQAAQEAAQgAARwAASUBpNAAANUAAPUAAQABqOAAAO0AAPQAAREAASQAASkBqNQAANkAAOUAAOwAAQkAARABpNgAAOEAAOQAAO0AAQEAAQgAAR0AASgBqOAAAOUAAP0AAQABpOEAAOQAAPwAAQEAARwAATEA1QAAAQkA1NEAAOAAAOwAAQEAAQgAAREBqNAAAO0AARAAARUAATAAATkBpP0AAQAAAQkAARQBqNEAAOwAAPwAAQEAAQgAAREAATEAATgCBUzQAADlAAEQAAEVAAElAAEwAajhAADkAaTZAADgAAEAAAEJAajRAADYAAEkAAEpAaTJAADQAAEUAAEZAAEoAAExAajFAADIAai9AADEAAEYAAEdAAEpAAEwAaUVAAEcAai8AADRAAEBAAEIAAERAAEUAAElAAEoAaTJAADQAAEJAAEQAAEdAAEkAajFAADIAAEIAAEVAAEcAai9AADEAAD5AAEAAAEJAAEUAAEdANEIAAERANS1AAC8AAD1AAD4AAEQAAEVAAEcAAElAaj0AAD9AAEJAAEUAaS0AADRAAD8AAEBAAEIAAERAAEdAAEkAgVQtQAA0AABEAABFQABHAABJQGlEQABFAGotAAAyQAA+QABAAABCQABEAABFQABJAGkyAAA0QAA9QAA+AGoyQAA0AAA9AAA+QABFAABHQGoxQAAyAAA+AABAQABCAABEQABHAABJQDREAABGQDUvQAAxAABAAABCQABGAABHQABJAABKQIFTLwAANkAARkAARwAASUAASgBqQEAAQgBqNgAAN0AAPkAAQAAARgAAR0AASQBpNkAANwAARUBqNEAANgAAPgAAQEAAQ0AARQAARwAASUCBUzJAADQAADlAAEAAAEJAAEMAAEkAAEpAgVMtQAAyAABAQABCAABJQABKAGpAAABFQGktAAA0QAA5AAA7QABHQABJAGpEQABFAGo7AAA9QABFQABHAGk9AAA/QABCQABEAGo/AABAQABCAABEQABFAABMQGk0AAA2QABEAABFQGo2AAA4QABFAABHQGo0QAA4AABKQABMAGk0AAA5QABJQABKAGo4QAA5AAA9QABHAGk2QAA4AAA5QAA9AABAAABFQABJAABKQGo0QAA2AAA5AAA9QABJQABKAGoyQAA0AAA9AABCQABHQABJAGkvQAAyAAA+QABCAGovAAA0QAA7QAA+AABEQABFAGk7AABAQGotQAA0AAA9QABEAABFQABHAIZNLQAAPQAAQAAARQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section517 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section517 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section517 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section517 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section517 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section517 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section517 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section517 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section517 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section517 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section517 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section517&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Evaluation Prompt, 21 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA== sound-font visualizer=&quot;#section517 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUoAakAAajkAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>In what follows, we’ll vary the “temperature” parameter of the model (see the bottom of the previous lesson), to see its effect on what comes out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>new_tokens <span class="op">=</span> num_tokens <span class="op">-</span> prompt_len</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> temperature <span class="kw">in</span> [ <span class="fl">0.7</span>, <span class="fl">0.85</span>, <span class="fl">0.92</span>, <span class="fl">1.0</span>, <span class="fl">1.2</span>, <span class="fl">1.5</span>]:</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    set_seeds(<span class="dv">1337</span>) <span class="co"># same temp for same seed will yield same output</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>new_tokens, temperature<span class="op">=</span>temperature)[<span class="dv">0</span>].cpu() )</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    display(midiplayer(notes, title<span class="op">=</span><span class="ss">f"Temperature = </span><span class="sc">{</span>temperature<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.7<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAERAAEUAajgAADlAajkAADsAAD1AAD8AAEBAAEQAAEVAaT9AAEAAAEJAAEUAajRAAD0AAEBAAEIAAERAaTtAAD8AAEAAAEdAajQAADZAADpAADsAAEJAAEQAAEcAAElAajoAADtAAEBAAEIAaTYAADhAADsAAD1AAD9AAEAAAEdAAEkAajtAAD0AaTZAADgAADlAADsAAD8AAEJAAEVAAEcAajkAADtAajFAADYAADsAAD1AAERAAEUAgVMvQAAxAAA9AAA+QABCAABEAABEQIFTLwAANkAAPgAAQkAARAAAR0AASkBqQEAAQgBpNEAANgAAQAAAREAARUAARwAASUAASgBqNAAANkAAOUAAQkAARAAARQAASQAASkBpNgAAOEAAOQAAO0AAQEAAQgBqOAAAOUAAOwAAPUAAQAAAQEAARUAASgBqQAAAQkBpOEAAOQAAO0AAPQAAQEAAQgAAREAARQBqOAAAOUBpOQAAOwAAPkAAQAAAQkAARAAARUBqO0AAPUAAPgAAQEAAQEAAQgAAREAARQBqMkAAPQAAQAAAQAAAQkAARABpMgAANEAAOwAAQEAAQgAAREBqNAAANkAAOUAAQAAAQkAARAAARUBpOQAAO0AAP0AAQgBqNEAANgAAOwAAPUAAPwAAQEAAREAARQCBUypAADQAAEAAAEJAAEQAAEVAajtAAD0AaSoAADFAADhAADsAAD1AAEBAAEIAAEUAgVQvQAAxAAA2QAA4AAA9AAA/QABAAABHQIFTLwAAMUAANEAANgAAPUAAPwAARUAARwBpPQAAP0BqMQAAM0AANAAANkAAPwAAQEAAREAARQBqMwAANEAANgAAOEBpMkAANAAANkAAOAAAOkAAQAAAQkAARABqNEAANgBpI0AAMgAAOgAAO0AAQgAAREBqMkAANAA1MUAAMgA1IwAAJ0AAMQAAM0AAOkAAOwAAQ0AARACBUycAAC5AADJAADMAAEFAAEMAgVMyAAA2QAA6AGpJQGkuAAAwQAA2AAA4QABHQABJAIFTMAAAMUAAN0AAOAAAQQAARkAARwCBVDEAADNAADcAADhAAD9AAEYAAEdAaT8AAEFAajJAADMAADgAADpAAD9AAEEAAEJAAEcAaTFAADIAai9AADEAAEIAAERAajhAADoAaS5AAC8AADgAADpAAENAAEQAaidAADdAADhAADoAAD8AaS4AADBAADgAAD9AAEMAaicAaixAADAAADcAADhAADxAAD8AaSwAAC5AADVAADgAAD1AajNAADUAADdAADwAaSpAACxAAC4AADMAADcAADhAADxAAD0AAD9AailAACoAACwAAC5AADVAADgAADwAAD1AAD8AaikAAC4AADBAADNAADUAAD0AAD9AaTAAADFAADMAADVAADhAAD8AAEFAai5AADEAADUAADgAaS4AgVRBAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAERAAEUAajgAADlAajkAADsAAD1AAD8AAEBAAEQAAEVAaT9AAEAAAEJAAEUAajRAAD0AAEBAAEIAAERAaTtAAD8AAEAAAEdAajQAADZAADpAADsAAEJAAEQAAEcAAElAajoAADtAAEBAAEIAaTYAADhAADsAAD1AAD9AAEAAAEdAAEkAajtAAD0AaTZAADgAADlAADsAAD8AAEJAAEVAAEcAajkAADtAajFAADYAADsAAD1AAERAAEUAgVMvQAAxAAA9AAA+QABCAABEAABEQIFTLwAANkAAPgAAQkAARAAAR0AASkBqQEAAQgBpNEAANgAAQAAAREAARUAARwAASUAASgBqNAAANkAAOUAAQkAARAAARQAASQAASkBpNgAAOEAAOQAAO0AAQEAAQgBqOAAAOUAAOwAAPUAAQAAAQEAARUAASgBqQAAAQkBpOEAAOQAAO0AAPQAAQEAAQgAAREAARQBqOAAAOUBpOQAAOwAAPkAAQAAAQkAARAAARUBqO0AAPUAAPgAAQEAAQEAAQgAAREAARQBqMkAAPQAAQAAAQAAAQkAARABpMgAANEAAOwAAQEAAQgAAREBqNAAANkAAOUAAQAAAQkAARAAARUBpOQAAO0AAP0AAQgBqNEAANgAAOwAAPUAAPwAAQEAAREAARQCBUypAADQAAEAAAEJAAEQAAEVAajtAAD0AaSoAADFAADhAADsAAD1AAEBAAEIAAEUAgVQvQAAxAAA2QAA4AAA9AAA/QABAAABHQIFTLwAAMUAANEAANgAAPUAAPwAARUAARwBpPQAAP0BqMQAAM0AANAAANkAAPwAAQEAAREAARQBqMwAANEAANgAAOEBpMkAANAAANkAAOAAAOkAAQAAAQkAARABqNEAANgBpI0AAMgAAOgAAO0AAQgAAREBqMkAANAA1MUAAMgA1IwAAJ0AAMQAAM0AAOkAAOwAAQ0AARACBUycAAC5AADJAADMAAEFAAEMAgVMyAAA2QAA6AGpJQGkuAAAwQAA2AAA4QABHQABJAIFTMAAAMUAAN0AAOAAAQQAARkAARwCBVDEAADNAADcAADhAAD9AAEYAAEdAaT8AAEFAajJAADMAADgAADpAAD9AAEEAAEJAAEcAaTFAADIAai9AADEAAEIAAERAajhAADoAaS5AAC8AADgAADpAAENAAEQAaidAADdAADhAADoAAD8AaS4AADBAADgAAD9AAEMAaicAaixAADAAADcAADhAADxAAD8AaSwAAC5AADVAADgAAD1AajNAADUAADdAADwAaSpAACxAAC4AADMAADcAADhAADxAAD0AAD9AailAACoAACwAAC5AADVAADgAADwAAD1AAD8AaikAAC4AADBAADNAADUAAD0AAD9AaTAAADFAADMAADVAADhAAD8AAEFAai5AADEAADUAADgAaS4AgVRBAAH/LwA= sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE/wDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAERAAEUAajgAADlAajkAADsAAD1AAD8AAEBAAEQAAEVAaT9AAEAAAEJAAEUAajRAAD0AAEBAAEIAAERAaTtAAD8AAEAAAEdAajQAADZAADpAADsAAEJAAEQAAEcAAElAajoAADtAAEBAAEIAaTYAADhAADsAAD1AAD9AAEAAAEdAAEkAajtAAD0AaTZAADgAADlAADsAAD8AAEJAAEVAAEcAajkAADtAajFAADYAADsAAD1AAERAAEUAgVMvQAAxAAA9AAA+QABCAABEAABEQIFTLwAANkAAPgAAQkAARAAAR0AASkBqQEAAQgBpNEAANgAAQAAAREAARUAARwAASUAASgBqNAAANkAAOUAAQkAARAAARQAASQAASkBpNgAAOEAAOQAAO0AAQEAAQgBqOAAAOUAAOwAAPUAAQAAAQEAARUAASgBqQAAAQkBpOEAAOQAAO0AAPQAAQEAAQgAAREAARQBqOAAAOUBpOQAAOwAAPkAAQAAAQkAARAAARUBqO0AAPUAAPgAAQEAAQEAAQgAAREAARQBqMkAAPQAAQAAAQAAAQkAARABpMgAANEAAOwAAQEAAQgAAREBqNAAANkAAOUAAQAAAQkAARAAARUBpOQAAO0AAP0AAQgBqNEAANgAAOwAAPUAAPwAAQEAAREAARQCBUypAADQAAEAAAEJAAEQAAEVAajtAAD0AaSoAADFAADhAADsAAD1AAEBAAEIAAEUAgVQvQAAxAAA2QAA4AAA9AAA/QABAAABHQIFTLwAAMUAANEAANgAAPUAAPwAARUAARwBpPQAAP0BqMQAAM0AANAAANkAAPwAAQEAAREAARQBqMwAANEAANgAAOEBpMkAANAAANkAAOAAAOkAAQAAAQkAARABqNEAANgBpI0AAMgAAOgAAO0AAQgAAREBqMkAANAA1MUAAMgA1IwAAJ0AAMQAAM0AAOkAAOwAAQ0AARACBUycAAC5AADJAADMAAEFAAEMAgVMyAAA2QAA6AGpJQGkuAAAwQAA2AAA4QABHQABJAIFTMAAAMUAAN0AAOAAAQQAARkAARwCBVDEAADNAADcAADhAAD9AAEYAAEdAaT8AAEFAajJAADMAADgAADpAAD9AAEEAAEJAAEcAaTFAADIAai9AADEAAEIAAERAajhAADoAaS5AAC8AADgAADpAAENAAEQAaidAADdAADhAADoAAD8AaS4AADBAADgAAD9AAEMAaicAaixAADAAADcAADhAADxAAD8AaSwAAC5AADVAADgAAD1AajNAADUAADdAADwAaSpAACxAAC4AADMAADcAADhAADxAAD0AAD9AailAACoAACwAAC5AADVAADgAADwAAD1AAD8AaikAAC4AADBAADNAADUAAD0AAD9AaTAAADFAADMAADVAADhAAD8AAEFAai5AADEAADUAADgAaS4AgVRBAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.85<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFCQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAEUAAEdAajZAADgAajRAADYAADsAAEBAAERAAEcAaTQAADhAAD1AAD8Aai1AADgAAD0AAD1AAEQAAEVAgVMtAAAxQAA5QAA9AABFAABFQIFTMQAAM0AAOQAAO0AAQkAARQBqMwAAOwAAR0BpNEAAOEAAQAAAQEAAQgAARwAASUBqNAAANkAAOAAAOUAAP0AAQABqNEAANgAAOEAAOQAAPUAAPwAAREAASQBpNAAAOAAAR0BqMUAAO0AAPQAAQkAARABpMQAANkAAOwAAPkAAQgAAQkAARUAARwBqNgAAOEAAPgAAQEAAQgAAR0BqOAAAOUAAO0AAP0AAQAAAQkAARQAARwBpOUAAOwBqOEAAOQAAQEAAR0BpNkAAOABqNgAAOQAAOUAAPUAAPwAAQgAARUAARwCBUzJAADkAAD0AAD5AAEAAAEJAAEUAAEdAaj1AAD4AAEVAAEcAaTIAADRAADtAAD0AAERAAEUAajsAAEdAajJAADQAAEBAAEIAAEcAAElAaTIAADRAAEdAAEkAajQAADZAADpAAEJAAEQAAEcAgVM6AAA9QABAAABCAABGQIFTNgAAPQAARgAATEBqOEAAO0AAR0BpQkAARwBqOAAAOUAAOwAAQEAAQgAASUCBUzVAADkAAEAAAERAakwAaTUAADZAADtAAERAAEVAAEkAakJAAEQAAEUAajYAADlAADsAAD1AAEBAAEIAAEQAAElAgVM9AAA/QABAAABCQABHQABJAIFTOEAAOQAAPwAAQEAAQgAAREBqP0AAQABpMUAAM0AAOAAAPwAAQEAARAAARUAARwCBUzEAADMAADZAAElAajRAADYAajQAADhAAD9AAEAAAERAAEUAAEdAAEkAaTZAADgAajYAADpAAEJAAEQAAEcAAElAgVM6AAA7QAA/AABCAABHQABJAABLQGo6QGk7AAA9QABAQABHAABJQABLAGo6AAA7QGk2QAA9AABAAABAQABCQABGQABJAGo2AAA3QAA7AAA/QABAAGo3AAA4QABCAABGAABHQGk4AAA6QAA/AABAQABHAABJQGo6AAA7QABAAABCQABHQABJAABLQGk2QAA7AAA9QABCAABGQABHAABLAIR6NgAAPQAASUCBU0YAAEkAAExAgVM7QAA/QABHQABLQABMAIFUOwAAPUAAPwAAQEAAREAARwAASUAASwBpQkAARABqPQAAQAAAQgAARkAASQBpOEAAP0AAREAARgAAR0BqRAAARkAARwBqOAAARgAAS0BpNkAAO0AASwAATECBUzNAADYAADpAADsAAEtAAEwAhBA/AGo6AABDQIFTMwAAOEAAQwAAREAASwCBUzgAAEQAAEdAAEtAajpAAD1AAElAakcAAEsAaTdAADoAAD0AAD9AAEkAAEtAajcAADhAaS5AADgAAD1AAD8AAEZAgVQuAABGAABLAIFTPQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFCQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAEUAAEdAajZAADgAajRAADYAADsAAEBAAERAAEcAaTQAADhAAD1AAD8Aai1AADgAAD0AAD1AAEQAAEVAgVMtAAAxQAA5QAA9AABFAABFQIFTMQAAM0AAOQAAO0AAQkAARQBqMwAAOwAAR0BpNEAAOEAAQAAAQEAAQgAARwAASUBqNAAANkAAOAAAOUAAP0AAQABqNEAANgAAOEAAOQAAPUAAPwAAREAASQBpNAAAOAAAR0BqMUAAO0AAPQAAQkAARABpMQAANkAAOwAAPkAAQgAAQkAARUAARwBqNgAAOEAAPgAAQEAAQgAAR0BqOAAAOUAAO0AAP0AAQAAAQkAARQAARwBpOUAAOwBqOEAAOQAAQEAAR0BpNkAAOABqNgAAOQAAOUAAPUAAPwAAQgAARUAARwCBUzJAADkAAD0AAD5AAEAAAEJAAEUAAEdAaj1AAD4AAEVAAEcAaTIAADRAADtAAD0AAERAAEUAajsAAEdAajJAADQAAEBAAEIAAEcAAElAaTIAADRAAEdAAEkAajQAADZAADpAAEJAAEQAAEcAgVM6AAA9QABAAABCAABGQIFTNgAAPQAARgAATEBqOEAAO0AAR0BpQkAARwBqOAAAOUAAOwAAQEAAQgAASUCBUzVAADkAAEAAAERAakwAaTUAADZAADtAAERAAEVAAEkAakJAAEQAAEUAajYAADlAADsAAD1AAEBAAEIAAEQAAElAgVM9AAA/QABAAABCQABHQABJAIFTOEAAOQAAPwAAQEAAQgAAREBqP0AAQABpMUAAM0AAOAAAPwAAQEAARAAARUAARwCBUzEAADMAADZAAElAajRAADYAajQAADhAAD9AAEAAAERAAEUAAEdAAEkAaTZAADgAajYAADpAAEJAAEQAAEcAAElAgVM6AAA7QAA/AABCAABHQABJAABLQGo6QGk7AAA9QABAQABHAABJQABLAGo6AAA7QGk2QAA9AABAAABAQABCQABGQABJAGo2AAA3QAA7AAA/QABAAGo3AAA4QABCAABGAABHQGk4AAA6QAA/AABAQABHAABJQGo6AAA7QABAAABCQABHQABJAABLQGk2QAA7AAA9QABCAABGQABHAABLAIR6NgAAPQAASUCBU0YAAEkAAExAgVM7QAA/QABHQABLQABMAIFUOwAAPUAAPwAAQEAAREAARwAASUAASwBpQkAARABqPQAAQAAAQgAARkAASQBpOEAAP0AAREAARgAAR0BqRAAARkAARwBqOAAARgAAS0BpNkAAO0AASwAATECBUzNAADYAADpAADsAAEtAAEwAhBA/AGo6AABDQIFTMwAAOEAAQwAAREAASwCBUzgAAEQAAEdAAEtAajpAAD1AAElAakcAAEsAaTdAADoAAD0AAD9AAEkAAEtAajcAADhAaS5AADgAAD1AAD8AAEZAgVQuAABGAABLAIFTPQAB/y8A sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFCQDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajhAADkAaTZAADgAAD1AAD4AAEVAAEcAakBAAEIAaTYAADhAADtAAD0AAD9AAEAAAEUAAEdAajZAADgAajRAADYAADsAAEBAAERAAEcAaTQAADhAAD1AAD8Aai1AADgAAD0AAD1AAEQAAEVAgVMtAAAxQAA5QAA9AABFAABFQIFTMQAAM0AAOQAAO0AAQkAARQBqMwAAOwAAR0BpNEAAOEAAQAAAQEAAQgAARwAASUBqNAAANkAAOAAAOUAAP0AAQABqNEAANgAAOEAAOQAAPUAAPwAAREAASQBpNAAAOAAAR0BqMUAAO0AAPQAAQkAARABpMQAANkAAOwAAPkAAQgAAQkAARUAARwBqNgAAOEAAPgAAQEAAQgAAR0BqOAAAOUAAO0AAP0AAQAAAQkAARQAARwBpOUAAOwBqOEAAOQAAQEAAR0BpNkAAOABqNgAAOQAAOUAAPUAAPwAAQgAARUAARwCBUzJAADkAAD0AAD5AAEAAAEJAAEUAAEdAaj1AAD4AAEVAAEcAaTIAADRAADtAAD0AAERAAEUAajsAAEdAajJAADQAAEBAAEIAAEcAAElAaTIAADRAAEdAAEkAajQAADZAADpAAEJAAEQAAEcAgVM6AAA9QABAAABCAABGQIFTNgAAPQAARgAATEBqOEAAO0AAR0BpQkAARwBqOAAAOUAAOwAAQEAAQgAASUCBUzVAADkAAEAAAERAakwAaTUAADZAADtAAERAAEVAAEkAakJAAEQAAEUAajYAADlAADsAAD1AAEBAAEIAAEQAAElAgVM9AAA/QABAAABCQABHQABJAIFTOEAAOQAAPwAAQEAAQgAAREBqP0AAQABpMUAAM0AAOAAAPwAAQEAARAAARUAARwCBUzEAADMAADZAAElAajRAADYAajQAADhAAD9AAEAAAERAAEUAAEdAAEkAaTZAADgAajYAADpAAEJAAEQAAEcAAElAgVM6AAA7QAA/AABCAABHQABJAABLQGo6QGk7AAA9QABAQABHAABJQABLAGo6AAA7QGk2QAA9AABAAABAQABCQABGQABJAGo2AAA3QAA7AAA/QABAAGo3AAA4QABCAABGAABHQGk4AAA6QAA/AABAQABHAABJQGo6AAA7QABAAABCQABHQABJAABLQGk2QAA7AAA9QABCAABGQABHAABLAIR6NgAAPQAASUCBU0YAAEkAAExAgVM7QAA/QABHQABLQABMAIFUOwAAPUAAPwAAQEAAREAARwAASUAASwBpQkAARABqPQAAQAAAQgAARkAASQBpOEAAP0AAREAARgAAR0BqRAAARkAARwBqOAAARgAAS0BpNkAAO0AASwAATECBUzNAADYAADpAADsAAEtAAEwAhBA/AGo6AABDQIFTMwAAOEAAQwAAREAASwCBUzgAAEQAAEdAAEtAajpAAD1AAElAakcAAEsAaTdAADoAAD0AAD9AAEkAAEtAajcAADhAaS5AADgAAD1AAD8AAEZAgVQuAABGAABLAIFTPQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.92<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAAD4AAD9AajRAADYAADdAADsAAD8AAEBAAEcAAElAaTZAADcAajJAADQAADYAADlAAEAAAEJAAEdAAEkAaTIAADRAADhAADkAajQAADZAADgAADlAAD1AAEIAAEVAAEcAajYAADhAADtAAD0AaTZAADgAADkAADsAAD1AAERAAEUAajtAAD0AAD5AaTFAADYAADsAAD1AAD4AAEFAAEQAAERANX9ANX9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANTEAAD0AAEEAAEQAAH8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8ANH8AAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAAD4AAD9AajRAADYAADdAADsAAD8AAEBAAEcAAElAaTZAADcAajJAADQAADYAADlAAEAAAEJAAEdAAEkAaTIAADRAADhAADkAajQAADZAADgAADlAAD1AAEIAAEVAAEcAajYAADhAADtAAD0AaTZAADgAADkAADsAAD1AAERAAEUAajtAAD0AAD5AaTFAADYAADsAAD1AAD4AAEFAAEQAAERANX9ANX9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANTEAAD0AAEEAAEQAAH8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8ANH8AAf8vAA== sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAE9QDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAAD4AAD9AajRAADYAADdAADsAAD8AAEBAAEcAAElAaTZAADcAajJAADQAADYAADlAAEAAAEJAAEdAAEkAaTIAADRAADhAADkAajQAADZAADgAADlAAD1AAEIAAEVAAEcAajYAADhAADtAAD0AaTZAADgAADkAADsAAD1AAERAAEUAajtAAD0AAD5AaTFAADYAADsAAD1AAD4AAEFAAEQAAERANX9ANX9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANTEAAD0AAEEAAEQAAH8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANH8AAH9ANX8AAH9ANX8AAH9ANX8AAH9ANX8ANH8AAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.0<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAajRAADYAAD4AAEBAAENAAEcAaTQAADZAAEJAAEMAajRAADYAAEIAAENAgVM0AAA5QABDAABFQIFTNkAAOQAAPkAAQkAARQAASkBqOwAAQEAAQgAASUAASgBpNgAAN0AAPgAAPkAAQAAAQAAAR0AASQBqRwAASUBqNkAANwAAOUAAPgAASkBpOQAAPkAAQkAASQBqNgAAPgAAR0AASgBpOUAAPUAAQEBqRwBqMkAAOQAAPQAAPkAAQAAAQgAARUBpSUBqMgAANEAAPgAAQEAAQ0AARQAAR0BpNAAANkAAQAAAQkAAQwAASQAASkBqNEAANgAAQ0AARwAASUAASgBqQkAAQwAAR0AASQBpQgAARwAAR0CBUzQAAD5AAEBAaj1AAD4AAEAAAEBAaj0AAD5AaTpAAD4AAD5AAEAAAEJAakBAAEFAAEIAaTtAAEAAakBAAEEAAEcAajsAADxAAD4AAEAAAEJAaToAAEIAajdAAD5AAEIAAENAAEZAaTcAADlAajRAADkAADwAajtAAD4AAEMANDdAADsANTcAAD1AajQAADZAAD0AAEBAAEVAaTJAADYAAD5AAEAAAEJAAEYAaj1AAD4Aai1AADIAADRAAD0AAEBAAEIAaUNAai0AADJAADQAADZAAD5AAEAAAEUAAEVAgVNDAGpCQGkyAABFAGo5QAA9QABCAABJQIFTPQAAPgAAQEAAQEAASQAASkBqNgBpN0AAOQAAPkAAQAAAQAAAQ0AASgAATECBUzZAADcAAD1AAD4AAEMAAEVAAEpAAEwAgVQ2AAA3QAA9AAA+QGk8QAA+AGo3AABDQABFAABKAGkyQAA8AAA+QABFQABOQGo3QABDAABOAABTQGoyAAA0QAA3AAA7QAA+AABDQABFAGlCQABDAABRQGo0AAA7AAA8QABTAGkzQAA8AABAQGo5QABCAGozAAA7QABAAABKQABPQABRAGk5AABCQABIQABKAGo3QAA7AAA7QABCAABHQABIAABOQABPAGlDQABHAGo7AAA8QABDAABFQGpAQABFAGkvQAA3AAA8AAA+QABAAABCQABHQABOAIFTLwAAOUCBVD1AAD4AAEIAAExAaTkAAEwAAE9Aaj0AAD5AAEVAAE5AAE8AgVM+AABFAABHAABOAABRQGpAQABDQABHQABPQABRAGlCQABDAABFQABHAABPAABRQGo3QAA+QABAAABCAABFAABHQABRAABTQGk3AAA5QAA+AABAQABHAABJQABRQABTAGpHQABJAGo5AAA7QABAAABCQABHAABKQABRAIR5OwAASgAAU0BqQ0BpQgBqPEAATECBUztAADwAAEJAAEVAAEtAAEwAgVNDAABTAIFUOwAAQEAARQAASwAATECBUz5AAEAAAEdAAEwAAE5AgVM3QAA+AABHAIFTNwAATgCBU0IAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAajRAADYAAD4AAEBAAENAAEcAaTQAADZAAEJAAEMAajRAADYAAEIAAENAgVM0AAA5QABDAABFQIFTNkAAOQAAPkAAQkAARQAASkBqOwAAQEAAQgAASUAASgBpNgAAN0AAPgAAPkAAQAAAQAAAR0AASQBqRwAASUBqNkAANwAAOUAAPgAASkBpOQAAPkAAQkAASQBqNgAAPgAAR0AASgBpOUAAPUAAQEBqRwBqMkAAOQAAPQAAPkAAQAAAQgAARUBpSUBqMgAANEAAPgAAQEAAQ0AARQAAR0BpNAAANkAAQAAAQkAAQwAASQAASkBqNEAANgAAQ0AARwAASUAASgBqQkAAQwAAR0AASQBpQgAARwAAR0CBUzQAAD5AAEBAaj1AAD4AAEAAAEBAaj0AAD5AaTpAAD4AAD5AAEAAAEJAakBAAEFAAEIAaTtAAEAAakBAAEEAAEcAajsAADxAAD4AAEAAAEJAaToAAEIAajdAAD5AAEIAAENAAEZAaTcAADlAajRAADkAADwAajtAAD4AAEMANDdAADsANTcAAD1AajQAADZAAD0AAEBAAEVAaTJAADYAAD5AAEAAAEJAAEYAaj1AAD4Aai1AADIAADRAAD0AAEBAAEIAaUNAai0AADJAADQAADZAAD5AAEAAAEUAAEVAgVNDAGpCQGkyAABFAGo5QAA9QABCAABJQIFTPQAAPgAAQEAAQEAASQAASkBqNgBpN0AAOQAAPkAAQAAAQAAAQ0AASgAATECBUzZAADcAAD1AAD4AAEMAAEVAAEpAAEwAgVQ2AAA3QAA9AAA+QGk8QAA+AGo3AABDQABFAABKAGkyQAA8AAA+QABFQABOQGo3QABDAABOAABTQGoyAAA0QAA3AAA7QAA+AABDQABFAGlCQABDAABRQGo0AAA7AAA8QABTAGkzQAA8AABAQGo5QABCAGozAAA7QABAAABKQABPQABRAGk5AABCQABIQABKAGo3QAA7AAA7QABCAABHQABIAABOQABPAGlDQABHAGo7AAA8QABDAABFQGpAQABFAGkvQAA3AAA8AAA+QABAAABCQABHQABOAIFTLwAAOUCBVD1AAD4AAEIAAExAaTkAAEwAAE9Aaj0AAD5AAEVAAE5AAE8AgVM+AABFAABHAABOAABRQGpAQABDQABHQABPQABRAGlCQABDAABFQABHAABPAABRQGo3QAA+QABAAABCAABFAABHQABRAABTQGk3AAA5QAA+AABAQABHAABJQABRQABTAGpHQABJAGo5AAA7QABAAABCQABHAABKQABRAIR5OwAASgAAU0BqQ0BpQgBqPEAATECBUztAADwAAEJAAEVAAEtAAEwAgVNDAABTAIFUOwAAQEAARQAASwAATECBUz5AAEAAAEdAAEwAAE5AgVM3QAA+AABHAIFTNwAATgCBU0IAAf8vAA== sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBwDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAEpAAEwAaUlAAEoAaj5AAEAAAEJAAEdAAEkAajdAADkAaTZAADcAAD1AAD4AAEVAAEcAakBAAEIAaTYAADdAADtAAD0AAD5AAEAAAEUAAEdAajZAADcAajRAADYAAD4AAEBAAENAAEcAaTQAADZAAEJAAEMAajRAADYAAEIAAENAgVM0AAA5QABDAABFQIFTNkAAOQAAPkAAQkAARQAASkBqOwAAQEAAQgAASUAASgBpNgAAN0AAPgAAPkAAQAAAQAAAR0AASQBqRwAASUBqNkAANwAAOUAAPgAASkBpOQAAPkAAQkAASQBqNgAAPgAAR0AASgBpOUAAPUAAQEBqRwBqMkAAOQAAPQAAPkAAQAAAQgAARUBpSUBqMgAANEAAPgAAQEAAQ0AARQAAR0BpNAAANkAAQAAAQkAAQwAASQAASkBqNEAANgAAQ0AARwAASUAASgBqQkAAQwAAR0AASQBpQgAARwAAR0CBUzQAAD5AAEBAaj1AAD4AAEAAAEBAaj0AAD5AaTpAAD4AAD5AAEAAAEJAakBAAEFAAEIAaTtAAEAAakBAAEEAAEcAajsAADxAAD4AAEAAAEJAaToAAEIAajdAAD5AAEIAAENAAEZAaTcAADlAajRAADkAADwAajtAAD4AAEMANDdAADsANTcAAD1AajQAADZAAD0AAEBAAEVAaTJAADYAAD5AAEAAAEJAAEYAaj1AAD4Aai1AADIAADRAAD0AAEBAAEIAaUNAai0AADJAADQAADZAAD5AAEAAAEUAAEVAgVNDAGpCQGkyAABFAGo5QAA9QABCAABJQIFTPQAAPgAAQEAAQEAASQAASkBqNgBpN0AAOQAAPkAAQAAAQAAAQ0AASgAATECBUzZAADcAAD1AAD4AAEMAAEVAAEpAAEwAgVQ2AAA3QAA9AAA+QGk8QAA+AGo3AABDQABFAABKAGkyQAA8AAA+QABFQABOQGo3QABDAABOAABTQGoyAAA0QAA3AAA7QAA+AABDQABFAGlCQABDAABRQGo0AAA7AAA8QABTAGkzQAA8AABAQGo5QABCAGozAAA7QABAAABKQABPQABRAGk5AABCQABIQABKAGo3QAA7AAA7QABCAABHQABIAABOQABPAGlDQABHAGo7AAA8QABDAABFQGpAQABFAGkvQAA3AAA8AAA+QABAAABCQABHQABOAIFTLwAAOUCBVD1AAD4AAEIAAExAaTkAAEwAAE9Aaj0AAD5AAEVAAE5AAE8AgVM+AABFAABHAABOAABRQGpAQABDQABHQABPQABRAGlCQABDAABFQABHAABPAABRQGo3QAA+QABAAABCAABFAABHQABRAABTQGk3AAA5QAA+AABAQABHAABJQABRQABTAGpHQABJAGo5AAA7QABAAABCQABHAABKQABRAIR5OwAASgAAU0BqQ0BpQgBqPEAATECBUztAADwAAEJAAEVAAEtAAEwAgVNDAABTAIFUOwAAQEAARQAASwAATECBUz5AAEAAAEdAAEwAAE5AgVM3QAA+AABHAIFTNwAATgCBU0IAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.2<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAaj5AAEAAAERAajkAAD1AAD4AAEQAaT0AAEVAAElAajhAAEUAAEdAaTZAADgAAEJAAEVAAEcAAEkAAEpAAEwAajYAADhAajgAADlAAElAAEoAaTkAADtAAD1AAEUAajlAADsAaTJAADkAAD0AAEJAAEVAgVQxQAAyAABCAABFAABHQABMQIFTMQAAOkAAQgAAQ0AARwAASkAATABpOEAAOUAAOgAAQEAAQwAARUAASQBqOAAAOQAARQAASUAASgCBUz1AAERAAEdAAEkAajZAAD0AAEJAAEQAaTRAADYAAEAAAEBAAEIAAERAAEcAAEdAgVQyQAA0AAA5QABAAABCQABEAABHAGk5AABJQGoyAAA0QABCAABEQABMQGk0AAA2QABAQABEAABEQABJAABKQABMAGo0QAA2AAA+QABAAABEAGo0AAA+AABFQABJQGk7QABFAABHQABJAABPQGo5QAA7AABAQABJQABKAABPAGkyQABAAABCQABHADUyAABFQDU5AABFAABHQABJAGpKQGk2QGpFQGk2AAA4QABAQABCAABFAABHAABHQGo4AAA5QABFQABHAABKAGo5AABJQIMmN0AAQAAARQAAR0AASQAAT0BqNwAAO0AAPkAARwBpOwAAPUAAPgAAQEAATEBqPQAAPkAAQAAAQkAASkAATAAATwBpSgAAU0BqNEAAQgAAQ0AAT0AAUwCBUzQAAEBAAEMAaj4AAElAaTlAAEAAAEVAAE8AakNAajJAADkAAEJAAEMAAEkAAEpAgyYyAAA+QABCAABKAABOQIFTPUAAPgAAQEAARQAATgAAT0CBUz0AAD1AAD5AAEAAAEBAAEdAAE5AAE8Aak4AAE9AajpAAD4AAEAAAEJAAEcAAExAAE8Agjw9AGo6AAA7QABCAABDQABKQABMAGo5QAA7AGk5AAA8QABDAABFQGo8AGk3QABFAABKAABOQABTQGpAQABOAABPQGo3AABAAABCQABHQABKQABPAGlRQABTAGo3QABCAABDQABHAABRAABTQIFTNwAAQEAAQUAAQwAASgAATEBqSkAATABpNkAAPkAAQAAAQQAAUUAAUwCDJzYAAD4AaUoAajlAAEBAAEVAAElAAE5AaUAAAENAAEUAAE4AAE9AAFEAajkAAD5AAEMAAEVAAEkAAE5AAE8AgyZFAIFUOUAAPUAAPgAAQECBUzkAADtAAD0AAD5AAEAAAEdAAE4AAE9AaT4AAEBAajsAAEAAAEcAAE8AAE9AajZAADxAAD5AAEVAAEVAaTYAADdAAD4AAEUAAEdAAE8AajwAAEVAaTRAADcAAENAAEUAAEUAAExAgVQ0AAA2QABCQABDAABKQABMAIFTNgAAN0AAQgAAQ0AASgAATEBpQkAAQwAASkAATABqMkAANwAAQgAARUA1f0A1f0A0fwAAf0A1RwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1MgAARQAASgAAfwA0fwAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAaj5AAEAAAERAajkAAD1AAD4AAEQAaT0AAEVAAElAajhAAEUAAEdAaTZAADgAAEJAAEVAAEcAAEkAAEpAAEwAajYAADhAajgAADlAAElAAEoAaTkAADtAAD1AAEUAajlAADsAaTJAADkAAD0AAEJAAEVAgVQxQAAyAABCAABFAABHQABMQIFTMQAAOkAAQgAAQ0AARwAASkAATABpOEAAOUAAOgAAQEAAQwAARUAASQBqOAAAOQAARQAASUAASgCBUz1AAERAAEdAAEkAajZAAD0AAEJAAEQAaTRAADYAAEAAAEBAAEIAAERAAEcAAEdAgVQyQAA0AAA5QABAAABCQABEAABHAGk5AABJQGoyAAA0QABCAABEQABMQGk0AAA2QABAQABEAABEQABJAABKQABMAGo0QAA2AAA+QABAAABEAGo0AAA+AABFQABJQGk7QABFAABHQABJAABPQGo5QAA7AABAQABJQABKAABPAGkyQABAAABCQABHADUyAABFQDU5AABFAABHQABJAGpKQGk2QGpFQGk2AAA4QABAQABCAABFAABHAABHQGo4AAA5QABFQABHAABKAGo5AABJQIMmN0AAQAAARQAAR0AASQAAT0BqNwAAO0AAPkAARwBpOwAAPUAAPgAAQEAATEBqPQAAPkAAQAAAQkAASkAATAAATwBpSgAAU0BqNEAAQgAAQ0AAT0AAUwCBUzQAAEBAAEMAaj4AAElAaTlAAEAAAEVAAE8AakNAajJAADkAAEJAAEMAAEkAAEpAgyYyAAA+QABCAABKAABOQIFTPUAAPgAAQEAARQAATgAAT0CBUz0AAD1AAD5AAEAAAEBAAEdAAE5AAE8Aak4AAE9AajpAAD4AAEAAAEJAAEcAAExAAE8Agjw9AGo6AAA7QABCAABDQABKQABMAGo5QAA7AGk5AAA8QABDAABFQGo8AGk3QABFAABKAABOQABTQGpAQABOAABPQGo3AABAAABCQABHQABKQABPAGlRQABTAGo3QABCAABDQABHAABRAABTQIFTNwAAQEAAQUAAQwAASgAATEBqSkAATABpNkAAPkAAQAAAQQAAUUAAUwCDJzYAAD4AaUoAajlAAEBAAEVAAElAAE5AaUAAAENAAEUAAE4AAE9AAFEAajkAAD5AAEMAAEVAAEkAAE5AAE8AgyZFAIFUOUAAPUAAPgAAQECBUzkAADtAAD0AAD5AAEAAAEdAAE4AAE9AaT4AAEBAajsAAEAAAEcAAE8AAE9AajZAADxAAD5AAEVAAEVAaTYAADdAAD4AAEUAAEdAAE8AajwAAEVAaTRAADcAAENAAEUAAEUAAExAgVQ0AAA2QABCQABDAABKQABMAIFTNgAAN0AAQgAAQ0AASgAATEBpQkAAQwAASkAATABqMkAANwAAQgAARUA1f0A1f0A0fwAAf0A1RwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1MgAARQAASgAAfwA0fwAB/y8A sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFBgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAaj5AAEAAAERAajkAAD1AAD4AAEQAaT0AAEVAAElAajhAAEUAAEdAaTZAADgAAEJAAEVAAEcAAEkAAEpAAEwAajYAADhAajgAADlAAElAAEoAaTkAADtAAD1AAEUAajlAADsAaTJAADkAAD0AAEJAAEVAgVQxQAAyAABCAABFAABHQABMQIFTMQAAOkAAQgAAQ0AARwAASkAATABpOEAAOUAAOgAAQEAAQwAARUAASQBqOAAAOQAARQAASUAASgCBUz1AAERAAEdAAEkAajZAAD0AAEJAAEQAaTRAADYAAEAAAEBAAEIAAERAAEcAAEdAgVQyQAA0AAA5QABAAABCQABEAABHAGk5AABJQGoyAAA0QABCAABEQABMQGk0AAA2QABAQABEAABEQABJAABKQABMAGo0QAA2AAA+QABAAABEAGo0AAA+AABFQABJQGk7QABFAABHQABJAABPQGo5QAA7AABAQABJQABKAABPAGkyQABAAABCQABHADUyAABFQDU5AABFAABHQABJAGpKQGk2QGpFQGk2AAA4QABAQABCAABFAABHAABHQGo4AAA5QABFQABHAABKAGo5AABJQIMmN0AAQAAARQAAR0AASQAAT0BqNwAAO0AAPkAARwBpOwAAPUAAPgAAQEAATEBqPQAAPkAAQAAAQkAASkAATAAATwBpSgAAU0BqNEAAQgAAQ0AAT0AAUwCBUzQAAEBAAEMAaj4AAElAaTlAAEAAAEVAAE8AakNAajJAADkAAEJAAEMAAEkAAEpAgyYyAAA+QABCAABKAABOQIFTPUAAPgAAQEAARQAATgAAT0CBUz0AAD1AAD5AAEAAAEBAAEdAAE5AAE8Aak4AAE9AajpAAD4AAEAAAEJAAEcAAExAAE8Agjw9AGo6AAA7QABCAABDQABKQABMAGo5QAA7AGk5AAA8QABDAABFQGo8AGk3QABFAABKAABOQABTQGpAQABOAABPQGo3AABAAABCQABHQABKQABPAGlRQABTAGo3QABCAABDQABHAABRAABTQIFTNwAAQEAAQUAAQwAASgAATEBqSkAATABpNkAAPkAAQAAAQQAAUUAAUwCDJzYAAD4AaUoAajlAAEBAAEVAAElAAE5AaUAAAENAAEUAAE4AAE9AAFEAajkAAD5AAEMAAEVAAEkAAE5AAE8AgyZFAIFUOUAAPUAAPgAAQECBUzkAADtAAD0AAD5AAEAAAEdAAE4AAE9AaT4AAEBAajsAAEAAAEcAAE8AAE9AajZAADxAAD5AAEVAAEVAaTYAADdAAD4AAEUAAEdAAE8AajwAAEVAaTRAADcAAENAAEUAAEUAAExAgVQ0AAA2QABCQABDAABKQABMAIFTNgAAN0AAQgAAQ0AASgAATEBpQkAAQwAASkAATABqMkAANwAAQgAARUA1f0A1f0A0fwAAf0A1RwAAfwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A0fwAAf0A1fwAAf0A1fwAAf0A1fwAAf0A1MgAARQAASgAAfwA0fwAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.5<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFGgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAakAAAEpAajJAADkAaTIAADRAADZAAEBAajQAAEdAAElAAEoAaTFAADYAAEVAAEcAAEkAAEwAai9AADEAAEJAakAAaUIAAEpAai8AADFAaTEAADJAAEJAgVQ7QABKAIFTQ0AARQCBUy1AAEMAAEhAajRAaS0AADIAADdAAEIAAENAAEgAajQAAEdAaTcAajNAADRAADxAAEcAajMAADQAADVAAEMAaTUAADhAADwAAEBAAEVAajFAADgAAD1AAERAAEUAaTsAAEAAai9AADEAAD0AAD5AakNAaS8AADJAAEFAAEQAgVMyAAA8QABBAABBQGpDAGo7QIFTOwAAPAAAcECBU0VAgVNBAIFTPkAAcACBVDRAAD4AAERAAExARj4AIzQAADVAajUAADdAADlAAENAAEQAAEUAaTRAADcAajQAADVAajUAADdAaTRAADcAADkAADtAAEdAAEwAhHo0AAA7AABPQIFTRwAAV0CBUyhAAEBAAEMAAFcAajJAAEFAaSgAAEAAAEEAAEVAajIAAEUAAEdAaj1AAEVAAEcAAE9AaU1AAE8AajxAAD0AAD9AAE0AAE9AgVNPAIFTRQCBUzwAAD5AAD8AAENAAE1AAE8AgVQ8QGlDAABFQGo6QAA8AAA+AABKQIFTOgAAQ0AARQAARkAASgAATEAATQCBUy1AAEMAAEYAAEhAgVMtAABBQABIAABTQIFUNEAANEAANUAAQQAAQ0AAREAATAAAUwCBUzQAADdAAEMAaUQAajQAADcAAEZAAEhAakRAaTBAAEBAAENAAEgAakQANTUANDAAAEMAAElAakYAAEZAajhAAD9AAEAAAEhAAEkAaUYAAFBAajFAADgAAD1AAD8AAE1AAFAAaTEAADNAajMAADpAAEtAAExAAE0Agj09AGk5QAA6AAA8QABBQABIAABLAABMAABNQIFUOQAAPAAAPEAASEBpOkAAPABqN0AAOgAAOkAAQQAARkAASACBUzcAADxAAENAAEYAAFBAajNAADoAaTwAADxAAE0AAFAAAFVAhBAzAGo3QAA8AABTQABVAIFTMUAANwAATEAAUkAAUwBqQkAATABpMQAASkAAUgBqN0AASgAAVEBpQwBqSEAAUUAAVABqQ0AAR0AAT0AAUQA0TUAATwA1NwAAPEAAQgAARkAARwAASAAATEAATQBqSUCBUzlAAEkAAFBAakMAAEwAhBA5AABBQABIQABQAGlGAGo8QABBAABDQABMQIFTNUAAPAAAQUAAQwAAREAAREAASAAATABqPAAAP0AAQQAAQkAARABpNQAAPwAAS0CBUzhAAEhAaklAAEsAajBAADgAAD9AAEIAAEkAAEtAaUQAajAAADZAAD8AAEFAAEsAAE1AgVM2AAA3QABBAABDQABLQABNAIMmSACBVEMAAEZAaTcAajhAAERAAEYAAEsAgVM1QAA/QABEQIFTRkBqLkBpNQAARAAARABqOAAAQUBqPwAAP0AAQQBpLgAAN0AAPkAAPwAAP0CBU0ZAajxAAD4AajcAADwAgVM/AABGAGlGAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFGgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAakAAAEpAajJAADkAaTIAADRAADZAAEBAajQAAEdAAElAAEoAaTFAADYAAEVAAEcAAEkAAEwAai9AADEAAEJAakAAaUIAAEpAai8AADFAaTEAADJAAEJAgVQ7QABKAIFTQ0AARQCBUy1AAEMAAEhAajRAaS0AADIAADdAAEIAAENAAEgAajQAAEdAaTcAajNAADRAADxAAEcAajMAADQAADVAAEMAaTUAADhAADwAAEBAAEVAajFAADgAAD1AAERAAEUAaTsAAEAAai9AADEAAD0AAD5AakNAaS8AADJAAEFAAEQAgVMyAAA8QABBAABBQGpDAGo7QIFTOwAAPAAAcECBU0VAgVNBAIFTPkAAcACBVDRAAD4AAERAAExARj4AIzQAADVAajUAADdAADlAAENAAEQAAEUAaTRAADcAajQAADVAajUAADdAaTRAADcAADkAADtAAEdAAEwAhHo0AAA7AABPQIFTRwAAV0CBUyhAAEBAAEMAAFcAajJAAEFAaSgAAEAAAEEAAEVAajIAAEUAAEdAaj1AAEVAAEcAAE9AaU1AAE8AajxAAD0AAD9AAE0AAE9AgVNPAIFTRQCBUzwAAD5AAD8AAENAAE1AAE8AgVQ8QGlDAABFQGo6QAA8AAA+AABKQIFTOgAAQ0AARQAARkAASgAATEAATQCBUy1AAEMAAEYAAEhAgVMtAABBQABIAABTQIFUNEAANEAANUAAQQAAQ0AAREAATAAAUwCBUzQAADdAAEMAaUQAajQAADcAAEZAAEhAakRAaTBAAEBAAENAAEgAakQANTUANDAAAEMAAElAakYAAEZAajhAAD9AAEAAAEhAAEkAaUYAAFBAajFAADgAAD1AAD8AAE1AAFAAaTEAADNAajMAADpAAEtAAExAAE0Agj09AGk5QAA6AAA8QABBQABIAABLAABMAABNQIFUOQAAPAAAPEAASEBpOkAAPABqN0AAOgAAOkAAQQAARkAASACBUzcAADxAAENAAEYAAFBAajNAADoAaTwAADxAAE0AAFAAAFVAhBAzAGo3QAA8AABTQABVAIFTMUAANwAATEAAUkAAUwBqQkAATABpMQAASkAAUgBqN0AASgAAVEBpQwBqSEAAUUAAVABqQ0AAR0AAT0AAUQA0TUAATwA1NwAAPEAAQgAARkAARwAASAAATEAATQBqSUCBUzlAAEkAAFBAakMAAEwAhBA5AABBQABIQABQAGlGAGo8QABBAABDQABMQIFTNUAAPAAAQUAAQwAAREAAREAASAAATABqPAAAP0AAQQAAQkAARABpNQAAPwAAS0CBUzhAAEhAaklAAEsAajBAADgAAD9AAEIAAEkAAEtAaUQAajAAADZAAD8AAEFAAEsAAE1AgVM2AAA3QABBAABDQABLQABNAIMmSACBVEMAAEZAaTcAajhAAERAAEYAAEsAgVM1QAA/QABEQIFTRkBqLkBpNQAARAAARABqOAAAQUBqPwAAP0AAQQBpLgAAN0AAPkAAPwAAP0CBU0ZAajxAAD4AajcAADwAgVM/AABGAGlGAAH/LwA= sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFGgDAAACQNkAAPUAAQkAARUBqPQAAPkBpNgAAPUAAPgAAQEAAQgBqQkBpO0AAPQAAPkAAQAAAQgAAREAARQAATEBqOUAAOwAAPUAAPgAARAAARUBqOEAAOQAAO0AAPQAARQAAR0CBUzgAADlAADsAAEBAAEcAAElAAEpAAEwAaUkAAEoAAExAakAAAEpAajJAADkAaTIAADRAADZAAEBAajQAAEdAAElAAEoAaTFAADYAAEVAAEcAAEkAAEwAai9AADEAAEJAakAAaUIAAEpAai8AADFAaTEAADJAAEJAgVQ7QABKAIFTQ0AARQCBUy1AAEMAAEhAajRAaS0AADIAADdAAEIAAENAAEgAajQAAEdAaTcAajNAADRAADxAAEcAajMAADQAADVAAEMAaTUAADhAADwAAEBAAEVAajFAADgAAD1AAERAAEUAaTsAAEAAai9AADEAAD0AAD5AakNAaS8AADJAAEFAAEQAgVMyAAA8QABBAABBQGpDAGo7QIFTOwAAPAAAcECBU0VAgVNBAIFTPkAAcACBVDRAAD4AAERAAExARj4AIzQAADVAajUAADdAADlAAENAAEQAAEUAaTRAADcAajQAADVAajUAADdAaTRAADcAADkAADtAAEdAAEwAhHo0AAA7AABPQIFTRwAAV0CBUyhAAEBAAEMAAFcAajJAAEFAaSgAAEAAAEEAAEVAajIAAEUAAEdAaj1AAEVAAEcAAE9AaU1AAE8AajxAAD0AAD9AAE0AAE9AgVNPAIFTRQCBUzwAAD5AAD8AAENAAE1AAE8AgVQ8QGlDAABFQGo6QAA8AAA+AABKQIFTOgAAQ0AARQAARkAASgAATEAATQCBUy1AAEMAAEYAAEhAgVMtAABBQABIAABTQIFUNEAANEAANUAAQQAAQ0AAREAATAAAUwCBUzQAADdAAEMAaUQAajQAADcAAEZAAEhAakRAaTBAAEBAAENAAEgAakQANTUANDAAAEMAAElAakYAAEZAajhAAD9AAEAAAEhAAEkAaUYAAFBAajFAADgAAD1AAD8AAE1AAFAAaTEAADNAajMAADpAAEtAAExAAE0Agj09AGk5QAA6AAA8QABBQABIAABLAABMAABNQIFUOQAAPAAAPEAASEBpOkAAPABqN0AAOgAAOkAAQQAARkAASACBUzcAADxAAENAAEYAAFBAajNAADoAaTwAADxAAE0AAFAAAFVAhBAzAGo3QAA8AABTQABVAIFTMUAANwAATEAAUkAAUwBqQkAATABpMQAASkAAUgBqN0AASgAAVEBpQwBqSEAAUUAAVABqQ0AAR0AAT0AAUQA0TUAATwA1NwAAPEAAQgAARkAARwAASAAATEAATQBqSUCBUzlAAEkAAFBAakMAAEwAhBA5AABBQABIQABQAGlGAGo8QABBAABDQABMQIFTNUAAPAAAQUAAQwAAREAAREAASAAATABqPAAAP0AAQQAAQkAARABpNQAAPwAAS0CBUzhAAEhAaklAAEsAajBAADgAAD9AAEIAAEkAAEtAaUQAajAAADZAAD8AAEFAAEsAAE1AgVM2AAA3QABBAABDQABLQABNAIMmSACBVEMAAEZAaTcAajhAAERAAEYAAEsAgVM1QAA/QABEQIFTRkBqLkBpNQAARAAARABqOAAAQUBqPwAAP0AAQQBpLgAAN0AAPkAAPwAAP0CBU0ZAajxAAD4AajcAADwAgVM/AABGAGlGAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="perplexity-score" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</h2>
<p>“<a href="https://blog.echen.me/2021/12/23/a-laymans-introduction-to-perplexity-in-nlp/">Perplexity</a>” is a common metric for language models which comes from the field of information theory. It is often described as a measure of how “surprised” your model is by novel data.</p>
<p>Operationally, it’s just the exponential of the value of the loss function – like, …yea, that’s it.</p>
<p>Why do people report perplexity instead of just the loss value (since the exponential function is monotonic)? Well…because of custom, and because perplexity has some natural relation to entropy, and because it relates to something called the “branching factor” of a language… but “because custom” is enough.</p>
<p>So, all we’re going to do is feed the test set into our model and measure the loss, and take the exponential of that and… that’s our perplexity! Lower is better.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> NotesDataset(test_notes_tl, config.seq_length, len_mult<span class="op">=</span>config.batch_size, pad<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>test_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>total, batches <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, batch <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(test_dl, ncols<span class="op">=</span><span class="dv">100</span>)): </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        batches <span class="op">+=</span><span class="dv">1</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> [q.to(device) <span class="cf">for</span> q <span class="kw">in</span> batch]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        logits, loss <span class="op">=</span> model(xb, yb)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> total <span class="op">+</span> loss.cpu().item()</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>perplexity <span class="op">=</span> np.exp(total<span class="op">/</span>batches) </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"(Average) Perplexity = </span><span class="sc">{</span>perplexity<span class="sc">:5.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████| 229/229 [00:07&lt;00:00, 30.59it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(Average) Perplexity = 2.393</code></pre>
</div>
</div>
<p>Interesting. That seems really low. Perhaps all it means is that once you’ve seen a couple hundred Bach chorales, new ones aren’t very surprising! ;-)</p>
</section>
<section id="accuracy-score" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="accuracy-score"><span class="header-section-number">8.3</span> Accuracy Score</h2>
<p>This is pretty simple: How often did the model guess the “correct” next note? …Uh… TODO later.</p>
</section>
<section id="data-distributions" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="data-distributions"><span class="header-section-number">8.4</span> Data Distributions</h2>
<p>Let’s compare statistics of true points vs.&nbsp;generated points. We’ll generate a lot of data, and then compare histograms:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>all_test_notes <span class="op">=</span> torch.vstack(test_notes_tl).<span class="bu">type</span>(torch.float32)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>all_test_notes <span class="op">=</span> all_test_notes[:<span class="bu">len</span>(all_test_notes)<span class="op">//</span><span class="dv">4</span>]  <span class="co"># to save time, let's not do stats on ALL-all of them, just a quarter</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a big batch of fake data. </span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: this is super slow because our generator only works for batches of one, oops</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>prompt_len, max_new_tokens <span class="op">=</span> <span class="dv">12</span>, <span class="dv">54</span>          <span class="co"># I just made these numbers up. not great science yet, sorry.</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>new_notes_list <span class="op">=</span> []</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Generating new notes..."</span>) </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, notes <span class="kw">in</span> <span class="bu">enumerate</span>(tqdm(test_notes_tl, ncols<span class="op">=</span><span class="dv">100</span>)): </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    ptoks <span class="op">=</span> encode(notes[:prompt_len]).unsqueeze(<span class="dv">0</span>).to(device)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generate more notes, chop off prompt before adding to list of all generated notes</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    new_notes_list.append( decode( model.generate(ptoks, max_new_tokens<span class="op">=</span>max_new_tokens)[<span class="dv">0</span>].cpu()[prompt_len:] ) )</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>all_new_notes <span class="op">=</span> torch.vstack(new_notes_list).<span class="bu">type</span>(torch.float32)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"# of test notes = </span><span class="sc">{</span><span class="bu">len</span>(all_test_notes)<span class="sc">}</span><span class="ss">,  # of generated notes = </span><span class="sc">{</span><span class="bu">len</span>(all_new_notes)<span class="sc">}</span><span class="ss"> --- Close enough!"</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [<span class="st">'pitch'</span>, <span class="st">'step'</span>, <span class="st">'duration'</span>]</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> <span class="dv">32</span> <span class="cf">if</span> i <span class="op">!=</span><span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>np.arange(<span class="dv">128</span><span class="op">//</span><span class="dv">2</span>) </span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    ax[i].hist(all_test_notes[:,i].numpy(), bins<span class="op">=</span>bins, label<span class="op">=</span><span class="st">'test data'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    ax[i].hist(all_new_notes[:,i].numpy(),  bins<span class="op">=</span>bins, label<span class="op">=</span><span class="st">'generated'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(names[i])</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i<span class="op">==</span><span class="dv">2</span>: ax[i].legend()</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlabel(<span class="st">'Value'</span><span class="op">+</span><span class="ss">f'</span><span class="sc">{</span><span class="st">" (s)"</span> <span class="cf">if</span> i<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="st">""</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>: ax[i].set_ylabel(<span class="st">'Count'</span>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generating new notes...
# of test notes = 4159,  # of generated notes = 4158 --- Close enough!</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████| 77/77 [02:10&lt;00:00,  1.70s/it]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Transformers2-MusicBox_files/figure-html/cell-30-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Hey! The generated and test data distributions look prety similar. The generated pitches have a slighly larger spread, which is consistent with what we observe in the generated examples, and may be due to the pitch-shifting in our dta augmentation.</p>
<p>I’m curious why the <code>step</code> values seem to be shifted to the right in the generated data; that’s a bit “sus” to me. But, that’ll be an investigation for another time. We need to wrap this up!</p>
</section>
</section>
<section id="summary" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Summary</h1>
<p>TODO: write more</p>
<p>Here’s the full code in a Colab notebook: TODO</p>
</section>
<section id="sec-further" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Ideas for Further Exploration</h1>
The following are some ideas for taking this lesson further.
<details>
<summary>
Details
</summary>
<section id="change-hyperparamters-dataset" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="change-hyperparamters-dataset"><span class="header-section-number">10.1</span> Change Hyperparamters / Dataset</h2>
<p>I tried a <em>lot</em> of hyperparameter tuning already. Now it’s your turn. Maybe even trying WandB’s <a href="https://docs.wandb.ai/guides/sweeps">“Sweeps”</a>feature. Here’s a <code>config</code> suggestion <a href="https://wandb.ai/drscotthawley/musicbox-maestro-tutorial?workspace=user-drscotthawley">that I used for the MAESTRO dataset</a>:</p>
<div class="cell">
<details>
<summary>Watch out, there’s a Monster in this code!</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LargeConfig:  <span class="co"># "Monster" size model ;-) </span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model architecture details</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    seq_length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    n_embd:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span>     </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    n_heads:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span>      </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    n_blocks:   <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>       </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    dropout:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>    </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    bias:      <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training details</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    weight_decay:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.04</span>   <span class="co"># 0.01 is pytorch default</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    epochs:          <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other handy bookkeeping</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    vocab_sizes: <span class="bu">tuple</span> <span class="op">=</span> <span class="bu">tuple</span>(vocab_sizes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="report-individual-parts-of-the-loss" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="report-individual-parts-of-the-loss"><span class="header-section-number">10.2</span> Report Individual Parts of the Loss</h2>
<p>Currently we’re not reporting the contributions of pitch, step, and durations to the loss, separately. Doing so could be instructive!</p>
</section>
<section id="improving-generation-by-implementing-beam-search" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="improving-generation-by-implementing-beam-search"><span class="header-section-number">10.3</span> Improving Generation by Implementing Beam Search</h2>
<p>Right now we’re just sampling a single token from the predicted probability distribution. If we instead predicted the most likely estimates by looking two or three steps into the future, that could greatly improve our results. Check out “beam search” algorithms.</p>
</section>
<section id="using-huggingfaces-transformers-instead" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="using-huggingfaces-transformers-instead"><span class="header-section-number">10.4</span> Using Huggingface’s <code>transformers</code> instead</h2>
<p><code>trasformers</code> is a package that is optimized for general applications and would probably outperform the above code in numerous ways.</p>
</section>
<section id="pitch-only-estimation" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="pitch-only-estimation"><span class="header-section-number">10.5</span> Pitch-Only Estimation</h2>
<p>The timing can be the most challenging part. If you take that out and do only pitches (i.e.&nbsp;assume all notes have the same spacing and duration), you may like what you hear.</p>
</section>
<section id="raw-audio" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="raw-audio"><span class="header-section-number">10.6</span> Raw Audio</h2>
<p>If you were to instead use raw audio, I’d recommend converting it to spectrograms, treating each column of the spectrogram as a “word vector.” However, there’d likely be a lot of “wasted space” so you’d probably want to (invertibly) compress the dimensionality of your “audio-word vectors” via something like <a href="https://drscotthawley.github.io/blog/posts/2023-06-12-RVQ.html">(Residual) Vector Quantization</a>, an <a href="https://drscotthawley.github.io/audio-algebra/given-models.html">autoencoder</a>, or <a href="https://umap-learn.readthedocs.io/en/latest/">UMAP</a>. …And then you’d need to expand/decode it on the output side to be able to listen. Relatedly, a pretrained sytem like Meta’s <a href="https://github.com/facebookresearch/encodec">EnCodec</a> would likely provide such functions nicely.</p>
</section>
</details></section>
<section id="acknowledgements" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Acknowledgements</h1>
<ul>
<li><p>Super huge thanks to <a href="https://twitter.com/jeremyjordan">Jeremy Jordan</a> for many fruitful discussions as I developed this! Check out <a href="https://www.jeremyjordan.me/">his blog</a> for many helpful posts, esp.&nbsp;on Transformers, Attention, and many other Machine Learning topics.</p></li>
<li><p>I referred to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">Andrej Karpathy’s lesson and codes</a> frequently when my own code wasn’t working to my satisfaction (i.e.&nbsp;all the time).</p></li>
<li><p>Various papers by the Google Magenta team – the undisputed ML-MIDI experts in my book – were helpful in figuring out what to do. This lesson was influenced by their tutorial <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">“Generate Music with an RNN”</a>, which I converted PyTorch. In this lesson, code that wasn’t lifted from Karpathy was lifted from that.</p></li>
<li><p>I’m thankful to <a href="https://github.com/cifkao">Ondřej Cífka</a> for the exchanges that led to my development of Jupyter support for the MIDI player object(s) that he built off Magenta’s work.</p></li>
<li><p>As I included in the Preface, thanks to <a href="https://twitter.com/mamodrzejewski">Mateusz Modrzejewski</a> for what I took to be a word of encouragement.</p></li>
<li><p>ChatGPT was used extensively for helping with what I’ll unapologetically term “annoying formatting bullshit” (with pandas, tqdm, CSS,…), but not for anything more significant.</p></li>
</ul>
</section>
<section id="appendix-feeding-it-christmas-carols" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols 🎄</h1>
<p>This is probably a bad idea for so many reasons – it will be <em>wayyy</em> outside the distribution of training data – but given the time of year, I’ma try it anyway.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Attribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’re downloading the prompt MIDI files on the fly from <a href="https://www.mfiles.co.uk/christmas-music-and-carols.htm">MFiles</a>.</p>
</div>
</div>
<!--- comment 

---
# Afterward: Stuff I Probably Should Have Looked at First


BTW, that code is a PyTorch implementation of the 2018 [Music Transformer](https://arxiv.org/abs/1809.04281) paper by Google Brain, the abstract of which includes:

> "Existing approaches for representing relative positional information
in the Transformer modulate attention based on pairwise distance (Shaw et al.,
2018). This is impractical for long sequences such as musical compositions since
their memory complexity for intermediate relative information is quadratic in the
sequence length. We propose an algorithm that reduces their intermediate memory
requirement to linear in the sequence length.
This enables us to demonstrate that a
Transformer with our modified relative attention mechanism can generate minutelong compositions (thousands of steps, four times the length modeled in Oore et al.
(2018)) with compelling structure, generate continuations that coherently elaborate
on a given motif, and in a seq2seq setup generate accompaniments conditioned on
melodies"

....but this notebook is a tutorial, so forgive me if it's 5 years behind SOTA. ;-)

[Here's a nother code for a Pytorch MIDI transformer from 2 years ago](https://github.com/spectraldoy/music-transformer)

https://medium.com/data-science-in-your-pocket/music-generation-using-musictransformer-with-codes-c7be89ba85b1

--->
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>xmas_css <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="st">/* Custom player style */</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="st">p { </span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 0; </span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player {</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="st">  display: block;</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="st">  width: inherit;</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 4px;</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="st">  margin-bottom: 0;</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #d4d4d4; /* Lighter text color for better readability */</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(control-panel) {</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="st">  background: #004400; /* green background */</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid #888; /* Lightened border color for contrast */</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 10px 10px 0 0;</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(play-button) {</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #ffffff; /* White text for visibility */</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid currentColor;</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="st">  background-color: #ff00000; </span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 20px;</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="st">  transition: all 0.2s;</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="st">  content: 'hello';</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(play-button):hover {</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="st">  color: #a00; </span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="st">  background-color: #9fafc9; </span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 10px;</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-player::part(time) {</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="st">  font-family: monospace; /* Monospace font for time */</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="st">/* Custom visualizer style */</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer .piano-roll-visualizer {</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="st">  background: #900; /* red background for visualizer */</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="st">  border: 2px solid #505050; /* Dark border for subtle appearance */</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="st">  border-top: none;</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="st">  border-radius: 0 0 10px 10px;</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="st">  margin: 4px;</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a><span class="st">  width: inherit;</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a><span class="st">  margin-top: 0;</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="st">  overflow: auto;</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note {</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a><span class="st">  opacity: 0.9; </span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke-width: 1; /* Stroke width for note clarity */</span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a><span class="st">/* Different instrument colors */</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-instrument="0"]{</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #00f000; /* Green for Instrument 0 */</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #444; </span></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-instrument="2"]{</span></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #008000; /* Green for Instrument 2 */</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #444;</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note[data-is-drum="true"]{</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a><span class="st">  fill: #008000; /* Green for drum notes */</span></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #bbb;</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a><span class="st">#section3 midi-visualizer svg rect.note.active {</span></span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a><span class="st">  opacity: 0.9; /* Highlight active notes */</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke: #ffffff; /* White stroke for maximum contrast */</span></span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a><span class="st">  stroke-width: 2; /* Thicker stroke for active notes */</span></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xmasplayer(notes_tensor, height<span class="op">=</span><span class="dv">400</span>, time_rescale<span class="op">=</span><span class="va">None</span>, midi_file<span class="op">=</span><span class="st">"/tmp/tmp.mid"</span>, title<span class="op">=</span><span class="st">''</span>, styler<span class="op">=</span>general, css<span class="op">=</span>xmas_css):</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">"MIDIplayer that writes input tensor to temporary file"</span></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> notes_to_midi(notes_tensor, time_rescale<span class="op">=</span>time_rescale, out_file<span class="op">=</span>midi_file)</span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MIDIPlayer(midi_file, height, styler<span class="op">=</span>partial(styler, css<span class="op">=</span>css), dl<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span>title)</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> christmas_ohno(filename, title<span class="op">=</span><span class="st">""</span>, time_rescale<span class="op">=</span><span class="fl">0.242</span><span class="op">/</span><span class="fl">0.2880</span>, debug<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://www.mfiles.co.uk/downloads/"</span><span class="op">+</span>filename</span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>wget <span class="op">-</span>qq <span class="op">-</span>N {url}</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> midi_file_to_tensor(filename)</span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> debug: <span class="bu">print</span>(<span class="st">"notes = "</span>,notes)</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>    notes[:,<span class="dv">1</span>:] <span class="op">=</span> quantize_times(notes[:,<span class="dv">1</span>:]<span class="op">*</span>time_rescale, res_ms<span class="op">=</span><span class="dv">10</span>) <span class="co"># time rescale is mainly to get codebooks to agree</span></span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> notes[:<span class="dv">30</span>]</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>    prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>    set_seeds(<span class="dv">1</span>)</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>new_tokens, temperature<span class="op">=</span><span class="fl">0.9</span>)[<span class="dv">0</span>].cpu() )</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>    display(xmasplayer(notes,title<span class="op">=</span>title))</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>christmas_ohno(<span class="st">"jingle-bells-keyboard.mid"</span>, title<span class="op">=</span><span class="st">"Janky Bells"</span>)</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>christmas_ohno(<span class="st">"away-in-a-manger.mid"</span>, title<span class="op">=</span><span class="st">"Away in a Mangled"</span>, time_rescale<span class="op">=</span><span class="fl">.48</span><span class="op">/</span><span class="fl">.68</span>)</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>christmas_ohno(<span class="st">"hark-the-herald-angels-sing.mid"</span>, title<span class="op">=</span><span class="st">"Arg the Herald Angels Cringe"</span>,time_rescale<span class="op">=</span><span class="fl">.48</span><span class="op">/</span><span class="fl">.616</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section137 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section137 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section137 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section137 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section137 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section137 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section137 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section137 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section137 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section137 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section137 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section137&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Janky Bells<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFOwDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpNAAANUAARUBqNQAAN0BqNkAANwAAPAAAPkAAQABpNgAAQkBqRQBpN0AAO0CBVDsAAEIAAENAAEdAaT4AajFAADcAADlAAEBAAEMAAEVAAEcAgVM0QAA5AAA9QABAAGo9AAA+QGk0AAA+AABEQABFAABHQGotQAA5QAA9QABFQABHAGkxAAA3QAA5AABEAGoyQAA2QAA3AAA9AAA+QABFAABFQGotAABCQABFAGk2AAA3QAA7QAA+AABCAABDQIFTKkAAOUAAOwAAQwAARUBqNwBqMgAAPEAARQBpKgAAOQAAQ0BqK0AAO0AAPABpKwAANEAANkAAOUAAOwA1MkAANAAANgA1LUAAMEAAMgAANEAAOQBqLQAANEBpL0AAMAAAMkAANAAANAAAN0CBUy8AADBAADIAADRAADcAADxAgVQwAAAyQAA2QAA5QAA8AGkyQAA0AABDAGoyAAA2AAA3QAA5AAA7QGkyAAA+QGoxQAA0QAA3AAA5QAA7AAA+AABFQGo0AAA2QDQzQAA2ADUsQAAxAAAzAAA0QAA5AAA7QABFAABHQGoyQAA0AGksAAAtQAAyAAA0QABHAABJQGo5QAA7AGotAAAyQIFTMgAANEAAOQAAQkAASQBpMkAANAAAPkAAQgAAQ0BqNAAAO0BqPgBpMUAAOwAAQEAARUBqL0AAMQAAMgAAQwBpLUAALwAAPUBqLQAAL0BqLwAAMUAAREAARQCBUy1AAD0AAEAAAEFAAEJAgVMtAAAvQAAxAAA+QABBAABEAIFTLUAALwAAPUAAPgAAQECBUytAAC0AADZAAEAAAEIAAEVAaj0AAD5AaisAADFAADRAADYAADpAAD4AAENAAEUAaTJAADQAADoAADtAajBAADEAADIAADRAADsAADxAaTQAADpAADwAajAAADJAADlAADoAAEJAgVNDAGo5AAA+QGk3QABCAGoqQAAxQAA3AAA5QAA+AABFQGoxAAAyAAA0QGkqAAAyQAA0AAA5AAA7QAA8QABAQABFAGo3QAA7AAA7QAA8AGktQAAyAAA3AAA5QAA7AAA8QABAAABCQGo2QAA5AGotAAAvQAAyQAA2AAA7QAA8AGkxQAAyAGooQAAvAAAxAAAyQAA3QAA7AABCAABDQGkoAAAqQAA3AAA5QGooQAAqAAA3QAA5AIFTJkAAKAAALUAAMgAANwAAPkAAQkAAQwCBUyYAACtAAC0AAC9AADdAAD4AAEBAAEIAajRAADcAai8AADJAADQAADtAaTFAADIAAEAAAEJAaisAAC9AADEAADJAADZAADsAAEIAAENAaTRAADYAajIAADQAAD5AgVMqQAAvAAA2QAA5QAA+AAA+QABDAGo+AABCQGkoQAAqAAA2AAA3QAA5AAA7QABCAABDQIFUKAAAKkAAOkAAOwAAPUAAQwCDJioAADJAajoAaTIAADcAAD0AAEJAajZAaS9AADJAADYAADtAAD5AAEIAgVQvAAAyAAA7AAA+AABDQABHQGk2QAA+QABDAGotQAA2AAA+AABHAGktAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFOwDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpNAAANUAARUBqNQAAN0BqNkAANwAAPAAAPkAAQABpNgAAQkBqRQBpN0AAO0CBVDsAAEIAAENAAEdAaT4AajFAADcAADlAAEBAAEMAAEVAAEcAgVM0QAA5AAA9QABAAGo9AAA+QGk0AAA+AABEQABFAABHQGotQAA5QAA9QABFQABHAGkxAAA3QAA5AABEAGoyQAA2QAA3AAA9AAA+QABFAABFQGotAABCQABFAGk2AAA3QAA7QAA+AABCAABDQIFTKkAAOUAAOwAAQwAARUBqNwBqMgAAPEAARQBpKgAAOQAAQ0BqK0AAO0AAPABpKwAANEAANkAAOUAAOwA1MkAANAAANgA1LUAAMEAAMgAANEAAOQBqLQAANEBpL0AAMAAAMkAANAAANAAAN0CBUy8AADBAADIAADRAADcAADxAgVQwAAAyQAA2QAA5QAA8AGkyQAA0AABDAGoyAAA2AAA3QAA5AAA7QGkyAAA+QGoxQAA0QAA3AAA5QAA7AAA+AABFQGo0AAA2QDQzQAA2ADUsQAAxAAAzAAA0QAA5AAA7QABFAABHQGoyQAA0AGksAAAtQAAyAAA0QABHAABJQGo5QAA7AGotAAAyQIFTMgAANEAAOQAAQkAASQBpMkAANAAAPkAAQgAAQ0BqNAAAO0BqPgBpMUAAOwAAQEAARUBqL0AAMQAAMgAAQwBpLUAALwAAPUBqLQAAL0BqLwAAMUAAREAARQCBUy1AAD0AAEAAAEFAAEJAgVMtAAAvQAAxAAA+QABBAABEAIFTLUAALwAAPUAAPgAAQECBUytAAC0AADZAAEAAAEIAAEVAaj0AAD5AaisAADFAADRAADYAADpAAD4AAENAAEUAaTJAADQAADoAADtAajBAADEAADIAADRAADsAADxAaTQAADpAADwAajAAADJAADlAADoAAEJAgVNDAGo5AAA+QGk3QABCAGoqQAAxQAA3AAA5QAA+AABFQGoxAAAyAAA0QGkqAAAyQAA0AAA5AAA7QAA8QABAQABFAGo3QAA7AAA7QAA8AGktQAAyAAA3AAA5QAA7AAA8QABAAABCQGo2QAA5AGotAAAvQAAyQAA2AAA7QAA8AGkxQAAyAGooQAAvAAAxAAAyQAA3QAA7AABCAABDQGkoAAAqQAA3AAA5QGooQAAqAAA3QAA5AIFTJkAAKAAALUAAMgAANwAAPkAAQkAAQwCBUyYAACtAAC0AAC9AADdAAD4AAEBAAEIAajRAADcAai8AADJAADQAADtAaTFAADIAAEAAAEJAaisAAC9AADEAADJAADZAADsAAEIAAENAaTRAADYAajIAADQAAD5AgVMqQAAvAAA2QAA5QAA+AAA+QABDAGo+AABCQGkoQAAqAAA2AAA3QAA5AAA7QABCAABDQIFUKAAAKkAAOkAAOwAAPUAAQwCDJioAADJAajoAaTIAADcAAD0AAEJAajZAaS9AADJAADYAADtAAD5AAEIAgVQvAAAyAAA7AAA+AABDQABHQGk2QAA+QABDAGotQAA2AAA+AABHAGktAAH/LwA= sound-font visualizer=&quot;#section137 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFOwDAAACQK0AAO0AAPkBqKwAAMkAAPgAAR0BpMgAAN0AARUAARwBqMkAANwAAQ0AARQBpK0AAMgAAOwAAO0AAPkAAQwBqKwAAMkBqMgAAN0BpMkAANwAAPgAAPkA1PgAAPkA1K0AAMgAAOwAAO0AAPgAAPkBpKwAAMkAAPgAAR0BqMgAAN0AARUAARwBqMkAANwAAQ0AARQBpMEAAMgAAOwAAPEAAQEAAQwBqMAAANEBpNAAANUAARUBqNQAAN0BqNkAANwAAPAAAPkAAQABpNgAAQkBqRQBpN0AAO0CBVDsAAEIAAENAAEdAaT4AajFAADcAADlAAEBAAEMAAEVAAEcAgVM0QAA5AAA9QABAAGo9AAA+QGk0AAA+AABEQABFAABHQGotQAA5QAA9QABFQABHAGkxAAA3QAA5AABEAGoyQAA2QAA3AAA9AAA+QABFAABFQGotAABCQABFAGk2AAA3QAA7QAA+AABCAABDQIFTKkAAOUAAOwAAQwAARUBqNwBqMgAAPEAARQBpKgAAOQAAQ0BqK0AAO0AAPABpKwAANEAANkAAOUAAOwA1MkAANAAANgA1LUAAMEAAMgAANEAAOQBqLQAANEBpL0AAMAAAMkAANAAANAAAN0CBUy8AADBAADIAADRAADcAADxAgVQwAAAyQAA2QAA5QAA8AGkyQAA0AABDAGoyAAA2AAA3QAA5AAA7QGkyAAA+QGoxQAA0QAA3AAA5QAA7AAA+AABFQGo0AAA2QDQzQAA2ADUsQAAxAAAzAAA0QAA5AAA7QABFAABHQGoyQAA0AGksAAAtQAAyAAA0QABHAABJQGo5QAA7AGotAAAyQIFTMgAANEAAOQAAQkAASQBpMkAANAAAPkAAQgAAQ0BqNAAAO0BqPgBpMUAAOwAAQEAARUBqL0AAMQAAMgAAQwBpLUAALwAAPUBqLQAAL0BqLwAAMUAAREAARQCBUy1AAD0AAEAAAEFAAEJAgVMtAAAvQAAxAAA+QABBAABEAIFTLUAALwAAPUAAPgAAQECBUytAAC0AADZAAEAAAEIAAEVAaj0AAD5AaisAADFAADRAADYAADpAAD4AAENAAEUAaTJAADQAADoAADtAajBAADEAADIAADRAADsAADxAaTQAADpAADwAajAAADJAADlAADoAAEJAgVNDAGo5AAA+QGk3QABCAGoqQAAxQAA3AAA5QAA+AABFQGoxAAAyAAA0QGkqAAAyQAA0AAA5AAA7QAA8QABAQABFAGo3QAA7AAA7QAA8AGktQAAyAAA3AAA5QAA7AAA8QABAAABCQGo2QAA5AGotAAAvQAAyQAA2AAA7QAA8AGkxQAAyAGooQAAvAAAxAAAyQAA3QAA7AABCAABDQGkoAAAqQAA3AAA5QGooQAAqAAA3QAA5AIFTJkAAKAAALUAAMgAANwAAPkAAQkAAQwCBUyYAACtAAC0AAC9AADdAAD4AAEBAAEIAajRAADcAai8AADJAADQAADtAaTFAADIAAEAAAEJAaisAAC9AADEAADJAADZAADsAAEIAAENAaTRAADYAajIAADQAAD5AgVMqQAAvAAA2QAA5QAA+AAA+QABDAGo+AABCQGkoQAAqAAA2AAA3QAA5AAA7QABCAABDQIFUKAAAKkAAOkAAOwAAPUAAQwCDJioAADJAajoAaTIAADcAAD0AAEJAajZAaS9AADJAADYAADtAAD5AAEIAgVQvAAAyAAA7AAA+AABDQABHQGk2QAA+QABDAGotQAA2AAA+AABHAGktAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section137 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section137 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section137 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section137 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section137 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section137 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section137 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section137 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section137 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section137 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section137 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section137&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Away in a Mangled<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRQDAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpARjUAgQ0yAAA3QABAQABCAABJQABKAIFTMkAAPkAAQUAASQCBUzFAADIAAD4AAEEAAEZARzUAhDMmQAAxAAA3AAA6QABAAABBQABGAEYtAIENJgAALUAAOgAAPECBUyhAAC0AAC5AADpAADwAAD5AAEBAgVQoAAAtQAAuAAA5QAA6AAA8QAA+AABAAABBAABIQIFTK0AALQAAOQAAOkAAPAAAPkAARkAASABpKwAALkAARUAARgBqLgAAMEAAN0AAOgAARQAARkCBUzAAADJAADVAADcAAEVAAEYAgVMtQAAyAAA8QAA+AGo1AABDQABFAGotAAAuQAA8AAA+QABBQABDAGk3QGotQAAuAAAwQAA3AAA5QAA+AABAQABBAGkrQAAtAGorAAAuQAAwAAAyQAA1QAA5AAA+QABAAGoqQAAuAGkqAAArQAA6QAA+AIFTKEAAMEAAMgAANQCBVCZAACgAACsAADAAADJAADVAADlAADoAgVMkQAAmAAArQAAyAAA0QAA1AAA5AAA8QGkkAAAmQAA0AAA1QGomAAAoQAA1AAA3QAA6QAA8AIFTKAAAKUAAKwAAMEAANwAAOUAAOgBqOQAAOkBpLUAAMAAANUAAOgAAPEBqKQBqK0AALkAAPABpLgAANEBqKwAAMkAANAAANQAANUAAOUCBUyhAAC0AADBAADIAADUAADdAADkAADpAai5AADAAaSgAAClAAC4AADBAADlAADoAaihAACkAAC5AADkAADpAaSgAAClAAC4AADAAADBAADlAADoAgVQmQAApAAAwAAAyQAA3AAA6QGkyAAA0QGohQAAmAAAwQAA0AAA2QAA5AAA6AAA8QIFTH0AAIQAALkAAMAAAMkAANgAAOkAAPABqMgAAM0BpHwAAJkAALgAAMwAANUBqM0AANQBpIkAAJgAAMkAAMwAANUBqJEAAJkAAMEAAMgBqIgAAIkAAMAAAOgBpIgAAJEAAJgAAK0BqKwAAN0BpJAAAJABqJEAALkAALkAAMEAANEAANQAANwBqMAAAM0AANABpJAAAKUAALUAALgAALgAAMwAANUBqKQAALQAAOUBpJEAAMEAANEAANQAAN0AAOQBqMkAANABqHUAAJAAAMgAANUAANwAAOUBpN0AAOQBqHQAAIkAAKUAAMAAAMEAANQAANwAAOUBpIgAAJEBqJAAAJEAAMAAANEBqJAAAJkAAKQAAMkAANAAANUAAOQAAOkBpJEAAJgAAMgAANEAANQAAN0AAOgBqLUAAMkAANABpJAAALQAAMgAANUAAOUBqMkAANUAANwBqMEAAMgAANQBpIkAAMAAAOkAAPkBqIUAAIgAAOQBpH0AAIQAANQAAN0AAPEAAPgCBVB8AACFAADVAADcAADlAADoAaTNAADUAaiEAACJAADJAADMAADdAADkAADpAADwAgVMiAAAoQAA6AAA8QGokQAAoAAAwQAAyADQvQAAwADUkAAAmQAAtQAAvAAA8AAA+QIFTHkAAJgAAK0AALQAANwAAOkAAPgAAQEBqHgAAJEAAOgBqJAAAKwAAQAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRQDAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpARjUAgQ0yAAA3QABAQABCAABJQABKAIFTMkAAPkAAQUAASQCBUzFAADIAAD4AAEEAAEZARzUAhDMmQAAxAAA3AAA6QABAAABBQABGAEYtAIENJgAALUAAOgAAPECBUyhAAC0AAC5AADpAADwAAD5AAEBAgVQoAAAtQAAuAAA5QAA6AAA8QAA+AABAAABBAABIQIFTK0AALQAAOQAAOkAAPAAAPkAARkAASABpKwAALkAARUAARgBqLgAAMEAAN0AAOgAARQAARkCBUzAAADJAADVAADcAAEVAAEYAgVMtQAAyAAA8QAA+AGo1AABDQABFAGotAAAuQAA8AAA+QABBQABDAGk3QGotQAAuAAAwQAA3AAA5QAA+AABAQABBAGkrQAAtAGorAAAuQAAwAAAyQAA1QAA5AAA+QABAAGoqQAAuAGkqAAArQAA6QAA+AIFTKEAAMEAAMgAANQCBVCZAACgAACsAADAAADJAADVAADlAADoAgVMkQAAmAAArQAAyAAA0QAA1AAA5AAA8QGkkAAAmQAA0AAA1QGomAAAoQAA1AAA3QAA6QAA8AIFTKAAAKUAAKwAAMEAANwAAOUAAOgBqOQAAOkBpLUAAMAAANUAAOgAAPEBqKQBqK0AALkAAPABpLgAANEBqKwAAMkAANAAANQAANUAAOUCBUyhAAC0AADBAADIAADUAADdAADkAADpAai5AADAAaSgAAClAAC4AADBAADlAADoAaihAACkAAC5AADkAADpAaSgAAClAAC4AADAAADBAADlAADoAgVQmQAApAAAwAAAyQAA3AAA6QGkyAAA0QGohQAAmAAAwQAA0AAA2QAA5AAA6AAA8QIFTH0AAIQAALkAAMAAAMkAANgAAOkAAPABqMgAAM0BpHwAAJkAALgAAMwAANUBqM0AANQBpIkAAJgAAMkAAMwAANUBqJEAAJkAAMEAAMgBqIgAAIkAAMAAAOgBpIgAAJEAAJgAAK0BqKwAAN0BpJAAAJABqJEAALkAALkAAMEAANEAANQAANwBqMAAAM0AANABpJAAAKUAALUAALgAALgAAMwAANUBqKQAALQAAOUBpJEAAMEAANEAANQAAN0AAOQBqMkAANABqHUAAJAAAMgAANUAANwAAOUBpN0AAOQBqHQAAIkAAKUAAMAAAMEAANQAANwAAOUBpIgAAJEBqJAAAJEAAMAAANEBqJAAAJkAAKQAAMkAANAAANUAAOQAAOkBpJEAAJgAAMgAANEAANQAAN0AAOgBqLUAAMkAANABpJAAALQAAMgAANUAAOUBqMkAANUAANwBqMEAAMgAANQBpIkAAMAAAOkAAPkBqIUAAIgAAOQBpH0AAIQAANQAAN0AAPEAAPgCBVB8AACFAADVAADcAADlAADoAaTNAADUAaiEAACJAADJAADMAADdAADkAADpAADwAgVMiAAAoQAA6AAA8QGokQAAoAAAwQAAyADQvQAAwADUkAAAmQAAtQAAvAAA8AAA+QIFTHkAAJgAAK0AALQAANwAAOkAAPgAAQEBqHgAAJEAAOgBqJAAAKwAAQAAB/y8A sound-font visualizer=&quot;#section137 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFRQDAAACQMEAAN0AAPECBUylAADAAADVAADcAADlAADwAAEFAgVNBAABBQIFUKQAALkAAOQAAOkAAQQAAQ0BpQwAARUBqKUAALgAANUAAOUAAOgAAQUAARQCBU0EAAEFAgVMpAAAyQAA5AABBAABBQABFQGpFAABGQGktQAAyAAA0QABBAABFQABGAABIQIFUQ0AARQAASAAASECBUzJAADQAAEJAAEMAAEgAAEpARjUAgQ0yAAA3QABAQABCAABJQABKAIFTMkAAPkAAQUAASQCBUzFAADIAAD4AAEEAAEZARzUAhDMmQAAxAAA3AAA6QABAAABBQABGAEYtAIENJgAALUAAOgAAPECBUyhAAC0AAC5AADpAADwAAD5AAEBAgVQoAAAtQAAuAAA5QAA6AAA8QAA+AABAAABBAABIQIFTK0AALQAAOQAAOkAAPAAAPkAARkAASABpKwAALkAARUAARgBqLgAAMEAAN0AAOgAARQAARkCBUzAAADJAADVAADcAAEVAAEYAgVMtQAAyAAA8QAA+AGo1AABDQABFAGotAAAuQAA8AAA+QABBQABDAGk3QGotQAAuAAAwQAA3AAA5QAA+AABAQABBAGkrQAAtAGorAAAuQAAwAAAyQAA1QAA5AAA+QABAAGoqQAAuAGkqAAArQAA6QAA+AIFTKEAAMEAAMgAANQCBVCZAACgAACsAADAAADJAADVAADlAADoAgVMkQAAmAAArQAAyAAA0QAA1AAA5AAA8QGkkAAAmQAA0AAA1QGomAAAoQAA1AAA3QAA6QAA8AIFTKAAAKUAAKwAAMEAANwAAOUAAOgBqOQAAOkBpLUAAMAAANUAAOgAAPEBqKQBqK0AALkAAPABpLgAANEBqKwAAMkAANAAANQAANUAAOUCBUyhAAC0AADBAADIAADUAADdAADkAADpAai5AADAAaSgAAClAAC4AADBAADlAADoAaihAACkAAC5AADkAADpAaSgAAClAAC4AADAAADBAADlAADoAgVQmQAApAAAwAAAyQAA3AAA6QGkyAAA0QGohQAAmAAAwQAA0AAA2QAA5AAA6AAA8QIFTH0AAIQAALkAAMAAAMkAANgAAOkAAPABqMgAAM0BpHwAAJkAALgAAMwAANUBqM0AANQBpIkAAJgAAMkAAMwAANUBqJEAAJkAAMEAAMgBqIgAAIkAAMAAAOgBpIgAAJEAAJgAAK0BqKwAAN0BpJAAAJABqJEAALkAALkAAMEAANEAANQAANwBqMAAAM0AANABpJAAAKUAALUAALgAALgAAMwAANUBqKQAALQAAOUBpJEAAMEAANEAANQAAN0AAOQBqMkAANABqHUAAJAAAMgAANUAANwAAOUBpN0AAOQBqHQAAIkAAKUAAMAAAMEAANQAANwAAOUBpIgAAJEBqJAAAJEAAMAAANEBqJAAAJkAAKQAAMkAANAAANUAAOQAAOkBpJEAAJgAAMgAANEAANQAAN0AAOgBqLUAAMkAANABpJAAALQAAMgAANUAAOUBqMkAANUAANwBqMEAAMgAANQBpIkAAMAAAOkAAPkBqIUAAIgAAOQBpH0AAIQAANQAAN0AAPEAAPgCBVB8AACFAADVAADcAADlAADoAaTNAADUAaiEAACJAADJAADMAADdAADkAADpAADwAgVMiAAAoQAA6AAA8QGokQAAoAAAwQAAyADQvQAAwADUkAAAmQAAtQAAvAAA8AAA+QIFTHkAAJgAAK0AALQAANwAAOkAAPgAAQEBqHgAAJEAAOgBqJAAAKwAAQAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin: 0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section137 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section137 midi-player::part(control-panel) {
  background: #004400; /* green background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section137 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #ff00000; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section137 midi-player::part(play-button):hover {
  color: #a00; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section137 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section137 midi-visualizer .piano-roll-visualizer {
  background: #900; /* red background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section137 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section137 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #00f000; /* Green for Instrument 0 */
  stroke: #444; 
}
#section137 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #008000; /* Green for Instrument 2 */
  stroke: #444;
}
#section137 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: #008000; /* Green for drum notes */
  stroke: #bbb;
}
#section137 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ffffff; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section137&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Arg the Herald Angels Cringe<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AAEAAAEFAAEMAaUBAailAAC0AADlAAEEAaTkAAEAAAEFAaikAADxAAEBAAEEAakNAaTpAADwAAEAAAEFAakMAaTlAgyc6AEYwAAA8AIENMEAAN0AAOQAAPEAAQEAAQQCBUy5AADAAADVAADcAADpAADwAAD1AAEAAajhAADoAaS4AADBAADUAAD0AAD9AgVQpQAAwAAA1QAA4AAA4QAA9QAA/AGkoQAApAAA1AAA8QAA9AGomQAAoAAA1QAA4AAA6QAA8AAA9QGkmAAAoQGooAAApQAA8QAA9AGosQAA1ADQqQAAsADUgQAApAAAqAAAwQAA4QAA6AAA8AAA/QIFTIAAAKUAAMAAAMUAAOAAAOEBqMEAAMQBqKQAAK0AALkAAMAAAOAAAOkAAPUAAPwBpLgAAM0BqKwAALEAAMwAANUAAOgAAPEAAPQBpK0AALABqKwAALEAAM0BqMwBpLAAALkAAMUAANQAAOkAAPAAAPkBqLEAALgAAPEAAPgBpK0AALAAAMQAAM0AAPAAAP0CBVCsAADMAADNAADdAADoAADpAaThAADoAajBAADMAADNAADcAAD8AAERAaTJAADMAai5AADAAADIAADNAADdAADgAAENAAEQAajhAAEFAAEMAaS4AADBAADcAADdAADgAAD9AAEEAajJAADMAaSlAADAAADBAADIAADcAADhAAD8AAEFAajdAADgAAD9AAEEAaiVAACkAAC5AADAAADVAADcAAD8AAEFAaSRAACUAADRAADUAaiJAACQAAClAAC4AADQAADpAAD5AAEEAaSkAADhAaiIAACdAADdAADgAAD4AAD9AajhAADoAaSRAADcAADdAADxAAD8AajgAgj0kAAAzQAA3AAA3QAA6QIFTJwAAMEAAMEAAMkAAMwAANUAANwAAOUAAOgAAOkAAPABpLkAAMAAAMgAAPkBqMAAANQAAN0AAOgAAPgAAP0BqLUAALgAANUAAOQAAPEAAPwBpNwAAOUAAPAAAPkBqLQAALkAAM0AANQAAN0AAOQAAPEAAPgBpMwAANUAANwAAOUAAPAAAPkBqLgAAMkAANQAANUAAOQAAO0BqMEAAMgAAM0AANQAAN0AAOwAAPEAAPgBpMAAAMkAAMwAANkAAOUAAPABqJkAANgAANwAAO0BpJgAAJ0AAOQBqJwAAK0AAN0BqKwAAOkAAOwBpJkAAMkAANkAANwAAOUAAOgBqMgBpJgAAMEAAMgAANgAAN0AAOQAAQECBVC9AADAAADJAAD5AAEAAaS1AAC8AADcAADlAaitAAC0AADIAADdAADkAADtAaTZAADcAaisAAC1AADBAADRAADYAADsAADxAAD4AgVMmQAAtAAAwAAAyQAA0AAA2QGojQAAmAGkjAAAwQAA5QAA8AGowAAAyAAAyQGoyAAA2AAA2QAA+QGkvQAA2AAA2QAA3QAA5AGotQAAvAAA0QAA2AAA3AAA8QGkrQAAtAAA7QAA8AGorAAAtQAAwQAA5QAA7AGowAAAyQGktAAAyAAA5AAA+AIFTNAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AAEAAAEFAAEMAaUBAailAAC0AADlAAEEAaTkAAEAAAEFAaikAADxAAEBAAEEAakNAaTpAADwAAEAAAEFAakMAaTlAgyc6AEYwAAA8AIENMEAAN0AAOQAAPEAAQEAAQQCBUy5AADAAADVAADcAADpAADwAAD1AAEAAajhAADoAaS4AADBAADUAAD0AAD9AgVQpQAAwAAA1QAA4AAA4QAA9QAA/AGkoQAApAAA1AAA8QAA9AGomQAAoAAA1QAA4AAA6QAA8AAA9QGkmAAAoQGooAAApQAA8QAA9AGosQAA1ADQqQAAsADUgQAApAAAqAAAwQAA4QAA6AAA8AAA/QIFTIAAAKUAAMAAAMUAAOAAAOEBqMEAAMQBqKQAAK0AALkAAMAAAOAAAOkAAPUAAPwBpLgAAM0BqKwAALEAAMwAANUAAOgAAPEAAPQBpK0AALABqKwAALEAAM0BqMwBpLAAALkAAMUAANQAAOkAAPAAAPkBqLEAALgAAPEAAPgBpK0AALAAAMQAAM0AAPAAAP0CBVCsAADMAADNAADdAADoAADpAaThAADoAajBAADMAADNAADcAAD8AAERAaTJAADMAai5AADAAADIAADNAADdAADgAAENAAEQAajhAAEFAAEMAaS4AADBAADcAADdAADgAAD9AAEEAajJAADMAaSlAADAAADBAADIAADcAADhAAD8AAEFAajdAADgAAD9AAEEAaiVAACkAAC5AADAAADVAADcAAD8AAEFAaSRAACUAADRAADUAaiJAACQAAClAAC4AADQAADpAAD5AAEEAaSkAADhAaiIAACdAADdAADgAAD4AAD9AajhAADoAaSRAADcAADdAADxAAD8AajgAgj0kAAAzQAA3AAA3QAA6QIFTJwAAMEAAMEAAMkAAMwAANUAANwAAOUAAOgAAOkAAPABpLkAAMAAAMgAAPkBqMAAANQAAN0AAOgAAPgAAP0BqLUAALgAANUAAOQAAPEAAPwBpNwAAOUAAPAAAPkBqLQAALkAAM0AANQAAN0AAOQAAPEAAPgBpMwAANUAANwAAOUAAPAAAPkBqLgAAMkAANQAANUAAOQAAO0BqMEAAMgAAM0AANQAAN0AAOwAAPEAAPgBpMAAAMkAAMwAANkAAOUAAPABqJkAANgAANwAAO0BpJgAAJ0AAOQBqJwAAK0AAN0BqKwAAOkAAOwBpJkAAMkAANkAANwAAOUAAOgBqMgBpJgAAMEAAMgAANgAAN0AAOQAAQECBVC9AADAAADJAAD5AAEAAaS1AAC8AADcAADlAaitAAC0AADIAADdAADkAADtAaTZAADcAaisAAC1AADBAADRAADYAADsAADxAAD4AgVMmQAAtAAAwAAAyQAA0AAA2QGojQAAmAGkjAAAwQAA5QAA8AGowAAAyAAAyQGoyAAA2AAA2QAA+QGkvQAA2AAA2QAA3QAA5AGotQAAvAAA0QAA2AAA3AAA8QGkrQAAtAAA7QAA8AGorAAAtQAAwQAA5QAA7AGowAAAyQGktAAAyAAA5AAA+AIFTNAAB/y8A sound-font visualizer=&quot;#section137 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAFPADAAACQNUAAOUAAPECBUzUAADVAADkAADlAADwAADxAAEFAgVM1AAA1QAA5AAA5QAA8AAA8QABBAABBQIFUMEAANQBpN0AAOQAAPAAAPEAAQEAAQQBqLUAAMAAANwAAOUAAPAAAPEAAQAAAQUCBUylAAC0AADkAADwAADxAAEEAAEFAAEVAgVMpAAAwQAA8AAA8QABBAABBQABFAABFQIFTQEAAQQAAQ0AARQCBVC1AAEAAAEFAAEMAaUBAailAAC0AADlAAEEAaTkAAEAAAEFAaikAADxAAEBAAEEAakNAaTpAADwAAEAAAEFAakMAaTlAgyc6AEYwAAA8AIENMEAAN0AAOQAAPEAAQEAAQQCBUy5AADAAADVAADcAADpAADwAAD1AAEAAajhAADoAaS4AADBAADUAAD0AAD9AgVQpQAAwAAA1QAA4AAA4QAA9QAA/AGkoQAApAAA1AAA8QAA9AGomQAAoAAA1QAA4AAA6QAA8AAA9QGkmAAAoQGooAAApQAA8QAA9AGosQAA1ADQqQAAsADUgQAApAAAqAAAwQAA4QAA6AAA8AAA/QIFTIAAAKUAAMAAAMUAAOAAAOEBqMEAAMQBqKQAAK0AALkAAMAAAOAAAOkAAPUAAPwBpLgAAM0BqKwAALEAAMwAANUAAOgAAPEAAPQBpK0AALABqKwAALEAAM0BqMwBpLAAALkAAMUAANQAAOkAAPAAAPkBqLEAALgAAPEAAPgBpK0AALAAAMQAAM0AAPAAAP0CBVCsAADMAADNAADdAADoAADpAaThAADoAajBAADMAADNAADcAAD8AAERAaTJAADMAai5AADAAADIAADNAADdAADgAAENAAEQAajhAAEFAAEMAaS4AADBAADcAADdAADgAAD9AAEEAajJAADMAaSlAADAAADBAADIAADcAADhAAD8AAEFAajdAADgAAD9AAEEAaiVAACkAAC5AADAAADVAADcAAD8AAEFAaSRAACUAADRAADUAaiJAACQAAClAAC4AADQAADpAAD5AAEEAaSkAADhAaiIAACdAADdAADgAAD4AAD9AajhAADoAaSRAADcAADdAADxAAD8AajgAgj0kAAAzQAA3AAA3QAA6QIFTJwAAMEAAMEAAMkAAMwAANUAANwAAOUAAOgAAOkAAPABpLkAAMAAAMgAAPkBqMAAANQAAN0AAOgAAPgAAP0BqLUAALgAANUAAOQAAPEAAPwBpNwAAOUAAPAAAPkBqLQAALkAAM0AANQAAN0AAOQAAPEAAPgBpMwAANUAANwAAOUAAPAAAPkBqLgAAMkAANQAANUAAOQAAO0BqMEAAMgAAM0AANQAAN0AAOwAAPEAAPgBpMAAAMkAAMwAANkAAOUAAPABqJkAANgAANwAAO0BpJgAAJ0AAOQBqJwAAK0AAN0BqKwAAOkAAOwBpJkAAMkAANkAANwAAOUAAOgBqMgBpJgAAMEAAMgAANgAAN0AAOQAAQECBVC9AADAAADJAAD5AAEAAaS1AAC8AADcAADlAaitAAC0AADIAADdAADkAADtAaTZAADcAaisAAC1AADBAADRAADYAADsAADxAAD4AgVMmQAAtAAAwAAAyQAA0AAA2QGojQAAmAGkjAAAwQAA5QAA8AGowAAAyAAAyQGoyAAA2AAA2QAA+QGkvQAA2AAA2QAA3QAA5AGotQAAvAAA0QAA2AAA3AAA8QGkrQAAtAAA7QAA8AGorAAAtQAAwQAA5QAA7AGowAAAyQGktAAAyAAA5AAA+AIFTNAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>…yea, not sure what that accomplished, but it was fun to try!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more holiday-themed Machine Learning instruction, check out <a href="https://hedges.belmont.edu/~shawley/naughty/">“🎅 Naughty by Numbers: Classifications at Christmas”</a>!</p>
</div>
</div>
<hr>
<p>Copyright (c) 2023, Scott H. Hawley. Code is MIT-licensed, text is licensed CC-BY-NC 4.0.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/drscotthawley\.github\.io\/blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>