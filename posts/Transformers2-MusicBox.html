<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Scott H. Hawley">
<meta name="dcterms.date" content="2023-12-13">
<meta name="description" content="Toy Transformer Tunes">

<title>blog - Understanding Transformers, Part 2: Wee Music Box</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
details > summary {
    color: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="blog - Understanding Transformers, Part 2: Wee Music Box">
<meta name="twitter:description" content="Toy Transformer Tunes">
<meta name="twitter:image" content="https://drscotthawley.github.io/blog/posts/images/musicbox_prime.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/drscotthawley" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/drscotthawley" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Understanding Transformers, Part 2: Wee Music Box</h1>
                  <div>
        <div class="description">
          Toy Transformer Tunes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">nlp</div>
                <div class="quarto-category">architectures</div>
                <div class="quarto-category">transformers</div>
                <div class="quarto-category">music</div>
                <div class="quarto-category">midi</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Scott H. Hawley </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 13, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preface" id="toc-preface" class="nav-link active" data-scroll-target="#preface"><span class="header-section-number">1</span> Preface</a>
  <ul class="collapse">
  <li><a href="#managing-expectations" id="toc-managing-expectations" class="nav-link" data-scroll-target="#managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</a></li>
  </ul></li>
  <li><a href="#intuiting-the-rest-of-the-transformer" id="toc-intuiting-the-rest-of-the-transformer" class="nav-link" data-scroll-target="#intuiting-the-rest-of-the-transformer"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</a>
  <ul class="collapse">
  <li><a href="#the-cost-of-attention" id="toc-the-cost-of-attention" class="nav-link" data-scroll-target="#the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</a></li>
  <li><a href="#positional-encoding-aka-positional-embeddings" id="toc-positional-encoding-aka-positional-embeddings" class="nav-link" data-scroll-target="#positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</a>
  <ul class="collapse">
  <li><a href="#pe-to-add-or-concatenate" id="toc-pe-to-add-or-concatenate" class="nav-link" data-scroll-target="#pe-to-add-or-concatenate"><span class="header-section-number">2.2.1</span> PE: To Add or Concatenate?</a></li>
  <li><a href="#pe-wheres-the-start" id="toc-pe-wheres-the-start" class="nav-link" data-scroll-target="#pe-wheres-the-start"><span class="header-section-number">2.2.2</span> PE: Where’s the “Start”?</a></li>
  </ul></li>
  <li><a href="#residual-connections" id="toc-residual-connections" class="nav-link" data-scroll-target="#residual-connections"><span class="header-section-number">2.3</span> Residual Connections</a></li>
  <li><a href="#multi-head-attention" id="toc-multi-head-attention" class="nav-link" data-scroll-target="#multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</a></li>
  <li><a href="#layer-normalization" id="toc-layer-normalization" class="nav-link" data-scroll-target="#layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</a></li>
  <li><a href="#stacking-blocks-embeddings-of-embeddingsof-embeddings" id="toc-stacking-blocks-embeddings-of-embeddingsof-embeddings" class="nav-link" data-scroll-target="#stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings…of Embeddings</a></li>
  </ul></li>
  <li><a href="#the-music-midi-dataset" id="toc-the-music-midi-dataset" class="nav-link" data-scroll-target="#the-music-midi-dataset"><span class="header-section-number">3</span> The Music (MIDI) Dataset</a>
  <ul class="collapse">
  <li><a href="#learning-about-midi-data" id="toc-learning-about-midi-data" class="nav-link" data-scroll-target="#learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</a></li>
  <li><a href="#install-and-import" id="toc-install-and-import" class="nav-link" data-scroll-target="#install-and-import"><span class="header-section-number">3.2</span> Install and Import</a></li>
  <li><a href="#download-and-inspect-the-data" id="toc-download-and-inspect-the-data" class="nav-link" data-scroll-target="#download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</a></li>
  <li><a href="#making-a-tokenizer" id="toc-making-a-tokenizer" class="nav-link" data-scroll-target="#making-a-tokenizer"><span class="header-section-number">3.4</span> Making a Tokenizer</a>
  <ul class="collapse">
  <li><a href="#more-checks" id="toc-more-checks" class="nav-link" data-scroll-target="#more-checks"><span class="header-section-number">3.4.1</span> More Checks:</a></li>
  </ul></li>
  <li><a href="#making-pytorch-datasets" id="toc-making-pytorch-datasets" class="nav-link" data-scroll-target="#making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</a>
  <ul class="collapse">
  <li><a href="#data-augmentation" id="toc-data-augmentation" class="nav-link" data-scroll-target="#data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</a></li>
  <li><a href="#dataset-object-definition" id="toc-dataset-object-definition" class="nav-link" data-scroll-target="#dataset-object-definition"><span class="header-section-number">3.5.2</span> Dataset Object Definition</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#hyperparameters-model-configuration" id="toc-hyperparameters-model-configuration" class="nav-link" data-scroll-target="#hyperparameters-model-configuration"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</a></li>
  <li><a href="#transformer-model-code" id="toc-transformer-model-code" class="nav-link" data-scroll-target="#transformer-model-code"><span class="header-section-number">5</span> Transformer Model Code</a></li>
  <li><a href="#preliminaries-before-training" id="toc-preliminaries-before-training" class="nav-link" data-scroll-target="#preliminaries-before-training"><span class="header-section-number">6</span> Preliminaries before Training</a>
  <ul class="collapse">
  <li><a href="#set-up-the-gpucpu-device" id="toc-set-up-the-gpucpu-device" class="nav-link" data-scroll-target="#set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></a></li>
  <li><a href="#prompt-for-demos" id="toc-prompt-for-demos" class="nav-link" data-scroll-target="#prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</a></li>
  <li><a href="#optional-set-up-wandb-run-tracking" id="toc-optional-set-up-wandb-run-tracking" class="nav-link" data-scroll-target="#optional-set-up-wandb-run-tracking"><span class="header-section-number">6.3</span> Optional: set up WandB run tracking</a></li>
  <li><a href="#re-init-everything-lets-roll" id="toc-re-init-everything-lets-roll" class="nav-link" data-scroll-target="#re-init-everything-lets-roll"><span class="header-section-number">6.4</span> (Re-)Init Everything &amp; Let’s Roll</a></li>
  </ul></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model"><span class="header-section-number">7</span> Train the Model</a></li>
  <li><a href="#evaluate-the-model" id="toc-evaluate-the-model" class="nav-link" data-scroll-target="#evaluate-the-model"><span class="header-section-number">8</span> Evaluate the Model</a>
  <ul class="collapse">
  <li><a href="#sample-generations" id="toc-sample-generations" class="nav-link" data-scroll-target="#sample-generations"><span class="header-section-number">8.1</span> Sample Generations</a></li>
  <li><a href="#perplexity-score" id="toc-perplexity-score" class="nav-link" data-scroll-target="#perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9</span> Summary</a></li>
  <li><a href="#sec-further" id="toc-sec-further" class="nav-link" data-scroll-target="#sec-further"><span class="header-section-number">10</span> Ideas for Further Exploration</a>
  <ul class="collapse">
  <li><a href="#change-the-hyperparamters" id="toc-change-the-hyperparamters" class="nav-link" data-scroll-target="#change-the-hyperparamters"><span class="header-section-number">10.1</span> Change the Hyperparamters</a></li>
  <li><a href="#improving-outputs-with-beam-search" id="toc-improving-outputs-with-beam-search" class="nav-link" data-scroll-target="#improving-outputs-with-beam-search"><span class="header-section-number">10.2</span> Improving Outputs with Beam Search</a></li>
  <li><a href="#using-huggingfaces-transformers-instead" id="toc-using-huggingfaces-transformers-instead" class="nav-link" data-scroll-target="#using-huggingfaces-transformers-instead"><span class="header-section-number">10.3</span> Using Huggingface’s <code>transformers</code> instead</a></li>
  <li><a href="#pitch-only-estimation" id="toc-pitch-only-estimation" class="nav-link" data-scroll-target="#pitch-only-estimation"><span class="header-section-number">10.4</span> Pitch-Only Estimation</a></li>
  <li><a href="#raw-audio" id="toc-raw-audio" class="nav-link" data-scroll-target="#raw-audio"><span class="header-section-number">10.5</span> Raw Audio</a></li>
  </ul></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements"><span class="header-section-number">11</span> Acknowledgements</a></li>
  <li><a href="#appendix-feeding-it-christmas-carols" id="toc-appendix-feeding-it-christmas-carols" class="nav-link" data-scroll-target="#appendix-feeding-it-christmas-carols"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols 🎄</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/musicbox_prime.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Musicbox-Transformer image, via Stable Diffusion XL</figcaption>
</figure>
</div>
<center>
<h1>
— DRAFT MODE: Work in progress. —
</h1>
</center>
<div class="cell">
<div class="cell-output cell-output-display">
<style>
details > summary {
    colora: #00966f;   /* the greenish tinge that appears in my blog */
    cursor: pointer; /* lil triangle thingy */
}
</style>
</div>
</div>
<section id="preface" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Preface</h1>
<p>This is a follow-up to an earlier lesson, <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">“To Understand Transformers, Focus on Attention”</a>. In this lesson, we’ll fill the “blanks” we left in the Transformer architecture last time, and go on to build a working example.</p>
<p>For that example, let’s do something different from the many other online lessons about working with text &amp; Natural Language Processing (NLP): Let’s make a “Generative Music Transformer.” To keep things “small,” we’ll work in terms of MIDI instead of raw audio. For ideas about trying raw audio, see “Further Study” in <a href="#sec-further">Section&nbsp;10</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The goal of this exercise is building <em>some understanding</em>, not building a killer MIDI-generating app. If you want the latter, check out <a href="https://magenta.tensorflow.org/music-transformer">Google Magenta’s paper</a> from 2018, or various extensions since then. If you just want to play around with a great MIDI model, check out <a href="https://huggingface.co/spaces/skytnt/midi-composer">SkyTNT’s HuggingFace Space</a>. By “some” understanding, I also mean that we’re going to largely ignore the many, many variants and improvements on Transformers made over the past several years. I find that <a href="https://twitter.com/rasbt">Sebastian Raschka</a>’s posts to be helpful for considering major updates on the Transformer “theme”.</p>
</div>
</div>
<section id="managing-expectations" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="managing-expectations"><span class="header-section-number">1.1</span> Managing Expectations</h2>
<p>What we’ll end up with is something akin to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">producing garbled Shakespeare</a>, except it’s going to be musical. Garbled music seems much harder to tolerate than garbled Shakespeare, which is why I have delayed releasing this lesson for <em>multiple months</em> – I’ve kept trying to get better results. At this point, I’m resigned to the fact that <em>this is a hard problem</em> (even for MIDI!), and my current outputs are about “as good as they’re going to get”:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
It's way harder to train a simple MIDI transformer to sound OK than a next-character GPT-type transformer to create text that makes at least basic sense. MIDI tokenizer choice is a big deal here also.
</p>
— Mateusz Modrzejewski (@mamodrzejewski) <a href="https://twitter.com/mamodrzejewski/status/1728858756736557451?ref_src=twsrc%5Etfw">November 26, 2023</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>…and we’re going to keep the tokenizer simple.</p>
<p>– <a href="https://hedges.belmont.edu">Scott H. Hawley</a>, December 2023</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In what follows, I’ve often put sections and subsections in expandable “Details” blocks, to enable readers to pick and choose the level of depth they want to see. Enjoy!</p>
</div>
</div>
<hr>
</section>
</section>
<section id="intuiting-the-rest-of-the-transformer" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Intuiting the Rest of the Transformer</h1>
<p>The <a href="https://drscotthawley.github.io/blog/posts/Transformers1-Attention.html">previous lesson</a> left some things out. In this section, we’ll build some intuitive understanding of these other components, and a bit of code.</p>
<p>Below is a picture of the original Transformer model diagram, whose parts we will elucide as we go on. It’s set up like the traditional <a href="https://tex.stackexchange.com/questions/374926/drawing-an-encoder-decoder-architecture-in-tikz">“encoder-decoder” architecture</a> one often sees in the form of an <a href="images/EncoderDecoder_feedback_large.png">“hourglass shape”</a>, although it may not be obvious from the Transformer diagram:</p>
<style>
.img1 {
    /*transform-origin: top left;*/
    width:450px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img1:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-trans-diag" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/TransformerSchematic_labeled.png" class="img1 img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;1<strong>.</strong> (Mouse-over or press to expand.) Original Transformer architecture illustration, blue and red annotations added by me. The “Encoder side” in red is often used for generating embeddings for analysis-based workflows such as classification tasks; one of which of the most famous ‘encoder-only’ models was BERT (which stood Bidirectional Encoder Representations from Transformers). For langauge translation tasks, both the Encoder and Decoder (circled in blue) are used. For purely “generative” systems like the GPT variants and what we’ll do today, we’ll use the Decoder side. Note however that even the Decoder can involve some encoding, as we combine an embedding of the words / MIDI / “tokens” with Positional Encoding information. PE is discussed below.</figcaption>
</figure>
</div>
<p>We’re going to go through the various components that make up the above diagram. But first, let’s point out something about the Attention mechanism that we skipped over in the previous less, namely the computational “cost” associated with making every part of a sequence with every other part.</p>
<section id="the-cost-of-attention" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-cost-of-attention"><span class="header-section-number">2.1</span> The Cost of Attention</h2>
<p>The attention mechanism <em>per se</em> that we covered in the previous post has a serious drawback: the computational cost scales like the sequence length squared, i.e.&nbsp;for a sequence length of <span class="math inline">\(N\)</span>, the cost is <big>𝒪</big>(<span class="math inline">\(N^2)\)</span>. This is one reason that Large Language Models can be “Large” – trying to model long sequences results in big matrices!</p>
<details>
<summary>
Details
</summary>
<p>Various schemes have been proposed to reduce this cost, such as only applying attention over nearby tokens (so-called “sliding window” attention) or other methods that fall under the general heading of “matrix sparsification”. Here’s a slide from a talk I gave a few years ago, illustrating a few of these schemes:</p>
<div id="fig-attn-cost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/attention_cost.hawley.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;2<strong>.</strong> Various schemes for reducing the <big>𝒪</big>(<span class="math inline">\(N^2)\)</span> cost of Attention. Many such schemes involve replacing the <code>Linear</code> layers with convolution operations, such as with the local receptive fields shown in b) and c). (Source: S.H. Hawley, <a href="https://hedges.belmont.edu/AES_ML_2020/">“Learning Tunable Audio Effects via Neural Networks with Self-Attention”</a>, AES Virtual Symposium: Applications of Machine Learning in Audio, Sep 28, 2020.)</figcaption>
</figure>
</div>
<p>TODO: crop that image</p>
<p>For this lesson, we’ll see how far we can get with the basic <span class="math inline">\(N^2\)</span> attention. Beyond that, I encourage you to check the literature for whatever the latest/hottest cost-reducing model might be. Popular candidates include <a href="https://arxiv.org/abs/2205.14135">FlashAttention</a> and <a href="https://arxiv.org/abs/2107.14795">PercieverIO</a>. Even sliding windows are <a href="https://twitter.com/hrishioa/status/1712199009308398079">still in use in ways that some people find significant</a>.</p>
</details></section>
<section id="positional-encoding-aka-positional-embeddings" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="positional-encoding-aka-positional-embeddings"><span class="header-section-number">2.2</span> Positional Encoding (aka Positional Embeddings)</h2>
<p>MLPs and/or ConvNets don’t come with (much of) a sense of position, but giving them one can improve performance on tasks where ordering and position matters. There many ways people have have endowed such models with position-awareness and… TBH there’s not really a “silver bullet” solution, so a variety of approaches end up performing about the same. In what follows we’ll mention a few options.</p>
<details>
<summary>
Details
</summary>
<p>TODO: I want to redo this whole thing.</p>
<p>Various models will encode position by either adding numbers to our input encodings(/embeddings), or by concatenating additional channels.</p>
<p>For example the official Transformer model used with NLP employes sines &amp; cosines (i.e., Fourier series) for the PEs and <em>adds</em> them to the text embeddings. The frequencies of the functions the original used underwent some tweaking (as in the “10000”s in the equations below):</p>
<p><span class="math display">\[
PE_{(pos,2i)} = \sin(pos / 10000^{2i/d_{model}}) \\
PE_{(pos,2i+1)} = \cos(pos / 10000^{2i/d_{model}})
\]</span></p>
<p>…<strong>but we’re not going to use those</strong>. (Because I’ve decided we’re not gonna do NLP!)</p>
<p>In fact, even the authors of the Transformer paper said they tried a few different PE methods/equations (including letting the model learn the PEs) but found no significant impact on performance between them.</p>
<p>So instead of the original sines &amp; cosines,, we’ll use a simplified scheme that <a href="https://fleuret.org/francois/">Francois Fleuret</a> used in the <a href="https://fleuret.org/git-extract/pytorch/attentiontoy1d.py">code</a> for his <a href="https://twitter.com/francoisfleuret/status/1262639062785105922">“AttentionToy1D”</a> demo. It essentially makes a “binary oscillation” scheme of ever-increasing “wavelength”. (Or, if you like to think geometrically, it labels each position as being a vertex of a hypercube.)</p>
<p>See the picture that follows this code for <code>get_positional_input()</code>:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math, torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_positional_input(seq_length, channel_index<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""scheme taken from Francois Flueret's attentiontoy1.py,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">    cf. https://twitter.com/francoisfleuret/status/1263516788479922176"""</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> math.ceil(math.log(seq_length) <span class="op">/</span> math.log(<span class="fl">2.0</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    positional_input <span class="op">=</span> ((torch.arange(seq_length).unsqueeze(<span class="dv">0</span>) <span class="op">//</span> <span class="dv">2</span><span class="op">**</span>torch.arange(c).unsqueeze(<span class="dv">1</span>))<span class="op">%</span><span class="dv">2</span>).<span class="bu">float</span>()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> channel_index<span class="op">==</span><span class="dv">1</span>: positional_input <span class="op">=</span> positional_input.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> positional_input</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>test_seq_length <span class="op">=</span>  <span class="dv">64</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pe <span class="op">=</span> get_positional_input(test_seq_length)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot what these PE channels look like:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span>pe.shape[<span class="dv">0</span>], figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">7</span>))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(pe.shape[<span class="dv">0</span>]):</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    ax[c].plot(pe[c,:],<span class="st">'o-'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    ax[c].set_ylabel(<span class="ss">f"Channel </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>ax[c].set_xlabel(<span class="ss">f"Sequence position"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>plt.plot()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>pe<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> PE channels for test_seq_length = </span><span class="sc">{</span>test_seq_length<span class="sc">}</span><span class="ss">.  (Check: log_2(</span><span class="sc">{</span>test_seq_length<span class="sc">}</span><span class="ss">) = </span><span class="sc">{</span>math<span class="sc">.</span>log2(test_seq_length)<span class="sc">}</span><span class="ss">)."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>6 PE channels for test_seq_length = 64.  (Check: log_2(64) = 6.0).</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="pos-enc" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Transformers2-MusicBox_files/figure-html/pos-enc-output-2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Positional encoding diagram, ala Francois Fleuret</figcaption>
</figure>
</div>
</div>
</div>
<p>…So for each sequence position (horizontally), there is a unique list of 1’s and 0’s across the PE channels (vertically). These lists will be our Positional Encodings.</p>
<section id="pe-to-add-or-concatenate" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="pe-to-add-or-concatenate"><span class="header-section-number">2.2.1</span> PE: To Add or Concatenate?</h3>
<p>Here’s a design question: Should we add these PEs to our inputs or concatenate them? That’s debateable, and it depends. <a href="https://www.youtube.com/watch?v=M2ToEXF6Olw">Here’s a great video discussing this topic</a>. If the number of PE channels is less than the number of input channels (or input embedding dimensions), then we’ll definitely need to concatenate the PEs as additional channels for the inputs. That’s what Fleuret did when he was working with only one channel of floating point inputs, BTW. Here’s some code we’ll use later to concatenate the PEs to our data sequences:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> concat_positional_encoding(<span class="bu">input</span>, channel_index<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"concatenates additional PE channels onto to input"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    positional_input <span class="op">=</span> get_positional_input(<span class="bu">input</span>.shape[<span class="op">-</span><span class="dv">1</span>], channel_index<span class="op">=</span>channel_index)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.cat( (<span class="bu">input</span>, positional_input), dim<span class="op">=</span>channel_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pe-wheres-the-start" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="pe-wheres-the-start"><span class="header-section-number">2.2.2</span> PE: Where’s the “Start”?</h3>
<p>Another design decision: Should we encode each token’s position relative to the start of the <em>entire document/song</em>, or only the token’s position relative to the start of the <em>batch</em> (or sequence-window) we’re computing?</p>
<p>The former (full-document PEs) would allow the model to learn some sense of what sorts of things happen near the beginning, middle &amp; end of a piece (e.g., intro, chorus, outro), but perhaps at the cost of better learning local phenomena. Plus we’d need more channels of PEs to cover such lengths, which would imply more dimensions to our embeddings.</p>
<p>(Also note that if we try to concatenate many articles/songs together, then…should we re-start the PE values at each “boundary” between pieces?)</p>
<p>The latter (PEs only within each batch-sequence) would be simple to do, but it seems unlikely that the model will learn much about the “structure” of the works we want to model. &gt; My usual mantra in ML is “Try both and see! (But do the simplest thing first.)”</p>
<p>So we’ll set it up with position-within-batch at first. And maybe change it later.</p>
</section>
</details></section>
<section id="residual-connections" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="residual-connections"><span class="header-section-number">2.3</span> Residual Connections</h2>
<p>In the Transfomer model diagram of <a href="#fig-trans-diag">Figure&nbsp;1</a>, wherever you see arrows going <em>around</em> something and connecting to a yellow “Add &amp; Norm” block, that is indicative of a “skip residual” or just “residual” connection. Readers will likely have seen residual / skip connections in other contexts, so we’ll make this section “Details”-expandable for those who haven’t encountered them.</p>
<details>
<summary>
Details
</summary>
<p>This is a pretty simple idea that yields payoffs in many areas of numerical modeling: You model the <em>change</em> in something instead of modeling the whole thing. The following flowchart illustrates this:</p>
<div id="fig-resid" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div style="background-color:white; width: 65%; margin-left: auto; margin-right: auto;">
<p><img src="https://mermaid.ink/svg/pako:eNo1j0EKg0AMRa8yBAQFewEXBaubQruxu5JNcGIVnIyMGUqR3r3TSnf_fR4kf4PeW4YKhtk_-5GCmkuHkmVG_WLsRI9ADqXOz7JELczhcDzljXcJ2DQjyYMLlNO3N01eW5uo3gml-YU273iNsxZQguPgaLLp3oZiDIKO7BihStHyQElDQHknlaL620t6qDRELiEulpTb_aN_yXZSH677hN-SEhaSu_dJGWhe-f0B3txJZw" class="figure-img"></p>
</div>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;3<strong>.</strong> Flowchart of a residual connection</figcaption>
</figure>
</div>
<p>With neural networks, this residual scheme has the added benefit of allowing for efficient backpropagation. There are claims that “skip residual” connections also help smooth the loss surface, such as <a href="https://arxiv.org/abs/1712.09913">this figure in a N(eur)IPS paper from 2017</a>:</p>
<div id="fig-loss-landscape" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://miro.medium.com/v2/resize:fit:723/1*_Qd_txKxRlsMdfuH2J-k4g.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;4<strong>.</strong> Loss landscape picture. TODO: I find this a bit gratuitous and may remove.</figcaption>
</figure>
</div>
</details></section>
<section id="multi-head-attention" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="multi-head-attention"><span class="header-section-number">2.4</span> Multi-Head Attention</h2>
<p>As described in the previous lesson, Multi-Head Attention simply involves allowing differently-weighted attention operators (called “heads”) to perform attention operations, allowing them to focus on different “senses” of phrases, parts of speech, or in our case, musical structures.</p>
<style>
.img-mh {
    /*transform-origin: top left;*/
    width:250px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-mh:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-mh-attn" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://machinelearningmastery.com/wp-content/uploads/2021/09/tour_4.png" class="img-mh img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;5<strong>.</strong> Diagram of Multi-Head Attention. The multiple attention “heads” are shown below as depthwise semi-transparent copies, which are then concatenated into “one big long thing” via the Concat operation, and then mapped into the the output for the module via the last Linear layer: (Source: AIAYN paper.)</figcaption>
</figure>
</div>
</section>
<section id="layer-normalization" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="layer-normalization"><span class="header-section-number">2.5</span> Layer Normalization</h2>
<p>This alternative to <a href="https://paperswithcode.com/method/batch-normalization">Batch Normalization</a> (in which we perform elementwise operations where we subtract the mean across the batch dimension and divide by the variance). Instead of doing this across the batch dimension, we do it across the feature dimension(s).</p>
<style>
.img-ln {
    /*transform-origin: top left;*/
    width:350px;
    transition:transform 0.4s ease;
    position: relative;
    z-index: 0;
}
.img-ln:hover {
    -webkit-transform:scale(1.7);
    transform:scale(1.7);
    z-index:1;
}
</style>
<div id="fig-norm-types" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://production-media.paperswithcode.com/methods/Screen_Shot_2020-05-19_at_4.24.42_PM.png" class="img-ln img-fluid figure-img"></p>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;6<strong>.</strong> (Mouse-over or press to expand.) Batch normalization vs.&nbsp;Layer normalization. Source: TODO</figcaption>
</figure>
</div>
<p>One big advantage of doing our normalization across layers instead of batches is that <em>it allows for small batch sizes.</em> Language models are often <em>large</em>, so they take up a lot of memory, which means you might need very small batches. But small batches will not allow you to do very good batch normalization. So, LayerNorm helps us get good statistics for the mean and variance that we use to normalize.</p>
</section>
<section id="stacking-blocks-embeddings-of-embeddingsof-embeddings" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="stacking-blocks-embeddings-of-embeddingsof-embeddings"><span class="header-section-number">2.6</span> Stacking Blocks: Embeddings of Embeddings…of Embeddings</h2>
<p>By stacking layers of our transformers, i.e.&nbsp;feeding embeddings into layers that will render them as new embeddings, we wil increase the representational power of our model. In terms of code, this is easy to do by looping over a list of layers.</p>
</section>
</section>
<section id="the-music-midi-dataset" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The Music (MIDI) Dataset</h1>
<p>This section adopts a first-person perspective because I want to convey a personal tone: I confess that I’m “not a MIDI guy,” having always worked with raw audio exclusively. I vastly underestimated how difficult it would be to get decent results. Starting from Google’s well-known <a href="https://magenta.tensorflow.org/datasets/maestro">MAESTRO dataset</a> of solo piano performances – NOTE: <em>virtuoso</em> piano performances! –I kept downgrading the “difficulty” of the dataset until settling on <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach chorales</a>.</p>
<section id="learning-about-midi-data" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="learning-about-midi-data"><span class="header-section-number">3.1</span> Learning About MIDI Data</h2>
<details>
<summary>
Details
</summary>
<p>The MAESTRO data wasn’t overly challenging if I only focussed on modeling the pitches, but music is pitch + timing (+ more). What’s more, I’d only ever seen MIDI music “quantized” into a grid-based “piano roll” format with a known time-signature, not realizing that that’s not what MIDI data really is. For our purposes, it’s worth noting that MIDI encodes several pieces of information on a <em>per-note</em> basis:</p>
<ol type="1">
<li>What instrument played the note</li>
<li>What pitch was played – an integer between 0 and 127.</li>
<li>The start time of the note – in units of the “MIDI clock” which <em>usually</em> ticks at 50,000 times a second. This is typically rendered as a floating-point number when using Python MIDI-processing packages such as Colin Raffel’s <a href="https://craffel.github.io/pretty-midi/">pretty-midi</a> (which we will use)</li>
<li>The end time of the note - another float.</li>
<li>The “velocity” of the note – e.g.&nbsp;how hard a piano key was struck.</li>
</ol>
<p>So, no time signature, no quarter-note, half-note, etc. But fine, taking a lead from the <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">Google Tensorflow Demo for RNN Modeling</a>, we can reduce each note to 3 numbers: 1. pitch 2. “step” in time since the previous note 3. duration of the note (i.e.&nbsp;end time minus start time).</p>
<p>…and focus on single-instrument work, and disregard the velocity.</p>
<p>EVEN THAT was too hard for the code below do with MAESTRO. I then noticed a <a href="https://arxiv.org/abs/1808.03715">paper by the Google team</a> pointed out that quantizing the time into bins of 8 milliseconds was an ok simplification to make, but even this proved too hard for my model. (I could do 16 ms, but that sounded weird.)</p>
<p>…so…. after surveying other things, I went with <a href="https://github.com/czhuang/JSB-Chorales-dataset">Bach Chorales</a>, which actually <em>are</em> presented in piano-roll format quantized to 16th note time intervals. Then I had to convert those from JSON to true MIDI, because by then the rest of my code expected MIDI.</p>
<p>I’ll spare you the details of that process, but note that the data link below is not the official dataset link, it’s <a href="https://drive.google.com/file/d/1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb/view?usp=sharing">my private stash</a> where I converted the JSON to .mid.</p>
</details></section>
<section id="install-and-import" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="install-and-import"><span class="header-section-number">3.2</span> Install and Import</h2>
<div class="cell">
<details>
<summary>Show the code for system-wide installs</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> install_package(package_name):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"For installing system binaries on Linux (Ubuntu/Debia) or Mac (via Homebrew)"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">'Darwin'</span>:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        os.system(<span class="ss">f'brew install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> platform.system() <span class="op">==</span> <span class="st">'Linux'</span>:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> getpass  <span class="co"># </span><span class="al">TODO</span><span class="co">: colab doesn't need a password for sudo</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        password <span class="op">=</span> getpass.getpass()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        command <span class="op">=</span> <span class="ss">f"sudo -S apt-get install </span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        os.popen(command, <span class="st">'w'</span>).write(password<span class="op">+</span><span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Unsupported Operating System"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>install_package(<span class="st">'fluidsynth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code for pip installs</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>qq gdown pyfluidsynth pretty_midi torch numpy pandas midi<span class="op">-</span>player multiprocess</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code for imports</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import (most of) what we'll need for the entire lesson</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fluidsynth</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pretty_midi</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn, einsum</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> functional <span class="im">as</span> F</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocess <span class="im">as</span> mp   <span class="co"># multiprocess is a Jupyter-compatible fork of multiprocessing</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm  <span class="co"># note: Quarto blog won't print output from tqdm.notebook</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">#from tqdm.contrib.concurrent import process_map  # process_map throws errors on Mac :'-( </span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pprint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-and-inspect-the-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="download-and-inspect-the-data"><span class="header-section-number">3.3</span> Download and Inspect the Data</h2>
<div class="cell">
<details>
<summary>Show the code for downloading the dataset</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data_source <span class="op">=</span> <span class="st">'jsb_chorales_midi'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add options for MAESTRO, others</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">'midi_data'</span>) <span class="co"># generic name for whatever midi we might want</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>REST_PITCH <span class="op">=</span> <span class="dv">127</span>  <span class="co"># special code  used to denote rests</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>gdown <span class="op">-</span>O {data_source}.tgz <span class="dv">1</span><span class="er">MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tar zxf {data_source}.tgz<span class="op">;</span> rm <span class="op">-</span>rf midi_data<span class="op">;</span> ln <span class="op">-</span>s {data_source} midi_data <span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the list of MIDI filenames</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> <span class="bu">sorted</span>(glob(<span class="bu">str</span>(data_dir<span class="op">/</span><span class="st">'**/*.mid*'</span>),recursive<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Number of files:'</span>, <span class="bu">len</span>(filenames))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading...
From: https://drive.google.com/uc?id=1MdJiNEgtkvCx9tnyQWcnEE5GPMY6ADUb
To: /Users/shawley/github/blog/posts/jsb_chorales_midi.tgz
100%|████████████████████████████████████████| 137k/137k [00:00&lt;00:00, 3.26MB/s]
Number of files: 382</code></pre>
</div>
</div>
<p>Let’s inspect one of the files – using the <a href="https://github.com/drscotthawley/midi-player"><code>MIDIPlayer</code></a> object created especially for this lesson!</p>
<div class="cell">
<details>
<summary>Show the code for MIDI player usage</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player <span class="im">import</span> MIDIPlayer</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_player.stylers <span class="im">import</span> dark <span class="co"># I like dark mode</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>midi_file <span class="op">=</span> filenames[<span class="dv">0</span>]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>MIDIPlayer(midi_file, <span class="dv">360</span>, styler<span class="op">=</span>dark, title<span class="op">=</span><span class="ss">f"midi_file = </span><span class="sc">{</span>midi_file<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-midi-play1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section597 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section597 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section597 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section597 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section597 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section597 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section597 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section597 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section597 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section597 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section597 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section597&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>midi_file = midi_data/test/jsb_chorale_test_0.mid<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A sound-font visualizer=&quot;#section597 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhQDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIMnMEAANQAAQ0AARQAASECDJilAADAAAEFAAEMAAEVAAEgAhBApAAArQGorAAAtQGktAAAuQGouAAAwQABAQABBAABDQABFAGowAAAyQAA+QABAAGkyAAA0QAA+AGowQAA0AAA6QGkwAAA1QAA5QAA6AABDAABFQGo1AAA3QAA5AAA6QGo3AAA5QAA6AGk5AAA6QAA+QGo6AAA+AABAQABDQABFAGk6QGo5QAA6AGo3QAA5AGk1QAA3AABAAABBQABDAABFQGo0QAA1AGkyQAA0AAA8AAA+QGowQAAyAGouQAAwAABDQABFAGkrQAAuAGorAAAwQAA8QAA+AABAQABBAGk6QAA8AGopQAAwAAA5QAA6AABAAABBQABDAIMmJkAAKQAAOQAAPkAAQQAARUAATUBqJgAAKUAAPEAAPgBqKQAAK0AAOkAAPAAAQ0AARQAATEAATQBpKwAALUBqLQAALkAAQUAAQwAASkAATABpOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADVAADcAAD5AAEAAAEZAAEgAajIAADRAADUAADdAaTQAADVAADcAADlAADxAAD4AAEVAAEYAai1AADUAADkAai0AAC5AADpAADwAAD5AAENAAEUAaStAAC4ANTlAADoANSsAADBAADdAADkAADxAAD4AgVMpQAAwAAA3AAA5QABBQABDAIMmKQAAOQAAPAAAQQAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="360" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
<figcaption class="figure-caption"><strong>Figure</strong>&nbsp;7<strong>.</strong> Example of the first MIDI file on our list. (Press the play button to listen.) These particular notes really <em>were</em> arranged on a “grid,” however I converted them to a series of MIDI “notes,” occurring one after the other in the file, with simultaneously-starting notes sorted in ascending order of pitch.</figcaption>
</figure>
</div>
</div>
<p>Let’s load a single file and convert it to a PyTorch tensor called <code>notes_tensor</code>, and we’ll go ahead and convert “start” and “end” times “step” and “duration” times. So, displaying the first several notes (using a <code>pandas</code> dataframe for style) we see…</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midi_file_to_tensor(filenames, i<span class="op">=</span><span class="va">None</span>, keep_start_end<span class="op">=</span><span class="va">False</span>):  <span class="co"># filenames could just be a single filename</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    midi_file <span class="op">=</span> filenames <span class="cf">if</span> i <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">type</span>(filenames)<span class="op">==</span><span class="bu">str</span>  <span class="cf">else</span> filenames[i]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"reads a single midi file and converts it to tensor with elements (pitch, step, duration)"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI(midi_file) <span class="co"># read in the whole file. this can be very slow for long MIDI files (e.g. in MAESTRO)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort the notes first by start time (and then by pitch if two notes start at the same time)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    sorted_notes <span class="op">=</span> <span class="bu">sorted</span>(pm.instruments[<span class="dv">0</span>].notes, key<span class="op">=</span><span class="kw">lambda</span> note: (note.start, note.pitch))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> torch.empty( (<span class="bu">len</span>(sorted_notes), <span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>keep_start_end), dtype<span class="op">=</span>torch.float32 ) <span class="co"># allocate storage</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> sorted_notes[<span class="dv">0</span>].start</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_notes):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        notes[i] <span class="op">=</span> note.pitch</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        notes[i, <span class="dv">1</span>] <span class="op">=</span> note.start <span class="op">-</span> prev_start  <span class="co"># step, i.e. time since start of previous note</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        notes[i, <span class="dv">2</span>] <span class="op">=</span> note.end <span class="op">-</span> note.start    <span class="co"># duration</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> note.start</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> keep_start_end:                     <span class="co"># might find it useful be able to keep these for easier analysis later</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            notes[i, <span class="dv">3</span>] <span class="op">=</span> note.start</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            notes[i, <span class="dv">4</span>] <span class="op">=</span> note.end</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> notes</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>notes_tensor <span class="op">=</span> midi_file_to_tensor(midi_file)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.notebook_repr_html'</span>, <span class="va">True</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>notes_df <span class="op">=</span> pd.DataFrame(notes_tensor, columns<span class="op">=</span>[<span class="st">'pitch'</span>,<span class="st">'step'</span>,<span class="st">'duration'</span>]) <span class="co"># actually df's look nicer</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># making it look better in the blog: adjust width of pandas dataframes</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">'''</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe {</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="st">    width: 40%; /* Adjust this value as needed */</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="st">.dataframe th, .dataframe td {</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="st">    width: auto !important;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="st">table {</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-left: auto;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-right: auto;</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="st">th, td {</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="st">    text-align: center;</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="st">    min-width: 100px; /* Or any other width */</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>))</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>HTML(notes_df[:<span class="dv">8</span>].to_html(index<span class="op">=</span><span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">


<style>
.dataframe {
    width: 40%; /* Adjust this value as needed */
    margin-left: auto;
    margin-right: auto;
}
.dataframe th, .dataframe td {
    text-align: center;
    width: auto !important;
}

table {
    margin-left: auto;
    margin-right: auto;
}
th, td {
    text-align: center;
    min-width: 100px; /* Or any other width */
}
</style>
</div>
<div class="cell-output cell-output-display">
<div id="tbl-firstnotes" class="anchored">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<caption>Table&nbsp;1<strong>.</strong> First 8 notes of <code>notes_tensor</code></caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pitch</th>
<th data-quarto-table-cell-role="th">step</th>
<th data-quarto-table-cell-role="th">duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>53.0</td>
<td>0.000000</td>
<td>0.479545</td>
</tr>
<tr class="even">
<td>57.0</td>
<td>0.000000</td>
<td>0.479545</td>
</tr>
<tr class="odd">
<td>60.0</td>
<td>0.000000</td>
<td>1.440909</td>
</tr>
<tr class="even">
<td>65.0</td>
<td>0.000000</td>
<td>0.479545</td>
</tr>
<tr class="odd">
<td>52.0</td>
<td>0.479545</td>
<td>0.479545</td>
</tr>
<tr class="even">
<td>55.0</td>
<td>0.000000</td>
<td>0.479545</td>
</tr>
<tr class="odd">
<td>72.0</td>
<td>0.000000</td>
<td>0.240909</td>
</tr>
<tr class="even">
<td>70.0</td>
<td>0.240909</td>
<td>0.238636</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We’ll convert those floating point numbers to integers via the “tokenizer” below.</p>
<p>Now we’ll load each song into an entry in a list called <code>notes_tensor_list</code>:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> files_to_tensor_list(filenames, keep_start_end<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Reads MIDI files in parallel so should be reasonably fast. JSB Chorales are no prob but for MAESTRO you want this"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tensor_list = process_map(midi_file_to_tensor, filenames, max_workers=mp.cpu_count(), chunksize=1) # Doesn't work on Mac</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    tensor_list <span class="op">=</span> []</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mp.Pool(processes<span class="op">=</span>mp.cpu_count()) <span class="im">as</span> p:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        max_ <span class="op">=</span> <span class="bu">len</span>(filenames)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tqdm(total<span class="op">=</span>max_) <span class="im">as</span> pbar:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> r <span class="kw">in</span> p.imap_unordered(partial(midi_file_to_tensor, filenames, keep_start_end<span class="op">=</span>keep_start_end), <span class="bu">range</span>(<span class="dv">0</span>, max_)):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                tensor_list.append(r)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                pbar.update()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  tensor_list</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>notes_tensor_list_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>data_source<span class="sc">}</span><span class="ss">_tensor_list.pt'</span>         <span class="co"># we'll save the result to a file for easier re-reading next time</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>read_all_midi_files <span class="op">=</span> <span class="kw">not</span> os.path.exists(notes_tensor_list_filename) <span class="co"># check to see if it already exists</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> read_all_midi_files:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> files_to_tensor_list(filenames)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    torch.save(notes_tensor_list, notes_tensor_list_filename) <span class="co"># save for next time</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    notes_tensor_list <span class="op">=</span> torch.load(notes_tensor_list_filename) <span class="co"># just read from the last time we made one</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">len(notes_tensor_list) = </span><span class="sc">{</span><span class="bu">len</span>(notes_tensor_list)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
len(notes_tensor_list) = 382</code></pre>
</div>
</div>
<p>Also, let’s make a single tensor <code>all_notes</code> out of all the notes. We’re only going to use this for analysis purposes; for everything else we’ll use the <code>notes_tensor_list</code>, which…I’m now going to abbreviate as <code>notes_tl</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>notes_tl <span class="op">=</span> notes_tensor_list</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>all_notes <span class="op">=</span> torch.vstack(notes_tl).<span class="bu">type</span>(torch.float32)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"all_notes.shape = "</span>,all_notes.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>all_notes.shape =  torch.Size([78418, 3])</code></pre>
</div>
</div>
</section>
<section id="making-a-tokenizer" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="making-a-tokenizer"><span class="header-section-number">3.4</span> Making a Tokenizer</h2>
Rather than try something sophisticated like calling <a href="https://github.com/Natooz/MidiTok">MidiTok</a>, we’re going to treat this like a “char-level RNN” and just regard each note as a “parallel” group of 3 tokens (one token for pitch, step, and duration). This means that we will need 3 “codebooks” that can encode &amp; decode between true values and their tokens.
<details>
<summary>
Details
</summary>
<p>For the pitch values, it’s pretty easy since there are up to 128 pitches. Probably they won’t all be used, so we <em>could</em> limit the range of pitches, however, I’m going to want to do some pitch-bending data augmentation, so the pitch tokens will just be <code>int</code> versions of their <code>floats</code>, indices in a 128-dimensional space.</p>
<p>For the timing – which I don’t plan to do any augmentation of – we’ll just write down what unique values are present. These will form the “vocabularies” that we often see used in NLP settings.</p>
<p>Oh, also: The timing values end up being <em>reaaalllly</em> long in some cases. Like, notes with 15 seconds in duration? I’m going to go ahead an clamp those to a maximum value of 4 seconds.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_codebooks(all_notes, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    codebooks <span class="op">=</span> []</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    n_codebooks <span class="op">=</span> all_notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="co"># should be 3</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_codebooks): </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:  <span class="co"># i=0 means pitch</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> torch.arange(<span class="dv">128</span>)  <span class="co"># just use all possible pitches </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:     <span class="co"># i!=0 means timing</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            cb_vals <span class="op">=</span> all_notes[:,i].unique().sort()[<span class="dv">0</span>] </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">---</span><span class="ch">\n</span><span class="ss">cb </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: cb_vals = </span><span class="sc">{</span>cb_vals<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        codebooks.append({<span class="st">'encode'</span>:{k.item(): <span class="bu">int</span>(v) <span class="cf">for</span> v, k <span class="kw">in</span> <span class="bu">enumerate</span>(cb_vals)}, <span class="co"># codebooks go both ways</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'decode'</span>:{<span class="bu">int</span>(v): k <span class="cf">for</span> v, k <span class="kw">in</span> <span class="bu">enumerate</span>(cb_vals)}})</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f" cb </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: cb keys = </span><span class="sc">{</span>codebooks[<span class="op">-</span><span class="dv">1</span>][<span class="st">'encode'</span>]<span class="sc">.</span>keys()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> codebooks</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>all_notes[:,<span class="dv">1</span>:] <span class="op">=</span> torch.clamp(all_notes[:,<span class="dv">1</span>:], <span class="dv">0</span>, <span class="fl">4.0</span>) <span class="co"># clamp max value of step &amp; dur</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>codebooks <span class="op">=</span> make_codebooks(all_notes)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>vocab_sizes <span class="op">=</span> [<span class="bu">len</span>(cb[<span class="st">'encode'</span>]) <span class="cf">for</span> cb <span class="kw">in</span> codebooks]</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"vocab_sizes = "</span>,vocab_sizes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
---
cb 0: cb_vals = tensor([  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,
         14,  15,  16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,  27,
         28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,  41,
         42,  43,  44,  45,  46,  47,  48,  49,  50,  51,  52,  53,  54,  55,
         56,  57,  58,  59,  60,  61,  62,  63,  64,  65,  66,  67,  68,  69,
         70,  71,  72,  73,  74,  75,  76,  77,  78,  79,  80,  81,  82,  83,
         84,  85,  86,  87,  88,  89,  90,  91,  92,  93,  94,  95,  96,  97,
         98,  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
        112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125,
        126, 127])
 cb 0: cb keys = dict_keys([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127])

---
cb 1: cb_vals = tensor([0.0000, 0.1182, 0.1205, 0.2386, 0.2409, 0.3591, 0.3614, 0.4795, 0.4818,
        0.7182, 0.7205, 0.9591, 0.9614, 1.2000, 1.4386, 1.4409, 1.6795, 1.6818,
        1.9182, 1.9205, 2.4000, 2.8795, 2.8818, 3.8386, 3.8409, 4.0000])
 cb 1: cb keys = dict_keys([0.0, 0.11818181723356247, 0.12045454233884811, 0.23863635957241058, 0.24090908467769623, 0.3590908944606781, 0.36136364936828613, 0.4795454442501068, 0.48181816935539246, 0.7181817889213562, 0.7204545736312866, 0.9590908885002136, 0.9613636136054993, 1.2000000476837158, 1.4386364221572876, 1.4409091472625732, 1.6795454025268555, 1.6818181276321411, 1.9181817770004272, 1.920454502105713, 2.4000000953674316, 2.8795454502105713, 2.8818182945251465, 3.8386363983154297, 3.840909004211426, 4.0])

---
cb 2: cb_vals = tensor([0.1182, 0.1205, 0.2386, 0.2409, 0.3591, 0.3614, 0.4795, 0.4818, 0.6000,
        0.7182, 0.7205, 0.8386, 0.8409, 0.9591, 0.9614, 1.0795, 1.0818, 1.2000,
        1.3205, 1.4386, 1.4409, 1.5591, 1.6795, 1.6818, 1.8000, 1.9182, 1.9205,
        2.0409, 2.1591, 2.1614, 2.4000, 2.5205, 2.6386, 2.6409, 2.8795, 2.8818,
        3.1182, 3.1205, 3.2386, 3.3591, 3.3614, 3.6000, 3.8386, 3.8409, 4.0000])
 cb 2: cb keys = dict_keys([0.11818181723356247, 0.12045454233884811, 0.23863635957241058, 0.24090908467769623, 0.3590908944606781, 0.36136364936828613, 0.4795454442501068, 0.48181816935539246, 0.6000000238418579, 0.7181817889213562, 0.7204545736312866, 0.8386363387107849, 0.8409090638160706, 0.9590908885002136, 0.9613636136054993, 1.079545497894287, 1.0818182229995728, 1.2000000476837158, 1.3204545974731445, 1.4386364221572876, 1.4409091472625732, 1.5590908527374268, 1.6795454025268555, 1.6818181276321411, 1.7999999523162842, 1.9181817770004272, 1.920454502105713, 2.0409090518951416, 2.159090995788574, 2.1613636016845703, 2.4000000953674316, 2.5204546451568604, 2.638636350631714, 2.640909194946289, 2.8795454502105713, 2.8818182945251465, 3.1181817054748535, 3.1204545497894287, 3.2386362552642822, 3.359090805053711, 3.361363649368286, 3.5999999046325684, 3.8386363983154297, 3.840909004211426, 4.0])
vocab_sizes =  [128, 26, 45]</code></pre>
</div>
</div>
<p>Now we need routines to convert back and forth between values and codebook indices. We’ll make a single function <code>remap_vals()</code> that can either go “forward” for encoding, or “backward” for decoding:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remap_vals(seq, encdec_str, dtype<span class="op">=</span>torch.<span class="bu">long</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> torch.zeros_like(seq, dtype<span class="op">=</span>dtype)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(seq.shape[<span class="op">-</span><span class="dv">1</span>]): </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        dict_map <span class="op">=</span> codebooks[cb][encdec_str]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        default_map <span class="op">=</span> <span class="bu">max</span>(codebooks[cb][encdec_str].values())</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        out[:,cb] <span class="op">=</span> torch.tensor([dict_map.get(x.item(),default_map) <span class="cf">for</span> x <span class="kw">in</span> seq[:,cb]], dtype<span class="op">=</span>dtype)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll be calling these 'encode' and 'decode functions', which really just pull up the applicable part of the codebooks</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>encode <span class="op">=</span> <span class="kw">lambda</span> s: remap_vals(s, <span class="st">'encode'</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>decode <span class="op">=</span> <span class="kw">lambda</span> s: remap_vals(s, <span class="st">'decode'</span>, dtype<span class="op">=</span>all_notes.dtype)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># And let's do a little test</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>midi_seq <span class="op">=</span> all_notes[<span class="dv">0</span>:<span class="dv">6</span>].clone()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before encoding, midi_seq =</span><span class="ch">\n</span><span class="st">"</span>,midi_seq)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After encoding, token_list =</span><span class="ch">\n</span><span class="st">"</span>,token_list)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>return_seq <span class="op">=</span> decode(token_list)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After decoding, return_seq =</span><span class="ch">\n</span><span class="st">"</span>,return_seq)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> torch.equal(midi_seq, return_seq), <span class="ss">f"Oops. midi_seq=</span><span class="sc">{</span>midi_seq<span class="sc">}</span><span class="ss">, but return_seq=</span><span class="sc">{</span>return_seq<span class="sc">}</span><span class="ss">. Should be the same"</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>midi_seq[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">100.0</span>  <span class="co"># give the last time a huge value to check that our mapper won't crash</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>token_list <span class="op">=</span> encode(midi_seq) <span class="co"># if it doesn't crash, we're good</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> token_list[<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="bu">list</span>(codebooks[<span class="op">-</span><span class="dv">1</span>][<span class="st">'encode'</span>].values())[<span class="op">-</span><span class="dv">1</span>], <span class="st">"Big value should have gotten the last spot in the last codebook"</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checks pass! :-)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Before encoding, midi_seq =
 tensor([[50.0000,  0.0000,  0.2409],
        [53.0000,  0.0000,  0.2409],
        [57.0000,  0.0000,  0.9591],
        [62.0000,  0.0000,  0.9591],
        [52.0000,  0.2409,  0.2386],
        [55.0000,  0.0000,  0.2386]])
After encoding, token_list =
 tensor([[50,  0,  3],
        [53,  0,  3],
        [57,  0, 13],
        [62,  0, 13],
        [52,  4,  2],
        [55,  0,  2]])
After decoding, return_seq =
 tensor([[50.0000,  0.0000,  0.2409],
        [53.0000,  0.0000,  0.2409],
        [57.0000,  0.0000,  0.9591],
        [62.0000,  0.0000,  0.9591],
        [52.0000,  0.2409,  0.2386],
        [55.0000,  0.0000,  0.2386]])
Checks pass! :-)</code></pre>
</div>
</div>
<section id="more-checks" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="more-checks"><span class="header-section-number">3.4.1</span> More Checks:</h3>
<p>Before moving on, it’s a good idea to double check: Can we really encode and decode an entire midi sequence? Let’s write some more utility files. Notably the <code>midiplayer()</code> routine which will allow us to play our PyTorch tensors directly in this notebook.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_startend(notes:torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"integrates (step,duration) timing pairs to recover (start,end) info. concats them as new columns"</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    newnotes <span class="op">=</span> torch.zeros((<span class="bu">len</span>(notes), <span class="dv">5</span>), dtype<span class="op">=</span>notes.dtype, device<span class="op">=</span>notes.device)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    newnotes[:,:<span class="dv">3</span>] <span class="op">=</span> notes[:,:<span class="dv">3</span>]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, note <span class="kw">in</span> <span class="bu">enumerate</span>(notes): </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        step, dur <span class="op">=</span> note[<span class="dv">1</span>], note[<span class="dv">2</span>]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> step  <span class="op">+</span> prev_start </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        end   <span class="op">=</span> start <span class="op">+</span> dur</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        newnotes[i,<span class="dv">3</span>], newnotes[i,<span class="dv">4</span>] <span class="op">=</span> start, end</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> start   </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newnotes</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> notes_to_midi(notes:torch.Tensor, </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                  time_rescale<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                  out_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">''</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                  instrument_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">'Acoustic Grand Piano'</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                  velocity: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span>,  <span class="co"># default loudness for all notes</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                 ) <span class="op">-&gt;</span> pretty_midi.PrettyMIDI:</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.clone() <span class="co"># just to avoid weird overwrites of memory addresses</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="fl">0.0</span>:</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">"WARNING: You have negative pitches, steps or durations. Setting them to zero"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      notes <span class="op">=</span> notes <span class="op">*</span> (notes <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> time_rescale <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: <span class="co"># just added this because sometime I want to slow/speed up</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        notes[:,<span class="dv">1</span>:] <span class="op">=</span> notes[:,<span class="dv">1</span>:] <span class="op">*</span>time_rescale</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> pretty_midi.PrettyMIDI()</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    instrument <span class="op">=</span> pretty_midi.Instrument(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        program<span class="op">=</span>pretty_midi.instrument_name_to_program(</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>            instrument_name))</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> notes.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">5</span>: notes <span class="op">=</span> get_startend(notes)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> notes.cpu().numpy()</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    prev_start <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> note <span class="kw">in</span> notes: </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        pitch, start, end <span class="op">=</span> <span class="bu">int</span>(note[<span class="dv">0</span>]), note[<span class="dv">3</span>], note[<span class="dv">4</span>] </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        midi_note <span class="op">=</span> pretty_midi.Note( velocity<span class="op">=</span>velocity, pitch<span class="op">=</span>pitch, start<span class="op">=</span>start, end<span class="op">=</span>end, )</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        instrument.notes.append(midi_note)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        prev_start <span class="op">=</span> start   </span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    pm.instruments.append(instrument)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_file: pm.write(out_file)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pm</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> midiplayer(notes_tensor, height<span class="op">=</span><span class="dv">400</span>, time_rescale<span class="op">=</span><span class="va">None</span>, midi_file<span class="op">=</span><span class="st">"/tmp/tmp.mid"</span>, title<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"MIDIplayer that writes input tensor to temporary file"</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    pm <span class="op">=</span> notes_to_midi(notes_tensor, time_rescale<span class="op">=</span>time_rescale, out_file<span class="op">=</span>midi_file)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MIDIPlayer(midi_file, height, styler<span class="op">=</span>dark, dl<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span>title)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’re going to encode &amp; decode, and write to a MIDI file, and play that midi file. Using the same file as above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>midiplayer(decode(encode(midi_file_to_tensor(filenames[<span class="dv">0</span>]))), title<span class="op">=</span><span class="st">'Encode-Decode Test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section369 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section369 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section369 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section369 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section369 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section369 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section369 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section369 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section369 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section369 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section369 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section369&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Encode-Decode Test<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== sound-font visualizer=&quot;#section369 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAEhgDAAACQNUAAOUAAPEAAQUCBUzRAADUAADdAADkAAEEAAEhAakZAAEgAaTQAADVAADcAAEVAAEYAajRAADUAADdAAENAAEUAajJAADQAADcAADlAADwAAD5AAEFAAEMAaTkAADpAAD4AAEBAai1AADIAADoAADxAAEAAAEhAgVMtAAAuQABIAABKQGouAAAwQAA6QAA8ADQ5QAA6ADUwAAAyQAA5AAA6QGoyAAA0QGk0AAA1QAA5QAA6AABIQABKAIFUNEAANQAAOQAAPEAAQQAAQ0CBUzQAADVAAEMAAEVAAEgAAEpAgVM1AAA3QAA7QAA8AABDQABFAABKAABMQIFTNwAAOUAAOwAAPEAAQUAAQwAATAAATUBqOQAAOkAAPAAAPkAAQQAAQ0BpOgAAPEAAPgAAQEAATEAATQBqNEAAN0AAPAAAQABqNAAANUAANwAAOUAAQUAAQwAASkAATABpMkAANQAAOQAAPkBqMgAAN0AAO0AAPgCBUzBAADcAADsAADxAAEBAAEEAAEhAAEoAgVMwAAA1QABAAABBQABFQABIAIFTLkAANQAAOkAAPAAARQAASkBqOUAAOgBqLgAAMEAAN0AAOQAAQEAAQQAASEAASgCBUzAAADJAADcAAD5AAEAAAEFAAEZAAEgAaTIAADRAADxAAD4AAEEAAENAajQAADVAAEFAAEMAAEVAAEYAai5AADUAaS4AADBAAENAAEUAgVNAQABBAIFUKUAAMAAAQAAAQUAAQwCDJikAADRAAEEAAENAAEhAgyY0AAA1QABDAABFQABIAIEwPACBdzBAADUAAENAAEUAAEhAgyYpQAAwAABBQABDAABFQABIAIQQKQAAK0BqKwAALUBpLQAALkBqLgAAMEAAQEAAQQAAQ0AARQBqMAAAMkAAPkAAQABpMgAANEAAPgBqMEAANAAAOkBpMAAANUAAOUAAOgAAQwAARUBqNQAAN0AAOQAAOkBqNwAAOUAAOgBpOQAAOkAAPkBqOgAAPgAAQEAAQ0AARQBpOkBqOUAAOgBqN0AAOQBpNUAANwAAQAAAQUAAQwAARUBqNEAANQBpMkAANAAAPkBqMEAAMgBqLkAAMAAAQ0AARQBpK0AALgBqKwAAMEAAPEAAPgAAQEAAQQBpOkAAPABqKUAAMAAAOUAAOgAAQAAAQUAAQwCDJiZAACkAADkAAD5AAEEAAEVAAE1AaiYAAClAADxAAD4AaikAACtAADpAADwAAENAAEUAAExAAE0AaSsAAC1Aai0AAC5AAEFAAEMAAEpAAEwAaTlAADoAai4AADBAADdAADkAAEBAAEEAAEhAAEoAgVMwAAAyQAA1QAA3AAA+QABAAABGQABIAGoyAAA0QAA1AAA3QGk0AAA1QAA3AAA5QAA8QAA+AABFQABGAGotQAA1AAA5AGotAAAuQAA6QAA8AAA+QABDQABFAGkrQAAuADU5QAA6ADUrAAAwQAA3QAA5AAA8QAA+AIFTKUAAMAAANwAAOUAAQUAAQwCDJikAADkAADwAAEEAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>Yay! Moving on…</p>
</section>
</details></section>
<section id="making-pytorch-datasets" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="making-pytorch-datasets"><span class="header-section-number">3.5</span> Making PyTorch Dataset(s)</h2>
<p>Our particular dataset already comes with a test/train/valid split in its subdirectores, so let’s use that split. We’ll go ahead and re-load the files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor lists</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>train_filenames <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/train'</span> <span class="kw">in</span> x]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>val_filenames   <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/val'</span>   <span class="kw">in</span> x]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>test_filenames  <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> filenames <span class="cf">if</span> <span class="st">'/test'</span>  <span class="kw">in</span> x]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>train_notes_tl <span class="op">=</span> files_to_tensor_list(train_filenames)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>val_notes_tl   <span class="op">=</span> files_to_tensor_list(val_filenames)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>test_notes_tl  <span class="op">=</span> files_to_tensor_list(test_filenames)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, tl <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">'train'</span>,<span class="st">'val'</span>,<span class="st">'test'</span>],[train_notes_tl, val_notes_tl, test_notes_tl]):</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> torch.vstack(tl)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(tl)<span class="sc">}</span><span class="ss"> songs in </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>stack<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> notes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████| 229/229 [00:00&lt;00:00, 869.86it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 76/76 [00:00&lt;00:00, 985.16it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 77/77 [00:00&lt;00:00, 927.04it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>229 songs in train, 46680 notes
76 songs in val, 15079 notes
77 songs in test, 16659 notes</code></pre>
</div>
</div>
<p>…that’s not a ton of data. We should incude some data augmentation.</p>
<section id="data-augmentation" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">3.5.1</span> Data Augmentation</h3>
<p>We’ll augment the pitch values by raising &amp; lowering them within an octave, except we’ll leave the rest pitch (=127 for the JSB chorales) alone since that sometimes gets used as a rest. And we’ll leave the timing values alone.</p>
<div class="cell">
<details>
<summary>Show the Data Augmentation code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_data(data, pitch_shift<span class="op">=</span><span class="dv">12</span>, debug<span class="op">=</span><span class="va">True</span>, invert<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    datanew <span class="op">=</span> data.clone()                                     <span class="co"># avoid overwriting memory of data</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pitch</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    change <span class="op">=</span> torch.randint(<span class="op">-</span>pitch_shift, pitch_shift, (<span class="dv">1</span>,))    <span class="co"># how many semitones to change all the pitches</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((change, <span class="dv">0</span>, <span class="dv">0</span>))  <span class="co"># change the pitches</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> invert <span class="kw">and</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>:                         <span class="co"># sometimes invert pitches? Probably not useful but anyway</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">*=</span> torch.tensor((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">0</span>] <span class="op">!=</span> REST_PITCH ] <span class="op">+=</span> torch.tensor((<span class="dv">127</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time - if we sometimes increase each non-zero time-token by one, that should be ok, right? </span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do step</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.rand(<span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">0.2</span>: <span class="co"># do duration</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        datanew[ datanew[:,<span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="op">+=</span> torch.tensor((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extra 'safety' constraint: clamp to range of valid values (of tokens)</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, cb <span class="kw">in</span> <span class="bu">enumerate</span>(codebooks):</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        datanew[:,i] <span class="op">=</span> torch.clamp(datanew[:,i], <span class="dv">0</span>, <span class="bu">len</span>(cb[<span class="st">'encode'</span>])<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datanew</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># testing code: </span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">3</span>) <span class="co"># setting this just  to make sure something happens ;-) </span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> torch.tensor([[<span class="dv">54</span>,<span class="dv">12</span>,<span class="dv">6</span>],[<span class="dv">61</span>,<span class="dv">0</span>,<span class="dv">40</span>],[<span class="dv">127</span>,<span class="dv">14</span>,<span class="dv">4</span>],[<span class="dv">86</span>,<span class="dv">0</span>,<span class="dv">12</span>],[<span class="dv">126</span>,<span class="dv">7</span>,<span class="dv">12</span>]])</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"data.shape = "</span>,data.shape)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"original data = </span><span class="ch">\n</span><span class="st">"</span>,data)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>aug <span class="op">=</span> augment_data(data)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"augmented data = </span><span class="ch">\n</span><span class="st">"</span>,aug) <span class="co"># </span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> torch.equal(aug[:,<span class="dv">0</span>], data[:,<span class="dv">0</span>]), <span class="st">"Oops, nothing changed"</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> aug[<span class="dv">2</span>,<span class="dv">0</span>]<span class="op">==</span>data[<span class="dv">2</span>,<span class="dv">0</span>], <span class="st">"Oops,  The 127 got changed"</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checks passed! :-) "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data.shape =  torch.Size([5, 3])
original data = 
 tensor([[ 54,  12,   6],
        [ 61,   0,  40],
        [127,  14,   4],
        [ 86,   0,  12],
        [126,   7,  12]])
augmented data = 
 tensor([[ 75,  12,   7],
        [ 68,   0,  41],
        [127,  14,   5],
        [ 43,   0,  13],
        [  3,   7,  13]])
Checks passed! :-) </code></pre>
</div>
</div>
</section>
<section id="dataset-object-definition" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="dataset-object-definition"><span class="header-section-number">3.5.2</span> Dataset Object Definition</h3>
<p>Here we go with the dataset:</p>
<div class="cell">
<details>
<summary>Show the Pytorch Dataset code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesDataset(Dataset):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"simple custom dataset of sliding windows"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                 tensor_list, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                 seq_length:<span class="bu">int</span>, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                 tokenizer<span class="op">=</span>encode,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                 codebooks<span class="op">=</span>codebooks, </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                 aug_callback<span class="op">=</span>augment_data,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>                 len_mult<span class="op">=</span><span class="dv">100</span>,  <span class="co"># factor to 'fudge' the dataset length when it's inspected by DataLoaders</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>                 pad<span class="op">=</span><span class="va">True</span>, <span class="co"># pad end with rests</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sl <span class="op">=</span> seq_length</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.len_mult <span class="op">=</span> len_mult</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_list <span class="op">=</span> [tokenizer(t) <span class="cf">for</span> t <span class="kw">in</span> tensor_list] <span class="co"># encoded tokens are all we'll use</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pad:</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>            rests <span class="op">=</span> torch.tensor([REST_PITCH,<span class="dv">1</span>,<span class="dv">1</span>]).unsqueeze(<span class="dv">0</span>).tile((seq_length,<span class="dv">1</span>))</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.data_list <span class="op">=</span> [torch.cat((toks,rests), dim<span class="op">=</span><span class="dv">0</span>) <span class="cf">for</span> toks <span class="kw">in</span> <span class="va">self</span>.data_list]</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.aug_callback <span class="op">=</span> aug_callback</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""we're going to be grabbing random windows from the data, so just the len of the tensor </span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co">        list will be too small for large batch sizes, hence we multiply by len_mult"""</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.data_list)<span class="op">*</span><span class="va">self</span>.len_mult  <span class="co"># this will keep the DataLoader going longer</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx, shift<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> (torch.Tensor, torch.Tensor):</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">"grabs a random 'window' from a random song, with an offset of `shift` tokens between inputs and targets"</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        i_song <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list), (<span class="dv">1</span>,)) <span class="co"># pick a song</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span>  torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data_list[i_song]) <span class="op">-</span> <span class="va">self</span>.sl <span class="op">-</span> <span class="dv">1</span>, (<span class="dv">1</span>,))  <span class="co"># start of window within song</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        data_block <span class="op">=</span> <span class="va">self</span>.data_list[i_song][ix:ix<span class="op">+</span><span class="va">self</span>.sl<span class="op">+</span><span class="dv">1</span>]  <span class="co"># grab window plus an extra character</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.aug_callback <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>            data_block <span class="op">=</span> <span class="va">self</span>.aug_callback(data_block)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        inputs, targets <span class="op">=</span> data_block[:<span class="va">self</span>.sl], data_block[shift:<span class="va">self</span>.sl<span class="op">+</span>shift]</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inputs, targets</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>seq_length <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset(train_notes_tl, seq_length)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="co"># save test_ds for Evaluation section, later</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_ds), <span class="bu">len</span>(val_ds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>(22900, 76000000)</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Temporary: Show my OTHER Pytorch Dataset code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> step_from_last(ts:torch.Tensor):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"returns how far the next song should step from the last-struck note of the current song"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ts.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">5</span>: <span class="cf">return</span> <span class="va">None</span> <span class="co"># too much of a pain to re-integrate start &amp; end times</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    last_struck_note <span class="op">=</span> ts.shape[<span class="dv">0</span>]<span class="op">-</span><span class="dv">1</span>  <span class="co"># the final midi note event</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    last_held_note <span class="op">=</span> ts[:,<span class="dv">4</span>].argmax() <span class="co"># the note with the final end time</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time diff between (start of last-struck note) and (end of last-held note)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts[last_held_note,<span class="dv">4</span>] <span class="op">-</span> ts[last_struck_note,<span class="dv">3</span>]</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tl_to_notes(tensor_list, </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                shuffle<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>                delimit<span class="op">=</span><span class="va">True</span>, <span class="co"># leave this on</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>                rest_pitch<span class="op">=</span><span class="dv">127</span>, <span class="co"># some datasets already prefer 127 or -1. you should check</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>                rest_dur<span class="op">=</span><span class="fl">0.96</span>,  <span class="co"># value used by jsb chorales iirc. in seconds</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Takes list of tensors (of arbitrary length, for each song).</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">    converts to one big long tensor of notes all running togehter"""</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shuffle: random.shuffle(tensor_list)  <span class="co"># shuffle order of songs</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># writing the following as a loop first so i get it right</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    out_tl <span class="op">=</span> []</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> si, ts <span class="kw">in</span> <span class="bu">enumerate</span>(tensor_list):  <span class="co"># ts = "tensor song" lol</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> si <span class="op">==</span> <span class="dv">0</span> :  </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>            out_tl.append(ts)  <span class="co"># no work to do</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> ts.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">5</span>, <span class="st">"We need start and end times to make this work"</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>            sfl <span class="op">=</span> step_from_last(tensor_list[<span class="op">-</span><span class="dv">1</span>]) </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>            add_rest <span class="op">=</span> torch.tensor((rest_pitch, sfl, rest_dur, <span class="dv">0</span>, rest_dur))  <span class="co"># jsb chorales used this method, so good enough for me</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>            out_tl.append(add_rest)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>            ts[<span class="dv">0</span>,<span class="dv">1</span>] <span class="op">=</span> rest_dur  <span class="co"># step of not of new song should be dur of rest that precedes it.</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>            out_tl.append(ts)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remember to strip out start &amp; end values</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> torch.vstack(out_tl).<span class="bu">type</span>(torch.float32)  <span class="co"># return one big tensor of floats</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> out[:,:<span class="dv">3</span>]   <span class="co">#  leave only pitch, step, duration</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Ok, I also want to try putting all the notes together. this is a bit janky right now. WIP. </span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesDataset2(Dataset):</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"like NotesDataSet except we slap all the songs together into one big'ol song"</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                 filenames, </span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                 seq_length:<span class="bu">int</span>, </span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                 tokenizer<span class="op">=</span>encode,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>                 aug_callback<span class="op">=</span>augment_data,</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>                 len_mult<span class="op">=</span><span class="dv">1</span>,  <span class="co"># factor to 'fudge' the dataset length when it's inspected by DataLoaders</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sl <span class="op">=</span> seq_length</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>        tensor_list <span class="op">=</span> files_to_tensor_list(filenames, keep_start_end<span class="op">=</span><span class="va">True</span>) <span class="co"># reread the files</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>        all_notes <span class="op">=</span> tl_to_notes(tensor_list)  <span class="co"># one big'ol tensor</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data <span class="op">=</span> tokenizer(all_notes)    <span class="co"># here's the data we'll use</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.aug_callback <span class="op">=</span> aug_callback</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.len_mult<span class="op">=</span>len_mult</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">int</span>( <span class="bu">len</span>(<span class="va">self</span>.data)<span class="op">//</span><span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.len_mult ) <span class="co"># eh, seems ok. </span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx, shift<span class="op">=</span><span class="dv">1</span>) <span class="op">-&gt;</span> (torch.Tensor, torch.Tensor):</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">"grabs a random 'window' from a random song, with an offset of `shift` tokens between inputs and targets"</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span>  torch.randint(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.data) <span class="op">-</span> <span class="va">self</span>.sl <span class="op">-</span> <span class="dv">1</span>, (<span class="dv">1</span>,))  <span class="co"># start of window </span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        data_block <span class="op">=</span> <span class="va">self</span>.data[ix:ix<span class="op">+</span><span class="va">self</span>.sl<span class="op">+</span><span class="dv">1</span>]  <span class="co"># grab window plus an extra character</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.aug_callback <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>            data_block <span class="op">=</span> <span class="va">self</span>.aug_callback(data_block)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        inputs, targets <span class="op">=</span> data_block[:<span class="va">self</span>.sl], data_block[shift:<span class="va">self</span>.sl<span class="op">+</span>shift]</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inputs, targets</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>seq_length <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> NotesDataset2(train_filenames, seq_length)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> NotesDataset2(val_filenames, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">100000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a><span class="co"># save test_ds for Evaluation section, later</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_ds), <span class="bu">len</span>(val_ds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████| 229/229 [00:00&lt;00:00, 939.70it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 76/76 [00:00&lt;00:00, 367.54it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(23454, 757700000)</code></pre>
</div>
</div>
<p>And before we use it, let’s seed all the Random Number Generators for the sake of reproducibility</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  set RNG seeds for reproducibility.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seeds(seed):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    torch.manual_seed(seed)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed(seed)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        torch.cuda.manual_seed_all(seed) </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span> <span class="co"># We may change this further down, for now it's just a test</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, )</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>batch_x, batch_y <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_dl))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"batch_x.shape, batch_y.shape = "</span>,batch_x.shape, batch_y.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>batch_x.shape, batch_y.shape =  torch.Size([128, 64, 3]) torch.Size([128, 64, 3])</code></pre>
</div>
</div>
<p>Ok. Now that we have a feel for how to handle our data, let’s get setup for the Transformer!</p>
</section>
</section>
</section>
<section id="hyperparameters-model-configuration" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Hyperparameters / Model Configuration</h1>
<p>Here’s where we’ll put all of our architecture design variables, storing it in a dict-like “<code>dataclass</code>” object for easy passing around.</p>
<div class="cell">
<details>
<summary>Show the config-creation code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicBoxConfig:</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model architecture details</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    seq_length: <span class="bu">int</span> <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    n_embd:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span>     <span class="co"># embedding dimension to use for tokens &amp; positions</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    n_heads:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>       <span class="co"># number of attention heads</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    n_blocks:   <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>       <span class="co"># number of attention blocks</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    dropout:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>     <span class="co"># dropout value applied everywhere</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    bias:      <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>   <span class="co"># True: bias in Linears and LayerNorms, like GPT-2. False: a bit better and faster</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training details</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    learning_rate: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    weight_decay:  <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>   <span class="co"># 0.01 is pytorch default</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    epochs:          <span class="bu">int</span> <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># other handy bookkeeping</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    vocab_sizes: <span class="bu">tuple</span> <span class="op">=</span> <span class="bu">tuple</span>(vocab_sizes)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> MusicBoxConfig()</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>pp <span class="op">=</span> pprint.PrettyPrinter(indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>pp.pprint(config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MusicBoxConfig(seq_length=64,
               batch_size=128,
               n_embd=256,
               n_heads=8,
               n_blocks=4,
               dropout=0.1,
               bias=False,
               learning_rate=0.001,
               weight_decay=0.01,
               epochs=13,
               vocab_sizes=(128, 26, 45))</code></pre>
</div>
</div>
</section>
<section id="transformer-model-code" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Transformer Model Code</h1>
<p>I did write my own Transformer code completely from scratch – honest! – but it in the quest to get better results, I increasingly borrowed from Karpathy’s lesson code (feeling like the “Salieri” to his “Mozart”), to the point where the following is really a set of minor modifications, such as my added support for multiple codebooks, and passing around the config.</p>
<details>
<summary>
Details
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from my mod of K's code</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: add more commentary! </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Head(nn.Module):</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" one head of self-attention """</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, head_size, config):</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        n_embd, block_size <span class="op">=</span> config.n_embd, config.seq_length</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.query <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> nn.Linear(n_embd, head_size, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.register_buffer(<span class="st">'tril'</span>, torch.tril(torch.ones(block_size, block_size)))</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        B,T,C <span class="op">=</span> x.shape</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="va">self</span>.key(x)   <span class="co"># (B,T,C)</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> <span class="va">self</span>.query(x) <span class="co"># (B,T,C)</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># compute attention scores ("affinities")</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> q <span class="op">@</span> k.transpose(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> C<span class="op">**-</span><span class="fl">0.5</span> <span class="co"># (B, T, C) @ (B, C, T) -&gt; (B, T, T)</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> wei.masked_fill(<span class="va">self</span>.tril[:T, :T] <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">'-inf'</span>)) <span class="co"># (B, T, T)</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> F.softmax(wei, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, T, T)</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        wei <span class="op">=</span> <span class="va">self</span>.dropout(wei)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># perform the weighted aggregation of the values</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="va">self</span>.value(x) <span class="co"># (B,T,C)</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> wei <span class="op">@</span> v <span class="co"># (B, T, T) @ (B, T, C) -&gt; (B, T, C)</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiHeadAttention(nn.Module):</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" multiple heads of self-attention in parallel """</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_heads, head_size, config):</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        n_embd <span class="op">=</span> config.n_embd</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.heads <span class="op">=</span> nn.ModuleList([Head(head_size, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_heads)])</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proj <span class="op">=</span> nn.Linear(n_embd, n_embd)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(config.dropout)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> torch.cat([h(x) <span class="cf">for</span> h <span class="kw">in</span> <span class="va">self</span>.heads], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> <span class="va">self</span>.dropout(<span class="va">self</span>.proj(out))</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeedFoward(nn.Module):</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" a simple linear layer followed by a non-linearity """</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, config):</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.net <span class="op">=</span> nn.Sequential(</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>            nn.Linear(n_embd, <span class="dv">4</span> <span class="op">*</span> n_embd),</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">4</span> <span class="op">*</span> n_embd, n_embd),</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(config.dropout),</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.net(x)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Block(nn.Module):</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Transformer block: communication followed by computation """</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_embd, n_head, config):</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># n_embd: embedding dimension, n_head: the number of heads we'd like</span></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        head_size <span class="op">=</span> n_embd <span class="op">//</span> n_head</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sa <span class="op">=</span> MultiHeadAttention(n_head, head_size, config)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffwd <span class="op">=</span> FeedFoward(n_embd, config)</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln1 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln2 <span class="op">=</span> nn.LayerNorm(n_embd)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.sa(<span class="va">self</span>.ln1(x))</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.ffwd(<span class="va">self</span>.ln2(x))</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Transformer(nn.Module):</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, config, debug<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>        n_cb <span class="op">=</span> <span class="bu">len</span>(config.vocab_sizes)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block_size, n_embd, n_head, n_layer <span class="op">=</span> config.seq_length, config.n_embd, config.n_heads, config.n_blocks </span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># seperate embeddings for pitch, step &amp; dur part of notes</span></span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_embedding_tables <span class="op">=</span> nn.ModuleList([nn.Embedding(vocab_sizes[cbi], n_embd) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)])</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.position_embedding_table <span class="op">=</span> nn.Embedding(<span class="va">self</span>.block_size, n_embd)</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.blocks <span class="op">=</span> nn.Sequential(<span class="op">*</span>[Block(n_embd, n_head, config) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layer)])</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln_f <span class="op">=</span> nn.LayerNorm(n_embd) <span class="co"># final layer norm</span></span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lm_heads <span class="op">=</span> nn.ModuleList([nn.Linear(n_embd, vocab_sizes[cbi]) <span class="cf">for</span> cbi <span class="kw">in</span> <span class="bu">range</span>(n_cb)]) <span class="co"># output token predictors</span></span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.debug<span class="op">=</span><span class="va">False</span></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, idx, targets<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is array of input token indices in the current context</span></span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>        B, T, CBS <span class="op">=</span> idx.shape</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>        tok_emb <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS): <span class="co"># just sum codebook reps</span></span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>            tok_emb <span class="op">=</span> tok_emb <span class="op">+</span> <span class="va">self</span>.token_embedding_tables[cb](idx[:,:,cb])</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>        pos_emb <span class="op">=</span> <span class="va">self</span>.position_embedding_table(torch.arange(T, device<span class="op">=</span>idx.device)) <span class="co"># (T,E)</span></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tok_emb <span class="op">+</span> pos_emb <span class="co"># sum token embeddings &amp; positional embeddings</span></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.blocks(x) <span class="co"># Main computation loop! </span></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.ln_f(x)   <span class="co"># final layernorm</span></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>        logits_list <span class="op">=</span> [head(x) <span class="cf">for</span> head <span class="kw">in</span> <span class="va">self</span>.lm_heads]  <span class="co"># list of output projections over all codebook values</span></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> targets <span class="kw">is</span> <span class="va">None</span>:  <span class="co"># need targets to compute loss</span></span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="va">None</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>            lambdas <span class="op">=</span> [<span class="fl">0.5</span>]<span class="op">*</span>CBS   <span class="co"># relative "weights" to pitch, step, dur parts of loss</span></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(CBS):        <span class="co"># loop over codebooks  (for pitch, step &amp; dur), summing loss</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  </span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>                B, T, V <span class="op">=</span> logits.shape   <span class="co"># V = vocab size, i.e. codebook length</span></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targets[:,:,cb]   <span class="co"># B, T </span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits.view(B<span class="op">*</span>T, V)</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>                targ <span class="op">=</span> targ.reshape(B<span class="op">*</span>T)    <span class="co"># needs reshape &amp; not view b/c of contiguous memory issues.</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss <span class="op">+</span>  lambdas[cb] <span class="op">*</span> F.cross_entropy(logits, targ)</span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logits_list, loss</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">@torch.no_grad</span>()</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, idx, max_new_tokens, temperature<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># idx is (B, T, CBS) array of token indices in the current context</span></span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_new_tokens):</span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>            idx_cond <span class="op">=</span> idx[:, <span class="op">-</span><span class="va">self</span>.block_size:]      <span class="co"># crop idx to the last block_size tokens</span></span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>            logits_list, loss <span class="op">=</span> <span class="va">self</span>(idx_cond)   <span class="co"># get the predictions</span></span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>            idx_next_list <span class="op">=</span> []</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cb <span class="kw">in</span> <span class="bu">range</span>(idx_cond.shape[<span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>                <span class="co"># focus only on the last time step</span></span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits_list[cb]  <span class="co"># B, T, V  where V = vocab/embedding size </span></span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>                logits <span class="op">=</span> logits[:, <span class="op">-</span><span class="dv">1</span>, :] <span class="co"># get last time.  becomes (B, V)</span></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>                <span class="co"># apply softmax to get probabilities</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>                probs <span class="op">=</span> F.softmax(logits<span class="op">/</span>temperature, dim<span class="op">=-</span><span class="dv">1</span>) <span class="co"># (B, V)</span></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>                <span class="co"># sample from the distribution</span></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>                idx_next_list.append(torch.multinomial(probs, num_samples<span class="op">=</span><span class="dv">1</span>)) <span class="co"># (B, 1)</span></span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>            idx_next <span class="op">=</span> torch.tensor(idx_next_list).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>).to(idx.device)</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>            <span class="co"># append sampled index to the running sequence</span></span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> torch.cat((idx, idx_next), dim<span class="op">=</span><span class="dv">1</span>) <span class="co"># (B, T+1)</span></span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a><span class="co"># test that, make sure we don't get errors: </span></span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details></section>
<section id="preliminaries-before-training" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Preliminaries before Training</h1>
GPU device, Demo prompts, WandB logging, Re-Init
<details>
<summary>
Details
</summary>
<section id="set-up-the-gpucpu-device" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="set-up-the-gpucpu-device"><span class="header-section-number">6.1</span> Set Up the GPU/CPU <code>device</code></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"mps"</span> <span class="cf">if</span> torch.backends.mps.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"device is"</span>,device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>device is mps</code></pre>
</div>
</div>
</section>
<section id="prompt-for-demos" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="prompt-for-demos"><span class="header-section-number">6.2</span> Prompt for Demos</h2>
<p>Let’s create a “prompt” from the validation dataset so we can monitor the models capabilities in producing “demos” of the music</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>demo_prompt_idx <span class="op">=</span> <span class="dv">0</span>    <span class="co"># file index from which to pull the demo prompt</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>demo_target <span class="op">=</span> val_notes_tl[demo_prompt_idx]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>display(midiplayer(demo_target, title<span class="op">=</span><span class="ss">f"Full demo 'target', </span><span class="sc">{</span><span class="bu">len</span>(demo_target)<span class="sc">}</span><span class="ss"> notes in length"</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>demo_prompt_length <span class="op">=</span> <span class="dv">16</span>  <span class="co"># number of notes in demo prompt context</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>demo_max_new_tokens <span class="op">=</span> <span class="bu">min</span>(<span class="dv">150</span>, <span class="bu">len</span>(demo_target))  <span class="co"># try to make the whole song, but don't go on too long</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> demo_target[:demo_prompt_length]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>demo_prompt_length<span class="sc">}</span><span class="ss">-note 'prompt' for demos"</span>))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full demo 'target', 133 notes in length<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADMADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABFQABJQABKAGk9AAA+QGo2AAA3QAA+AABAQABDQABFAABHQABJAGo2QAA3AGk0QAA2AABHAABJQGo+QABAAGk0AAA2QAA9QAA+AABCQABDAABGQABJAIMnKkAANgAAOkAARgCBUyoAADZAADlAADoAAEIAAEVAaj0AAD5AaTFAADYAAD4AAEBAajkAADtAaS9AADEAADsAAD1AAENAAEUAai1AAC8Aai0AADJAAEAAAEJAAEMAaUBAajIAADdAADtAAD0AAD5AAEAAAEIAAEdAaTZAADcAADlAADsAajRAADYAADdAADkAAD1AAD4Aaj0AAD5AaTQAADZAADcAAD4AAEBAAEZAAEcAgVMvQAA+QABAAABGAABHQIR6LwAAOkAAPgAAQkAARwAASUCBUzYAADoAADtAAEkAAEpAakIAAENAAEdAaTsAAD1AAEJAAEMAAEVAAEcAAEoAAExAakBAAEIAAENAAEUAaj0AAD5AAEAAAEJAAEMAAEwAAE5AaT1AAExAAE4AajtAAD0AAEIAAEdAAEwAAE5AaTlAADsAAE4AAE9AajdAADkAAExAAE8AajtAAD4AaTcAADlAADsAAD1AAEVAAEcAakNAAEUAaTJAAD0AAEJAAEMAAEpAAEwAgVQyAAA+QABCAABFQABKAABOQGk5AAA7QGo7AAA9QAA+AABFAABGQABMQABOAIFTNkAAO0AAPQAARgAAR0AASkAATABqNgAAN0BpNwAAOUAAOwAAQEAARwAASUAASgBqNkAAP0AAQABpNgAAN0AAOQAAO0AAPwAAQEAAR0AASQBqRwAASUBqNkAANwAAQAAAQkAASQAASkBpNEAANgAAQgAAQ0AASgAATEBqNAAANkAAOkAAOwAAQkAAQwAASUAATABpQEAAQgBqL0AAOgAAP0AAQAAAR0AASQCDJi8AADYAAD8AAEcAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADMADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABFQABJQABKAGk9AAA+QGo2AAA3QAA+AABAQABDQABFAABHQABJAGo2QAA3AGk0QAA2AABHAABJQGo+QABAAGk0AAA2QAA9QAA+AABCQABDAABGQABJAIMnKkAANgAAOkAARgCBUyoAADZAADlAADoAAEIAAEVAaj0AAD5AaTFAADYAAD4AAEBAajkAADtAaS9AADEAADsAAD1AAENAAEUAai1AAC8Aai0AADJAAEAAAEJAAEMAaUBAajIAADdAADtAAD0AAD5AAEAAAEIAAEdAaTZAADcAADlAADsAajRAADYAADdAADkAAD1AAD4Aaj0AAD5AaTQAADZAADcAAD4AAEBAAEZAAEcAgVMvQAA+QABAAABGAABHQIR6LwAAOkAAPgAAQkAARwAASUCBUzYAADoAADtAAEkAAEpAakIAAENAAEdAaTsAAD1AAEJAAEMAAEVAAEcAAEoAAExAakBAAEIAAENAAEUAaj0AAD5AAEAAAEJAAEMAAEwAAE5AaT1AAExAAE4AajtAAD0AAEIAAEdAAEwAAE5AaTlAADsAAE4AAE9AajdAADkAAExAAE8AajtAAD4AaTcAADlAADsAAD1AAEVAAEcAakNAAEUAaTJAAD0AAEJAAEMAAEpAAEwAgVQyAAA+QABCAABFQABKAABOQGk5AAA7QGo7AAA9QAA+AABFAABGQABMQABOAIFTNkAAO0AAPQAARgAAR0AASkAATABqNgAAN0BpNwAAOUAAOwAAQEAARwAASUAASgBqNkAAP0AAQABpNgAAN0AAOQAAO0AAPwAAQEAAR0AASQBqRwAASUBqNkAANwAAQAAAQkAASQAASkBpNEAANgAAQgAAQ0AASgAATEBqNAAANkAAOkAAOwAAQkAAQwAASUAATABpQEAAQgBqL0AAOgAAP0AAQAAAR0AASQCDJi8AADYAAD8AAEcAAf8vAA== sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADMADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABFQABJQABKAGk9AAA+QGo2AAA3QAA+AABAQABDQABFAABHQABJAGo2QAA3AGk0QAA2AABHAABJQGo+QABAAGk0AAA2QAA9QAA+AABCQABDAABGQABJAIMnKkAANgAAOkAARgCBUyoAADZAADlAADoAAEIAAEVAaj0AAD5AaTFAADYAAD4AAEBAajkAADtAaS9AADEAADsAAD1AAENAAEUAai1AAC8Aai0AADJAAEAAAEJAAEMAaUBAajIAADdAADtAAD0AAD5AAEAAAEIAAEdAaTZAADcAADlAADsAajRAADYAADdAADkAAD1AAD4Aaj0AAD5AaTQAADZAADcAAD4AAEBAAEZAAEcAgVMvQAA+QABAAABGAABHQIR6LwAAOkAAPgAAQkAARwAASUCBUzYAADoAADtAAEkAAEpAakIAAENAAEdAaTsAAD1AAEJAAEMAAEVAAEcAAEoAAExAakBAAEIAAENAAEUAaj0AAD5AAEAAAEJAAEMAAEwAAE5AaT1AAExAAE4AajtAAD0AAEIAAEdAAEwAAE5AaTlAADsAAE4AAE9AajdAADkAAExAAE8AajtAAD4AaTcAADlAADsAAD1AAEVAAEcAakNAAEUAaTJAAD0AAEJAAEMAAEpAAEwAgVQyAAA+QABCAABFQABKAABOQGk5AAA7QGo7AAA9QAA+AABFAABGQABMQABOAIFTNkAAO0AAPQAARgAAR0AASkAATABqNgAAN0BpNwAAOUAAOwAAQEAARwAASUAASgBqNkAAP0AAQABpNgAAN0AAOQAAO0AAPwAAQEAAR0AASQBqRwAASUBqNkAANwAAQAAAQkAASQAASkBpNEAANgAAQgAAQ0AASgAATEBqNAAANkAAOkAAOwAAQkAAQwAASUAATABpQEAAQgBqL0AAOgAAP0AAQAAAR0AASQCDJi8AADYAAD8AAEcAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>16-note 'prompt' for demos<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABKAIFTNgAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABKAIFTNgAB/y8A sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAawDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABKAIFTNgAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="optional-set-up-wandb-run-tracking" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="optional-set-up-wandb-run-tracking"><span class="header-section-number">6.3</span> Optional: set up WandB run tracking</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>use_wandb <span class="op">=</span> <span class="va">True</span>  <span class="co"># Tip: leave this off at first, until you're sure everything's working!</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> use_wandb:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> wandb </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    wandb.login()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    wandb.init(project<span class="op">=</span><span class="st">"musicbox-jsb-tutorial"</span>, config<span class="op">=</span>config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>wandb: Currently logged in as: drscotthawley. Use `wandb login --relogin` to force relogin</code></pre>
</div>
<div class="cell-output cell-output-display">
wandb version 0.16.1 is available!  To upgrade, please run:
 $ pip install wandb --upgrade
</div>
<div class="cell-output cell-output-display">
Tracking run with wandb version 0.15.4
</div>
<div class="cell-output cell-output-display">
Run data is saved locally in <code>/Users/shawley/github/blog/posts/wandb/run-20231213_121603-khhx2h1q</code>
</div>
<div class="cell-output cell-output-display">
Syncing run <strong><a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/khhx2h1q" target="_blank">graceful-monkey-11</a></strong> to <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">Weights &amp; Biases</a> (<a href="https://wandb.me/run" target="_blank">docs</a>)<br>
</div>
<div class="cell-output cell-output-display">
 View project at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial</a>
</div>
<div class="cell-output cell-output-display">
 View run at <a href="https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/khhx2h1q" target="_blank">https://wandb.ai/drscotthawley/musicbox-jsb-tutorial/runs/khhx2h1q</a>
</div>
</div>
</section>
<section id="re-init-everything-lets-roll" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="re-init-everything-lets-roll"><span class="header-section-number">6.4</span> (Re-)Init Everything &amp; Let’s Roll</h2>
<p>Let’s go! Re-setup the datasets &amp; loaders for good measure, instantiate a model and optimizer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>set_seeds(<span class="dv">0</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>dataset_choice <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> dataset_choice <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    train_ds <span class="op">=</span> NotesDataset(train_notes_tl, config.seq_length, len_mult<span class="op">=</span>config.batch_size)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    val_ds <span class="op">=</span> NotesDataset(val_notes_tl, seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    train_ds <span class="op">=</span> NotesDataset2(train_filenames, config.seq_length)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    val_ds <span class="op">=</span> NotesDataset2(val_filenames, config.seq_length, aug_callback<span class="op">=</span><span class="va">None</span>, len_mult<span class="op">=</span><span class="dv">1000000</span>) <span class="co"># no aug, neverending</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>train_dl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>val_dl   <span class="op">=</span> DataLoader(val_ds,   batch_size<span class="op">=</span>config.batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Transformer(config)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> model.to(device)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> m.parameters())<span class="op">/</span><span class="fl">1e6</span>, <span class="st">'M parameters in the model'</span>) </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.AdamW(model.parameters(), lr<span class="op">=</span>config.learning_rate, weight_decay<span class="op">=</span>config.weight_decay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████| 229/229 [00:00&lt;00:00, 889.62it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 76/76 [00:00&lt;00:00, 815.35it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3.274951 M parameters in the model</code></pre>
</div>
</div>
</section>
</details></section>
<section id="train-the-model" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Train the Model</h1>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>val_every  <span class="op">=</span> <span class="dv">1</span> <span class="co"># in steps, evaluate loss on val dataset</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>cp_every   <span class="op">=</span> <span class="dv">60</span> <span class="co"># in epochs, checkpoint every</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>demo_every <span class="op">=</span> <span class="dv">4</span> <span class="co"># in epochs, make a midi player demo</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>best_loss <span class="op">=</span> <span class="dv">999</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>ema_weight, loss_ema, val_loss_ema <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">None</span> , <span class="va">None</span> <span class="co"># exponential moving averages for loss reporting</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>step <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> {}</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> config.epochs</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,epochs<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    pbar <span class="op">=</span> tqdm(total<span class="op">=</span><span class="bu">len</span>(train_dl), desc<span class="op">=</span><span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>config<span class="sc">.</span>epochs<span class="sc">}</span><span class="ss">"</span>, dynamic_ncols<span class="op">=</span><span class="va">False</span>) <span class="co"># progress bar, per epoch</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bi, batch <span class="kw">in</span> <span class="bu">enumerate</span>(train_dl):</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        xb, yb <span class="op">=</span> batch[<span class="dv">0</span>].to(device), batch[<span class="dv">1</span>].to(device)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        logits, loss <span class="op">=</span> model(xb, yb) <span class="co"># evaluate the loss</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        loss_ema <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>loss_ema <span class="cf">if</span> loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> loss.item()</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        losses[<span class="st">'train'</span>], losses[<span class="st">'train_ema'</span>] <span class="op">=</span> loss.item(), loss_ema</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad(set_to_none<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># status / diagnostics:</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (step <span class="op">%</span> val_every <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>                model.<span class="bu">eval</span>()</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                xvb, yvb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(val_dl))</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>                val_logits, val_loss <span class="op">=</span> model( xvb.to(device), yvb.to(device) ) </span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                val_loss_ema <span class="op">=</span>  (<span class="fl">1.0</span><span class="op">-</span>ema_weight)<span class="op">*</span>val_loss.item() <span class="op">+</span> ema_weight<span class="op">*</span>val_loss_ema <span class="cf">if</span> val_loss_ema <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> val_loss.item() </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                losses[<span class="st">'val'</span>], losses[<span class="st">'val_ema'</span>] <span class="op">=</span> val_loss.item(), val_loss_ema</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>            model.train()</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        wbl_dict <span class="op">=</span> {<span class="st">'step'</span>:step, <span class="st">'epoch'</span>:epoch} <span class="op">|</span> losses   <span class="co"># dict for logging losses, midi examples, etc to wandb</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix( <span class="bu">dict</span>((k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>,<span class="st">'val_ema'</span>])) <span class="co"># loss info for progress bar</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        pbar.update(<span class="dv">1</span>)</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_wandb <span class="kw">and</span> wbl_dict <span class="op">!=</span> {}: wandb.log(wbl_dict)</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#--- end of epoch ---</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> losses[<span class="st">'val_ema'</span>] <span class="op">&lt;</span> best_loss: <span class="co"># Tracking best val_loss_ema for checkpointing purposes</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>        best_loss <span class="op">=</span> losses[<span class="st">'val_ema'</span>]</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>        pbar.set_postfix(<span class="bu">dict</span>( (k,losses[k]) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'train'</span>, <span class="st">'val'</span>]) <span class="op">|</span> {<span class="st">'New best val_ema'</span>:best_loss})</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch) <span class="op">%</span> cp_every<span class="op">==</span><span class="dv">0</span>:   <span class="co"># occasionally save a checkpoint of best model/optimizer states</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>            cp_file <span class="op">=</span> <span class="ss">f"musicbox-jsb"</span> <span class="co">#    -{step}" # let's leave out step to avoid filling disk</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saving a checkpoint to </span><span class="sc">{</span>cp_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>            torch.save({ <span class="st">'step'</span>: step, <span class="st">'model_state_dict'</span>: model.state_dict(), <span class="st">'loss'</span>: loss,</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'optimizer_state_dict'</span>: optimizer.state_dict(),}, cp_file)</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>    pbar.refresh()</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>    pbar.close()</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (epoch <span class="op">%</span> demo_every <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> (epoch<span class="op">==</span>epochs):  <span class="co"># demo of midi generation</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>            new_notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>demo_max_new_tokens, temperature<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].cpu() )</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>            p2 <span class="op">=</span> midiplayer(new_notes,title<span class="op">=</span><span class="ss">f"Demo on val dataset, Epoch=</span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>            display(p2)</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> use_wandb: wandb.log( {<span class="st">'step'</span>:step, <span class="st">'player'</span>:wandb.Html(p2.html)} )              </span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>        model.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Epoch 1/13: 100%|████████████████████████████████████| 184/184 [00:37&lt;00:00,  4.93it/s, train=2.65, val=2.52, New best val_ema=2.6]
Epoch 2/13: 100%|███████████████████████████████████| 184/184 [00:37&lt;00:00,  4.91it/s, train=2.11, val=2.03, New best val_ema=2.02]
Epoch 3/13: 100%|████████████████████████████████████| 184/184 [00:38&lt;00:00,  4.79it/s, train=1.83, val=1.8, New best val_ema=1.81]
Epoch 4/13: 100%|████████████████████████████████████| 184/184 [00:39&lt;00:00,  4.47it/s, train=1.78, val=1.72, New best val_ema=1.7]Epoch 4/13: 100%|████████████████████████████████████| 184/184 [00:52&lt;00:00,  3.48it/s, train=1.78, val=1.72, New best val_ema=1.7]
Epoch 5/13: 100%|███████████████████████████████████| 184/184 [00:38&lt;00:00,  4.83it/s, train=1.63, val=1.62, New best val_ema=1.62]
Epoch 6/13: 100%|███████████████████████████████████| 184/184 [00:37&lt;00:00,  4.95it/s, train=1.57, val=1.55, New best val_ema=1.58]
Epoch 7/13: 100%|███████████████████████████████████| 184/184 [00:38&lt;00:00,  4.83it/s, train=1.61, val=1.55, New best val_ema=1.55]
Epoch 8/13: 100%|███████████████████████████████████| 184/184 [00:38&lt;00:00,  4.77it/s, train=1.41, val=1.55, New best val_ema=1.54]Epoch 8/13: 100%|███████████████████████████████████| 184/184 [00:42&lt;00:00,  4.32it/s, train=1.41, val=1.55, New best val_ema=1.54]
Epoch 9/13: 100%|███████████████████████████████████| 184/184 [00:38&lt;00:00,  4.78it/s, train=1.31, val=1.53, New best val_ema=1.53]
Epoch 10/13: 100%|██████████████████████████████████| 184/184 [00:38&lt;00:00,  4.80it/s, train=1.27, val=1.54, New best val_ema=1.53]
Epoch 11/13: 100%|███████████████████████████████████████████| 184/184 [00:38&lt;00:00,  4.82it/s, train=1.18, val=1.67, val_ema=1.55]
Epoch 12/13: 100%|███████████████████████████████████████████| 184/184 [00:38&lt;00:00,  4.81it/s, train=1.12, val=1.57, val_ema=1.56]Epoch 12/13: 100%|███████████████████████████████████████████| 184/184 [00:42&lt;00:00,  4.37it/s, train=1.12, val=1.57, val_ema=1.56]
Epoch 13/13: 100%|████████████████████████████████████████████| 184/184 [00:38&lt;00:00,  4.81it/s, train=1.18, val=1.57, val_ema=1.6]</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section864 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section864 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section864 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section864 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section864 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section864 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section864 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section864 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section864 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section864 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section864 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section864&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=4<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADnQDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABFQABJQABKAGo9QGk1QAA2AABEQABFAABHQABJAGo9AABAQGk1AAA2QABCQABEAABFQABHAGo2AAA4QAA7QABAAABHQGo4AAA5QAA/QABFAGkqQAA5AAA5QAA7AAA9QABFQABHAGlDQABFAAE/AABCAGkqAAAxQAA9AABAQABDAABFQIFTL0AAMQAAP0AAQAAAQkAARQCBVDkAgyYvAAA/AABHQABKQIFTNEAAO0AAREAARwAASUAASgCBUzQAADZAADlAADsAAEIAAEQAAEVAAEhAAEkAgVQ0QAA2AAA3QAA5AABAQABFAABHQABIAIFTMkAANAAANwAAOUAAPkAAQAAAQkAARwCBUzFAADIAADhAADkAAD4AAEBAAEIAAEVAaTZAADgAAD9AAEAAajEAADRAADYAADhAADtAAD8AAERAAEUAgVMxQAA0AAA7AAA9QABAQABEAIFTMQAAOAAAPQAARUBqNkAAO0AAQABqNEAANgAAP0AARQBqNAAAOwAAPwAARECBHi9AADVAAD1AAEFANS8AAEQANDNAADUAADZAAEEAAEJAAEdAaUcAAT0AAEIAAERAaTMAADRAADYAADtAAEQAAEVAajQAADsAAElAai5AAD1AAEBAAERAAEUAAEkAgVMtQAAuAAAvQAA4QAA5QAA7QAA9AABEAGosQAAtAAAvAAAvQAA7AGktQAAvAAAxQAA4AABAAGosAAAyQGkqQAAtAAAxAAA3QAA5AAB/QII+MgBpKgAANwAAfwCKOX9AjWA1QAA2QAA4QAA9QABEQAB/AIFTMUAANEAANQAANgAAOAAAPQAAPUCBUzEAADNAADQAADZAAD9AAEQAgVQxQAAzAAA0QAA2AAA/AABAQIFTMQAANAAAQAAARkBpOEBqNkAAOkAAPQAAP0AARgBpOAAAR0BqNUAANgAAOEAAOgAAPUAAPwAAREBpRwABOAAAOkBpNQAAPQABOgAARAAAS0BpNUBqNkAAOEAAPEAAP0ABSwBpNQAAPAAAREBpNgAAPwAASUABOABpNUAAOEAASUBpQkAARAAASQBqNEAANQAAOAAAQEAAQgCBUzQAgVNAAAFJAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADnQDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABFQABJQABKAGo9QGk1QAA2AABEQABFAABHQABJAGo9AABAQGk1AAA2QABCQABEAABFQABHAGo2AAA4QAA7QABAAABHQGo4AAA5QAA/QABFAGkqQAA5AAA5QAA7AAA9QABFQABHAGlDQABFAAE/AABCAGkqAAAxQAA9AABAQABDAABFQIFTL0AAMQAAP0AAQAAAQkAARQCBVDkAgyYvAAA/AABHQABKQIFTNEAAO0AAREAARwAASUAASgCBUzQAADZAADlAADsAAEIAAEQAAEVAAEhAAEkAgVQ0QAA2AAA3QAA5AABAQABFAABHQABIAIFTMkAANAAANwAAOUAAPkAAQAAAQkAARwCBUzFAADIAADhAADkAAD4AAEBAAEIAAEVAaTZAADgAAD9AAEAAajEAADRAADYAADhAADtAAD8AAERAAEUAgVMxQAA0AAA7AAA9QABAQABEAIFTMQAAOAAAPQAARUBqNkAAO0AAQABqNEAANgAAP0AARQBqNAAAOwAAPwAARECBHi9AADVAAD1AAEFANS8AAEQANDNAADUAADZAAEEAAEJAAEdAaUcAAT0AAEIAAERAaTMAADRAADYAADtAAEQAAEVAajQAADsAAElAai5AAD1AAEBAAERAAEUAAEkAgVMtQAAuAAAvQAA4QAA5QAA7QAA9AABEAGosQAAtAAAvAAAvQAA7AGktQAAvAAAxQAA4AABAAGosAAAyQGkqQAAtAAAxAAA3QAA5AAB/QII+MgBpKgAANwAAfwCKOX9AjWA1QAA2QAA4QAA9QABEQAB/AIFTMUAANEAANQAANgAAOAAAPQAAPUCBUzEAADNAADQAADZAAD9AAEQAgVQxQAAzAAA0QAA2AAA/AABAQIFTMQAANAAAQAAARkBpOEBqNkAAOkAAPQAAP0AARgBpOAAAR0BqNUAANgAAOEAAOgAAPUAAPwAAREBpRwABOAAAOkBpNQAAPQABOgAARAAAS0BpNUBqNkAAOEAAPEAAP0ABSwBpNQAAPAAAREBpNgAAPwAASUABOABpNUAAOEAASUBpQkAARAAASQBqNEAANQAAOAAAQEAAQgCBUzQAgVNAAAFJAAH/LwA= sound-font visualizer=&quot;#section864 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADnQDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AABDAABFQABJQABKAGo9QGk1QAA2AABEQABFAABHQABJAGo9AABAQGk1AAA2QABCQABEAABFQABHAGo2AAA4QAA7QABAAABHQGo4AAA5QAA/QABFAGkqQAA5AAA5QAA7AAA9QABFQABHAGlDQABFAAE/AABCAGkqAAAxQAA9AABAQABDAABFQIFTL0AAMQAAP0AAQAAAQkAARQCBVDkAgyYvAAA/AABHQABKQIFTNEAAO0AAREAARwAASUAASgCBUzQAADZAADlAADsAAEIAAEQAAEVAAEhAAEkAgVQ0QAA2AAA3QAA5AABAQABFAABHQABIAIFTMkAANAAANwAAOUAAPkAAQAAAQkAARwCBUzFAADIAADhAADkAAD4AAEBAAEIAAEVAaTZAADgAAD9AAEAAajEAADRAADYAADhAADtAAD8AAERAAEUAgVMxQAA0AAA7AAA9QABAQABEAIFTMQAAOAAAPQAARUBqNkAAO0AAQABqNEAANgAAP0AARQBqNAAAOwAAPwAARECBHi9AADVAAD1AAEFANS8AAEQANDNAADUAADZAAEEAAEJAAEdAaUcAAT0AAEIAAERAaTMAADRAADYAADtAAEQAAEVAajQAADsAAElAai5AAD1AAEBAAERAAEUAAEkAgVMtQAAuAAAvQAA4QAA5QAA7QAA9AABEAGosQAAtAAAvAAAvQAA7AGktQAAvAAAxQAA4AABAAGosAAAyQGkqQAAtAAAxAAA3QAA5AAB/QII+MgBpKgAANwAAfwCKOX9AjWA1QAA2QAA4QAA9QABEQAB/AIFTMUAANEAANQAANgAAOAAAPQAAPUCBUzEAADNAADQAADZAAD9AAEQAgVQxQAAzAAA0QAA2AAA/AABAQIFTMQAANAAAQAAARkBpOEBqNkAAOkAAPQAAP0AARgBpOAAAR0BqNUAANgAAOEAAOgAAPUAAPwAAREBpRwABOAAAOkBpNQAAPQABOgAARAAAS0BpNUBqNkAAOEAAPEAAP0ABSwBpNQAAPAAAREBpNgAAPwAASUABOABpNUAAOEAASUBpQkAARAAASQBqNEAANQAAOAAAQEAAQgCBUzQAgVNAAAFJAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section394 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section394 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section394 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section394 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section394 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section394 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section394 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section394 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section394 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section394 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section394 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section394&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=8<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA5QAA7AABCQABDAABJQABKAIFTMkAANgAAPkAAQgAASQAASkBqMUAAMgAAPgAAQEBpMQAAMkAAQAAAQkAASUAASgBqMUAAMgBqMQAAMkAAO0AAPkAAQgAASQAASkBpMgAAN0BqNwAAOQAAOwAAPUAAPgAAQEAARkAASgBpMkAAPkAAQABqMgAAMkAANEAAN0AAPQAAPgAAQ0AARgBpNAAAQwAARUBqMgAANkAANwAAOUAAPkAARQAASkBqNgAAN0BpNwAAOQAAO0AAQ0AASgAATEBpSkAATAABPgA0SgAATEA1OwAAPUAAQwAARUAATAAATEBqPQAAPkBpPgAAQEAAQ0BqQAAAQwAARQAASkAATAA1QkA0SgABN0AAOUAAPEAAQEAAQgAARUBpNwAAOQAAO0AAPAAAPEAAPkAAQAAAQkBqN0AAOwAAPAAAPgAAQEAAQgAARQAAR0BqNUAANwBpNQAAOUAARUAARwBqPkAAQAAAQkAARQA1QEAAQgA0K0AANEAAPgAAPkAAQABqKwAALkAAMkAAQEBqNAAAPgBpMgAANUAAPkAAQAAAf0BqOQBpLUAAL0AANEAANQBpNAABNUAANkAAfwBpLgAALwAAPgABNQBpLQAANEAAPUBpKkAAL0AANABqKgAAK0AALwAAL0AAO0AAPQBqNgBpLwAAL0AAPkBpMkAAPgBqKkAAKwAALUAALwAAOwAAPkBqKgAALEBpLAAALUAAPEAAPgBqLQBqK0AALQAAN0AAO0AAPABpKkAAOwBqKgAAKwAAMgAANwAAOUBqJkAALUAANkBpOQCCPSYAAC0AAC9AADxAAD5AgVMrQAAvAAAvQAAyQAA+AAE2AIFTKwAALUAANEAAPACBUyxAAC0AAC8AAC9AADIAADtAAD5AaTQAADVAADsAaiwAAC1AAC8AADRAADUAADlAgVMhQAAtAAA8QAA+AGowQAA0AGkhAAAmQAAvQAAwAAA1QAA5AAA8AAA+QIFTJgAAKEAALwAANQAAN0AAO0AAPgAAQEBqJkAAKABqJEAAJgAAK0AANEAANwAAOwAAPEAAQABpPABqNABpJACCPSsAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA5QAA7AABCQABDAABJQABKAIFTMkAANgAAPkAAQgAASQAASkBqMUAAMgAAPgAAQEBpMQAAMkAAQAAAQkAASUAASgBqMUAAMgBqMQAAMkAAO0AAPkAAQgAASQAASkBpMgAAN0BqNwAAOQAAOwAAPUAAPgAAQEAARkAASgBpMkAAPkAAQABqMgAAMkAANEAAN0AAPQAAPgAAQ0AARgBpNAAAQwAARUBqMgAANkAANwAAOUAAPkAARQAASkBqNgAAN0BpNwAAOQAAO0AAQ0AASgAATEBpSkAATAABPgA0SgAATEA1OwAAPUAAQwAARUAATAAATEBqPQAAPkBpPgAAQEAAQ0BqQAAAQwAARQAASkAATAA1QkA0SgABN0AAOUAAPEAAQEAAQgAARUBpNwAAOQAAO0AAPAAAPEAAPkAAQAAAQkBqN0AAOwAAPAAAPgAAQEAAQgAARQAAR0BqNUAANwBpNQAAOUAARUAARwBqPkAAQAAAQkAARQA1QEAAQgA0K0AANEAAPgAAPkAAQABqKwAALkAAMkAAQEBqNAAAPgBpMgAANUAAPkAAQAAAf0BqOQBpLUAAL0AANEAANQBpNAABNUAANkAAfwBpLgAALwAAPgABNQBpLQAANEAAPUBpKkAAL0AANABqKgAAK0AALwAAL0AAO0AAPQBqNgBpLwAAL0AAPkBpMkAAPgBqKkAAKwAALUAALwAAOwAAPkBqKgAALEBpLAAALUAAPEAAPgBqLQBqK0AALQAAN0AAO0AAPABpKkAAOwBqKgAAKwAAMgAANwAAOUBqJkAALUAANkBpOQCCPSYAAC0AAC9AADxAAD5AgVMrQAAvAAAvQAAyQAA+AAE2AIFTKwAALUAANEAAPACBUyxAAC0AAC8AAC9AADIAADtAAD5AaTQAADVAADsAaiwAAC1AAC8AADRAADUAADlAgVMhQAAtAAA8QAA+AGowQAA0AGkhAAAmQAAvQAAwAAA1QAA5AAA8AAA+QIFTJgAAKEAALwAANQAAN0AAO0AAPgAAQEBqJkAAKABqJEAAJgAAK0AANEAANwAAOwAAPEAAQABpPABqNABpJACCPSsAAf8vAA== sound-font visualizer=&quot;#section394 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkADAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA5QAA7AABCQABDAABJQABKAIFTMkAANgAAPkAAQgAASQAASkBqMUAAMgAAPgAAQEBpMQAAMkAAQAAAQkAASUAASgBqMUAAMgBqMQAAMkAAO0AAPkAAQgAASQAASkBpMgAAN0BqNwAAOQAAOwAAPUAAPgAAQEAARkAASgBpMkAAPkAAQABqMgAAMkAANEAAN0AAPQAAPgAAQ0AARgBpNAAAQwAARUBqMgAANkAANwAAOUAAPkAARQAASkBqNgAAN0BpNwAAOQAAO0AAQ0AASgAATEBpSkAATAABPgA0SgAATEA1OwAAPUAAQwAARUAATAAATEBqPQAAPkBpPgAAQEAAQ0BqQAAAQwAARQAASkAATAA1QkA0SgABN0AAOUAAPEAAQEAAQgAARUBpNwAAOQAAO0AAPAAAPEAAPkAAQAAAQkBqN0AAOwAAPAAAPgAAQEAAQgAARQAAR0BqNUAANwBpNQAAOUAARUAARwBqPkAAQAAAQkAARQA1QEAAQgA0K0AANEAAPgAAPkAAQABqKwAALkAAMkAAQEBqNAAAPgBpMgAANUAAPkAAQAAAf0BqOQBpLUAAL0AANEAANQBpNAABNUAANkAAfwBpLgAALwAAPgABNQBpLQAANEAAPUBpKkAAL0AANABqKgAAK0AALwAAL0AAO0AAPQBqNgBpLwAAL0AAPkBpMkAAPgBqKkAAKwAALUAALwAAOwAAPkBqKgAALEBpLAAALUAAPEAAPgBqLQBqK0AALQAAN0AAO0AAPABpKkAAOwBqKgAAKwAAMgAANwAAOUBqJkAALUAANkBpOQCCPSYAAC0AAC9AADxAAD5AgVMrQAAvAAAvQAAyQAA+AAE2AIFTKwAALUAANEAAPACBUyxAAC0AAC8AAC9AADIAADtAAD5AaTQAADVAADsAaiwAAC1AAC8AADRAADUAADlAgVMhQAAtAAA8QAA+AGowQAA0AGkhAAAmQAAvQAAwAAA1QAA5AAA8AAA+QIFTJgAAKEAALwAANQAAN0AAO0AAPgAAQEBqJkAAKABqJEAAJgAAK0AANEAANwAAOwAAPEAAQABpPABqNABpJACCPSsAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section776 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section776 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section776 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section776 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section776 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section776 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section776 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section776 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section776 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section776 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section776 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section776&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Demo on val dataset, Epoch=12<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkwDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABGQABJQABKAGlGAABHQGo2AAA3QAA9AAA+QABDQABHAABHQABJAIFTNwAAOUAAPUAAPgAAQkAAQwAARwAATEBqOEAAOQAAQEAAQgBpNkAAOAAAQAAARUBqNEAANgAAREAARQBpNAAANkAARAAARUBqNgAAPQAAPUAATABqREAARQAAR0BpQkAARAAARUAARwBqNEAAQgAAREAARQBpNAAANkAAQkAARAAARUBqQgBpNgAAQEAARQAARUAASUABPQBoQAABNkAAQkBqM0AANgAAR0AASQBpRQAAR0BqL0AAMwAAQEAARwAASUBpKkAAO0AAQAAARwBqKgAALUAALwAAOwAAPUAAQgAASQBqNkAAOUBpLQAAL0AAOQAAPQAAP0BqLEAANgAAO0AAPkAAPwBpQEBqLUAALwAAOwAAPEAAPgAAQAAAQkBqLAAALUBpLQAAPAAAPUCDJy0AaUIAajFAADZAADlAAD0AAD1AAEVAgVMxAAAyQAA5AABCQIFTMgAANEAAPUAAQEAAQgAARECBUzQAADZAAD0AAD5AAEAAAEQAAEVAATYAAD0AAEUAgVM2AAA4QAA+AABAQABFAABKQABMQIFTOAAAOkAAQAAAQkAASUAASgAATAAATECBUzoAAEIAAEJAAEkAAEtAAEwAAFFAAFNAaUIAAERAakQAAEsAAE5AAFBAAFEAAFFAAFMAAFVAaktAAFAAaT1AAD9AAEsAAExAAE4AAFBAAFEAAFFAAFUAaT8AAEJAAERAAFEAAFNAAT0AAEwAAFAANEQAAEVANThAAEIAAEUAAEdAAExAAFMAAFhAajgAADlAAEcAAElAAEwAAE5AAFdAAFgAaTkAADtAAEdAAEkAAFZAAFcANVYAAFpANUVAAEcAAEtAAFoANUsAAExAAFhANE4ANUxANUUANTtAAEdAAEpAAEwAAEwAAFNAAFgANTsAhEQ5QAA7AABAQABFQABHAABKAABTAABUQIFUOQAAO0AAPkAAQAAARQAAR0AAT0AAVACBUzsAAD1AAD4AAEBAAEVAAEcAAE8AAFFAaUAAAEJAAEUAaj0AAEIAAFEAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkwDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABGQABJQABKAGlGAABHQGo2AAA3QAA9AAA+QABDQABHAABHQABJAIFTNwAAOUAAPUAAPgAAQkAAQwAARwAATEBqOEAAOQAAQEAAQgBpNkAAOAAAQAAARUBqNEAANgAAREAARQBpNAAANkAARAAARUBqNgAAPQAAPUAATABqREAARQAAR0BpQkAARAAARUAARwBqNEAAQgAAREAARQBpNAAANkAAQkAARAAARUBqQgBpNgAAQEAARQAARUAASUABPQBoQAABNkAAQkBqM0AANgAAR0AASQBpRQAAR0BqL0AAMwAAQEAARwAASUBpKkAAO0AAQAAARwBqKgAALUAALwAAOwAAPUAAQgAASQBqNkAAOUBpLQAAL0AAOQAAPQAAP0BqLEAANgAAO0AAPkAAPwBpQEBqLUAALwAAOwAAPEAAPgAAQAAAQkBqLAAALUBpLQAAPAAAPUCDJy0AaUIAajFAADZAADlAAD0AAD1AAEVAgVMxAAAyQAA5AABCQIFTMgAANEAAPUAAQEAAQgAARECBUzQAADZAAD0AAD5AAEAAAEQAAEVAATYAAD0AAEUAgVM2AAA4QAA+AABAQABFAABKQABMQIFTOAAAOkAAQAAAQkAASUAASgAATAAATECBUzoAAEIAAEJAAEkAAEtAAEwAAFFAAFNAaUIAAERAakQAAEsAAE5AAFBAAFEAAFFAAFMAAFVAaktAAFAAaT1AAD9AAEsAAExAAE4AAFBAAFEAAFFAAFUAaT8AAEJAAERAAFEAAFNAAT0AAEwAAFAANEQAAEVANThAAEIAAEUAAEdAAExAAFMAAFhAajgAADlAAEcAAElAAEwAAE5AAFdAAFgAaTkAADtAAEdAAEkAAFZAAFcANVYAAFpANUVAAEcAAEtAAFoANUsAAExAAFhANE4ANUxANUUANTtAAEdAAEpAAEwAAEwAAFNAAFgANTsAhEQ5QAA7AABAQABFQABHAABKAABTAABUQIFUOQAAO0AAPkAAQAAARQAAR0AAT0AAVACBUzsAAD1AAD4AAEBAAEVAAEcAAE8AAFFAaUAAAEJAAEUAaj0AAEIAAFEAAf8vAA== sound-font visualizer=&quot;#section776 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAADkwDAAACQL0AAO0AAPkAAQkBqOwAAPUAAPgAAQEBpLwAAO0AAPQAAPkAAQAAAR0CBUzpAADsAAD1AAD4AAEcAAElAgVQ6AAA7QAA9AABJAABKQGlCAABDQGo2QAA7AAA9QABDAABGQABJQABKAGlGAABHQGo2AAA3QAA9AAA+QABDQABHAABHQABJAIFTNwAAOUAAPUAAPgAAQkAAQwAARwAATEBqOEAAOQAAQEAAQgBpNkAAOAAAQAAARUBqNEAANgAAREAARQBpNAAANkAARAAARUBqNgAAPQAAPUAATABqREAARQAAR0BpQkAARAAARUAARwBqNEAAQgAAREAARQBpNAAANkAAQkAARAAARUBqQgBpNgAAQEAARQAARUAASUABPQBoQAABNkAAQkBqM0AANgAAR0AASQBpRQAAR0BqL0AAMwAAQEAARwAASUBpKkAAO0AAQAAARwBqKgAALUAALwAAOwAAPUAAQgAASQBqNkAAOUBpLQAAL0AAOQAAPQAAP0BqLEAANgAAO0AAPkAAPwBpQEBqLUAALwAAOwAAPEAAPgAAQAAAQkBqLAAALUBpLQAAPAAAPUCDJy0AaUIAajFAADZAADlAAD0AAD1AAEVAgVMxAAAyQAA5AABCQIFTMgAANEAAPUAAQEAAQgAARECBUzQAADZAAD0AAD5AAEAAAEQAAEVAATYAAD0AAEUAgVM2AAA4QAA+AABAQABFAABKQABMQIFTOAAAOkAAQAAAQkAASUAASgAATAAATECBUzoAAEIAAEJAAEkAAEtAAEwAAFFAAFNAaUIAAERAakQAAEsAAE5AAFBAAFEAAFFAAFMAAFVAaktAAFAAaT1AAD9AAEsAAExAAE4AAFBAAFEAAFFAAFUAaT8AAEJAAERAAFEAAFNAAT0AAEwAAFAANEQAAEVANThAAEIAAEUAAEdAAExAAFMAAFhAajgAADlAAEcAAElAAEwAAE5AAFdAAFgAaTkAADtAAEdAAEkAAFZAAFcANVYAAFpANUVAAEcAAEtAAFoANUsAAExAAFhANE4ANUxANUUANTtAAEdAAEpAAEwAAEwAAFNAAFgANTsAhEQ5QAA7AABAQABFQABHAABKAABTAABUQIFUOQAAO0AAPkAAQAAARQAAR0AAT0AAVACBUzsAAD1AAD4AAEBAAEVAAEcAAE8AAFFAaUAAAEJAAEUAaj0AAEIAAFEAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p><br> <br> …and that’s about as good as it’s going to get for now. 😕 Moving on…</p>
</section>
<section id="evaluate-the-model" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Evaluate the Model</h1>
<p>Now we’ll grab some data from the hitherto-unseen <code>test</code> dataset, and use it to prompt the model. We’ll see how it “scores” – in more ways than one!</p>
<section id="sample-generations" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sample-generations"><span class="header-section-number">8.1</span> Sample Generations</h2>
<p>First we’ll set a “prompt” from the <code>test</code> set to see how the model continues it.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>file_ind <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>original <span class="op">=</span> test_notes_tl[file_ind]</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>num_tokens <span class="op">=</span> <span class="bu">len</span>(original)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>display(midiplayer(original, title<span class="op">=</span><span class="ss">f"Full Evaluation Target, </span><span class="sc">{</span>num_tokens<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>prompt_len <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> original[:prompt_len] </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>display(midiplayer(prompt, title<span class="op">=</span><span class="ss">f"Evaluation Prompt, </span><span class="sc">{</span>prompt_len<span class="sc">}</span><span class="ss"> notes long"</span>))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> encode(prompt).unsqueeze(<span class="dv">0</span>).to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section911 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section911 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section911 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section911 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section911 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section911 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section911 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section911 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section911 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section911 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section911 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section911&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Full Evaluation Target, 112 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADlAADsAajhAADkAAEBAAEIAaS1AADQAADgAADlAAElAAEoAgyctAAA3QAA5AAA7QABHQABJAGlHAABJQGo2QAA3AAA5QAA7AAA+QABAAABJAABKQIFTMUAANgAAPgAAQEAARUAASgBqQ0AARQBpMQAAMkAAPkAAQAAAQkAAQwBqMEAAMgBpL0AAMAAAN0AAOQAAQgAAQ0BqLkAALwBqLUAALgAANwAAOUAAQkAAQwBpLEAALQAAOQAAO0BqLAAALUAAQEAAQgBpOUAAOwAAPUAAPgA1N0AAOQA1LQAAMkAANkAANwAAOUAAPQAAPkAAQACBUzIAADNAADYAADkAADtAAD4AAEJAgVMzAAA0QABEQGo+QABCAGo7AAA9QAA+AABAQABEAABGQGkyQAA0AGoyAAA3QAA7QAA9AABGAABHQGk+QABAAABHAABJQGo2QAA3AAA+AABCQABJAABKQGo0QAA2AGk0AAA2QAA6QAA7AABJQABKAGo6AABAQGkvQAA2AAA+QABAAABHQABJAIMnLwAANEAAPgAAQEAAQgAAQ0AARwAASUCBUzJAADQAAEAAAEJAAEMAAEVAAEkAAEpAgVNAQABCAABKAABMQGoxQAAyAGkxAAAyQAA+QABAAABMAABOQIFUMgAAN0AARQAAR0AATEAATgCBUzcAADlAAD1AAD4AAEVAAEcAaUNAAEUAajJAAD0AAEJAAEMAAEpAAEwAgyYyAAA5AABCAABKAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADlAADsAajhAADkAAEBAAEIAaS1AADQAADgAADlAAElAAEoAgyctAAA3QAA5AAA7QABHQABJAGlHAABJQGo2QAA3AAA5QAA7AAA+QABAAABJAABKQIFTMUAANgAAPgAAQEAARUAASgBqQ0AARQBpMQAAMkAAPkAAQAAAQkAAQwBqMEAAMgBpL0AAMAAAN0AAOQAAQgAAQ0BqLkAALwBqLUAALgAANwAAOUAAQkAAQwBpLEAALQAAOQAAO0BqLAAALUAAQEAAQgBpOUAAOwAAPUAAPgA1N0AAOQA1LQAAMkAANkAANwAAOUAAPQAAPkAAQACBUzIAADNAADYAADkAADtAAD4AAEJAgVMzAAA0QABEQGo+QABCAGo7AAA9QAA+AABAQABEAABGQGkyQAA0AGoyAAA3QAA7QAA9AABGAABHQGk+QABAAABHAABJQGo2QAA3AAA+AABCQABJAABKQGo0QAA2AGk0AAA2QAA6QAA7AABJQABKAGo6AABAQGkvQAA2AAA+QABAAABHQABJAIMnLwAANEAAPgAAQEAAQgAAQ0AARwAASUCBUzJAADQAAEAAAEJAAEMAAEVAAEkAAEpAgVNAQABCAABKAABMQGoxQAAyAGkxAAAyQAA+QABAAABMAABOQIFUMgAAN0AARQAAR0AATEAATgCBUzcAADlAAD1AAD4AAEVAAEcAaUNAAEUAajJAAD0AAEJAAEMAAEpAAEwAgyYyAAA5AABCAABKAAH/LwA= sound-font visualizer=&quot;#section911 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADlAADsAajhAADkAAEBAAEIAaS1AADQAADgAADlAAElAAEoAgyctAAA3QAA5AAA7QABHQABJAGlHAABJQGo2QAA3AAA5QAA7AAA+QABAAABJAABKQIFTMUAANgAAPgAAQEAARUAASgBqQ0AARQBpMQAAMkAAPkAAQAAAQkAAQwBqMEAAMgBpL0AAMAAAN0AAOQAAQgAAQ0BqLkAALwBqLUAALgAANwAAOUAAQkAAQwBpLEAALQAAOQAAO0BqLAAALUAAQEAAQgBpOUAAOwAAPUAAPgA1N0AAOQA1LQAAMkAANkAANwAAOUAAPQAAPkAAQACBUzIAADNAADYAADkAADtAAD4AAEJAgVMzAAA0QABEQGo+QABCAGo7AAA9QAA+AABAQABEAABGQGkyQAA0AGoyAAA3QAA7QAA9AABGAABHQGk+QABAAABHAABJQGo2QAA3AAA+AABCQABJAABKQGo0QAA2AGk0AAA2QAA6QAA7AABJQABKAGo6AABAQGkvQAA2AAA+QABAAABHQABJAIMnLwAANEAAPgAAQEAAQgAAQ0AARwAASUCBUzJAADQAAEAAAEJAAEMAAEVAAEkAAEpAgVNAQABCAABKAABMQGoxQAAyAGkxAAAyQAA+QABAAABMAABOQIFUMgAAN0AARQAAR0AATEAATgCBUzcAADlAAD1AAD4AAEVAAEcAaUNAAEUAajJAAD0AAEJAAEMAAEpAAEwAgyYyAAA5AABCAABKAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section430 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section430 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section430 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section430 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section430 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section430 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section430 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section430 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section430 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section430 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section430 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section430&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Evaluation Prompt, 21 notes long<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADsAakIAaUoAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADsAakIAaUoAAf8vAA== sound-font visualizer=&quot;#section430 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAAAhwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADsAakIAaUoAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
<p>In what follows, we’ll vary the “temperature” parameter of the model (see the bottom of the previous lesson), to see its effect on what comes out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>new_tokens <span class="op">=</span> num_tokens <span class="op">-</span> prompt_len</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> temperature <span class="kw">in</span> [ <span class="fl">0.7</span>, <span class="fl">0.85</span>, <span class="fl">0.92</span>, <span class="fl">1.0</span>, <span class="fl">1.2</span>, <span class="fl">1.5</span>]:</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    set_seeds(<span class="dv">1337</span>) <span class="co"># same temp for same seed will yield same output</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    notes <span class="op">=</span> decode( model.generate(prompt_tokens, max_new_tokens<span class="op">=</span>new_tokens, temperature<span class="op">=</span>temperature)[<span class="dv">0</span>].cpu() )</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    display(midiplayer(notes, title<span class="op">=</span><span class="ss">f"Temperature = </span><span class="sc">{</span>temperature<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.7<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAAEBAaj5AAEAAAEIAaS1AADQAADcAADlAAD1AAD4AAEVAAEoAhHotAAA9QAA+QABAQGpAAABCQGk0QAA7QAA9AAA9AAA+AABCAABEQGpAQGktQAA0AAA5AAA7AAA9QABEAIFULQAAPQAAPkAAQAAAQUBpRQBqN0AAPgAAQEAAQEAAQQAARUAAR0AASEBqQkBpNwAAOUAAQAAARwBqQAAAQgAARQAARUBpOQAAPkAAQ0BpPgABN0AAQUAAQwAARQA1NwAAR0A1NEAAQQAAQ0AARwBpQwAARUBqLUAANAAAQ0AARQAARkBpRgAASEBqLQAAMkAAQwAARUAASAAASkAATkCBUzIAADdAAEgAAElAAEoAAExAAE4AakNAAEUAaTVAADcAAEMAAEVAAEkAAEpAAEwAak1AajUAADdAAD5AAEUAAEZAAEoAaT4AAEBAAE0AajcAADlAAEAAAEFAAEVAAEYAAEhAgyY5AABBAABFAABIAIo6f0CNYDZAAD1AAEJAAEZAAH8AgVM2AAA9AABGAABJQIFTO0AAPkAAQgAAR0AASQAATkCBUzsAAEcAAUNAAEdAAE4AakMAAEcAAE9AaUVAAE5Aak8AaTlAAENAAEUAAE4AAE9AgVMyQAA5AABCQABDAABOQABPAGoyAAA3QGk3AAA5QABCAABDQABMQABOAGpCQABDAGo3QAA5AABCAABDQABHQABMAIFSPgABMkAANwAAQwAARwCBUzIAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAAEBAaj5AAEAAAEIAaS1AADQAADcAADlAAD1AAD4AAEVAAEoAhHotAAA9QAA+QABAQGpAAABCQGk0QAA7QAA9AAA9AAA+AABCAABEQGpAQGktQAA0AAA5AAA7AAA9QABEAIFULQAAPQAAPkAAQAAAQUBpRQBqN0AAPgAAQEAAQEAAQQAARUAAR0AASEBqQkBpNwAAOUAAQAAARwBqQAAAQgAARQAARUBpOQAAPkAAQ0BpPgABN0AAQUAAQwAARQA1NwAAR0A1NEAAQQAAQ0AARwBpQwAARUBqLUAANAAAQ0AARQAARkBpRgAASEBqLQAAMkAAQwAARUAASAAASkAATkCBUzIAADdAAEgAAElAAEoAAExAAE4AakNAAEUAaTVAADcAAEMAAEVAAEkAAEpAAEwAak1AajUAADdAAD5AAEUAAEZAAEoAaT4AAEBAAE0AajcAADlAAEAAAEFAAEVAAEYAAEhAgyY5AABBAABFAABIAIo6f0CNYDZAAD1AAEJAAEZAAH8AgVM2AAA9AABGAABJQIFTO0AAPkAAQgAAR0AASQAATkCBUzsAAEcAAUNAAEdAAE4AakMAAEcAAE9AaUVAAE5Aak8AaTlAAENAAEUAAE4AAE9AgVMyQAA5AABCQABDAABOQABPAGoyAAA3QGk3AAA5QABCAABDQABMQABOAGpCQABDAGo3QAA5AABCAABDQABHQABMAIFSPgABMkAANwAAQwAARwCBUzIAAf8vAA== sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAAEBAaj5AAEAAAEIAaS1AADQAADcAADlAAD1AAD4AAEVAAEoAhHotAAA9QAA+QABAQGpAAABCQGk0QAA7QAA9AAA9AAA+AABCAABEQGpAQGktQAA0AAA5AAA7AAA9QABEAIFULQAAPQAAPkAAQAAAQUBpRQBqN0AAPgAAQEAAQEAAQQAARUAAR0AASEBqQkBpNwAAOUAAQAAARwBqQAAAQgAARQAARUBpOQAAPkAAQ0BpPgABN0AAQUAAQwAARQA1NwAAR0A1NEAAQQAAQ0AARwBpQwAARUBqLUAANAAAQ0AARQAARkBpRgAASEBqLQAAMkAAQwAARUAASAAASkAATkCBUzIAADdAAEgAAElAAEoAAExAAE4AakNAAEUAaTVAADcAAEMAAEVAAEkAAEpAAEwAak1AajUAADdAAD5AAEUAAEZAAEoAaT4AAEBAAE0AajcAADlAAEAAAEFAAEVAAEYAAEhAgyY5AABBAABFAABIAIo6f0CNYDZAAD1AAEJAAEZAAH8AgVM2AAA9AABGAABJQIFTO0AAPkAAQgAAR0AASQAATkCBUzsAAEcAAUNAAEdAAE4AakMAAEcAAE9AaUVAAE5Aak8AaTlAAENAAEUAAE4AAE9AgVMyQAA5AABCQABDAABOQABPAGoyAAA3QGk3AAA5QABCAABDQABMQABOAGpCQABDAGo3QAA5AABCAABDQABHQABMAIFSPgABMkAANwAAQwAARwCBUzIAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.85<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsgDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGpAQABBAGkxQAAyAAA4AAA5QABAAABCQABFQABHAGo4QAA5AGoxAAAzQAA2QAA4AAA9QABAQABCAABFAGkzAAA0QAA4QGo0AAA2AAA2QAA4AAA5QAA8QAA9AAA/QABAAGk4QAA5AGo0QAA2AAA4AAA7QAA8AAA/AABAQABEQGkzQAA0AGoxQAAzAABAAABAQABEAABFQGoxAAAzQAA7AAA8QABAAABCQGkzAAA0QAA3QAA7QAA8AABAQABCAABFAIFTMEAANAAANwAAOwAAPEAAP0AAQAAARUCBVDwAAD8AAEBAaUNAai5AADAAAD5AAEAAaS1AAC4AADxAAEJAAEMAakUAaitAAC0AADtAADwAAEIAAENAaT4AajVAADsAADxAgVMrAAA1AAA3QABDAABDQABGQIFTNUAANwAAPAAAQUAAQwAAREAARgCBUzUAAEEAAEQAAElAaTRAAD5AAEdAAEkAAEpAgVQ0AAA0QAA+AABDQABIQABKAGlDAABFQGo0AAA1QABFAABFQIFTMEAANQAAQ0AARQAASABqRkAARwBpMAAAQwABMkAAPEAARUAARgAATUBpMgAANEBqMkAANAAAPAAAQUAATEAATQCBUy5AADIAAD5AAEEAAEpAAEwAaj4AAEUAaS4AAEoAAf8vAA==&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsgDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGpAQABBAGkxQAAyAAA4AAA5QABAAABCQABFQABHAGo4QAA5AGoxAAAzQAA2QAA4AAA9QABAQABCAABFAGkzAAA0QAA4QGo0AAA2AAA2QAA4AAA5QAA8QAA9AAA/QABAAGk4QAA5AGo0QAA2AAA4AAA7QAA8AAA/AABAQABEQGkzQAA0AGoxQAAzAABAAABAQABEAABFQGoxAAAzQAA7AAA8QABAAABCQGkzAAA0QAA3QAA7QAA8AABAQABCAABFAIFTMEAANAAANwAAOwAAPEAAP0AAQAAARUCBVDwAAD8AAEBAaUNAai5AADAAAD5AAEAAaS1AAC4AADxAAEJAAEMAakUAaitAAC0AADtAADwAAEIAAENAaT4AajVAADsAADxAgVMrAAA1AAA3QABDAABDQABGQIFTNUAANwAAPAAAQUAAQwAAREAARgCBUzUAAEEAAEQAAElAaTRAAD5AAEdAAEkAAEpAgVQ0AAA0QAA+AABDQABIQABKAGlDAABFQGo0AAA1QABFAABFQIFTMEAANQAAQ0AARQAASABqRkAARwBpMAAAQwABMkAAPEAARUAARgAATUBpMgAANEBqMkAANAAAPAAAQUAATEAATQCBUy5AADIAAD5AAEEAAEpAAEwAaj4AAEUAaS4AAEoAAf8vAA== sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsgDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGpAQABBAGkxQAAyAAA4AAA5QABAAABCQABFQABHAGo4QAA5AGoxAAAzQAA2QAA4AAA9QABAQABCAABFAGkzAAA0QAA4QGo0AAA2AAA2QAA4AAA5QAA8QAA9AAA/QABAAGk4QAA5AGo0QAA2AAA4AAA7QAA8AAA/AABAQABEQGkzQAA0AGoxQAAzAABAAABAQABEAABFQGoxAAAzQAA7AAA8QABAAABCQGkzAAA0QAA3QAA7QAA8AABAQABCAABFAIFTMEAANAAANwAAOwAAPEAAP0AAQAAARUCBVDwAAD8AAEBAaUNAai5AADAAAD5AAEAAaS1AAC4AADxAAEJAAEMAakUAaitAAC0AADtAADwAAEIAAENAaT4AajVAADsAADxAgVMrAAA1AAA3QABDAABDQABGQIFTNUAANwAAPAAAQUAAQwAAREAARgCBUzUAAEEAAEQAAElAaTRAAD5AAEdAAEkAAEpAgVQ0AAA0QAA+AABDQABIQABKAGlDAABFQGo0AAA1QABFAABFQIFTMEAANQAAQ0AARQAASABqRkAARwBpMAAAQwABMkAAPEAARUAARgAATUBpMgAANEBqMkAANAAAPAAAQUAATEAATQCBUy5AADIAAD5AAEEAAEpAAEwAaj4AAEUAaS4AAEoAAf8vAA== type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 0.92<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACuQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAIFTMgAANEAAOAAAOkAARwAASUCBVDQAADVAADhAADoAAERAAEdAAEkAaUEAajUAADZAADgAAD1AAEQAAEVAAEcAaUJAajYAADhAADtAAD0AAEBAAEIAAERAAEUAajgAADlAaTkAAEAAAEJAAEQAAEVAgVQvQAA/QABFAIFTLwAANEAAPwAAQEAAQgAARECBUy9AADQAADsAAD9AAEAAgVMtQAAvAAA9QAA/AABAQGo7QAA9AGktAAAuQAA7AAA9QABEAGpAAABCQGkuAAAwQAA8QAA9AAA/QGpCAABEQGoxQAA4QAA8AAA9QAA/AABAQABEAGk7QAA9AGoqQAAwAAAxAAA4AAA5QAA7AAA9QABAAABCQGk5AAE4QAA/QABCAGkqAAA9AAEsQAA8QIMmLAAAOAAAPAAAPwCKOn9AjWA2QAA5QAA9QABCQAB/AIFTNEAANgAAOEAAOQAAQgAARECBUzNAADQAADgAAD0AAD9AAEJAakIAAERAaUBAAEQAAT8ANEJANEAANUIAajhAAD9AAEdAgVQxQAA4AAA/AABAQABHAABJQDUzAIEeMQAAM0AAO0AAQAAAR0AASQCBUzMAADRAADsAAD9AAEJAAEcAajQAADZANEQANThAAEIAajYAAD1AaTgAAEBAaj0AaUAAhWQ/AAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACuQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAIFTMgAANEAAOAAAOkAARwAASUCBVDQAADVAADhAADoAAERAAEdAAEkAaUEAajUAADZAADgAAD1AAEQAAEVAAEcAaUJAajYAADhAADtAAD0AAEBAAEIAAERAAEUAajgAADlAaTkAAEAAAEJAAEQAAEVAgVQvQAA/QABFAIFTLwAANEAAPwAAQEAAQgAARECBUy9AADQAADsAAD9AAEAAgVMtQAAvAAA9QAA/AABAQGo7QAA9AGktAAAuQAA7AAA9QABEAGpAAABCQGkuAAAwQAA8QAA9AAA/QGpCAABEQGoxQAA4QAA8AAA9QAA/AABAQABEAGk7QAA9AGoqQAAwAAAxAAA4AAA5QAA7AAA9QABAAABCQGk5AAE4QAA/QABCAGkqAAA9AAEsQAA8QIMmLAAAOAAAPAAAPwCKOn9AjWA2QAA5QAA9QABCQAB/AIFTNEAANgAAOEAAOQAAQgAARECBUzNAADQAADgAAD0AAD9AAEJAakIAAERAaUBAAEQAAT8ANEJANEAANUIAajhAAD9AAEdAgVQxQAA4AAA/AABAQABHAABJQDUzAIEeMQAAM0AAO0AAQAAAR0AASQCBUzMAADRAADsAAD9AAEJAAEcAajQAADZANEQANThAAEIAajYAAD1AaTgAAEBAaj0AaUAAhWQ/AAH/LwA= sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACuQDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAIFTMgAANEAAOAAAOkAARwAASUCBVDQAADVAADhAADoAAERAAEdAAEkAaUEAajUAADZAADgAAD1AAEQAAEVAAEcAaUJAajYAADhAADtAAD0AAEBAAEIAAERAAEUAajgAADlAaTkAAEAAAEJAAEQAAEVAgVQvQAA/QABFAIFTLwAANEAAPwAAQEAAQgAARECBUy9AADQAADsAAD9AAEAAgVMtQAAvAAA9QAA/AABAQGo7QAA9AGktAAAuQAA7AAA9QABEAGpAAABCQGkuAAAwQAA8QAA9AAA/QGpCAABEQGoxQAA4QAA8AAA9QAA/AABAQABEAGk7QAA9AGoqQAAwAAAxAAA4AAA5QAA7AAA9QABAAABCQGk5AAE4QAA/QABCAGkqAAA9AAEsQAA8QIMmLAAAOAAAPAAAPwCKOn9AjWA2QAA5QAA9QABCQAB/AIFTNEAANgAAOEAAOQAAQgAARECBUzNAADQAADgAAD0AAD9AAEJAakIAAERAaUBAAEQAAT8ANEJANEAANUIAajhAAD9AAEdAgVQxQAA4AAA/AABAQABHAABJQDUzAIEeMQAAM0AAO0AAQAAAR0AASQCBUzMAADRAADsAAD9AAEJAAEcAajQAADZANEQANThAAEIAajYAAD1AaTgAAEBAaj0AaUAAhWQ/AAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.0<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsADAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGo1QAA4AGkyAAAzQAA1AAA+QGo+AGlHAAEzAAA6QABDQABKQGk9QABBAGo5QAA6AAA8QAA9AAA/QABDAABIQABKAIFTNkAAOQAAPAAAPkAAPwAARUAASABqNgAAN0AAPEAAPgA0NwAAQkA1MkAAPAAAPkAAQgAARkBqMgAANEAAPgAAQ0BpPUAAQwAARgBpRUABNABpKkAARQAARUBqQ0AARQBpKgAANkAAQkAAQwAARkBqNEBpRgABQgAAQ0BpMEAANAAANgAARUABPQBpMAAAMkAAPkAAQkAAQwAARQBpMEAAMgAAQ0AARQBqLkAAMAAAMkAAQgAAQkAAQwCBUz4AgVMuAAAwQAAyAAA3QAA5QAA8QAA/QABCAGk5AAE6QAA8AGo6AAA/QIFTMAAANwAAN0A1NwAAOUA0LkAAOQAAOkAAPwAAPwAASkBqOUAAOgAAPEAASEAASgA1N0AAOQA1LgAANUAANwAAOUAAPAAAQUAASAAASkBpM0AANQAAQQAAQ0A1QwAARUA1K0AAMwAAOQAAO0AAQ0AARQBqQUAAQwBpKwAAMEAAN0AAOwAAP0AAQQAASEAASgCEejAAADJAADcAAD5AAD8AAEJAAEVAAEgAgVMyAAA3QABCAABDQABFAGo+AGk3AABDAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsADAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGo1QAA4AGkyAAAzQAA1AAA+QGo+AGlHAAEzAAA6QABDQABKQGk9QABBAGo5QAA6AAA8QAA9AAA/QABDAABIQABKAIFTNkAAOQAAPAAAPkAAPwAARUAASABqNgAAN0AAPEAAPgA0NwAAQkA1MkAAPAAAPkAAQgAARkBqMgAANEAAPgAAQ0BpPUAAQwAARgBpRUABNABpKkAARQAARUBqQ0AARQBpKgAANkAAQkAAQwAARkBqNEBpRgABQgAAQ0BpMEAANAAANgAARUABPQBpMAAAMkAAPkAAQkAAQwAARQBpMEAAMgAAQ0AARQBqLkAAMAAAMkAAQgAAQkAAQwCBUz4AgVMuAAAwQAAyAAA3QAA5QAA8QAA/QABCAGk5AAE6QAA8AGo6AAA/QIFTMAAANwAAN0A1NwAAOUA0LkAAOQAAOkAAPwAAPwAASkBqOUAAOgAAPEAASEAASgA1N0AAOQA1LgAANUAANwAAOUAAPAAAQUAASAAASkBpM0AANQAAQQAAQ0A1QwAARUA1K0AAMwAAOQAAO0AAQ0AARQBqQUAAQwBpKwAAMEAAN0AAOwAAP0AAQQAASEAASgCEejAAADJAADcAAD5AAD8AAEJAAEVAAEgAgVMyAAA3QABCAABDQABFAGo+AGk3AABDAAH/LwA= sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACsADAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIAaS1AADQAADcAADgAADlAAEBAAElAAEoAgVMtAAAyQAA4QAA5AABAAABBQABHQABJAGo1QAA4AGkyAAAzQAA1AAA+QGo+AGlHAAEzAAA6QABDQABKQGk9QABBAGo5QAA6AAA8QAA9AAA/QABDAABIQABKAIFTNkAAOQAAPAAAPkAAPwAARUAASABqNgAAN0AAPEAAPgA0NwAAQkA1MkAAPAAAPkAAQgAARkBqMgAANEAAPgAAQ0BpPUAAQwAARgBpRUABNABpKkAARQAARUBqQ0AARQBpKgAANkAAQkAAQwAARkBqNEBpRgABQgAAQ0BpMEAANAAANgAARUABPQBpMAAAMkAAPkAAQkAAQwAARQBpMEAAMgAAQ0AARQBqLkAAMAAAMkAAQgAAQkAAQwCBUz4AgVMuAAAwQAAyAAA3QAA5QAA8QAA/QABCAGk5AAE6QAA8AGo6AAA/QIFTMAAANwAAN0A1NwAAOUA0LkAAOQAAOkAAPwAAPwAASkBqOUAAOgAAPEAASEAASgA1N0AAOQA1LgAANUAANwAAOUAAPAAAQUAASAAASkBpM0AANQAAQQAAQ0A1QwAARUA1K0AAMwAAOQAAO0AAQ0AARQBqQUAAQwBpKwAAMEAAN0AAOwAAP0AAQQAASEAASgCEejAAADJAADcAAD5AAD8AAEJAAEVAAEgAgVMyAAA3QABCAABDQABFAGo+AGk3AABDAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.2<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIANDgAADlANS1AAC9AADQAADcAADdAADkAAEBAAEoAaj5AAEAAaS0AAC8AADRAAENAajcAhBArQAA0AAA7QIFTKwAANUAAOUAAOwAAQEAAQwAARUCBUzUAADdAADkAAEAAAEUAAEdAajZAaTBAADYAADdAAEBAAEVAATcAAD4AAEcAaDRAAENAAEUAATcANDQAADZANS9AADAAADYAADdAAD5AAEMAaTcAADdAAUAAaDBAADlAAS8AAD4ANDAAAEJANS9AADkAAD5AAEIAgyYrQABDQGorAAAwQAA7QABAQGkvAAA+AAFDAGk1QABAAIFTLUAAMAAAMEAANEAANQAANUAANwCBUzJAADQAADUAADVAAS0AADsAgVMvQAAwAAA1AAA3QABDQGkyAAA0QAA1QAA3AGotQAAvAAAwQAA0AAA1AAA5QABBQABDAGkpQAAtAGopAAArQAA3QAA5AABAQABBAIMmKUAAKwAANwAAOUAAQAAAQUCBVChAACkAADdAADkAAEEAAENAaSlAADxAaTVAAUMAaSkAADcAADtAADwAajAAADUAADdAajdAADsAADxAaTcAajBAADRAADwAaStAAC9AADcAATAAaSgAAClAACsAADQAADlAaShAACkAAClAACtAAC8AADBAADdAADkAaikAADBAaiZAACgAACpAACsAADAAADAAADBAADJAADcAgVMmAAAqAAAwAAAyAAH/LwA=&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIANDgAADlANS1AAC9AADQAADcAADdAADkAAEBAAEoAaj5AAEAAaS0AAC8AADRAAENAajcAhBArQAA0AAA7QIFTKwAANUAAOUAAOwAAQEAAQwAARUCBUzUAADdAADkAAEAAAEUAAEdAajZAaTBAADYAADdAAEBAAEVAATcAAD4AAEcAaDRAAENAAEUAATcANDQAADZANS9AADAAADYAADdAAD5AAEMAaTcAADdAAUAAaDBAADlAAS8AAD4ANDAAAEJANS9AADkAAD5AAEIAgyYrQABDQGorAAAwQAA7QABAQGkvAAA+AAFDAGk1QABAAIFTLUAAMAAAMEAANEAANQAANUAANwCBUzJAADQAADUAADVAAS0AADsAgVMvQAAwAAA1AAA3QABDQGkyAAA0QAA1QAA3AGotQAAvAAAwQAA0AAA1AAA5QABBQABDAGkpQAAtAGopAAArQAA3QAA5AABAQABBAIMmKUAAKwAANwAAOUAAQAAAQUCBVChAACkAADdAADkAAEEAAENAaSlAADxAaTVAAUMAaSkAADcAADtAADwAajAAADUAADdAajdAADsAADxAaTcAajBAADRAADwAaStAAC9AADcAATAAaSgAAClAACsAADQAADlAaShAACkAAClAACtAAC8AADBAADdAADkAaikAADBAaiZAACgAACpAACsAADAAADAAADBAADJAADcAgVMmAAAqAAAwAAAyAAH/LwA= sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACswDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAai8AADRAADdAADsAADtAaThAADsAAUIANDgAADlANS1AAC9AADQAADcAADdAADkAAEBAAEoAaj5AAEAAaS0AAC8AADRAAENAajcAhBArQAA0AAA7QIFTKwAANUAAOUAAOwAAQEAAQwAARUCBUzUAADdAADkAAEAAAEUAAEdAajZAaTBAADYAADdAAEBAAEVAATcAAD4AAEcAaDRAAENAAEUAATcANDQAADZANS9AADAAADYAADdAAD5AAEMAaTcAADdAAUAAaDBAADlAAS8AAD4ANDAAAEJANS9AADkAAD5AAEIAgyYrQABDQGorAAAwQAA7QABAQGkvAAA+AAFDAGk1QABAAIFTLUAAMAAAMEAANEAANQAANUAANwCBUzJAADQAADUAADVAAS0AADsAgVMvQAAwAAA1AAA3QABDQGkyAAA0QAA1QAA3AGotQAAvAAAwQAA0AAA1AAA5QABBQABDAGkpQAAtAGopAAArQAA3QAA5AABAQABBAIMmKUAAKwAANwAAOUAAQAAAQUCBVChAACkAADdAADkAAEEAAENAaSlAADxAaTVAAUMAaSkAADcAADtAADwAajAAADUAADdAajdAADsAADxAaTcAajBAADRAADwAaStAAC9AADcAATAAaSgAAClAACsAADQAADlAaShAACkAAClAACtAAC8AADBAADdAADkAaikAADBAaiZAACgAACpAACsAADAAADAAADBAADJAADcAgVMmAAAqAAAwAAAyAAH/LwA= type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
<div class="cell-output cell-output-display">
<iframe srcdoc="<script src=&quot;https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0&quot;></script>

<style>
/* Custom player style */
p { 
  margin:0; 
  color: #c4c4c4; /* mid-lightness text color for title, intended for dark backgrounds */
}

#section632 midi-player {
  display: block;
  width: inherit;
  margin: 4px;
  margin-bottom: 0;
  color: #d4d4d4; /* Lighter text color for better readability */
}
#section632 midi-player::part(control-panel) {
  background: #222; /* Dark background */
  border: 2px solid #888; /* Lightened border color for contrast */
  border-radius: 10px 10px 0 0;
}
#section632 midi-player::part(play-button) {
  color: #ffffff; /* White text for visibility */
  border: 2px solid currentColor;
  background-color: #6c7a89; 
  border-radius: 20px;
  transition: all 0.2s;
  content: 'hello';
}
#section632 midi-player::part(play-button):hover {
  color: #00a; 
  background-color: #9fafc9; 
  border-radius: 10px;
}
#section632 midi-player::part(time) {
  font-family: monospace; /* Monospace font for time */
}

/* Custom visualizer style */
#section632 midi-visualizer .piano-roll-visualizer {
  background: #333; /* Dark background for visualizer */
  border: 2px solid #505050; /* Dark border for subtle appearance */
  border-top: none;
  border-radius: 0 0 10px 10px;
  margin: 4px;
  width: inherit;
  margin-top: 0;
  overflow: auto;
}
#section632 midi-visualizer svg rect.note {
  opacity: 0.9; 
  stroke-width: 1; /* Stroke width for note clarity */
}

/* Different instrument colors */
#section632 midi-visualizer svg rect.note[data-instrument=&quot;0&quot;]{
  fill: #7aa6ed; /*  blue for Instrument 0 */
  stroke: #444; 
}
#section632 midi-visualizer svg rect.note[data-instrument=&quot;2&quot;]{
  fill: #d586d0; /* purple for Instrument 2 for consistency */
  stroke: #444; /* White stroke for visibility */
}
#section632 midi-visualizer svg rect.note[data-is-drum=&quot;true&quot;]{
  fill: brightorange; 
  stroke: #bbb;
}
#section632 midi-visualizer svg rect.note.active {
  opacity: 0.9; /* Highlight active notes */
  stroke: #ddd; /* White stroke for maximum contrast */
  stroke-width: 2; /* Thicker stroke for active notes */
}
</style>

          <section id=&quot;section632&quot;><p style=&quot;text-align:left;font-family:Arial;&quot;>Temperature = 1.5<span style=&quot;float:right;&quot;><a href=&quot;data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAaipAAC8AADdAADsAADtAaTpAADsAAUIANDoAADtANSoAAC1AADcAADsAAD1AAEBAAEVAAEoAakNAAEUAaTRAADdAAD0AakAAgjwtAAA3AABHQGoyQAA0AIEeNUA2MgA0M0AANQAAOUA1RwA1PEAAP0BpMwBqL0AAPAAAPkAAPwBpPgAAQEA2QwA0N0AAOQAAO0BpNkAANwAAPkAAQAABLwBpMEAANgAAOUBqJkAAMAAAMkAAOQAAOUAAOwAAPgAAQkBpMEAAMgBqJgAAJ0AALkAAMAAAN0AAOQAAQgAAQ0CDJicAgVMrQAAuAAAvQABDAGo+QDU3AAA5QDQrAAEvAAA3QGk1QGonQAAwQAA3AGk1AAA8QDU5ADUmQAAnAAAwAAAyQAA1QGk8AAEmAAA5QAA+AABFQGkzQABDQAE1ADU5ADQmQAAyAAA6QABFAGkzAAA3QAA6AABDADVGQDUmAAA5QAA/QDVGADUwQIFTNwBpPwBqMABqOQCJUDJAADRAADdAADpAaiFAADIAADJAADQAADlAADoAajcAaS5AADRANStAADBANCEAADQAAS4AADIANCpAACsAAC1AADAAaioAAC0AAC1AADJAgVMmQAArQAAtAGkrQGomAAArAAAwQAAyADU5ADVAQIFTMECCPTAAaTxAAUAAaSsAaiZAACpAADAAADwAAD9AgVMmAAAqAAArQAAvQAA7QAA+QAA/AIFTKwAALEAALwAAMEAAOwCDJywAhkw+AIFTMAAB/y8A&quot; target=&quot;_blank&quot;>Download MIDI</a><br></span></p>
          <midi-player src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAaipAAC8AADdAADsAADtAaTpAADsAAUIANDoAADtANSoAAC1AADcAADsAAD1AAEBAAEVAAEoAakNAAEUAaTRAADdAAD0AakAAgjwtAAA3AABHQGoyQAA0AIEeNUA2MgA0M0AANQAAOUA1RwA1PEAAP0BpMwBqL0AAPAAAPkAAPwBpPgAAQEA2QwA0N0AAOQAAO0BpNkAANwAAPkAAQAABLwBpMEAANgAAOUBqJkAAMAAAMkAAOQAAOUAAOwAAPgAAQkBpMEAAMgBqJgAAJ0AALkAAMAAAN0AAOQAAQgAAQ0CDJicAgVMrQAAuAAAvQABDAGo+QDU3AAA5QDQrAAEvAAA3QGk1QGonQAAwQAA3AGk1AAA8QDU5ADUmQAAnAAAwAAAyQAA1QGk8AAEmAAA5QAA+AABFQGkzQABDQAE1ADU5ADQmQAAyAAA6QABFAGkzAAA3QAA6AABDADVGQDUmAAA5QAA/QDVGADUwQIFTNwBpPwBqMABqOQCJUDJAADRAADdAADpAaiFAADIAADJAADQAADlAADoAajcAaS5AADRANStAADBANCEAADQAAS4AADIANCpAACsAAC1AADAAaioAAC0AAC1AADJAgVMmQAArQAAtAGkrQGomAAArAAAwQAAyADU5ADVAQIFTMECCPTAAaTxAAUAAaSsAaiZAACpAADAAADwAAD9AgVMmAAAqAAArQAAvQAA7QAA+QAA/AIFTKwAALEAALwAAMEAAOwCDJywAhkw+AIFTMAAB/y8A sound-font visualizer=&quot;#section632 midi-visualizer&quot;></midi-player>
          <midi-visualizer src=data:audio/midi;base64,TVRoZAAAAAYAAQACANxNVHJrAAAAEwD/UQMHoSAA/1gEBAIYCAH/LwBNVHJrAAACtwDAAACQMkAAOUAAQkAARUCBU0BAAEIAAENAAEUAaj5AAEAAAEJAAEMAaStAADIAAEIAAEdAajdAADkAAD4AAEBAaisAAC1AAEcAAElAaTcAADlAAEAAAEJANTdAADkANS0AAC9AADZAADcAAEkAAEpAaTYAADtAaipAAC8AADdAADsAADtAaTpAADsAAUIANDoAADtANSoAAC1AADcAADsAAD1AAEBAAEVAAEoAakNAAEUAaTRAADdAAD0AakAAgjwtAAA3AABHQGoyQAA0AIEeNUA2MgA0M0AANQAAOUA1RwA1PEAAP0BpMwBqL0AAPAAAPkAAPwBpPgAAQEA2QwA0N0AAOQAAO0BpNkAANwAAPkAAQAABLwBpMEAANgAAOUBqJkAAMAAAMkAAOQAAOUAAOwAAPgAAQkBpMEAAMgBqJgAAJ0AALkAAMAAAN0AAOQAAQgAAQ0CDJicAgVMrQAAuAAAvQABDAGo+QDU3AAA5QDQrAAEvAAA3QGk1QGonQAAwQAA3AGk1AAA8QDU5ADUmQAAnAAAwAAAyQAA1QGk8AAEmAAA5QAA+AABFQGkzQABDQAE1ADU5ADQmQAAyAAA6QABFAGkzAAA3QAA6AABDADVGQDUmAAA5QAA/QDVGADUwQIFTNwBpPwBqMABqOQCJUDJAADRAADdAADpAaiFAADIAADJAADQAADlAADoAajcAaS5AADRANStAADBANCEAADQAAS4AADIANCpAACsAAC1AADAAaioAAC0AAC1AADJAgVMmQAArQAAtAGkrQGomAAArAAAwQAAyADU5ADVAQIFTMECCPTAAaTxAAUAAaSsAaiZAACpAADAAADwAAD9AgVMmAAAqAAArQAAvQAA7QAA+QAA/AIFTKwAALEAALwAAMEAAOwCDJywAhkw+AIFTMAAB/y8A type=piano-roll></midi-visualizer>
          </section>
          " width="100%" height="400" style="border:none !important;" "allowfullscreen"="" "webkitallowfullscreen"="" "mozallowfullscreen"="">'
            </iframe>
</div>
</div>
</section>
<section id="perplexity-score" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="perplexity-score"><span class="header-section-number">8.2</span> Perplexity Score</h2>
<p>TODO</p>
</section>
</section>
<section id="summary" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Summary</h1>
<p>TODO: write more</p>
<p>Here’s the full code in a Colab notebook: TODO</p>
</section>
<section id="sec-further" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Ideas for Further Exploration</h1>
The following are some ideas for taking this lesson further.
<details>
<summary>
Details
</summary>
<section id="change-the-hyperparamters" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="change-the-hyperparamters"><span class="header-section-number">10.1</span> Change the Hyperparamters</h2>
<p>I did a <em>lot</em> of that already. Now it’s your turn. Maybe even trying WandB’s Sweeps feature.</p>
</section>
<section id="improving-outputs-with-beam-search" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="improving-outputs-with-beam-search"><span class="header-section-number">10.2</span> Improving Outputs with Beam Search</h2>
</section>
<section id="using-huggingfaces-transformers-instead" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="using-huggingfaces-transformers-instead"><span class="header-section-number">10.3</span> Using Huggingface’s <code>transformers</code> instead</h2>
<p><code>trasformers</code> is a package that is optimized for general applications and would probably outperform the above code in numerous ways.</p>
</section>
<section id="pitch-only-estimation" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="pitch-only-estimation"><span class="header-section-number">10.4</span> Pitch-Only Estimation</h2>
</section>
<section id="raw-audio" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="raw-audio"><span class="header-section-number">10.5</span> Raw Audio</h2>
<p>If you were to instead use raw audio, I’d recommend converting it to spectrograms, treating each column of the spectrogram as a “word vector.” However, there’d likely be a lot of “wasted space” so you’d probably want to (invertibly) compress the dimensionality of your “audio-word vectors” via something like <a href="https://drscotthawley.github.io/blog/posts/2023-06-12-RVQ.html">(Residual) Vector Quantization</a>, an <a href="https://drscotthawley.github.io/audio-algebra/given-models.html">autoencoder</a>, or <a href="https://umap-learn.readthedocs.io/en/latest/">UMAP</a>. …And then you’d need to expand/decode it on the output side to be able to listen. Relatedly, a pretrained sytem like Meta’s <a href="https://github.com/facebookresearch/encodec">EnCodec</a> would likely provide such functions nicely.</p>
</section>
</details></section>
<section id="acknowledgements" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Acknowledgements</h1>
<ul>
<li><p>Super huge thanks to <a href="https://twitter.com/jeremyjordan">Jeremy Jordan</a> for many fruitful discussions as I developed this! Check out <a href="https://www.jeremyjordan.me/">his blog</a> for many helpful posts, esp.&nbsp;on Transformers, Attention, and many other Machine Learning topics.</p></li>
<li><p>I referred to <a href="https://www.youtube.com/watch?v=kCc8FmEb1nY">Andrej Karpathy’s lesson and codes</a> frequently when my own code wasn’t working to my satisfaction (i.e.&nbsp;all the time).</p></li>
<li><p>Various papers by the Google Magenta team – the undisputed ML-MIDI experts in my book – were helpful in figuring out what to do. This lesson was influenced by their tutorial <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/audio/music_generation.ipynb">“Generate Music with an RNN”</a>, which I converted PyTorch. In this lesson, code that wasn’t lifted from Karpathy was lifted from that.</p></li>
<li><p>As I included in the Preface, thanks to <a href="https://twitter.com/mamodrzejewski">Mateusz Modrzejewski</a> for what I took to be a word of encouragement.</p></li>
<li><p>ChatGPT was used extensively for figuring out annoying little code snippets like formatting Pandas &amp; CSS, but not for anything more significant.</p></li>
</ul>
</section>
<section id="appendix-feeding-it-christmas-carols" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Appendix: Feeding it Christmas Carols 🎄</h1>
<p>This is probably a bad idea for so many reasons – it will be <em>wayyy</em> outside the distribution of training data – but given the time of year, I’ma try it anyway.</p>
<!--- comment 

---
# Afterward: Stuff I Probably Should Have Looked at First


BTW, that code is a PyTorch implementation of the 2018 [Music Transformer](https://arxiv.org/abs/1809.04281) paper by Google Brain, the abstract of which includes:

> "Existing approaches for representing relative positional information
in the Transformer modulate attention based on pairwise distance (Shaw et al.,
2018). This is impractical for long sequences such as musical compositions since
their memory complexity for intermediate relative information is quadratic in the
sequence length. We propose an algorithm that reduces their intermediate memory
requirement to linear in the sequence length.
This enables us to demonstrate that a
Transformer with our modified relative attention mechanism can generate minutelong compositions (thousands of steps, four times the length modeled in Oore et al.
(2018)) with compelling structure, generate continuations that coherently elaborate
on a given motif, and in a seq2seq setup generate accompaniments conditioned on
melodies"

....but this notebook is a tutorial, so forgive me if it's 5 years behind SOTA. ;-)

[Here's a nother code for a Pytorch MIDI transformer from 2 years ago](https://github.com/spectraldoy/music-transformer)

https://medium.com/data-science-in-your-pocket/music-generation-using-musictransformer-with-codes-c7be89ba85b1

--->
<hr>
<p>Copyright (c) 2023, Scott H. Hawley. Code is MIT-licensed, text is licensed CC-BY-NC 4.0.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/drscotthawley\.github\.io\/blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>